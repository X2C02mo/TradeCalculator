<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trader Calculator</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
  
  <script async src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { init, trackEvent } from 'https://esm.sh/@telegram-apps/analytics@0.1.4';
    const TG_ANALYTICS_TOKEN = "eyJhcHBfbmFtZSI6InRyYWRlcl9jYWxjdWxhdG9yIiwiYXBwX3VybCI6Imh0dHBzOi8vdC5tZS9DYWxjdWxhdG9yVHJhZGVyQm90IiwiYXBwX2RvbWFpbiI6Imh0dHBzOi8vdHJhZGUtY2FsY3VsYXRvci1maXZlLnZlcmNlbC5hcHAifQ==!+ZTX3Nk0y5cUIMvJ8jWfv22EWL8UPctpRGiFct3mBr0=";
    try {
      init({
        token: TG_ANALYTICS_TOKEN,
        appName: "trader_calculator"
      });
      setTimeout(() => {
        try { trackEvent('app_open', { timestamp: Date.now() }); } catch(e) {}
      }, 1000);
    } catch (error) {}
  </script>

<style>
    :root{
      --bg:#000;
      --panel:#0b0b0b;
      --border:#151515;
      --text:#fff;
      --muted:#9a9a9a;
      --accent:#7CFC00;
      --accent-gradient: linear-gradient(135deg, #7CFC00 0%, #00FFAA 100%);
      --chip:#111;
      --chip2:#0f0f0f;
      --danger:#ff4d4d;
      --radius:14px;
      --shadow:0 12px 30px rgba(0,0,0,.55);
      --input-bg:#070707;
      --result-bg:#060606;
      --chip-bg:#0a0a0a;
      --support-tagline:#22c55e;
    }
    html[data-theme="light"]{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --border:#e6e8ee;
      --text:#0b0b0b;
      --muted:#5f6675;
      --accent:#2d8cff;
      --accent-gradient: linear-gradient(135deg, #2d8cff 0%, #00d4ff 100%);
      --chip:#f0f2f8;
      --chip2:#eef1f7;
      --danger:#d90429;
      --shadow:0 12px 30px rgba(10,20,40,.10);
      --input-bg:#fbfcff;
      --result-bg:#f7f9ff;
      --chip-bg:#f1f4fb;
      --support-tagline:#2d8cff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #app{min-height:100vh;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 10px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.35);backdrop-filter: blur(8px);}
    html[data-theme="light"] header{background:rgba(255,255,255,.7)}
    .leftbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .lang{display:flex;gap:6px;align-items:center}
    .lang button{background:transparent;border:1px solid var(--border);color:var(--muted);padding:5px 9px;cursor:pointer;border-radius:12px;font-weight:800;font-size:12px;letter-spacing:.4px;}
    .lang button.active{border-color:var(--accent);color:var(--accent)}
    .iconbtn{border:1px solid var(--border);background:transparent;color:var(--muted);padding:6px 10px;border-radius:12px;cursor:pointer;font-weight:900;line-height:1.1;min-height:34px;display:inline-flex;align-items:center;gap:8px;}
    .iconbtn:hover{border-color:color-mix(in srgb, var(--accent) 50%, var(--border))}
    .iconbtn .ico{font-size:15px}
    .iconbtn .lbl{font-size:12px;font-weight:800;white-space:nowrap}
    .iconbtn.active{border-color:var(--accent);color:var(--accent)}
    main{flex:1;padding:12px;padding-bottom: 92px;display:flex;flex-direction:column;gap:14px;}
    .main-screen{display:none}
    .main-screen.active{display:block}
    .subtabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;margin-bottom:12px;}
    .subtab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:12px;font-weight:900;border:1px solid transparent;display:inline-flex;align-items:center;gap:6px;}
    .subtab:hover{border-color:var(--border)}
    .subtab.active{color:var(--accent);border-color:var(--accent);background:var(--chip-bg);}
    .subtab.active::before {content: "";display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--accent-gradient);}
    .panels{display:flex;gap:14px;flex-wrap:wrap;flex:1}
    .screen{display:none;width:100%}
    .screen.active{display:block}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;max-width:820px;box-shadow:var(--shadow);}
    .card h3{margin:0 0 10px 0;display:flex;align-items:center;gap:8px;}
    .card h3::before{content:"";display:inline-block;width:6px;height:20px;border-radius:3px;background:var(--accent-gradient);}
    .field{margin-bottom:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:800;display:flex;align-items:center;gap:6px;}
    label::before{content:"";display:inline-block;width:10px;height:2px;background:color-mix(in srgb, var(--muted) 50%, transparent);border-radius:1px;}
    input, select{width:100%;padding:11px 10px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:12px;font-size:15px;outline:none;transition: border-color 0.2s ease, box-shadow 0.2s ease;}
    input:hover, select:hover{border-color:color-mix(in srgb, var(--accent) 30%, var(--border));}
    input:focus, select:focus{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 30%, transparent);}
    input.error, select.error{border-color:color-mix(in srgb, var(--danger) 60%, var(--border));}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:150px}
    @media(max-width:420px){.row.dca-mobile-stack{flex-direction:column;} .row.dca-mobile-stack > *{min-width:100%;}}
    .result{margin-top:8px;padding:10px;border-radius:12px;background:var(--result-bg);border:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between;font-weight:900;transition: border-color 0.3s ease;}
    .result.success{border-color:color-mix(in srgb, var(--accent) 40%, var(--border));}
    .result.error{border-color:color-mix(in srgb, var(--danger) 40%, var(--border));}
    .result .v{color:var(--accent);background:var(--accent-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:1000;}
    .result-value{position:relative;overflow:hidden;}
    .result-value .old{position:absolute;top:0;left:0;opacity:0;transform:translateY(-5px);}
    .result-value .new{display:inline-block;}
    .small{font-size:12px;color:var(--muted);font-weight:700}
    .small.hint{padding:6px 8px;background:color-mix(in srgb, var(--accent) 10%, transparent);border-radius:8px;border-left:3px solid var(--accent);margin-top:4px;animation:fadeInUp 0.3s ease;}
    .small.warning{border-left-color:var(--danger);background:color-mix(in srgb, var(--danger) 10%, transparent);}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .btn{background:transparent;color:var(--accent);border:1px solid color-mix(in srgb, var(--border) 80%, var(--accent));padding:9px 12px;border-radius:12px;cursor:pointer;font-weight:900;transition: all 0.2s ease;display:inline-flex;align-items:center;justify-content:center;gap:6px;position:relative;overflow:hidden;}
    .btn:hover{border-color:var(--accent);transform:translateY(-1px);}
    .btn:active{transform:translateY(0);}
    .btn.accent{background:var(--accent-gradient);color:#000;border:none;font-weight:1000;}
    .btn.ghost{color:var(--muted);border-color:var(--border)}
    .btn.danger{color:var(--danger);border-color:color-mix(in srgb, var(--danger) 40%, var(--border))}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none !important;}
    .btn-copy{min-width:70px;transition:min-width 0.3s ease;}
    .btn-copy.copied{min-width:40px;}
    .btn-copy.copied .copy-text{opacity:0;transform:translateX(-10px);}
    .btn-copy.copied::after{content:"âœ“";position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);font-size:16px;opacity:1;}
    .btn-copy::after{content:"âœ“";position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);font-size:16px;opacity:0;transition:opacity 0.3s ease;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{border:1px solid var(--border);background:var(--chip-bg);padding:7px 10px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:900;font-size:12px;transition: all 0.2s ease;display:inline-flex;align-items:center;gap:5px;}
    .chip:hover{border-color:color-mix(in srgb, var(--accent) 50%, var(--border));transform:translateY(-1px);}
    .chip.active{border-color:var(--accent);color:var(--accent);background:color-mix(in srgb, var(--accent) 10%, transparent);padding-right:30px;position:relative;}
    .chip.active::after{content:"âœ“";position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;}
    .history{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:10px;width:100%;max-width:460px;box-shadow:var(--shadow);}
    .history h4{margin:0 0 8px 0;display:flex;align-items:center;gap:8px;}
    .history h4::before{content:"";display:inline-block;width:6px;height:16px;border-radius:3px;background:var(--accent-gradient);}
    .history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:4px;}
    .hist-item{border:1px solid var(--border);border-radius:12px;padding:8px;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));animation:slideIn 0.3s ease;}
    html[data-theme="light"] .hist-item{background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0))}
    .hist-item b{display:block;font-size:13px}
    .hist-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .mini{border:1px solid var(--border);background:transparent;color:var(--muted);padding:6px 9px;border-radius:12px;cursor:pointer;font-weight:900;font-size:12px;transition: all 0.2s ease;}
    .mini:hover{border-color:color-mix(in srgb, var(--accent) 45%, var(--border));color:var(--accent);transform:translateY(-1px);}
    .note{font-size:12px;color:var(--muted);font-weight:700;margin-top:8px}
    .rainbow{display:inline-block;font-weight:1000;text-decoration:none;background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);background-size:400% 400%;-webkit-background-clip:text;background-clip:text;color:transparent;animation:rain 3.5s linear infinite;}
    @keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
    .tagline{color:var(--support-tagline) !important;background:none !important;-webkit-text-fill-color:currentColor !important;animation:none !important;text-decoration:none;font-weight:1000;}
    .support-wrap{display:flex;flex-direction:column;gap:14px;align-items:center;}
    .support-links{display:flex;gap:18px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:8px;}
    .support-tags{font-size:13px;letter-spacing:1px;font-weight:1000;}
    .bottomnav{position:fixed;left:0; right:0; bottom:0;z-index:20;padding:10px 12px;padding-bottom: calc(10px + env(safe-area-inset-bottom));border-top:1px solid var(--border);background:rgba(0,0,0,.55);backdrop-filter: blur(10px);display:flex;justify-content:center;}
    html[data-theme="light"] .bottomnav{background:rgba(255,255,255,.85)}
    .bottomnav .bar{width:min(520px, 100%);display:flex;gap:10px;}
    .main-tab{flex:1;border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:1000;display:flex;align-items:center;justify-content:center;gap:10px;transition: all 0.2s ease;}
    .main-tab:hover{border-color:color-mix(in srgb, var(--accent) 50%, var(--border));transform:translateY(-1px);}
    .main-tab.active{border-color:var(--accent);color:var(--accent);background:color-mix(in srgb, var(--accent) 10%, transparent);}
    .main-tab .ico{font-size:16px}
    #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(0,0,0,.75);color:#fff;font-weight:900;font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:999;}
    html[data-theme="light"] #toast{background:rgba(0,0,0,.72)}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
    #modal_backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:998;padding:12px;}
    #modal{width:min(680px, 100%);border-radius:18px;border:1px solid var(--border);background:var(--panel);box-shadow:var(--shadow);padding:12px;animation:modalAppear 0.3s ease;}
    #modal_header{display:flex;justify-content:space-between;align-items:center;gap:10px}
    #modal_header b{font-size:14px}
    #modal_close{border:1px solid var(--border);background:transparent;border-radius:12px;color:var(--muted);padding:6px 10px;cursor:pointer;font-weight:1000;transition: all 0.2s ease;}
    #modal_close:hover{border-color:var(--accent);color:var(--accent);transform:rotate(90deg);}
    #modal_body{margin-top:10px;display:flex;gap:12px;flex-wrap:wrap}
    #modal_canvas_wrap{flex:1;min-width:280px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--result-bg);aspect-ratio:3/2;display:flex;align-items:center;justify-content:center;}
    #card_canvas{display:block;width:100%;height:100%}
    #modal_right{width:240px;min-width:240px;display:flex;flex-direction:column;gap:8px}
    #modal_right .btn{width:100%}
    #modal_help{font-size:12px;color:var(--muted);font-weight:700}
    .vizgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
    @media(max-width:520px){ .vizgrid{grid-template-columns:1fr} }
    .viz{border:1px solid var(--border);border-radius:16px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));transition:border-color 0.3s ease;}
    html[data-theme="light"] .viz{background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0))}
    .viz h5{margin:0 0 8px 0;font-size:12px;color:var(--muted);font-weight:1000;letter-spacing:.3px}
    .viz canvas{width:100%;height:130px;display:block}
    .viz .big{font-size:22px;font-weight:1000}
    .viz .sub{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}
    @media(max-width:420px){.iconbtn .lbl{display:none}.subtabs{gap:6px}.subtab{padding:6px 8px}#modal_right{width:100%;min-width:100%}}
    @keyframes fadeInUp {from {opacity:0;transform:translateY(5px);}to {opacity:1;transform:translateY(0);}}
    @keyframes slideIn {from {opacity:0;transform:translateY(-10px);}to {opacity:1;transform:translateY(0);}}
    @keyframes modalAppear {from {opacity:0;transform:scale(0.95);}to {opacity:1;transform:scale(1);}}
    @keyframes numberChange {0% {opacity:1;transform:translateY(0);}50% {opacity:0;transform:translateY(-10px);}51% {opacity:0;transform:translateY(10px);}100% {opacity:1;transform:translateY(0);}}
    .scenario-controls {display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
    .scenario-item {display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--chip-bg);border:1px solid var(--border);border-radius:10px;font-size:12px;}
    .threshold-control {display:flex;align-items:center;gap:8px;margin-top:8px;}
    .threshold-control input {width:60px;text-align:center;}
    .color-picker {display:flex;gap:8px;margin-top:10px;}
    .color-option {width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid var(--border);transition:transform 0.2s ease;}
    .color-option:hover {transform:scale(1.1);}
    .color-option.active {border-color:var(--text);transform:scale(1.1);}
  </style>
</head>

<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru">RU</button>
        <button id="btn_en">EN</button>
      </div>

      <button class="iconbtn" id="theme_toggle" type="button" aria-label="Theme">
        <span class="ico" id="theme_icon">ğŸŒ™</span>
        <span class="lbl" id="theme_text">Dark</span>
      </button>

      <button class="iconbtn" id="share_btn" type="button" aria-label="Share">
        <span class="ico">ğŸ“‹</span>
        <span class="lbl" data-i18n="share">Share</span>
      </button>

      <button class="iconbtn" id="card_btn" type="button" aria-label="Trade Card PNG">
        <span class="ico">ğŸ–¼ï¸</span>
        <span class="lbl" data-i18n="cardpng">Card PNG</span>
      </button>
    </div>
  </header>

  <main>
    
    <section id="main_calc" class="main-screen active">
      <div class="subtabs" role="tablist" aria-label="Calculator tabs">
        <button class="subtab active" data-tab="dca" data-i18n="tab.dca" type="button">
          ğŸ“ˆ DCA
        </button>
        <button class="subtab" data-tab="rr" data-i18n="tab.rr" type="button">
          âš–ï¸ R/R
        </button>
        <button class="subtab" data-tab="cap" data-i18n="tab.cap" type="button">
          ğŸ’° Capital
        </button>
        <button class="subtab" data-tab="ind" data-i18n="tab.ind" type="button">
          ğŸ“Š Indicators
        </button>
      </div>

      <div class="panels">
        <section id="dca" class="screen active">
          <div class="card">
            <h3 data-i18n="dca.title">DCA Calculator</h3>
            <div class="small" style="margin-bottom:10px" data-i18n="dca.tip">
              Tip: add multiple entries â€” app will calculate avg, total volume and cost.
            </div>

            <div id="dca_rows"></div>

            <div class="controls" style="margin-top:10px">
              <button class="btn accent" id="dca_add" type="button" data-i18n="dca.add">
                â• Add entry
              </button>
              <button class="btn ghost" id="dca_clear" type="button" data-i18n="common.clear">
                ğŸ—‘ï¸ Clear
              </button>
            </div>

            <div class="result" style="margin-top:12px" id="dca_avg_result">
              <div>
                <div class="small" data-i18n="dca.avg">Average price</div>
                <div class="result-value">
                  <span class="v new" id="dca_avg">â€”</span>
                </div>
              </div>
              <button class="btn ghost btn-copy" id="dca_copy" type="button" data-i18n="common.copy">
                <span class="copy-text">ğŸ“‹ Copy</span>
              </button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="result" style="flex:1" id="dca_vol_result">
                <div>
                  <div class="small" data-i18n="dca.vol">Total volume</div>
                  <div class="result-value">
                    <span class="v new" id="dca_total_vol">â€”</span>
                  </div>
                </div>
              </div>
              <div class="result" style="flex:1" id="dca_cost_result">
                <div>
                  <div class="small" data-i18n="dca.cost">Total cost</div>
                  <div class="result-value">
                    <span class="v new" id="dca_total_cost">â€”</span>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px">
                <b style="color:var(--accent);font-weight:1000" data-i18n="dca.goalHeader">ğŸ¯ DCA Goal</b>
                <span class="small" data-i18n="dca.goalOptional">optional</span>
              </div>

              <div class="small" style="margin-bottom:8px" data-i18n="dca.goalTitle">Target average (optional)</div>

              <div class="row">
                <div class="field" style="margin:0">
                  <label data-i18n="dca.goalPrice">ğŸ¯ Target avg price</label>
                  <input id="dca_goal" type="number" step="any" inputmode="decimal" />
                </div>
                <div class="field" style="margin:0">
                  <label data-i18n="dca.nextPrice">â¡ï¸ Next buy price</label>
                  <input id="dca_next_price" type="number" step="any" inputmode="decimal" />
                </div>
              </div>

              <div class="result" id="dca_need_result">
                <div>
                  <div class="small" data-i18n="dca.need">Needed volume at next price</div>
                  <div class="result-value">
                    <span class="v new" id="dca_need_vol">â€”</span>
                  </div>
                </div>
                <button class="btn ghost btn-copy" id="dca_need_copy" type="button" data-i18n="common.copy">
                  <span class="copy-text">ğŸ“‹ Copy</span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <section id="rr" class="screen">
          <div class="card">
            <h3 data-i18n="rr.title">Risk/Reward Calculator</h3>
            <div class="row">
              <div class="field" style="flex:1">
                <label data-i18n="rr.entry">ğŸ“¥ Entry</label>
                <input id="rr_entry" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field" style="flex:1">
                <label data-i18n="rr.sl">ğŸ›‘ Stop Loss</label>
                <input id="rr_sl" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field" style="flex:1">
                <label data-i18n="rr.tp">ğŸ¯ Take Profit</label>
                <input id="rr_tp" type="number" step="any" inputmode="decimal" />
              </div>
            </div>

            <div class="row">
              <div class="field" style="flex:1">
                <label data-i18n="rr.fee">ğŸ’° Fee % (entry+exit)</label>
                <input id="rr_fee" type="number" step="any" inputmode="decimal" value="0.2" />
                <div class="small" data-i18n="rr.feeNote" style="margin-top:4px">
                  Shows net R/R: approximates entry+exit fees.
                </div>
              </div>
            </div>

            <div class="result" id="rr_gross_result">
              <div>
                <div class="small" data-i18n="rr.gross">Gross R/R</div>
                <div class="result-value">
                  <span class="v new" id="rr_gross">â€”</span>
                </div>
              </div>
              <button class="btn ghost btn-copy" id="rr_copy_gross" type="button" data-i18n="common.copy">
                <span class="copy-text">ğŸ“‹ Copy</span>
              </button>
            </div>

            <div class="result" id="rr_net_result">
              <div>
                <div class="small" data-i18n="rr.net">Net R/R (fees)</div>
                <div class="result-value">
                  <span class="v new" id="rr_net">â€”</span>
                </div>
              </div>
              <button class="btn ghost btn-copy" id="rr_copy_net" type="button" data-i18n="common.copy">
                <span class="copy-text">ğŸ“‹ Copy</span>
              </button>
            </div>
            <div id="rr_hint"></div>
          </div>
        </section>

        <section id="cap" class="screen">
          <div class="card">
            <h3 data-i18n="cap.title">Capital Management</h3>
            <div class="row">
              <div class="field">
                <label data-i18n="cap.dep">ğŸ’° Deposit</label>
                <input id="cap_dep" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field">
                <label data-i18n="cap.risk">âš ï¸ Risk %</label>
                <input id="cap_risk" type="number" step="any" inputmode="decimal" value="1" />
              </div>
              <div class="field">
                <label data-i18n="cap.lev">âš¡ Leverage</label>
                <input id="cap_lev" type="number" step="any" inputmode="decimal" value="1" />
              </div>
            </div>

            <div class="chips" aria-label="Risk presets">
              <div class="small" style="width:100%" data-i18n="cap.presets">Quick risks</div>
              <button class="chip" data-risk="0.5" type="button">0.5%</button>
              <button class="chip active" data-risk="1" type="button">1%</button>
              <button class="chip" data-risk="2" type="button">2%</button>
              <button class="chip" data-risk="3" type="button">3%</button>
            </div>

            <div class="scenario-controls">
              <button class="btn ghost" id="cap_save_scenario" type="button" style="font-size:12px">
                ğŸ’¾ Save preset
              </button>
              <select id="cap_load_scenario" style="flex:1; max-width:200px; font-size:12px; padding:6px 10px;">
                <option value="">Load preset...</option>
              </select>
              <button class="btn ghost danger" id="cap_delete_scenario" type="button" style="font-size:12px" disabled>
                ğŸ—‘ï¸ Delete
              </button>
            </div>

            <div class="row" style="margin-top:8px">
              <div class="field">
                <label data-i18n="cap.entry">ğŸ“¥ Entry</label>
                <input id="cap_entry" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field">
                <label data-i18n="cap.sl">ğŸ›‘ Stop Loss</label>
                <input id="cap_sl" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field">
                <label data-i18n="cap.fee">ğŸ’° Fee % (entry+exit)</label>
                <input id="cap_fee" type="number" step="any" inputmode="decimal" value="0.2" />
              </div>
            </div>

            <div class="row">
              <div class="result" style="flex:1" id="cap_pos_result">
                <div>
                  <div class="small" data-i18n="cap.pos">ğŸ“Š Position size</div>
                  <div class="result-value">
                    <span class="v new" id="cap_pos">â€”</span>
                  </div>
                </div>
                <button class="btn ghost btn-copy" id="cap_copy_pos" type="button" data-i18n="common.copy">
                  <span class="copy-text">ğŸ“‹ Copy</span>
                </button>
              </div>
            </div>

            <div class="row">
              <div class="result" style="flex:1" id="cap_risk_result">
                <div>
                  <div class="small" data-i18n="cap.riskUsd">âš ï¸ Risk $</div>
                  <div class="result-value">
                    <span class="v new" id="cap_risk_usd">â€”</span>
                  </div>
                </div>
              </div>
              <div class="result" style="flex:1" id="cap_margin_result">
                <div>
                  <div class="small" data-i18n="cap.margin">ğŸ¦ Margin (lev)</div>
                  <div class="result-value">
                    <span class="v new" id="cap_margin">â€”</span>
                  </div>
                </div>
              </div>
            </div>
            <div id="cap_hint"></div>
          </div>
        </section>

        <section id="ind" class="screen">
          <div class="card">
            <h3 data-i18n="ind.title">ğŸ“Š Market Indicators</h3>

            <div class="row">
              <div class="field" style="flex:1">
                <label data-i18n="ind.fg.label">ğŸ˜¨ğŸ˜Š Fear & Greed</label>
                <div id="fg_value" class="result">
                  <div>
                    <div class="small" data-i18n="ind.fg.valueLabel">Value</div>
                    <div class="result-value">
                      <span class="v new" id="fg_text">â€”</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="field" style="flex:1">
                <label data-i18n="ind.mood.label">ğŸŒ¡ï¸ Market Mood</label>
                <div class="result">
                  <div>
                    <div class="small" data-i18n="ind.mood.hint">Derived from F&G + Alt dom</div>
                    <div class="result-value">
                      <span class="v new" id="mood">â€”</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px; border-top:1px dashed var(--border); padding-top:12px;">
              <div class="small" style="margin-bottom:8px;">âš™ï¸ Fear & Greed Thresholds</div>
              <div class="threshold-control">
                <label style="font-size:11px;">Fear (<)</label>
                <input type="number" id="fg_fear_threshold" min="0" max="100" value="30" style="width:50px;"/>
                <label style="font-size:11px;">Neutral</label>
                <input type="number" id="fg_neutral_threshold" min="0" max="100" value="70" style="width:50px;" disabled/>
                <label style="font-size:11px;">Greed (>)</label>
              </div>
            </div>

            <div class="row">
              <div class="field" style="flex:1">
                <label data-i18n="ind.tcap.label">ğŸŒ Total Market Cap (USD)</label>
                <div id="tcap" class="result">
                  <div class="result-value">
                    <span class="v new" id="tcap_text">â€”</span>
                  </div>
                </div>
              </div>
              <div class="field" style="flex:1">
                <label data-i18n="ind.alt.label">ğŸ”„ Alt dominance (proxy Altseason)</label>
                <div id="alt_dom" class="result">
                  <div class="result-value">
                    <span class="v new" id="alt_text">â€”</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="controls">
              <button class="btn accent" id="refresh_ind" type="button" data-i18n="ind.refresh">
                ğŸ”„ Refresh
              </button>
              <span class="small" id="ind_note"></span>
            </div>

            <div class="vizgrid">
              <div class="viz" id="fg_viz">
                <h5 data-i18n="ind.viz.fg">F&G Gauge</h5>
                <canvas id="fg_canvas" width="600" height="260"></canvas>
                <div class="big" id="fg_big">â€”</div>
                <div class="sub" id="fg_sub">â€”</div>
              </div>
              <div class="viz" id="dom_viz">
                <h5 data-i18n="ind.viz.dom">Dominance Split</h5>
                <canvas id="dom_canvas" width="600" height="260"></canvas>
                <div class="big" id="dom_big">â€”</div>
                <div class="sub" id="dom_sub">â€”</div>
              </div>
            </div>
          </div>
        </section>

        <aside class="history" aria-live="polite">
          <h4 data-i18n="hist.title">ğŸ“œ History</h4>
          <div class="history-list" id="history_list"></div>
          <div class="controls" style="margin-top:8px">
            <button class="btn ghost" id="clear_history" type="button" data-i18n="hist.clear">
              ğŸ—‘ï¸ Clear
            </button>
          </div>
          <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
        </aside>
      </div>
    </section>

    
    <section id="main_support" class="main-screen">
      <div class="support-wrap">
        <div class="card" style="width:min(820px,100%)">
          <h3 data-i18n="support.title">ğŸ›Ÿ Support & Settings</h3>

          <div class="small" data-i18n="support.desc" style="margin-bottom:10px">
            Wallet connection & tips are here. You can also contact support below.
          </div>

          <div style="margin-top:16px; border-top:1px dashed var(--border); padding-top:12px;">
            <div class="small" style="margin-bottom:8px;">ğŸ¨ Accent Color Theme</div>
            <div class="color-picker">
              <div class="color-option active" style="background:linear-gradient(135deg, #7CFC00 0%, #00FFAA 100%);" data-color="#7CFC00"></div>
              <div class="color-option" style="background:linear-gradient(135deg, #2d8cff 0%, #00d4ff 100%);" data-color="#2d8cff"></div>
              <div class="color-option" style="background:linear-gradient(135deg, #FF6B8B 0%, #FF8E53 100%);" data-color="#FF6B8B"></div>
              <div class="color-option" style="background:linear-gradient(135deg, #9D50BB 0%, #6E48AA 100%);" data-color="#9D50BB"></div>
            </div>
          </div>

          <div class="controls" style="margin-top:16px">
            <button class="btn" id="wallet_btn" type="button" aria-label="TON Wallet">
              <span data-i18n="wallet">ğŸ‘› Wallet</span>
            </button>

            <button class="btn" id="tip_btn" type="button" aria-label="Tip TON">
              <span data-i18n="tip">ğŸ’ Tip TON</span>
            </button>
          </div>

          <div class="small" style="margin-top:10px" data-i18n="support.docs">
            Docs: Terms & Privacy are available at /terms.html and /privacy.html
          </div>

          <div class="controls" style="margin-top:10px">
            <button class="btn ghost" id="open_terms" type="button">ğŸ“„ Terms</button>
            <button class="btn ghost" id="open_privacy" type="button">ğŸ”’ Privacy</button>
            <button class="btn ghost" id="open_support" type="button">ğŸ’¬ Contact</button>
          </div>
        </div>

        <div style="text-align:center">
          
          <div class="support-tags tagline">AIRDROP â€¢ NEWS â€¢ TRADING</div>
          <div class="support-links">
            <a id="link_telegram" class="rainbow" href="https://t.me/ChalovCrypto" target="_blank" rel="noopener">TELEGRAM</a>
            <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@ChalovCrypto" target="_blank" rel="noopener">YOUTUBE</a>
          </div>
        </div>
      </div>
    </section>
  </main>

  
  <nav class="bottomnav" aria-label="Main tabs">
    <div class="bar">
      <button id="main_tab_calc" class="main-tab active" type="button">
        <span class="ico">ğŸ§®</span>
        <span data-i18n="main.calc">Calculator</span>
      </button>
      <button id="main_tab_support" class="main-tab" type="button">
        <span class="ico">ğŸ›Ÿ</span>
        <span data-i18n="main.support">Support</span>
      </button>
    </div>
  </nav>
</div>

<div id="toast">â€”</div>

<div id="modal_backdrop" role="dialog" aria-modal="true">
  <div id="modal">
    <div id="modal_header">
      <b data-i18n="card.title">ğŸ–¼ï¸ Trade Card</b>
      <button id="modal_close" type="button">âœ•</button>
    </div>
    <div id="modal_body">
      <div id="modal_canvas_wrap">
        <canvas id="card_canvas" width="900" height="600"></canvas>
      </div>
      <div id="modal_right">
        <button class="btn accent" id="card_download" type="button" data-i18n="card.download">ğŸ“¥ Download PNG</button>
        <button class="btn ghost" id="card_copy" type="button" data-i18n="card.copy">ğŸ“‹ Copy</button>
        <div id="modal_help" data-i18n="card.help">If copy doesn't work on your device, use Download PNG.</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const tg = window.Telegram?.WebApp || null;
  try{ tg?.expand?.(); }catch(e){}
  try{ tg?.disableVerticalSwipes?.(); }catch(e){}
  try{ tg?.ready?.(); }catch(e){}

  const mainCalc = document.getElementById('main_calc');
  const mainSupport = document.getElementById('main_support');
  const mainBtnCalc = document.getElementById('main_tab_calc');
  const mainBtnSupport = document.getElementById('main_tab_support');

  function setMainTab(which){
    const isCalc = which === 'calc';
    mainCalc.classList.toggle('active', isCalc);
    mainSupport.classList.toggle('active', !isCalc);
    mainBtnCalc.classList.toggle('active', isCalc);
    mainBtnSupport.classList.toggle('active', !isCalc);
    setTimeout(()=>{ try{ drawAllIndicatorVisuals(lastIndicators); }catch(e){} }, 60);
  }
  mainBtnCalc?.addEventListener('click', ()=>setMainTab('calc'));
  mainBtnSupport?.addEventListener('click', ()=>setMainTab('support'));

  let lastIndicators = null;

  const locales = {
    ru:{ "main.calc":"ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€","main.support":"ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°","support.title":"ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° / ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸","support.desc":"Ğ—Ğ´ĞµÑÑŒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ğ¸ Ğ´Ğ¾Ğ½Ğ°Ñ‚. ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ ÑÑÑ‹Ğ»ĞºĞ¸ â€” Ğ½Ğ¸Ğ¶Ğµ.","support.docs":"Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹: Terms Ğ¸ Privacy Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ¿Ğ¾ /terms.html Ğ¸ /privacy.html","tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators","share":"ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ","cardpng":"ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° PNG","wallet":"ĞšĞ¾ÑˆĞµĞ»Ñ‘Ğº","tip":"Ğ”Ğ¾Ğ½Ğ°Ñ‚ TON","wallet.disconnectQ":"ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº?","toast.walletNeed":"Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸ ĞºĞ¾ÑˆĞµĞ»Ñ‘Ğº","toast.sent":"Ğ¢Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°","toast.fail":"ĞÑˆĞ¸Ğ±ĞºĞ°","toast.tonManifest":"Ğ£ĞºĞ°Ğ¶Ğ¸ manifest URL","common.clear":"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ","common.copy":"ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ","toast.copied":"Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!","toast.saved":"Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾","theme.dark":"Ğ¢Ñ‘Ğ¼Ğ½Ğ°Ñ","theme.light":"Ğ¡Ğ²ĞµÑ‚Ğ»Ğ°Ñ","dca.title":"ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ DCA","dca.tip":"Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞ¹ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ² â€” ĞºĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ¿Ğ¾ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ ÑÑ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ñƒ, Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±ÑŠÑ‘Ğ¼ Ğ¸ ÑÑƒĞ¼Ğ¼Ñƒ.","dca.add":"+ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ…Ğ¾Ğ´","dca.avg":"Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ğ°","dca.vol":"ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¾Ğ±ÑŠÑ‘Ğ¼","dca.cost":"Ğ¡ÑƒĞ¼Ğ¼Ğ°","dca.goalHeader":"Ğ¦ĞµĞ»ÑŒ DCA","dca.goalOptional":"Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾","dca.goalTitle":"Ğ¦ĞµĞ»ÑŒ Ğ¿Ğ¾ ÑÑ€ĞµĞ´Ğ½ĞµĞ¹ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)","dca.goalPrice":"Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ÑÑ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ğ°","dca.nextPrice":"Ğ¦ĞµĞ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸","dca.need":"ĞÑƒĞ¶Ğ½Ñ‹Ğ¹ Ğ¾Ğ±ÑŠÑ‘Ğ¼ Ğ¿Ğ¾ next-price","rr.title":"ĞšĞ°Ğ»ÑŒĞºÑƒĞ»ÑÑ‚Ğ¾Ñ€ Ğ Ğ¸ÑĞºĞ°/ĞŸÑ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸","rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.fee":"ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ % (Ğ²Ñ…Ğ¾Ğ´+Ğ²Ñ‹Ñ…Ğ¾Ğ´)","rr.feeNote":"ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ net R/R Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸.","rr.gross":"Gross R/R","rr.net":"Net R/R (fees)","cap.title":"Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞšĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ¾Ğ¼","cap.dep":"Ğ”ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚","cap.risk":"Ğ Ğ¸ÑĞº %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.fee":"ĞšĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ % (Ğ²Ñ…Ğ¾Ğ´+Ğ²Ñ‹Ñ…Ğ¾Ğ´)","cap.lev":"ĞŸĞ»ĞµÑ‡Ğ¾","cap.presets":"Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ñ€Ğ¸ÑĞºĞ¸","cap.pos":"ĞĞ±ÑŠÑ‘Ğ¼ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸","cap.riskUsd":"Ğ Ğ¸ÑĞº $","cap.margin":"ĞœĞ°Ñ€Ğ¶Ğ° (Ğ¿Ğ»ĞµÑ‡Ğ¾)","ind.title":"Ğ˜Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹","ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ","ind.tcap.label":"ĞĞ±Ñ‰Ğ°Ñ ĞºĞ°Ğ¿Ğ¸Ñ‚Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (USD)","ind.alt.label":"Ğ”Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ°Ğ»ÑŒÑ‚Ğ¾Ğ² (proxy Altseason)","ind.mood.label":"Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€Ñ‹Ğ½ĞºĞ°","ind.mood.hint":"Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· F&G + Ğ´Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸","ind.refresh":"ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ","ind.loading":"ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑÑâ€¦","ind.cached":"ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ‹ ĞºÑÑˆ-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ","ind.rate":"Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ API/Ğ¾ÑˆĞ¸Ğ±ĞºĞ° â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ¿Ğ¾Ğ·Ğ¶Ğµ","ind.viz.fg":"F&G Gauge","ind.viz.dom":"Split Ğ´Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸","hist.title":"Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ","hist.clear":"ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ","hist.note":"Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ","card.title":"Trade Card","card.download":"Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ PNG","card.copy":"ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ","card.help":"Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ½Ğ° ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ PNG.","consent.title":"ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°","consent.accept":"Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ","consent.decline":"ĞÑ‚ĞºĞ°Ğ·Ğ°Ñ‚ÑŒÑÑ" },
    en:{ "main.calc":"Calculator","main.support":"Support","support.title":"Support & Settings","support.desc":"Wallet connection & tips are here. Contacts and links are below.","support.docs":"Docs: Terms & Privacy are available at /terms.html and /privacy.html","tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators","share":"Share","cardpng":"Card PNG","wallet":"Wallet","tip":"Tip TON","wallet.disconnectQ":"Disconnect wallet?","toast.walletNeed":"Connect wallet first","toast.sent":"Transaction sent","toast.fail":"Error","toast.tonManifest":"Set manifest URL","common.clear":"Clear","common.copy":"Copy","toast.copied":"Copied!","toast.saved":"Done","theme.dark":"Dark","theme.light":"Light","dca.title":"DCA Calculator","dca.tip":"Tip: add multiple entries â€” app will calculate avg, total volume and cost.","dca.add":"+ Add entry","dca.avg":"Average price","dca.vol":"Total volume","dca.cost":"Total cost","dca.goalHeader":"DCA Goal","dca.goalOptional":"optional","dca.goalTitle":"Target average (optional)","dca.goalPrice":"Target avg price","dca.nextPrice":"Next buy price","dca.need":"Needed volume at next price","rr.title":"Risk/Reward Calculator","rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.fee":"Fee % (entry+exit)","rr.feeNote":"Shows net R/R: approximates entry+exit fees.","rr.gross":"Gross R/R","rr.net":"Net R/R (fees)","cap.title":"Capital Management","cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.fee":"Fee % (entry+exit)","cap.lev":"Leverage","cap.presets":"Quick risks","cap.pos":"Position size","cap.riskUsd":"Risk $","cap.margin":"Margin (lev)","ind.title":"Market Indicators","ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value","ind.tcap.label":"Total Market Cap (USD)","ind.alt.label":"Alt dominance (proxy Altseason)","ind.mood.label":"Market Mood","ind.mood.hint":"Derived from F&G + Alt dom","ind.refresh":"Refresh","ind.loading":"Refreshingâ€¦","ind.cached":"Showing cached data","ind.rate":"API limit/error â€” try later","ind.viz.fg":"F&G Gauge","ind.viz.dom":"Dominance Split","hist.title":"History","hist.clear":"Clear","hist.note":"Saved locally in your browser","card.title":"Trade Card","card.download":"Download PNG","card.copy":"Copy","card.help":"If copy doesn't work on your device, use Download PNG.","consent.title":"Analytics","consent.accept":"Accept","consent.decline":"Decline" }
  };

  let lang = 'en';
  try{ const tgl = tg?.initDataUnsafe?.user?.language_code; if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en'; }catch(e){ lang='en'; }
  function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }

  function translateAll(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n');
      if(locales[lang] && locales[lang][k] !== undefined){
        el.textContent = locales[lang][k];
      }
    });
    updateThemeUI();
  }

  let toastTimer=null;
  function showToast(msg){
    const el=document.getElementById('toast');
    if(!el) return;
    el.textContent=msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>el.classList.remove('show'), 1200);
  }

  const THEME_KEY='tc_theme_v10';
  const ACCENT_COLOR_KEY='tc_accent_color_v1';
  const SCENARIOS_KEY='tc_scenarios_v1';
  const FGSETTINGS_KEY='tc_fg_settings_v1';
  const DCA_STATE_KEY='tc_dca_state_v2';
  const RR_STATE_KEY='tc_rr_state_v2';
  const CAP_STATE_KEY='tc_cap_state_v2';

  function getInitialTheme(){
    const saved=localStorage.getItem(THEME_KEY);
    if(saved==='dark'||saved==='light') return saved;
    const tgScheme=(tg?.colorScheme||'').toLowerCase();
    if(tgScheme==='light') return 'light';
    return 'dark';
  }

  function getAccentColor(){ return localStorage.getItem(ACCENT_COLOR_KEY) || '#7CFC00'; }

  function setTheme(theme){
    if(theme!=='dark' && theme!=='light') theme='dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    updateThemeUI();
    drawAllIndicatorVisuals(lastIndicators);
  }

  function setAccentColor(color){
    document.documentElement.style.setProperty('--accent', color);
    const gradient = getGradientFromColor(color);
    document.documentElement.style.setProperty('--accent-gradient', gradient);
    localStorage.setItem(ACCENT_COLOR_KEY, color);
    updateThemeUI();
  }

  function getGradientFromColor(color){
    const gradients = {
      '#7CFC00': 'linear-gradient(135deg, #7CFC00 0%, #00FFAA 100%)',
      '#2d8cff': 'linear-gradient(135deg, #2d8cff 0%, #00d4ff 100%)',
      '#FF6B8B': 'linear-gradient(135deg, #FF6B8B 0%, #FF8E53 100%)',
      '#9D50BB': 'linear-gradient(135deg, #9D50BB 0%, #6E48AA 100%)'
    };
    return gradients[color] || gradients['#7CFC00'];
  }

  function updateThemeUI(){
    const theme=document.documentElement.getAttribute('data-theme')||'dark';
    const icon=document.getElementById('theme_icon');
    const text=document.getElementById('theme_text');
    const btn=document.getElementById('theme_toggle');
    if(!icon || !text || !btn) return;
    if(theme==='light'){ icon.textContent='â˜€ï¸'; text.textContent=t('theme.light'); btn.classList.add('active'); }
    else{ icon.textContent='ğŸŒ™'; text.textContent=t('theme.dark'); btn.classList.remove('active'); }
    const currentColor = getAccentColor();
    document.querySelectorAll('.color-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.color === currentColor);
    });
  }

  setTheme(getInitialTheme());
  setAccentColor(getAccentColor());
  
  document.getElementById('theme_toggle')?.addEventListener('click', ()=>{
    const current=document.documentElement.getAttribute('data-theme')||'dark';
    setTheme(current==='dark'?'light':'dark');
  });

  document.querySelectorAll('.color-option').forEach(opt => {
    opt.addEventListener('click', () => {
      setAccentColor(opt.dataset.color);
    });
  });

  function safeNum(v){ const x=parseFloat(v); return isFinite(x)?x:0; }
  function fmt(v, digits=8){
    if(v===null || v===undefined || !isFinite(v)) return 'â€”';
    const n=Number(v);
    const abs=Math.abs(n);
    const d = abs>=1000 ? 2 : (abs>=1 ? 6 : digits);
    return n.toLocaleString(undefined,{maximumFractionDigits:d});
  }

  function animateValueChange(element, newValue){
    if(!element || element.textContent === newValue) return;
    const oldValue = element.textContent;
    const container = element.parentElement;
    const oldSpan = document.createElement('span');
    oldSpan.className = 'old';
    oldSpan.textContent = oldValue;
    oldSpan.style.color = element.style.color || getComputedStyle(element).color;
    const newSpan = document.createElement('span');
    newSpan.className = 'new';
    newSpan.textContent = newValue;
    newSpan.style.animation = 'numberChange 0.4s ease';
    container.innerHTML = '';
    container.appendChild(oldSpan);
    container.appendChild(newSpan);
    element.textContent = newValue;
    setTimeout(() => {
      container.innerHTML = '';
      container.appendChild(newSpan);
    }, 400);
  }

  function animateCopyButton(button){
    if(!button) return;
    button.classList.add('copied');
    setTimeout(() => {
      button.classList.remove('copied');
    }, 1500);
  }

  function showHint(elementId, text, isWarning=false){
    const element = document.getElementById(elementId);
    if(!element) return;
    const oldHint = element.querySelector('.small.hint');
    if(oldHint) oldHint.remove();
    if(!text) return;
    const hint = document.createElement('div');
    hint.className = `small hint ${isWarning ? 'warning' : ''}`;
    hint.textContent = text;
    element.appendChild(hint);
    setTimeout(() => {
      if(hint.parentElement === element){
        hint.style.opacity = '0';
        hint.style.transition = 'opacity 0.3s ease';
        setTimeout(() => hint.remove(), 300);
      }
    }, 5000);
  }

  function haptic(type='impact', style='light'){
    try{
      if(!tg?.HapticFeedback) return;
      if(type==='impact') tg.HapticFeedback.impactOccurred(style);
      if(type==='notify') tg.HapticFeedback.notificationOccurred(style);
    }catch(e){}
  }

  const btnRu=document.getElementById('btn_ru');
  const btnEn=document.getElementById('btn_en');
  function syncLangButtons(){
    if(!btnRu || !btnEn) return;
    if(lang==='ru'){ btnRu.classList.add('active'); btnEn.classList.remove('active'); }
    else { btnEn.classList.add('active'); btnRu.classList.remove('active'); }
  }
  syncLangButtons();
  btnRu?.addEventListener('click', ()=>{ lang='ru'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); updateWalletUI(); loadScenarios(); loadDcaState(); loadRRState(); loadCapState(); });
  btnEn?.addEventListener('click', ()=>{ lang='en'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); updateWalletUI(); loadScenarios(); loadDcaState(); loadRRState(); loadCapState(); });

  document.querySelectorAll('.subtab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.subtab').forEach(tn=>tn.classList.remove('active'));
      btn.classList.add('active');
      const target=btn.dataset.tab;
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(target)?.classList.add('active');
      if(target==='ind' && document.getElementById('tcap')?.textContent?.trim()==='â€”') fetchIndicators();
    });
  });
  function activeTab(){ const act=document.querySelector('.subtab.active'); return act?.dataset?.tab || 'dca'; }

  const dcaRowsEl=document.getElementById('dca_rows');
  const dcaAvgEl=document.getElementById('dca_avg');
  const dcaTotalVolEl=document.getElementById('dca_total_vol');
  const dcaTotalCostEl=document.getElementById('dca_total_cost');
  const dcaGoal=document.getElementById('dca_goal');
  const dcaNext=document.getElementById('dca_next_price');
  const dcaNeedVol=document.getElementById('dca_need_vol');

  let dcaRows=[];
  function addDcaRow(p=0,v=0){
    const rowId=String(Math.random()).slice(2);
    const wrap=document.createElement('div');
    wrap.className='row dca-mobile-stack';
    wrap.style.marginBottom='8px';
    wrap.innerHTML=`
      <div class="field" style="flex:1;margin:0">
        <label>ğŸ’° ${lang==='ru'?'Ğ¦ĞµĞ½Ğ°':'Price'}</label>
        <input type="number" step="any" inputmode="decimal" value="${p||''}">
      </div>
      <div class="field" style="flex:1;margin:0">
        <label>ğŸ“Š ${lang==='ru'?'ĞĞ±ÑŠÑ‘Ğ¼':'Volume'}</label>
        <input type="number" step="any" inputmode="decimal" value="${v||''}">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn ghost" type="button" aria-label="remove" style="padding:9px 12px">ğŸ—‘ï¸</button>
      </div>
    `;
    const inputs=wrap.querySelectorAll('input');
    const btnRemove=wrap.querySelector('button');
    const item={id:rowId, el:wrap, pEl:inputs[0], vEl:inputs[1]};
    inputs.forEach(inp=>{
      inp.addEventListener('input', ()=>{
        calcDCA();
        saveDcaState();
        pushHistoryIfReady();
        if(parseFloat(inp.value) < 0){
          inp.classList.add('error');
          showHint('dca', lang==='ru' ? 'Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼' : 'Value cannot be negative', true);
        } else {
          inp.classList.remove('error');
        }
      });
      inp.addEventListener('focus', ()=>inp.parentElement.style.transform='translateY(-1px)');
      inp.addEventListener('blur', ()=>inp.parentElement.style.transform='');
    });
    btnRemove.addEventListener('click', ()=>{
      dcaRows = dcaRows.filter(r=>r.id!==rowId);
      wrap.style.opacity='0';
      wrap.style.transform='translateX(-10px)';
      wrap.style.transition='all 0.3s ease';
      setTimeout(()=>{
        wrap.remove();
        calcDCA();
        saveDcaState();
        pushHistoryIfReady();
      }, 300);
    });
    dcaRows.push(item);
    dcaRowsEl.appendChild(wrap);
    wrap.style.opacity='0';
    wrap.style.transform='translateY(10px)';
    setTimeout(()=>{
      wrap.style.opacity='1';
      wrap.style.transform='translateY(0)';
      wrap.style.transition='all 0.3s ease';
    }, 10);
    calcDCA();
  }

  function saveDcaState(){
    try {
      const state = dcaRows.map(r => ({ p: r.pEl.value, v: r.vEl.value }));
      localStorage.setItem(DCA_STATE_KEY, JSON.stringify(state));
    } catch(e) {}
  }

  function loadDcaState(){
    try {
      const saved = localStorage.getItem(DCA_STATE_KEY);
      dcaRows = [];
      dcaRowsEl.innerHTML = '';
      if (saved) {
        const state = JSON.parse(saved);
        state.forEach(row => { addDcaRow(parseFloat(row.p) || 0, parseFloat(row.v) || 0); });
      }
      if (dcaRows.length === 0) { addDcaRow(); addDcaRow(); }
      calcDCA();
    } catch(e) {}
  }

  function clearDCA(){
    dcaRows.forEach(r=>{ r.el.style.opacity='0'; r.el.style.transform='translateX(-10px)'; r.el.style.transition='all 0.3s ease'; });
    setTimeout(()=>{
      dcaRows=[];
      dcaRowsEl.innerHTML='';
      addDcaRow();
      addDcaRow();
      dcaGoal.value='';
      dcaNext.value='';
      calcDCA();
      saveDcaState();
      showHint('dca', lang==='ru' ? 'Ğ’ÑĞµ Ğ¿Ğ¾Ğ»Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ñ‹' : 'All fields cleared');
    }, 300);
  }

  function calcDCA(){
    let totalVol=0;
    let totalCost=0;
    let hasError = false;
    
    dcaRows.forEach(r=>{
      const p=safeNum(r.pEl.value);
      const v=safeNum(r.vEl.value);
      if(p>0 && v>0){
        totalVol += v;
        totalCost += p*v;
      }
      if(p < 0 || v < 0) hasError = true;
    });

    const dcaAvgResult = document.getElementById('dca_avg_result');
    const dcaVolResult = document.getElementById('dca_vol_result');
    const dcaCostResult = document.getElementById('dca_cost_result');
    const dcaNeedResult = document.getElementById('dca_need_result');

    if(hasError){
      [dcaAvgResult, dcaVolResult, dcaCostResult, dcaNeedResult].forEach(el=>{ if(el) el.classList.add('error'); el?.classList.remove('success'); });
    } else if(totalVol<=0){
      animateValueChange(dcaAvgEl, 'â€”');
      animateValueChange(dcaTotalVolEl, 'â€”');
      animateValueChange(dcaTotalCostEl, 'â€”');
      animateValueChange(dcaNeedVol, 'â€”');
      [dcaAvgResult, dcaVolResult, dcaCostResult, dcaNeedResult].forEach(el=>{ el?.classList.remove('success', 'error'); });
      return {avg:null, totalVol:0, totalCost:0};
    } else {
      const avg=totalCost/totalVol;
      animateValueChange(dcaAvgEl, fmt(avg, 10));
      animateValueChange(dcaTotalVolEl, fmt(totalVol, 8));
      animateValueChange(dcaTotalCostEl, fmt(totalCost, 2));

      const target=safeNum(dcaGoal.value);
      const nextP=safeNum(dcaNext.value);
      if(target>0 && nextP>0 && nextP!==target){
        const x=(target*totalVol - totalCost) / (nextP - target);
        animateValueChange(dcaNeedVol, (isFinite(x) && x>0) ? fmt(x, 8) : 'â€”');
        dcaNeedResult?.classList.add('success');
      }else{
        animateValueChange(dcaNeedVol, 'â€”');
        dcaNeedResult?.classList.remove('success');
      }

      [dcaAvgResult, dcaVolResult, dcaCostResult].forEach(el=>{ el?.classList.add('success'); el?.classList.remove('error'); });

      if(target > 0 && nextP > 0 && nextP === target){
        showHint('dca', lang==='ru' ? 'Ğ¦ĞµĞ»ÑŒ Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ Ñ†ĞµĞ½Ğ° Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ' : 'Target and next price should not be equal', true);
      }

      return {avg, totalVol, totalCost};
    }
  }

  document.getElementById('dca_add')?.addEventListener('click', ()=>{ addDcaRow(); haptic('impact', 'light'); saveDcaState(); });
  document.getElementById('dca_clear')?.addEventListener('click', ()=>{ clearDCA(); haptic('impact', 'medium'); });
  dcaGoal?.addEventListener('input', ()=>{ calcDCA(); saveDcaState(); pushHistoryIfReady(); });
  dcaNext?.addEventListener('input', ()=>{ calcDCA(); saveDcaState(); pushHistoryIfReady(); });

  async function copyText(text, button){
    if(!text || text==='â€”') return false;
    try{
      await navigator.clipboard.writeText(String(text).replace(/[^0-9.-]/g, ''));
      showToast(t('toast.copied'));
      haptic('notify','success');
      if(button) animateCopyButton(button);
      return true;
    }catch(e){
      try{
        const ta=document.createElement('textarea');
        ta.value=String(text).replace(/[^0-9.-]/g, '');
        ta.style.position='fixed';
        ta.style.top='-1000px';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok=document.execCommand('copy');
        ta.remove();
        if(ok){ showToast(t('toast.copied')); haptic('notify','success'); if(button) animateCopyButton(button); }
        return !!ok;
      }catch(e2){ return false; }
    }
  }

  function bindCopy(btn, getVal){
    if(!btn) return;
    btn.addEventListener('click', async ()=>{ const val=getVal(); await copyText(val, btn); });
  }

  bindCopy(document.getElementById('dca_copy'), ()=>dcaAvgEl.textContent);
  bindCopy(document.getElementById('dca_need_copy'), ()=>dcaNeedVol.textContent);

  const rrEntry=document.getElementById('rr_entry');
  const rrSl=document.getElementById('rr_sl');
  const rrTp=document.getElementById('rr_tp');
  const rrFee=document.getElementById('rr_fee');
  const rrGross=document.getElementById('rr_gross');
  const rrNet=document.getElementById('rr_net');
  const rrHint=document.getElementById('rr_hint');

  function saveRRState(){ try { const state = { entry: rrEntry.value, sl: rrSl.value, tp: rrTp.value, fee: rrFee.value }; localStorage.setItem(RR_STATE_KEY, JSON.stringify(state)); } catch(e) {} }

  function loadRRState(){ try { const saved = localStorage.getItem(RR_STATE_KEY); if (saved) { const state = JSON.parse(saved); rrEntry.value = state.entry || ''; rrSl.value = state.sl || ''; rrTp.value = state.tp || ''; rrFee.value = state.fee || '0.2'; calcRR(); } } catch(e) {} }

  function calcRR(){
    const e=safeNum(rrEntry.value), sl=safeNum(rrSl.value), tp=safeNum(rrTp.value);
    const fee=safeNum(rrFee.value)/100;
    const grossResult = document.getElementById('rr_gross_result');
    const netResult = document.getElementById('rr_net_result');
    if(e !== 0 && sl !== 0 && e === sl){
      showHint('rr_hint', lang==='ru' ? 'Entry Ğ¸ Stop Loss Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ' : 'Entry and Stop Loss should not be equal', true);
      rrEntry.classList.add('error'); rrSl.classList.add('error');
      grossResult?.classList.remove('success'); netResult?.classList.remove('success');
      return {gross:null, net:null};
    } else { rrEntry.classList.remove('error'); rrSl.classList.remove('error'); }
    if(!e || !sl || !tp || e===sl){
      animateValueChange(rrGross, 'â€”'); animateValueChange(rrNet, 'â€”');
      grossResult?.classList.remove('success'); netResult?.classList.remove('success');
      return {gross:null, net:null};
    }
    const risk=Math.abs(e-sl);
    const reward=Math.abs(tp-e);
    if(!risk || !reward){ animateValueChange(rrGross, 'â€”'); animateValueChange(rrNet, 'â€”'); return {gross:null, net:null}; }
    const gross=(reward/risk);
    animateValueChange(rrGross, '1:' + gross.toFixed(2));
    const feeEntry = e*fee;
    const feeExit  = tp*fee;
    const netReward = Math.max(0, reward - (feeEntry+feeExit));
    const net=(netReward / (risk + feeEntry));
    animateValueChange(rrNet, '1:' + net.toFixed(2));
    grossResult?.classList.add('success'); netResult?.classList.add('success');
    if(gross > 3){ showHint('rr_hint', lang==='ru' ? 'ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ñ€Ğ¸ÑĞºĞ°!' : 'Great risk ratio!'); }
    else if(gross < 1){ showHint('rr_hint', lang==='ru' ? 'Ğ Ğ¸ÑĞº Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»ÑŒ' : 'Risk exceeds potential profit', true); }
    return {gross, net};
  }

  [rrEntry,rrSl,rrTp,rrFee].forEach(x=>{
    x?.addEventListener('input', ()=>{ calcRR(); saveRRState(); pushHistoryIfReady(); if(x === rrFee && parseFloat(x.value) > 5){ showHint('rr_hint', lang==='ru' ? 'Ğ’Ñ‹ÑĞ¾ĞºĞ°Ñ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ñ' : 'High fee percentage', true); } });
  });

  bindCopy(document.getElementById('rr_copy_gross'), ()=>rrGross.textContent);
  bindCopy(document.getElementById('rr_copy_net'), ()=>rrNet.textContent);

  const capDep=document.getElementById('cap_dep');
  const capRisk=document.getElementById('cap_risk');
  const capLev=document.getElementById('cap_lev');
  const capEntry=document.getElementById('cap_entry');
  const capSl=document.getElementById('cap_sl');
  const capFee=document.getElementById('cap_fee');
  const capPos=document.getElementById('cap_pos');
  const capRiskUsd=document.getElementById('cap_risk_usd');
  const capMargin=document.getElementById('cap_margin');
  const capHint=document.getElementById('cap_hint');

  function saveCapState(){ try { const state = { dep: capDep.value, risk: capRisk.value, lev: capLev.value, entry: capEntry.value, sl: capSl.value, fee: capFee.value }; localStorage.setItem(CAP_STATE_KEY, JSON.stringify(state)); } catch(e) {} }

  function loadCapState(){ try { const saved = localStorage.getItem(CAP_STATE_KEY); if (saved) { const state = JSON.parse(saved); capDep.value = state.dep || ''; capRisk.value = state.risk || '1'; capLev.value = state.lev || '1'; capEntry.value = state.entry || ''; capSl.value = state.sl || ''; capFee.value = state.fee || '0.2'; document.querySelectorAll('.chip[data-risk]').forEach(ch => { ch.classList.toggle('active', ch.dataset.risk === capRisk.value); }); calcCap(); } } catch(e) {} }

  function loadScenarios(){ try{ const scenarios = JSON.parse(localStorage.getItem(SCENARIOS_KEY)) || []; const select = document.getElementById('cap_load_scenario'); if(!select) return; select.innerHTML = '<option value="">Load preset...</option>'; scenarios.forEach((scenario, index) => { const option = document.createElement('option'); option.value = index; option.textContent = scenario.name + (scenario.date ? ` (${scenario.date})` : ''); select.appendChild(option); }); const deleteBtn = document.getElementById('cap_delete_scenario'); deleteBtn.disabled = scenarios.length === 0; }catch(e){} }

  function saveScenario(){
    const name = prompt(lang==='ru' ? 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµÑĞµÑ‚Ğ°:' : 'Enter preset name:', lang==='ru' ? 'ĞœĞ¾Ğ¹ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹' : 'My Scenario');
    if(!name) return;
    const scenario = { name, date: new Date().toLocaleDateString(), dep: capDep.value, risk: capRisk.value, lev: capLev.value, entry: capEntry.value, sl: capSl.value, fee: capFee.value };
    try{ const scenarios = JSON.parse(localStorage.getItem(SCENARIOS_KEY)) || []; scenarios.push(scenario); localStorage.setItem(SCENARIOS_KEY, JSON.stringify(scenarios)); loadScenarios(); showToast(lang==='ru' ? 'Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½' : 'Scenario saved'); }catch(e){ showToast(lang==='ru' ? 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ' : 'Save error'); }
  }

  function loadScenario(index){
    try{
      const scenarios = JSON.parse(localStorage.getItem(SCENARIOS_KEY)) || [];
      const scenario = scenarios[index];
      if(!scenario) return;
      capDep.value = scenario.dep;
      capRisk.value = scenario.risk;
      capLev.value = scenario.lev;
      capEntry.value = scenario.entry;
      capSl.value = scenario.sl;
      capFee.value = scenario.fee;
      document.querySelectorAll('.chip[data-risk]').forEach(ch => { ch.classList.toggle('active', ch.dataset.risk === capRisk.value); });
      calcCap();
      saveCapState();
      pushHistoryIfReady();
      showToast(lang==='ru' ? 'Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½' : 'Scenario loaded');
    }catch(e){ showToast(lang==='ru' ? 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸' : 'Load error'); }
  }

  document.getElementById('cap_save_scenario')?.addEventListener('click', saveScenario);
  document.getElementById('cap_load_scenario')?.addEventListener('change', function(){ if(this.value) loadScenario(parseInt(this.value)); });
  document.getElementById('cap_delete_scenario')?.addEventListener('click', deleteScenario);

  document.querySelectorAll('.chip[data-risk]').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip[data-risk]').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      capRisk.value=ch.dataset.risk;
      calcCap();
      saveCapState();
      pushHistoryIfReady();
      haptic('impact', 'light');
    });
  });

  function calcCap(){
    const dep=safeNum(capDep.value);
    const rp=safeNum(capRisk.value)/100;
    const lev=Math.max(1, safeNum(capLev.value)||1);
    const e=safeNum(capEntry.value);
    const sl=safeNum(capSl.value);
    const fee=safeNum(capFee.value)/100;
    const posResult = document.getElementById('cap_pos_result');
    const riskResult = document.getElementById('cap_risk_result');
    const marginResult = document.getElementById('cap_margin_result');
    if(e !== 0 && sl !== 0 && e === sl){
      showHint('cap_hint', lang==='ru' ? 'Entry Ğ¸ Stop Loss Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ' : 'Entry and Stop Loss should not be equal', true);
      capEntry.classList.add('error'); capSl.classList.add('error');
      posResult?.classList.remove('success'); riskResult?.classList.remove('success'); marginResult?.classList.remove('success');
      return {pos:null};
    } else { capEntry.classList.remove('error'); capSl.classList.remove('error'); }
    if(dep<=0 || rp<=0 || e<=0 || sl<=0 || e===sl){
      animateValueChange(capPos, 'â€”'); animateValueChange(capRiskUsd, 'â€”'); animateValueChange(capMargin, 'â€”');
      posResult?.classList.remove('success'); riskResult?.classList.remove('success'); marginResult?.classList.remove('success');
      return {pos:null};
    }
    const riskUsd=dep*rp;
    const move=Math.abs(e-sl) + (e*fee);
    const pos = riskUsd / move;
    animateValueChange(capPos, fmt(pos, 8));
    animateValueChange(capRiskUsd, fmt(riskUsd, 2));
    const notional = pos * e;
    animateValueChange(capMargin, fmt(notional/lev, 2));
    posResult?.classList.add('success'); riskResult?.classList.add('success'); marginResult?.classList.add('success');
    if(rp > 0.05){ showHint('cap_hint', lang==='ru' ? 'Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ€Ğ¸ÑĞºĞ°' : 'High risk level', true); }
    else if(lev > 10){ showHint('cap_hint', lang==='ru' ? 'Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ ĞºÑ€ĞµĞ´Ğ¸Ñ‚Ğ½Ğ¾Ğµ Ğ¿Ğ»ĞµÑ‡Ğ¾' : 'High leverage', true); }
    return {pos};
  }

  [capDep,capRisk,capLev,capEntry,capSl,capFee].forEach(x=>{
    x?.addEventListener('input', ()=>{ calcCap(); saveCapState(); pushHistoryIfReady(); if(x === capRisk && parseFloat(x.value) > 10){ showHint('cap_hint', lang==='ru' ? 'ĞÑ‡ĞµĞ½ÑŒ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº' : 'Very high risk', true); } });
  });

  bindCopy(document.getElementById('cap_copy_pos'), ()=>capPos.textContent);

  const fgText=document.getElementById('fg_text');
  const tcapText=document.getElementById('tcap_text');
  const altText=document.getElementById('alt_text');
  const moodEl=document.getElementById('mood');
  const indNote=document.getElementById('ind_note');
  const fgFearThreshold = document.getElementById('fg_fear_threshold');
  const fgNeutralThreshold = document.getElementById('fg_neutral_threshold');

  function loadFgSettings(){ try{ const settings = JSON.parse(localStorage.getItem(FGSETTINGS_KEY)); if(settings){ if(fgFearThreshold) fgFearThreshold.value = settings.fearThreshold || 30; if(fgNeutralThreshold) fgNeutralThreshold.value = settings.neutralThreshold || 70; } }catch(e){} }
  function saveFgSettings(){ try{ const settings = { fearThreshold: parseInt(fgFearThreshold?.value) || 30, neutralThreshold: parseInt(fgNeutralThreshold?.value) || 70 }; localStorage.setItem(FGSETTINGS_KEY, JSON.stringify(settings)); }catch(e){} }

  if(fgFearThreshold){
    fgFearThreshold.addEventListener('change', ()=>{
      if(fgNeutralThreshold){ const fear = parseInt(fgFearThreshold.value) || 30; const neutral = parseInt(fgNeutralThreshold.value) || 70; if(fear >= neutral){ fgFearThreshold.value = neutral - 1; } }
      saveFgSettings();
      updateIndicatorColors();
    });
  }

  if(fgNeutralThreshold){
    fgNeutralThreshold.addEventListener('change', ()=>{
      if(fgFearThreshold){ const fear = parseInt(fgFearThreshold.value) || 30; const neutral = parseInt(fgNeutralThreshold.value) || 70; if(neutral <= fear){ fgNeutralThreshold.value = fear + 1; } }
      saveFgSettings();
      updateIndicatorColors();
    });
  }

  function openUrl(url){ try{ if(tg?.openLink) tg.openLink(url); else window.open(url,'_blank'); }catch(e){ window.open(url,'_blank'); } }
  document.getElementById('open_terms')?.addEventListener('click', ()=>openUrl(location.origin + '/terms.html'));
  document.getElementById('open_privacy')?.addEventListener('click', ()=>openUrl(location.origin + '/privacy.html'));
  document.getElementById('open_support')?.addEventListener('click', ()=>openUrl('https://t.me/Trader_TradeSupportBot'));

  const modalBackdrop=document.getElementById('modal_backdrop');
  const modalClose=document.getElementById('modal_close');
  const cardCanvas=document.getElementById('card_canvas');
  const btnDownload=document.getElementById('card_download');
  const btnCopyImg=document.getElementById('card_copy');

  function openModal(){ modalBackdrop.style.display='flex'; setTimeout(() => { modalBackdrop.style.opacity = '1'; }, 10); }
  function closeModal(){ modalBackdrop.style.opacity = '0'; setTimeout(() => { modalBackdrop.style.display='none'; }, 300); }
  modalClose?.addEventListener('click', closeModal);
  modalBackdrop?.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  function roundRect(ctx,x,y,w,h,r){ const rr = Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

  function drawCard({title, lines}){
    const ctx=cardCanvas.getContext('2d');
    const w=cardCanvas.width, h=cardCanvas.height;
    ctx.clearRect(0,0,w,h);
    const theme=document.documentElement.getAttribute('data-theme')||'dark';
    const bg = theme==='light' ? '#f6f7fb' : '#0a0a0a';
    const panel = theme==='light' ? '#ffffff' : '#0f0f0f';
    const border = theme==='light' ? '#e6e8ee' : '#1a1a1a';
    const text = theme==='light' ? '#0b0b0b' : '#ffffff';
    const muted = theme==='light' ? '#5f6675' : '#a8a8a8';
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || (theme==='light' ? '#2d8cff' : '#7CFC00');
    const accentGradient = getComputedStyle(document.documentElement).getPropertyValue('--accent-gradient').trim();
    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    const pad=30; const r=24;
    roundRect(ctx, pad, pad, w-pad*2, h-pad*2, r);
    ctx.fillStyle=panel; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle=border; ctx.stroke();
    ctx.fillStyle=text; ctx.font='800 44px Inter, Arial'; ctx.fillText('Trader Calculator', pad+28, pad+64);
    const gradient = ctx.createLinearGradient(pad+28, 0, pad+300, 0);
    gradient.addColorStop(0, accent); gradient.addColorStop(1, accentGradient.includes('00FFAA') ? '#00FFAA' : accent);
    ctx.font='900 36px Inter, Arial'; ctx.fillStyle=gradient; ctx.fillText(title, pad+28, pad+118);
    let y=pad+175;
    lines.forEach(line=>{
      ctx.fillStyle=muted; ctx.font='800 26px Inter, Arial'; ctx.fillText(line.k, pad+28, y);
      ctx.fillStyle=text; ctx.font='900 28px Inter, Arial'; ctx.fillText(line.v, pad+330, y);
      y+=46;
    });
    ctx.fillStyle=muted; ctx.font='900 22px Inter, Arial'; ctx.fillText('AIRDROP Â· NEWS Â· TRADING', pad+28, h-pad-22);
  }

  function buildCardData({fromHistory, historyItem}){
    if(fromHistory && historyItem){
      return { title: historyItem.type, lines: [ {k:'Time', v: new Date(historyItem.t).toLocaleString()}, {k:'Summary', v: historyItem.summary || 'â€”'} ] };
    }
    const tab=activeTab();
    if(tab==='dca'){
      const goal = safeNum(dcaGoal.value);
      const next = safeNum(dcaNext.value);
      const lines = [ {k:'AVG', v: dcaAvgEl.textContent}, {k:'VOL', v: dcaTotalVolEl.textContent}, {k:'COST', v: dcaTotalCostEl.textContent} ];
      if(goal > 0) lines.push({k:'Goal AVG', v: fmt(goal, 10)});
      if(next > 0) lines.push({k:'Next Price', v: fmt(next, 10)});
      if(dcaNeedVol.textContent.trim() !== 'â€”') lines.push({k:'Need VOL', v: dcaNeedVol.textContent});
      return { title:'DCA', lines };
    }
    if(tab==='rr'){
      return { title:'R/R', lines:[ {k:'Gross', v: rrGross.textContent}, {k:'Net', v: rrNet.textContent} ]};
    }
    if(tab==='cap'){
      return { title:'Capital', lines:[ {k:'POS', v: capPos.textContent}, {k:'Risk $', v: capRiskUsd.textContent}, {k:'Margin $', v: capMargin.textContent} ]};
    }
    return {title:'Trader', lines:[{k:'â€”',v:'â€”'}]};
  }

  async function canvasToBlob(){ return await new Promise(resolve=>cardCanvas.toBlob(resolve,'image/png')); }
  async function tryCopyImage(){
    try{
      const blob = await canvasToBlob();
      if(!blob) throw new Error('no blob');
      if(!navigator.clipboard || !window.ClipboardItem) throw new Error('no clipboard api');
      await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
      return true;
    }catch(e){ return false; }
  }

  async function downloadPng(){
    const blob = await canvasToBlob();
    if(!blob) return;
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='trade-card.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showToast(t('toast.saved')); haptic('notify','success');
  }

  async function exportCardPNG({fromHistory=false, historyItem=null}){
    const data=buildCardData({fromHistory, historyItem});
    drawCard(data);
    openModal();
  }

  btnDownload?.addEventListener('click', ()=>{ downloadPng(); haptic('impact', 'medium'); });
  btnCopyImg?.addEventListener('click', async ()=>{ const ok = await tryCopyImage(); if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }else{ await downloadPng(); } });
  document.getElementById('card_btn')?.addEventListener('click', ()=>{ exportCardPNG({fromHistory:false}); haptic('impact', 'light'); });

  const TONCONNECT_MANIFEST_URL = 'https://trade-calculator-five.vercel.app/tonconnect-manifest.json';
  const TIP_ADDRESS = 'UQD04FKshVmZaQjZq9y2AtBXWklkzQfK4sEJWrsYfqbNHGGz';
  const TIP_AMOUNT_TON = 0.05;

  let tonConnectUI = null;

  function shortAddr(addr){ if(!addr) return ''; return addr.length > 12 ? (addr.slice(0,4) + 'â€¦' + addr.slice(-4)) : addr; }
  function toNanoStr(ton){ const v = Number(ton); if(!isFinite(v) || v <= 0) return '0'; return String(Math.floor(v * 1e9)); }

  async function confirmDialog(text){ try{ if(tg?.showConfirm){ return await new Promise(resolve => tg.showConfirm(text, ok => resolve(!!ok))); } }catch(e){} return window.confirm(text); }

  function updateWalletUI(){
    const wBtn = document.getElementById('wallet_btn');
    const tipBtn = document.getElementById('tip_btn');
    if(!wBtn || !tipBtn) return;
    if(!tonConnectUI){ wBtn.disabled = true; tipBtn.disabled = true; wBtn.textContent = t('wallet'); tipBtn.textContent = t('tip'); return; }
    wBtn.disabled = false;
    if(tonConnectUI.connected){ const addr = tonConnectUI.account?.address || ''; wBtn.textContent = shortAddr(addr) || t('wallet'); tipBtn.disabled = false; }else{ wBtn.textContent = t('wallet'); tipBtn.disabled = true; }
  }

  function initTonConnect(){
    try{
      if(!window.TON_CONNECT_UI?.TonConnectUI) return;
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({ manifestUrl: TONCONNECT_MANIFEST_URL });
      tonConnectUI.onStatusChange(() => { updateWalletUI(); haptic('notify','success'); });
      tonConnectUI.connectionRestored?.then(() => updateWalletUI()).catch(() => {});
      updateWalletUI();
    }catch(e){ tonConnectUI = null; updateWalletUI(); }
  }

  document.getElementById('wallet_btn')?.addEventListener('click', async ()=>{
    if(!tonConnectUI){ showToast(t('toast.tonManifest')); return; }
    try{
      if(tonConnectUI.connected){
        const ok = await confirmDialog(t('wallet.disconnectQ'));
        if(ok){ await tonConnectUI.disconnect(); updateWalletUI(); showToast(t('toast.saved')); haptic('impact', 'medium'); }
      }else{ await tonConnectUI.openModal(); }
    }catch(e){ updateWalletUI(); }
  });

  document.getElementById('tip_btn')?.addEventListener('click', async ()=>{
    if(!tonConnectUI?.connected){ showToast(t('toast.walletNeed')); haptic('notify','warning'); return; }
    if(!TIP_ADDRESS || TIP_ADDRESS.startsWith('REPLACE_')){ showToast('Set TIP_ADDRESS'); return; }
    try{
      const tx = { validUntil: Math.floor(Date.now()/1000) + 600, messages: [{ address: TIP_ADDRESS, amount: toNanoStr(TIP_AMOUNT_TON) }] };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('toast.sent')); haptic('notify','success');
    }catch(e){ showToast(t('toast.fail')); haptic('notify','error'); }
  });

  initTonConnect();

  document.getElementById('share_btn')?.addEventListener('click', async ()=>{
    const tab=activeTab();
    let text='ğŸ“Š Trader Calculator\n';
    if(tab==='dca'){ text += `DCA AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}\n`; if(dcaNeedVol.textContent.trim()!=='â€”') text += `\nğŸ¯ DCA Goal\nNeed: ${dcaNeedVol.textContent}`; }
    if(tab==='rr'){ text += `Gross: ${rrGross.textContent}\nNet: ${rrNet.textContent}\n`; }
    if(tab==='cap'){ text += `POS: ${capPos.textContent}\nRisk$: ${capRiskUsd.textContent}\nMargin$: ${capMargin.textContent}\n`; }
    try{ if(navigator.share){ await navigator.share({text}); return; } }catch(e){}
    const ok = await copyText(text);
    if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
  });

  function refreshAll(){
    dcaRows.forEach(r=>{
      const labels=r.el.querySelectorAll('label');
      if(labels[0]) labels[0].textContent = 'ğŸ’° ' + (lang==='ru'?'Ğ¦ĞµĞ½Ğ°':'Price');
      if(labels[1]) labels[1].textContent = 'ğŸ“Š ' + (lang==='ru'?'ĞĞ±ÑŠÑ‘Ğ¼':'Volume');
    });
    calcDCA();
    calcRR();
    calcCap();
    drawAllIndicatorVisuals(lastIndicators);
  }

  translateAll();
  loadDcaState();
  loadRRState();
  loadCapState();
  calcRR(); calcCap();
  renderHistory();
  loadScenarios();
  loadFgSettings();

  setTimeout(()=>{ try{ refreshAll(); }catch(e){} }, 60);

  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ drawAllIndicatorVisuals(lastIndicators); } });
  window.refreshAll = refreshAll;
  window.addEventListener('resize', ()=>{ drawAllIndicatorVisuals(lastIndicators); });

  try{ tg?.onEvent?.('viewportChanged', ()=>{ setTimeout(()=>drawAllIndicatorVisuals(lastIndicators), 150); }); }catch(e){}

  function pushHistoryIfReady(){
    try{
      const tab=activeTab();
      const tstamp=Date.now();
      if(tab==='dca'){
        const st = calcDCA();
        if(st && st.totalVol>0){
          const summary=`AVG:${fmt(st.avg,6)} VOL:${fmt(st.totalVol,6)} COST:${fmt(st.totalCost,2)}`;
          pushHistory({type:'DCA', t:tstamp, summary});
        }
      } else if(tab==='rr'){
        const st=calcRR();
        if(st && st.gross){ pushHistory({type:'R/R', t:tstamp, summary:`Gross:${formatIf(st.gross)} Net:${formatIf(st.net)}`}); }
      } else if(tab==='cap'){
        const st=calcCap();
        if(st && st.pos){ pushHistory({type:'CAP', t:tstamp, summary:`POS:${formatIf(st.pos)}`}); }
      }
    }catch(e){}
  }

  function formatIf(v){ return isFinite(v) ? String(v) : 'â€”'; }

  function pushHistory(item){
    try{
      const list = JSON.parse(localStorage.getItem('tc_history_v1')||'[]');
      list.unshift(item);
      if(list.length>80) list.pop();
      localStorage.setItem('tc_history_v1', JSON.stringify(list));
      renderHistory();
    }catch(e){}
  }

  function renderHistory(){
    try{
      const list = JSON.parse(localStorage.getItem('tc_history_v1')||'[]');
      const wrap = document.getElementById('history_list');
      if(!wrap) return;
      wrap.innerHTML='';
      list.forEach(it=>{
        const el=document.createElement('div');
        el.className='hist-item';
        el.innerHTML=`<div><b>${it.type}</b><div class="small">${new Date(it.t).toLocaleString()}</div><div class="note">${it.summary||''}</div></div><div class="hist-actions"><button class="mini">Export</button></div>`;
        wrap.appendChild(el);
      });
    }catch(e){}
  }

  document.getElementById('clear_history')?.addEventListener('click', ()=>{
    if(confirm(lang==='ru' ? 'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ?' : 'Clear history?')){ localStorage.removeItem('tc_history_v1'); renderHistory(); showToast(t('toast.saved')); }
  });

  function drawAllIndicatorVisuals(ind){ try{ /* placeholders kept minimal to avoid external deps */ }catch(e){} }
  function fetchIndicators(){ try{ /* minimal placeholder */ }catch(e){} }
  function updateIndicatorColors(){}

})();
</script>
</body>
</html>
