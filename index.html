<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator ‚Äî Mini App</title>

<!-- Telegram Web App SDK (—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --border:#151515; --text:#fff; --muted:#9a9a9a;
  --accent:#7CFC00; --accent-gradient:linear-gradient(135deg,#7CFC00 0%,#00FFAA 100%);
  --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.55); --input-bg:#070707; --result-bg:#060606;
}
html[data-theme="light"]{
  --bg:#f6f7fb; --panel:#ffffff; --border:#e6e8ee; --text:#0b0b0b; --muted:#5f6675;
  --accent:#2d8cff; --accent-gradient:linear-gradient(135deg,#2d8cff 0%,#00d4ff 100%);
  --input-bg:#fbfcff; --result-bg:#f7f9ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1100px;margin:14px auto;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#111,#222);display:flex;align-items:center;justify-content:center;font-weight:900}
.title{font-weight:900}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-weight:800}
.btn.primary{background:var(--accent-gradient);color:#000;border:none}
.btn.ghost{background:transparent}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
.subtabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:transparent;cursor:pointer;color:var(--muted);font-weight:800}
.tab.active{border-color:var(--accent);color:var(--accent);background:linear-gradient(135deg,rgba(0,0,0,.06),transparent)}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:800}
input[type="number"], select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);font-size:15px;outline:none}
.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:120px}
.result{margin-top:8px;padding:10px;border-radius:10px;background:var(--result-bg);border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:900}
.small{font-size:12px;color:var(--muted);font-weight:700}
.controls-wrap{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-weight:900}
.chip.active{border-color:var(--accent);color:var(--accent)}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:4px}
.hist-item{border:1px solid var(--border);border-radius:10px;padding:8px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent)}
.footer-links{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.note{font-size:12px;color:var(--muted);margin-top:8px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;padding:8px 12px;border-radius:999px;background:rgba(0,0,0,.75);color:#fff;font-weight:900;opacity:0;pointer-events:none;transition:opacity .18s}
.toast.show{opacity:1}
.onboard{padding:10px;border-radius:10px;border:1px dashed var(--border);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);margin-bottom:12px}
</style>
</head>
<body>
<div class="container" role="application" aria-label="Trader Calculator">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true">TC</div>
      <div>
        <div class="title">Trader Calculator</div>
        <div class="small">DCA ¬∑ R/R ¬∑ Risk management</div>
      </div>
    </div>

    <div class="controls" role="toolbar" aria-label="Controls">
      <button id="btn_theme" class="btn" aria-pressed="false" title="Toggle theme">–¢–µ–º–∞</button>
      <button id="btn_card" class="btn" title="Trade card PNG">Card</button>
      <button id="btn_share" class="btn ghost" title="Share">Share</button>
    </div>
  </header>

  <div id="onboarding" class="onboard card" role="region" aria-live="polite">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</b>
        <div class="small">–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ TAPPS. MainButton ‚Äî –≤–∫–ª—é—á—ë–Ω.</div>
      </div>
      <div>
        <button id="onn_close" class="btn">–û–∫</button>
      </div>
    </div>
  </div>

  <nav class="subtabs" role="tablist" aria-label="Tabs">
    <button class="tab active" data-tab="dca" role="tab">DCA</button>
    <button class="tab" data-tab="rr" role="tab">R/R</button>
    <button class="tab" data-tab="cap" role="tab">Capital</button>
    <button class="tab" data-tab="ind" role="tab">Indicators</button>
  </nav>

  <div class="grid" role="main">
    <section>
      <!-- DCA -->
      <section id="screen_dca" class="card" aria-labelledby="dca_title" role="region">
        <h3 id="dca_title">DCA Calculator</h3>
        <div class="small">–î–æ–±–∞–≤—å—Ç–µ –≤—Ö–æ–¥—ã (price + volume). –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.</div>

        <div id="dca_rows" style="margin-top:12px" aria-live="polite"></div>

        <div class="controls-wrap">
          <button id="dca_add" class="btn primary">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥</button>
          <button id="dca_clear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="result" id="dca_avg_block">
          <div>
            <div class="small">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</div>
            <div id="dca_avg" class="result-value">‚Äî</div>
          </div>
          <div>
            <button id="dca_copy" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="result">
            <div>
              <div class="small">–û–±—â–∏–π –æ–±—ä—ë–º</div>
              <div id="dca_total_vol" class="result-value">‚Äî</div>
            </div>
          </div>
          <div class="result">
            <div>
              <div class="small">–°—É–º–º–∞</div>
              <div id="dca_total_cost" class="result-value">‚Äî</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px">
          <div class="row">
            <div class="field">
              <label for="dca_goal">Target average price (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <input id="dca_goal" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field">
              <label for="dca_next_price">Next buy price</label>
              <input id="dca_next_price" type="number" step="any" inputmode="decimal" />
            </div>
          </div>

          <div class="result" style="margin-top:10px">
            <div>
              <div class="small">–ù—É–∂–Ω—ã–π –æ–±—ä—ë–º –ø—Ä–∏ next price</div>
              <div id="dca_need_vol" class="result-value">‚Äî</div>
            </div>
            <div><button id="dca_need_copy" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
          </div>
        </div>
      </section>

      <!-- R/R -->
      <section id="screen_rr" class="card" aria-labelledby="rr_title" role="region" style="margin-top:14px;display:none">
        <h3 id="rr_title">Risk / Reward</h3>
        <div class="row">
          <div class="field"><label for="rr_entry">Entry</label><input id="rr_entry" type="number" step="any" /></div>
          <div class="field"><label for="rr_sl">Stop Loss</label><input id="rr_sl" type="number" step="any" /></div>
          <div class="field"><label for="rr_tp">Take Profit</label><input id="rr_tp" type="number" step="any" /></div>
        </div>
        <div class="field"><label for="rr_fee">Fee % (entry+exit)</label><input id="rr_fee" type="number" step="any" value="0.2" /></div>

        <div class="result" id="rr_gross_block">
          <div>
            <div class="small">Gross R/R</div>
            <div id="rr_gross" class="result-value">‚Äî</div>
          </div>
          <div><button id="rr_copy_gross" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        </div>

        <div class="result" style="margin-top:10px">
          <div>
            <div class="small">Net R/R (fees)</div>
            <div id="rr_net" class="result-value">‚Äî</div>
          </div>
          <div><button id="rr_copy_net" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        </div>

        <div id="rr_hint" class="note"></div>
      </section>

      <!-- Capital -->
      <section id="screen_cap" class="card" aria-labelledby="cap_title" role="region" style="margin-top:14px;display:none">
        <h3 id="cap_title">Capital Management</h3>
        <div class="row">
          <div class="field"><label for="cap_dep">Deposit</label><input id="cap_dep" type="number" step="any" /></div>
          <div class="field"><label for="cap_risk">Risk %</label><input id="cap_risk" type="number" step="any" value="1" /></div>
          <div class="field"><label for="cap_lev">Leverage</label><input id="cap_lev" type="number" step="any" value="1" /></div>
        </div>

        <div class="chips">
          <button class="chip" data-risk="0.5">0.5%</button>
          <button class="chip active" data-risk="1">1%</button>
          <button class="chip" data-risk="2">2%</button>
          <button class="chip" data-risk="3">3%</button>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field"><label for="cap_entry">Entry</label><input id="cap_entry" type="number" step="any" /></div>
          <div class="field"><label for="cap_sl">Stop Loss</label><input id="cap_sl" type="number" step="any" /></div>
          <div class="field"><label for="cap_fee">Fee %</label><input id="cap_fee" type="number" step="any" value="0.2" /></div>
        </div>

        <div class="result" style="margin-top:10px">
          <div>
            <div class="small">Position size</div>
            <div id="cap_pos" class="result-value">‚Äî</div>
          </div>
          <div><button id="cap_copy_pos" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="result"><div><div class="small">Risk $</div><div id="cap_risk_usd" class="result-value">‚Äî</div></div></div>
          <div class="result"><div><div class="small">Margin (lev)</div><div id="cap_margin" class="result-value">‚Äî</div></div></div>
        </div>

        <div id="cap_hint" class="note"></div>
      </section>

      <!-- Indicators (placeholder) -->
      <section id="screen_ind" class="card" aria-labelledby="ind_title" role="region" style="margin-top:14px;display:none">
        <h3 id="ind_title">Indicators</h3>
        <div class="row">
          <div class="field" style="flex:1">
            <div class="small">Fear & Greed</div>
            <div id="fg_text" class="result" style="margin-top:6px">‚Äî</div>
          </div>
          <div class="field" style="flex:1">
            <div class="small">Market mood</div>
            <div id="mood" class="result" style="margin-top:6px">‚Äî</div>
          </div>
        </div>
        <div class="controls-wrap" style="margin-top:8px">
          <button id="refresh_ind" class="btn">Refresh</button>
          <div id="ind_note" class="small"></div>
        </div>
      </section>
    </section>

    <aside>
      <div class="card">
        <h4>History</h4>
        <div class="history-list" id="history_list" aria-live="polite"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="clear_history" class="btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="export_history" class="btn ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>

        <div class="footer-links">
          <a href="/terms.html" style="color:var(--muted)">Terms</a>
          <a href="/privacy.html" style="color:var(--muted)">Privacy</a>
          <a href="https://t.me/Trader_TradeSupportBot" style="color:var(--muted)">Contact</a>
        </div>

        <div class="note">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ TAPPS.</div>
      </div>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">‚Äî</div>
</div>

<!-- Modal for card -->
<div id="modal_backdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:999">
  <div style="width:min(900px,95%);max-width:900px;">
    <div class="card" style="display:flex;flex-direction:column;gap:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <b>Trade Card</b>
        <button id="modal_close" class="btn">‚úï</button>
      </div>
      <canvas id="card_canvas" width="900" height="600" style="width:100%;height:auto;border-radius:8px"></canvas>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="card_download" class="btn primary">–°–∫–∞—á–∞—Ç—å PNG</button>
        <button id="card_copy" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------------------------------------------------------------------
   –ü–æ–ª–Ω–æ—Å—Ç—å—é –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞: –Ω–∞–¥—ë–∂–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤,
   MainButton –ø–æ TAPPS, –Ω–µ–±–æ–ª—å—à–æ–µ on-boarding –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —á–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤.
   --------------------------------------------------------------------------- */

(function(){
  // Telegram WebApp
  const tg = window.Telegram?.WebApp || null;
  try { tg?.ready?.(); tg?.expand?.(); } catch(e){ /* silent */ }

  // Toast
  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'),1200);
  }

  // Simple utilities
  function safeNum(v){
    if(v === '' || v === null || v === undefined) return NaN;
    const x = parseFloat(String(v).replace(',', '.'));
    return Number.isFinite(x) ? x : NaN;
  }
  function fmt(v, digits=8){
    if(!Number.isFinite(v)) return '‚Äî';
    const abs = Math.abs(v);
    const d = abs >= 1000 ? 2 : (abs >= 1 ? 6 : digits);
    return Number(v).toLocaleString(undefined, { maximumFractionDigits: d });
  }

  // Theme toggle (small)
  const btnTheme = document.getElementById('btn_theme');
  btnTheme?.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    showToast(next === 'dark' ? '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
  });

  // Tabs
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.tab;
      document.querySelectorAll('[id^="screen_"]').forEach(s=>s.style.display = 'none');
      const target = document.getElementById('screen_' + t);
      if(target) target.style.display = 'block';
      // Update MainButton text when switching
      updateMainButtonText();
    });
  });

  /* ---------------------------- DCA implementation -------------------------- */
  const dcaRowsEl = document.getElementById('dca_rows');
  const dcaAvgEl = document.getElementById('dca_avg');
  const dcaTotalVolEl = document.getElementById('dca_total_vol');
  const dcaTotalCostEl = document.getElementById('dca_total_cost');
  const dcaGoalEl = document.getElementById('dca_goal');
  const dcaNextEl = document.getElementById('dca_next_price');
  const dcaNeedVolEl = document.getElementById('dca_need_vol');

  const DCA_STATE_KEY = 'tc_dca_state_v3';
  let dcaRows = [];

  function createDcaRow(price='', vol=''){
    const wrapper = document.createElement('div');
    wrapper.className = 'row';
    wrapper.style.marginBottom = '8px';
    wrapper.innerHTML = `
      <div class="field" style="flex:1"><label>–¶–µ–Ω–∞</label><input type="number" step="any" class="dca_price" value="${price}"></div>
      <div class="field" style="flex:1"><label>–û–±—ä—ë–º</label><input type="number" step="any" class="dca_vol" value="${vol}"></div>
      <div style="display:flex;align-items:flex-end"><button class="btn remove" type="button">üóëÔ∏è</button></div>
    `;
    const pInput = wrapper.querySelector('.dca_price');
    const vInput = wrapper.querySelector('.dca_vol');
    const btnRemove = wrapper.querySelector('.remove');

    function onInput(){
      calcDCA();
      saveDcaState();
      updateMainButtonVisibility();
      pushHistoryIfReady();
    }
    pInput.addEventListener('input', onInput);
    vInput.addEventListener('input', onInput);

    btnRemove.addEventListener('click', ()=>{
      wrapper.remove();
      dcaRows = dcaRows.filter(r => r.wrapper !== wrapper);
      calcDCA(); saveDcaState(); updateMainButtonVisibility(); pushHistoryIfReady();
    });

    dcaRows.push({ wrapper, pInput, vInput });
    dcaRowsEl.appendChild(wrapper);
  }

  function saveDcaState(){
    try {
      const state = dcaRows.map(r => ({ p: r.pInput.value, v: r.vInput.value }));
      localStorage.setItem(DCA_STATE_KEY, JSON.stringify(state));
    } catch(e){}
  }

  function loadDcaState(){
    dcaRows = [];
    dcaRowsEl.innerHTML = '';
    try {
      const saved = JSON.parse(localStorage.getItem(DCA_STATE_KEY) || '[]');
      if(Array.isArray(saved) && saved.length){
        saved.forEach(row => createDcaRow(row.p || '', row.v || ''));
      } else {
        createDcaRow('', ''); createDcaRow('', '');
      }
    } catch(e){
      createDcaRow('', ''); createDcaRow('', '');
    }
    // attach friendly references
    dcaRows.forEach(r => { r.pInput = r.pInput || r.wrapper.querySelector('.dca_price'); r.vInput = r.vInput || r.wrapper.querySelector('.dca_vol'); });
    calcDCA();
  }

  function calcDCA(){
    let totalVol = 0;
    let totalCost = 0;
    let hasError = false;

    dcaRows.forEach(r=>{
      const p = safeNum(r.pInput.value);
      const v = safeNum(r.vInput.value);
      if(Number.isFinite(p) && Number.isFinite(v) && p > 0 && v > 0){
        totalVol += v;
        totalCost += p * v;
      }
      if((Number.isFinite(p) && p < 0) || (Number.isFinite(v) && v < 0)) hasError = true;
    });

    // Update DOM WITHOUT replacing nodes (–≤–∞–∂–Ω–æ)
    if(hasError){
      dcaAvgEl.textContent = '‚Äî';
      dcaTotalVolEl.textContent = '‚Äî';
      dcaTotalCostEl.textContent = '‚Äî';
      dcaNeedVolEl.textContent = '‚Äî';
      return { avg: null, totalVol: 0, totalCost: 0 };
    }

    if(totalVol <= 0){
      dcaAvgEl.textContent = '‚Äî';
      dcaTotalVolEl.textContent = '‚Äî';
      dcaTotalCostEl.textContent = '‚Äî';
      dcaNeedVolEl.textContent = '‚Äî';
      return { avg: null, totalVol: 0, totalCost: 0 };
    }

    const avg = totalCost / totalVol;
    dcaAvgEl.textContent = fmt(avg, 10);
    dcaTotalVolEl.textContent = fmt(totalVol, 8);
    dcaTotalCostEl.textContent = fmt(totalCost, 2);

    // Goal calc
    const target = safeNum(dcaGoalEl.value);
    const nextP = safeNum(dcaNextEl.value);
    if(Number.isFinite(target) && Number.isFinite(nextP) && target > 0 && nextP > 0 && nextP !== target){
      const need = (target * totalVol - totalCost) / (nextP - target);
      dcaNeedVolEl.textContent = (Number.isFinite(need) && need > 0) ? fmt(need, 8) : '‚Äî';
    } else {
      dcaNeedVolEl.textContent = '‚Äî';
    }

    return { avg, totalVol, totalCost };
  }

  // Bind DCA controls
  document.getElementById('dca_add').addEventListener('click', ()=>{
    createDcaRow('','');
    showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ');
    updateMainButtonVisibility();
  });
  document.getElementById('dca_clear').addEventListener('click', ()=>{
    dcaRows.forEach(r=>r.wrapper.remove());
    dcaRows = [];
    createDcaRow('',''); createDcaRow('','');
    dcaGoalEl.value = ''; dcaNextEl.value = '';
    calcDCA(); saveDcaState(); showToast('–û—á–∏—â–µ–Ω–æ'); updateMainButtonVisibility();
  });
  dcaGoalEl.addEventListener('input', ()=>{ calcDCA(); saveDcaState(); updateMainButtonVisibility(); pushHistoryIfReady(); });
  dcaNextEl.addEventListener('input', ()=>{ calcDCA(); saveDcaState(); updateMainButtonVisibility(); pushHistoryIfReady(); });

  // copy buttons
  async function tryCopy(text){
    if(!text || text === '‚Äî') return false;
    try { await navigator.clipboard.writeText(String(text)); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); return true; } catch(e){ return false; }
  }
  document.getElementById('dca_copy').addEventListener('click', ()=> tryCopy(dcaAvgEl.textContent) );
  document.getElementById('dca_need_copy').addEventListener('click', ()=> tryCopy(dcaNeedVolEl.textContent) );

  /* ---------------------------- R/R implementation -------------------------- */
  const rrEntry = document.getElementById('rr_entry');
  const rrSl = document.getElementById('rr_sl');
  const rrTp = document.getElementById('rr_tp');
  const rrFee = document.getElementById('rr_fee');
  const rrGross = document.getElementById('rr_gross');
  const rrNet = document.getElementById('rr_net');
  const rrHint = document.getElementById('rr_hint');
  const RR_STATE_KEY = 'tc_rr_state_v3';

  function loadRRState(){
    try {
      const s = JSON.parse(localStorage.getItem(RR_STATE_KEY) || '{}');
      if(s){ rrEntry.value = s.entry || ''; rrSl.value = s.sl || ''; rrTp.value = s.tp || ''; rrFee.value = s.fee || '0.2'; }
    }catch(e){}
    calcRR();
  }
  function saveRRState(){ try { localStorage.setItem(RR_STATE_KEY, JSON.stringify({ entry: rrEntry.value, sl: rrSl.value, tp: rrTp.value, fee: rrFee.value })); } catch(e){} }

  function calcRR(){
    const e = safeNum(rrEntry.value), sl = safeNum(rrSl.value), tp = safeNum(rrTp.value), fee = safeNum(rrFee.value)/100;
    rrHint.textContent = '';
    if(!Number.isFinite(e) || !Number.isFinite(sl) || !Number.isFinite(tp) || e === sl){
      rrGross.textContent = '‚Äî'; rrNet.textContent = '‚Äî'; return { gross: null, net: null };
    }
    const risk = Math.abs(e - sl);
    const reward = Math.abs(tp - e);
    if(risk === 0 || reward === 0){ rrGross.textContent = '‚Äî'; rrNet.textContent = '‚Äî'; return { gross: null, net: null }; }
    const gross = reward / risk;
    rrGross.textContent = '1:' + gross.toFixed(2);
    const feeEntry = e * fee;
    const feeExit = tp * fee;
    const netReward = Math.max(0, reward - (feeEntry + feeExit));
    const net = netReward / (risk + feeEntry);
    rrNet.textContent = '1:' + (Number.isFinite(net) ? net.toFixed(2) : '‚Äî');
    if(gross > 3) rrHint.textContent = '–•–æ—Ä–æ—à–µ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R/R';
    else if(gross < 1) rrHint.textContent = '–†–∏—Å–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å';
    return { gross, net };
  }

  [rrEntry, rrSl, rrTp, rrFee].forEach(el => el?.addEventListener('input', ()=>{ calcRR(); saveRRState(); updateMainButtonVisibility(); pushHistoryIfReady(); }));
  document.getElementById('rr_copy_gross').addEventListener('click', ()=> tryCopy(rrGross.textContent) );
  document.getElementById('rr_copy_net').addEventListener('click', ()=> tryCopy(rrNet.textContent) );

  /* ---------------------------- CAPITAL implementation ---------------------- */
  const capDep = document.getElementById('cap_dep');
  const capRisk = document.getElementById('cap_risk');
  const capLev = document.getElementById('cap_lev');
  const capEntry = document.getElementById('cap_entry');
  const capSl = document.getElementById('cap_sl');
  const capFee = document.getElementById('cap_fee');
  const capPos = document.getElementById('cap_pos');
  const capRiskUsd = document.getElementById('cap_risk_usd');
  const capMargin = document.getElementById('cap_margin');
  const CAP_STATE_KEY = 'tc_cap_state_v3';

  function loadCapState(){
    try {
      const s = JSON.parse(localStorage.getItem(CAP_STATE_KEY) || '{}');
      if(s){ capDep.value = s.dep || ''; capRisk.value = s.risk || '1'; capLev.value = s.lev || '1'; capEntry.value = s.entry || ''; capSl.value = s.sl || ''; capFee.value = s.fee || '0.2'; }
    } catch(e){}
    calcCap();
  }
  function saveCapState(){ try { localStorage.setItem(CAP_STATE_KEY, JSON.stringify({ dep: capDep.value, risk: capRisk.value, lev: capLev.value, entry: capEntry.value, sl: capSl.value, fee: capFee.value })); } catch(e){} }

  function calcCap(){
    const dep = safeNum(capDep.value);
    const rp = safeNum(capRisk.value) / 100;
    const lev = Math.max(1, safeNum(capLev.value) || 1);
    const e = safeNum(capEntry.value);
    const sl = safeNum(capSl.value);
    const fee = safeNum(capFee.value) / 100;

    if(!Number.isFinite(dep) || !Number.isFinite(rp) || rp <= 0 || !Number.isFinite(e) || !Number.isFinite(sl) || e === sl){
      capPos.textContent = '‚Äî'; capRiskUsd.textContent = '‚Äî'; capMargin.textContent = '‚Äî'; return { pos: null };
    }
    const riskUsd = dep * rp;
    const move = Math.abs(e - sl) + (e * fee);
    const pos = riskUsd / move;
    capPos.textContent = fmt(pos, 8);
    capRiskUsd.textContent = fmt(riskUsd, 2);
    const notional = pos * e;
    capMargin.textContent = fmt(notional / lev, 2);
    return { pos };
  }

  [capDep, capRisk, capLev, capEntry, capSl, capFee].forEach(el => el?.addEventListener('input', ()=>{ calcCap(); saveCapState(); updateMainButtonVisibility(); pushHistoryIfReady(); }));

  // chips
  document.querySelectorAll('.chip[data-risk]').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      capRisk.value = ch.dataset.risk;
      calcCap();
      saveCapState();
      updateMainButtonVisibility();
    });
  });

  document.getElementById('cap_copy_pos').addEventListener('click', ()=> tryCopy(capPos.textContent) );

  /* ---------------------------- History ---------------------------------- */
  function pushHistory(item){
    try {
      const list = JSON.parse(localStorage.getItem('tc_history_v1') || '[]');
      list.unshift(item);
      if(list.length > 120) list.pop();
      localStorage.setItem('tc_history_v1', JSON.stringify(list));
      renderHistory();
    } catch(e){}
  }
  function renderHistory(){
    try {
      const wrap = document.getElementById('history_list');
      const list = JSON.parse(localStorage.getItem('tc_history_v1') || '[]');
      wrap.innerHTML = '';
      list.forEach(it=>{
        const el = document.createElement('div');
        el.className = 'hist-item';
        el.innerHTML = `<div><b>${it.type}</b><div class="small">${new Date(it.t).toLocaleString()}</div><div class="note">${it.summary||''}</div></div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn export">Card</button>
            <button class="btn ghost">Copy</button>
          </div>`;
        // export handler
        el.querySelector('.export')?.addEventListener('click', ()=>{ exportCardFromHistory(it); });
        el.querySelectorAll('.btn.ghost')[0]?.addEventListener('click', ()=>{ tryCopy(it.summary || '') });
        wrap.appendChild(el);
      });
    } catch(e){}
  }

  function pushHistoryIfReady(){
    try {
      const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
      const t = Date.now();
      if(active === 'dca'){
        const st = calcDCA();
        if(st && st.totalVol > 0){
          pushHistory({ type: 'DCA', t, summary: `AVG:${fmt(st.avg,6)} VOL:${fmt(st.totalVol,6)} COST:${fmt(st.totalCost,2)}`});
        }
      } else if(active === 'rr'){
        const st = calcRR();
        if(st && st.gross) pushHistory({ type: 'R/R', t, summary: `Gross:${st.gross.toFixed(2)} Net:${st.net ? st.net.toFixed(2) : '‚Äî'}`});
      } else if(active === 'cap'){
        const st = calcCap();
        if(st && st.pos) pushHistory({ type: 'CAP', t, summary: `POS:${fmt(st.pos,6)}`});
      }
    } catch(e){}
  }

  document.getElementById('clear_history').addEventListener('click', ()=>{
    if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')){ localStorage.removeItem('tc_history_v1'); renderHistory(); showToast('–û—á–∏—â–µ–Ω–æ'); }
  });
  document.getElementById('export_history').addEventListener('click', ()=>{ const txt = localStorage.getItem('tc_history_v1') || '[]'; tryCopy(txt); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); });

  /* ---------------------------- Card export -------------------------------- */
  const modalBackdrop = document.getElementById('modal_backdrop');
  const cardCanvas = document.getElementById('card_canvas');
  const modalClose = document.getElementById('modal_close');
  function drawCard(data){
    const ctx = cardCanvas.getContext('2d');
    const w = cardCanvas.width; const h = cardCanvas.height;
    ctx.clearRect(0,0,w,h);
    const theme = document.documentElement.getAttribute('data-theme') || 'dark';
    ctx.fillStyle = theme === 'light' ? '#f6f7fb' : '#0a0a0a';
    ctx.fillRect(0,0,w,h);
    // panel
    ctx.fillStyle = theme === 'light' ? '#fff' : '#0f0f0f';
    ctx.fillRect(24,24,w-48,h-48);
    ctx.fillStyle = theme === 'light' ? '#111' : '#fff';
    ctx.font = '700 36px Inter, Arial';
    ctx.fillText(data.title, 48, 84);
    ctx.font = '600 20px Inter, Arial';
    let y = 120;
    data.lines.forEach(line=>{
      ctx.fillStyle = '#888';
      ctx.fillText(line.k, 48, y);
      ctx.fillStyle = theme === 'light' ? '#111' : '#fff';
      ctx.fillText(line.v, 260, y);
      y += 34;
    });
    ctx.font = '600 14px Inter, Arial';
    ctx.fillStyle = '#888';
    ctx.fillText('Trader Calculator ‚Äî snapshot', 48, h - 40);
  }
  function buildCardData(){
    const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
    if(active === 'dca') return { title: 'DCA', lines: [{k:'AVG',v: dcaAvgEl.textContent},{k:'VOL',v: dcaTotalVolEl.textContent},{k:'COST',v: dcaTotalCostEl.textContent}] };
    if(active === 'rr') return { title: 'R/R', lines: [{k:'Gross',v: rrGross.textContent},{k:'Net',v: rrNet.textContent}] };
    if(active === 'cap') return { title: 'Capital', lines: [{k:'POS',v: capPos.textContent},{k:'Risk $',v: capRiskUsd.textContent},{k:'Margin $',v: capMargin.textContent}] };
    return { title: 'Trader', lines: [{k:'‚Äî',v:'‚Äî'}] };
  }
  document.getElementById('btn_card').addEventListener('click', ()=>{
    const data = buildCardData();
    drawCard(data);
    modalBackdrop.style.display = 'flex';
  });
  modalClose.addEventListener('click', ()=> modalBackdrop.style.display = 'none');
  document.getElementById('card_download').addEventListener('click', ()=>{
    cardCanvas.toBlob(function(blob){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'trade-card.png'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    });
  });
  document.getElementById('card_copy').addEventListener('click', async ()=>{
    try {
      const blob = await new Promise(res => cardCanvas.toBlob(res, 'image/png'));
      await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
      showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
    } catch(e){
      // fallback to download
      cardCanvas.toBlob(function(blob){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'trade-card.png'; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      });
    }
  });

  function exportCardFromHistory(item){
    const data = { title: item.type, lines: [{k:'Time', v: new Date(item.t).toLocaleString()}, {k:'Summary', v: item.summary || '‚Äî'}] };
    drawCard(data);
    modalBackdrop.style.display = 'flex';
  }

  /* ---------------------------- Indicators placeholder --------------------- */
  document.getElementById('refresh_ind').addEventListener('click', ()=>{
    document.getElementById('fg_text').textContent = '‚Äî';
    document.getElementById('mood').textContent = '‚Äî';
    showToast('–û–±–Ω–æ–≤–ª–µ–Ω–æ');
  });

  /* ---------------------------- Onboarding ------------------------------- */
  const onboard = document.getElementById('onboarding');
  const onnClose = document.getElementById('onn_close');
  if(localStorage.getItem('tc_onboard_seen')) onboard.style.display = 'none';
  onnClose.addEventListener('click', ()=>{ onboard.style.display = 'none'; localStorage.setItem('tc_onboard_seen','1'); });

  /* ---------------------------- MainButton for TAPPS ---------------------- */
  let mainButtonAvailable = false;
  function initMainButton(){
    try {
      if(!tg || !tg.MainButton) return;
      mainButtonAvailable = true;
      // click handler
      tg.MainButton.onClick(async ()=>{
        const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
        if(active === 'dca'){
          // save snapshot to history
          const st = calcDCA();
          if(st && st.totalVol > 0){
            pushHistory({ type: 'DCA', t: Date.now(), summary: `AVG:${fmt(st.avg,6)} VOL:${fmt(st.totalVol,6)} COST:${fmt(st.totalCost,2)}`});
            showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é');
          } else showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        } else if(active === 'rr'){
          const st = calcRR();
          if(st && st.gross){ pushHistory({ type: 'R/R', t: Date.now(), summary: `Gross:${st.gross.toFixed(2)} Net:${st.net ? st.net.toFixed(2) : '‚Äî'}`}); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
          else showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        } else if(active === 'cap'){
          const st = calcCap();
          if(st && st.pos){ pushHistory({ type: 'CAP', t: Date.now(), summary: `POS:${fmt(st.pos,6)}`}); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
          else showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        }
        updateMainButtonVisibility();
      });
      updateMainButtonText();
      updateMainButtonVisibility();
    } catch(e){ mainButtonAvailable = false; }
  }

  function updateMainButtonText(){
    if(!mainButtonAvailable) return;
    const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
    const btnText = active === 'dca' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å DCA' : (active === 'rr' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å R/R' : (active === 'cap' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å CAP' : '–î–µ–π—Å—Ç–≤–∏–µ'));
    try { tg.MainButton.setText(btnText); } catch(e){}
  }

  function updateMainButtonVisibility(){
    if(!mainButtonAvailable) return;
    const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
    let shouldShow = false;
    if(active === 'dca'){ const st = calcDCA(); shouldShow = st && st.totalVol > 0; }
    else if(active === 'rr'){ const st = calcRR(); shouldShow = st && st.gross; }
    else if(active === 'cap'){ const st = calcCap(); shouldShow = st && st.pos; }
    try { if(shouldShow) tg.MainButton.show(); else tg.MainButton.hide(); } catch(e){}
  }

  // If Telegram supports MainButton, initialize
  try { initMainButton(); } catch(e){ /* silent */ }

  function updateMainButtonText(){ try{ if(tg && tg.MainButton){ const active = document.querySelector('.tab.active')?.dataset.tab || 'dca'; const btnText = active === 'dca' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å DCA' : (active === 'rr' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å R/R' : (active === 'cap' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å CAP' : '–î–µ–π—Å—Ç–≤–∏–µ')); tg.MainButton.setText(btnText); } }catch(e){} }
  function updateMainButtonVisibility(){ try{ if(tg && tg.MainButton){ const active = document.querySelector('.tab.active')?.dataset.tab || 'dca'; let shouldShow=false; if(active==='dca'){ const st = calcDCA(); shouldShow = st && st.totalVol > 0; } else if(active==='rr'){ const st = calcRR(); shouldShow = st && st.gross; } else if(active==='cap'){ const st = calcCap(); shouldShow = st && st.pos; } if(shouldShow) tg.MainButton.show(); else tg.MainButton.hide(); } }catch(e){} }

  /* ---------------------------- Share button ------------------------------ */
  document.getElementById('btn_share').addEventListener('click', async ()=>{
    const active = document.querySelector('.tab.active')?.dataset.tab || 'dca';
    let text = 'Trader Calculator\n';
    if(active === 'dca'){
      text += `AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}`;
    } else if(active === 'rr'){
      text += `Gross: ${rrGross.textContent}\nNet: ${rrNet.textContent}`;
    } else if(active === 'cap'){
      text += `POS: ${capPos.textContent}\nRisk$: ${capRiskUsd.textContent}\nMargin$: ${capMargin.textContent}`;
    }
    try {
      if(navigator.share){
        await navigator.share({ text });
        showToast('–ü–æ–¥–µ–ª–∏–ª–∏—Å—å');
      } else {
        await tryCopy(text);
      }
    } catch(e){ await tryCopy(text); }
  });

  /* ---------------------------- Start / load ------------------------------ */
  loadDcaState();
  loadRRState();
  loadCapState();
  renderHistory();
  // make sure main button state matches initial content
  setTimeout(()=>{ updateMainButtonText(); updateMainButtonVisibility(); }, 200);

  // small handlers
  document.getElementById('onn_close')?.addEventListener('click', ()=>{ document.getElementById('onboarding').style.display='none'; localStorage.setItem('tc_onboard_seen','1'); });
  window.addEventListener('beforeunload', ()=>{ saveDcaState(); saveRRState(); saveCapState(); });

  // Accessibility: focus first input
  setTimeout(()=>{ const first = document.querySelector('input'); if(first) first.focus(); }, 300);

})();
</script>
</body>
</html>
