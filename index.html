<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trader Calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
  <script type="module">
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: —ç—Ç–æ—Ç –±–ª–æ–∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–ª–∞—Ç–µ–∂–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    const TG_ANALYTICS_TOKEN = "eyJhcHBfbmFtZSI6InRyYWRlcl9jYWxjdWxhdG9yIiwiYXBwX3VybCI6Imh0dHBzOi8vdC5tZS9DYWxjdWxhdG9yVHJhZGVyQm90IiwiYXBwX2RvbWFpbiI6Imh0dHBzOi8vdHJhZGUtY2FsY3VsYXRvci1maXZlLnZlcmNlbC5hcHAifQ==!+ZTX3Nk0y5cUIMvJ8jWfv22EWL8UPctpRGiFct3mBr0=";
    const TG_ANALYTICS_APP_NAME = "trader_calculator";
    function validateAnalyticsConfig() { return TG_ANALYTICS_TOKEN && TG_ANALYTICS_TOKEN.length > 10; }
    window.TelegramAnalytics = { init: () => {}, trackEvent: () => {}, trackView: () => {} };
    const boot = async () => {
      if (!validateAnalyticsConfig()) { console.error('Invalid analytics token'); return; }
      if (!window.Telegram?.WebApp) { console.log('Not in Telegram environment'); return; }
      setTimeout(() => {
        import('https://esm.sh/@telegram-apps/analytics').then(({ init, trackEvent, trackView }) => {
          try {
            const user = window.Telegram?.WebApp?.initDataUnsafe?.user;
            const userId = user?.id?.toString();
            init({ token: TG_ANALYTICS_TOKEN, appName: TG_ANALYTICS_APP_NAME, autotrack: true, debug: false });
            trackEvent('app_launch', { platform: navigator.platform, user_id: userId, theme: window.Telegram?.WebApp?.colorScheme, user_agent: navigator.userAgent.substring(0, 100) });
            trackView('main_screen');
            console.log('Telegram Analytics SDK initialized');
            window.TelegramAnalytics = { init, trackEvent, trackView };
          } catch (error) { console.error('Telegram Analytics SDK error:', error); }
        });
      }, 1000);
    };
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => { boot().catch(console.error); }); } else { boot().catch(console.error); }
  </script>
  <style>
    /* === –í–ê–® –ü–û–õ–ù–´–ô CSS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) === */
    :root { --bg: #0a0a0a; --panel: #111111; --border: #252525; --text: #ffffff; --muted: #a0a0a0; --accent: #7CFC00; --accent-rgb: 124, 252, 0; --chip: #1a1a1a; --danger: #ff4d4d; --success: #22c55e; --radius: 14px; --shadow: 0 10px 28px rgba(0,0,0,0.45); --shadow-soft: 0 6px 18px rgba(0,0,0,0.25); --input-bg: #0d0d0d; --result-bg: #0f0f0f; --pulse-color: var(--accent); --glass: rgba(255,255,255,0.03); --glass-strong: rgba(255,255,255,0.06); --blur: 10px; }
    html[data-theme="light"] { --bg: #f5f7fa; --panel: #ffffff; --border: #e1e5eb; --text: #1a1a1a; --muted: #666666; --accent: #2d8cff; --accent-rgb: 45, 140, 255; --chip: #f0f2f5; --danger: #ef4444; --success: #10b981; --shadow: 0 8px 24px rgba(0,0,0,0.08); --input-bg: #fafbfc; --result-bg: #f8f9fa; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, -apple-system, sans-serif; overflow-x: hidden; }
    body::before{ content:''; position: fixed; inset: -20%; pointer-events: none; z-index: -1; background: radial-gradient(900px 450px at 15% 15%, rgba(var(--accent-rgb),0.18), transparent 55%), radial-gradient(900px 450px at 85% 25%, rgba(var(--accent-rgb),0.10), transparent 55%), radial-gradient(900px 520px at 50% 90%, rgba(var(--accent-rgb),0.08), transparent 55%); }
    #app { min-height: 100vh; display: flex; flex-direction: column; }
    header { position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--panel); animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .leftbar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .lang { display: flex; gap: 4px; background: var(--chip); padding: 4px; border-radius: 8px; border: 1px solid var(--border); animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .lang button { background: transparent; border: none; color: var(--muted); padding: 4px 12px; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s ease; }
    .lang button.active { background: var(--accent); color: #000; transform: scale(1.05); box-shadow: 0 2px 8px rgba(124, 252, 0, 0.3); }
    .iconbtn { border: 1px solid var(--border); background: var(--chip); color: var(--text); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: all 0.3s ease; }
    .iconbtn:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    main { flex: 1; padding: 16px; padding-bottom: 80px; display: flex; flex-direction: column; gap: 16px; max-width: 1200px; margin: 0 auto; width: 100%; }
    .main-screen { display: none; animation: fadeIn 0.4s ease; }
    .main-screen.active { display: block; }
    .subtabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .subtab { background: var(--chip); border: 1px solid var(--border); color: var(--muted); font-size: 14px; padding: 8px 16px; cursor: pointer; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; }
    .subtab:hover { border-color: var(--accent); transform: translateY(-2px); }
    .subtab.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.05); box-shadow: 0 4px 12px rgba(124, 252, 0, 0.3); }
    .panels { display: flex; gap: 20px; flex-wrap: wrap; }
    .screen { display: none; width: 100%; animation: slideUp 0.4s ease; }
    @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .screen.active { display: block; }
    .card { background: linear-gradient(180deg, var(--glass-strong), rgba(255,255,255,0.00) 45%), var(--panel); backdrop-filter: blur(var(--blur)); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; transition: all 0.3s ease; animation: cardAppear 0.5s ease; }
    @keyframes cardAppear { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
    .card h3 { margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: var(--accent); position: relative; padding-left: 12px; }
    .card h3::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent); border-radius: 2px; }
    .field { margin-bottom: 12px; animation: fadeIn 0.5s ease; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 600; }
    input, select { width: 100%; padding: 10px 12px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; font-size: 14px; outline: none; transition: all 0.2s ease; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124, 252, 0, 0.1); }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 150px; }
    .result { margin-top: 8px; padding: 12px; border-radius: 8px; background: var(--result-bg); border: 1px solid var(--border); display: flex; gap: 12px; align-items: center; justify-content: space-between; transition: all 0.3s ease; animation: pulse 3.2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0.22); } 70% { box-shadow: 0 0 0 7px rgba(var(--accent-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0); } }
    .result .v { color: var(--accent); font-weight: 700; font-size: 16px; }
    .small { font-size: 11px; color: var(--muted); font-weight: 500; }
    .controls { display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap; }
    .btn { background: var(--accent); color: #000; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s ease; position: relative; overflow: hidden; }
    .btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 5px; height: 5px; background: rgba(255, 255, 255, 0.5); opacity: 0; border-radius: 100%; transform: scale(1, 1) translate(-50%); transform-origin: 50% 50%; }
    .btn:focus:not(:active)::after { animation: ripple 1s ease-out; }
    @keyframes ripple { 0% { transform: scale(0, 0); opacity: 0.5; } 100% { transform: scale(20, 20); opacity: 0; } }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn.ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
    .btn.ghost:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-2px); }
    .chips { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .chip { border: 1px solid var(--border); background: var(--chip); padding: 6px 12px; border-radius: 20px; cursor: pointer; color: var(--muted); font-size: 12px; font-weight: 600; transition: all 0.3s ease; }
    .chip:hover { border-color: var(--accent); transform: translateY(-2px); }
    .chip.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.1); box-shadow: 0 2px 8px rgba(124, 252, 0, 0.3); }
    .history { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; width: 100%; box-shadow: var(--shadow); transition: all 0.3s ease; }
    .history:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
    .history h4 { margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: var(--accent); }
    .history-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow: auto; }
    .hist-item { border: 1px solid var(--border); border-radius: 8px; padding: 12px; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; background: var(--chip); transition: all 0.3s ease; }
    .hist-item:hover { border-color: var(--accent); transform: translateX(4px); }
    .hist-item b { display: block; font-size: 13px; margin-bottom: 4px; }
    .hist-actions { display: flex; gap: 6px; }
    .mini { border: 1px solid var(--border); background: transparent; color: var(--muted); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s ease; }
    .mini:hover { border-color: var(--accent); color: var(--accent); transform: scale(1.05); }
    .support-wrap { display: flex; flex-direction: column; gap: 20px; align-items: center; padding: 20px; }
    .support-links { display: flex; gap: 20px; margin-top: 16px; }
    .support-links a { color: var(--accent); text-decoration: none; font-weight: 700; font-size: 14px; transition: all 0.3s ease; position: relative; padding: 8px 16px; border-radius: 8px; background: var(--chip); }
    .support-links a:hover { text-decoration: none; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); background: var(--accent); color: #000; }
    .ach-card .ach-summary{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin: 12px 0 8px; }
    .ach-progress{ flex: 1; min-width: 220px; }
    .ach-bar{ margin-top:8px; height:10px; border-radius:999px; border:1px solid var(--border); background: var(--result-bg); overflow:hidden; }
    #ach_bar_fill{ height:100%; width:0%; background: var(--accent); transition: width .35s ease; }
    .ach-list{ display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .ach-item{ border:1px solid var(--border); background: linear-gradient(180deg, var(--glass), transparent 55%), var(--chip); border-radius: 12px; padding: 12px; display:flex; align-items:flex-start; gap: 12px; transition: all .25s ease; }
    .ach-item:hover{ border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow-soft); }
    .ach-ico{ width: 38px; height: 38px; border-radius: 12px; display:flex; align-items:center; justify-content:center; font-size: 18px; background: rgba(var(--accent-rgb),0.12); border: 1px solid rgba(var(--accent-rgb),0.25); flex: 0 0 auto; }
    .ach-main{ flex:1; min-width: 160px; }
    .ach-title{ font-weight: 800; font-size: 13px; line-height: 1.2; }
    .ach-desc{ margin-top: 4px; font-size: 12px; color: var(--muted); font-weight: 550; line-height: 1.35; }
    .ach-pill{ flex: 0 0 auto; font-size: 11px; font-weight: 800; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: var(--result-bg); color: var(--muted); }
    .ach-pill.unlocked{ border-color: rgba(var(--accent-rgb),0.35); color: #000; background: var(--accent); }
    .bottomnav { position: fixed; left: 0; right: 0; bottom: 0; z-index: 100; padding: 12px 16px; border-top: 1px solid var(--border); background: var(--panel); display: flex; justify-content: center; animation: slideUp 0.4s ease; }
    .bottomnav .bar { width: min(400px, 100%); display: flex; gap: 12px; }
    .main-tab { flex: 1; border: 1px solid var(--border); background: var(--chip); color: var(--muted); border-radius: 8px; padding: 10px; cursor: pointer; font-weight: 600; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s ease; }
    .main-tab:hover { border-color: var(--accent); transform: translateY(-2px); }
    .main-tab.active { background: var(--accent); color: #000; border-color: var(--accent); transform: scale(1.05); box-shadow: 0 4px 12px rgba(124, 252, 0, 0.3); }
    #toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 100px; padding: 12px 20px; border-radius: 8px; background: var(--panel); color: var(--text); font-weight: 600; font-size: 13px; opacity: 0; pointer-events: none; z-index: 1000; border: 1px solid var(--border); box-shadow: var(--shadow); transition: all 0.3s ease; }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    #modal_backdrop { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 999; padding: 16px; animation: fadeIn 0.3s ease; }
    #modal { width: min(600px, 100%); border-radius: 12px; background: var(--panel); border: 1px solid var(--border); padding: 20px; box-shadow: var(--shadow); animation: scaleIn 0.3s ease; }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    #modal_header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    #modal_header b { font-size: 16px; font-weight: 700; color: var(--accent); }
    #modal_close { border: 1px solid var(--border); background: transparent; border-radius: 6px; color: var(--muted); padding: 6px 10px; cursor: pointer; font-size: 16px; transition: all 0.2s ease; }
    #modal_close:hover { border-color: var(--accent); color: var(--accent); transform: rotate(90deg); }
    #modal_body { display: flex; gap: 16px; flex-wrap: wrap; }
    #modal_canvas_wrap { flex: 1; min-width: 200px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: var(--result-bg); transition: all 0.3s ease; }
    #modal_canvas_wrap:hover { border-color: var(--accent); transform: translateY(-2px); }
    #card_canvas { display: block; width: 100%; height: 200px; }
    #modal_right { width: 200px; display: flex; flex-direction: column; gap: 8px; }
    #modal_right .btn { width: 100%; }
    #modal_help { font-size: 11px; color: var(--muted); font-weight: 500; text-align: center; }
    .vizgrid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 20px; }
    .viz { border: 1px solid var(--border); border-radius: 8px; padding: 16px; background: var(--chip); transition: all 0.3s ease; }
    .viz:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    .viz h5 { margin: 0 0 12px 0; font-size: 13px; color: var(--muted); font-weight: 600; }
    .viz canvas { width: 100%; height: 120px; display: block; }
    .color-picker { display: flex; gap: 8px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
    .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
    .color-option:hover { transform: scale(1.1); }
    .color-option.active { border-color: var(--text); transform: scale(1.2); box-shadow: 0 0 0 2px var(--accent); }
    .color-option.green { background: #7CFC00; }
    .color-option.blue { background: #2d8cff; }
    .color-option.purple { background: #9b59b6; }
    .color-option.orange { background: #ffa500; }
    .color-option.pink { background: #ff6b9d; }
    .color-option.teal { background: #2dd4bf; }
    .color-option.yellow { background: #fbbf24; }
    .color-option.red { background: #ef4444; }
    .floating { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    .glow { animation: glow 2s ease-in-out infinite alternate; }
    @keyframes glow { from { box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent); } to { box-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent); } }
    @media (max-width: 768px) { .panels { flex-direction: column; } .history { max-width: 100%; } .row > * { min-width: 100%; } #modal_body { flex-direction: column; } #modal_right { width: 100%; } }
    @media (max-width: 480px) { #main_premium .row{flex-direction:column;} #main_premium .row > button{width:100%;} .premium-actions{width:100%;} }
    @media (max-width: 480px) { .subtabs { justify-content: center; } .main-tab span { display: inline-flex !important; align-items: center; } .main-tab { padding: 8px 10px; font-size: 12px; gap: 6px; } .subtab span { display: inline !important; } }
    @media (max-width: 320px) { .main-tab { font-size: 11px; gap: 4px; padding: 6px 8px; } .main-tab span:last-child { max-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } }
    .premium-head{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;margin-bottom:12px}
    .premium-title h2{margin:8px 0 4px 0}
    .premium-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .premium-badge{display:inline-flex;gap:6px;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width: 760px){.grid2{grid-template-columns:1.2fr 1fr}}
    .plan{display:flex;flex-direction:column;gap:8px}
    .plan-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:rgba(var(--accent-rgb),.14);border:1px solid rgba(var(--accent-rgb),.22);font-weight:700}
    .checklist{margin:0;padding-left:18px}
    .checklist li{margin:6px 0}
    .note{margin-top:10px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.12);border:1px dashed rgba(255,255,255,.18)}
    .glass{backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px)}
    :root[data-premium-theme="neon"]{ --accent:#00ffd1; }
    :root[data-premium-theme="gold"]{ --accent:#ffd166; }
    :root[data-premium-theme="midnight"]{ --accent:#7c4dff; }
    .ach-item.locked{opacity:.55;filter:saturate(.6)}
    .iconbtn.active{box-shadow:0 0 0 2px rgba(var(--accent-rgb),.35) inset}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="leftbar">
      <button class="iconbtn" id="card_btn"><span>üÉè</span><span data-i18n="Card">Card</span></button>
      <button class="iconbtn" id="premium_btn"><span>üíé</span><span data-i18n="Premium">Premium</span></button>
      <button class="iconbtn" id="settings_btn"><span>‚öôÔ∏è</span><span data-i18n="Settings">Settings</span></button>
    </div>
  </header>
  <main>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω) -->
    <section id="main_calc" class="main-screen active">...</section>
    <!-- –≠–∫—Ä–∞–Ω Premium (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω) -->
    <section id="main_premium" class="main-screen">...</section>
    <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω) -->
    <section id="main_settings" class="main-screen">...</section>
    <!-- –≠–∫—Ä–∞–Ω –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω) -->
    <section id="main_support" class="main-screen">...</section>
  </main>
  <nav class="bottomnav">
    <div class="bar">
      <button id="main_tab_calc" class="main-tab active"><span>üßÆ</span><span data-i18n="Calculator">Calculator</span></button>
      <button id="main_tab_support" class="main-tab"><span>üí¨</span><span data-i18n="Support">Support</span></button>
    </div>
  </nav>
</div>
<div id="toast">‚Äî</div>
<div id="modal_backdrop"><div id="modal">...</div></div>

<script>
(async function(){
  'use strict';
  const tg = window.Telegram?.WebApp || null;
  if (tg) { tg.expand(); tg.ready(); }

  // ‚ö†Ô∏è –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Äî –Ω–æ–≤—ã–π URL –≤–∞—à–µ–≥–æ Worker
  const API_BASE = 'https://tg-stars-premium-worker.reserv-g123.workers.dev';

  // --- –°–µ—Ä–≤–µ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ä–∞–±–æ—á–µ–µ) ---
  const __mem = Object.create(null);
  let __loaded = false;
  let __saveTimer = null;

  function getInitData(){ return window.Telegram?.WebApp?.initData || ''; }

  async function fetchWithTimeout(url, options, ms){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), ms);
    try{ const res = await fetch(url, { ...options, signal: controller.signal }); return res; }
    finally { clearTimeout(t); }
  }

  async function loadServerStorage(){
    if (__loaded) return;
    const initData = getInitData();
    if (!initData) { __loaded = true; return; }
    try{
      const r = await fetchWithTimeout(`${API_BASE}/api/user/storage`, {
        method:'GET', headers:{ 'X-Telegram-Init-Data': initData }
      }, 2500);
      const j = await r.json().catch(()=>null);
      if (j?.ok && j.data && typeof j.data === 'object') Object.assign(__mem, j.data);
    }catch(e){ console.warn('Storage load skipped:', e?.name || e); }
    finally{ __loaded = true; }
  }

  function scheduleSave(){
    if (__saveTimer) clearTimeout(__saveTimer);
    __saveTimer = setTimeout(async () => {
      const initData = getInitData();
      if (!initData) return;
      try{
        await fetch(`${API_BASE}/api/user/storage`, {
          method:'POST', headers:{ 'content-type':'application/json', 'X-Telegram-Init-Data': initData },
          body: JSON.stringify(__mem)
        });
      }catch(e){ console.warn('Storage save failed', e); }
    }, 600);
  }

  const localStorage = {
    getItem(k){ return Object.prototype.hasOwnProperty.call(__mem, k) ? String(__mem[k]) : null; },
    setItem(k,v){ __mem[k] = String(v); scheduleSave(); },
    removeItem(k){ delete __mem[k]; scheduleSave(); }
  };

  const storageReady = loadServerStorage();

  // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–ª–∞–≤–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const mainCalc = document.getElementById('main_calc');
  const mainPremium = document.getElementById('main_premium');
  const mainSupport = document.getElementById('main_support');
  const mainSettings = document.getElementById('main_settings');
  const mainBtnCalc = document.getElementById('main_tab_calc');
  const mainBtnSupport = document.getElementById('main_tab_support');
  const premiumBtn = document.getElementById('premium_btn');
  const settingsBtn = document.getElementById('settings_btn');

  function setMainTab(which){
    mainCalc.classList.toggle('active', which === 'calc');
    mainPremium.classList.toggle('active', which === 'premium');
    mainSupport.classList.toggle('active', which === 'support');
    mainSettings.classList.toggle('active', which === 'settings');
    mainBtnCalc.classList.toggle('active', which === 'calc');
    mainBtnSupport.classList.toggle('active', which === 'support');
    premiumBtn.classList.toggle('active', which === 'premium');
    settingsBtn.classList.toggle('active', which === 'settings');
    if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('screen_view', { screen: which });
  }

  mainBtnCalc.addEventListener('click', () => setMainTab('calc'));
  mainBtnSupport.addEventListener('click', () => setMainTab('support'));
  premiumBtn.addEventListener('click', () => setMainTab('premium'));
  settingsBtn.addEventListener('click', () => setMainTab('settings'));

  // --- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–∏) ---
  const locales = { ru: { ... }, en: { ... } };
  let lang = 'en';
  try { const tgl = tg?.initDataUnsafe?.user?.language_code; if (tgl && tgl.startsWith('ru')) lang = 'ru'; } catch(e) {}
  function t(key) { const locale = locales[lang] || locales.en; return locale[key] || key; }
  function translateAll() { /* ... */ }
  let toastTimer = null;
  function showToast(msg) { /* ... */ }

  // --- Premium (—Å–µ—Ä–≤–µ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ localStorage, –Ω–æ —Å—Ç–∞—Ç—É—Å –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å) ---
  const PREMIUM_KEY = 'tc_premium_v1';
  function loadPremium(){ try{ const raw = localStorage.getItem(PREMIUM_KEY); if(!raw) return { lifetime:false, expiresAt:0, plan:'', tx:'' }; const obj = JSON.parse(raw); return Object.assign({ lifetime:false, expiresAt:0, plan:'', tx:'' }, obj); }catch(e){ return { lifetime:false, expiresAt:0, plan:'', tx:'' }; } }
  function savePremium(p){ localStorage.setItem(PREMIUM_KEY, JSON.stringify(p)); }
  function isPremiumActive(p){ return !!p && (p.lifetime || (p.expiresAt && Date.now() < p.expiresAt)); }
  function premiumStatusText(){ const p = loadPremium(); if (p.lifetime) return t('Premium lifetime'); if (p.expiresAt && Date.now() < p.expiresAt) { const d = new Date(p.expiresAt); return `${t('Premium active until')} ${d.toLocaleString()}`; } return t('Premium inactive'); }
  function renderPremiumStatus(){ const el = document.getElementById('premium_status_text'); if (el) el.textContent = premiumStatusText(); }

  // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º ‚Äî –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  async function refreshPremiumStatus() {
    try {
      const initData = getInitData();
      if (!initData) return;
      const resp = await fetch(`${API_BASE}/api/premium/status`, {
        headers: { 'X-Telegram-Init-Data': initData }
      });
      const data = await resp.json();
      if (data.ok) {
        if (data.lifetime) {
          activatePremiumLifetime('from_server', '');
        } else if (data.expiresAt) {
          const remaining = data.expiresAt - Date.now();
          if (remaining > 0) {
            activatePremiumDays(Math.ceil(remaining / 86400000), 'from_server', '');
          }
        } else {
          resetPremium();
        }
      }
    } catch (e) { console.warn('Failed to refresh premium status', e); }
  }

  function activatePremiumDays(days, plan, tx){ const p = loadPremium(); const now = Date.now(); p.lifetime = false; p.expiresAt = now + days * 86400000; p.plan = plan || `days_${days}`; p.tx = tx || ''; savePremium(p); renderPremiumStatus(); try{ onAchievementEvent('premium_user'); }catch(e){} showToast(t('Premium activated')); }
  function activatePremiumLifetime(plan, tx){ const p = loadPremium(); p.lifetime = true; p.expiresAt = 0; p.plan = plan || 'lifetime'; p.tx = tx || ''; savePremium(p); renderPremiumStatus(); try{ onAchievementEvent('premium_user'); }catch(e){} showToast(t('Premium activated')); }
  function resetPremium(){ localStorage.removeItem(PREMIUM_KEY); renderPremiumStatus(); showToast(t('Premium inactive')); }
  function requirePremium(reason){ const p = loadPremium(); if (isPremiumActive(p)) return true; showToast(`${t('Premium required')} ‚Ä¢ ${reason || ''}`.trim()); setMainTab('premium'); return false; }

  // --- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const ACH_KEY = 'tc_achievements_v1';
  function loadAchState() { try { const raw = localStorage.getItem(ACH_KEY); if (!raw) return { unlocked: {}, counters: {} }; const j = JSON.parse(raw); return { unlocked: j?.unlocked || {}, counters: j?.counters || {} }; } catch(e) { return { unlocked: {}, counters: {} }; } }
  function saveAchState(state) { try { localStorage.setItem(ACH_KEY, JSON.stringify(state)); } catch(e) {} }
  const achievements = [ /* –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ */ ];
  await storageReady;
  let achState = loadAchState();
  function isUnlocked(id) { return !!achState.unlocked[id]; }
  function unlockAchievement(id) { if (isUnlocked(id)) return false; achState.unlocked[id] = Date.now(); saveAchState(achState); renderAchievements(); const a = achievements.find(x => x.id === id); showToast(`${t('Achievement unlocked')}: ${t(a?.titleKey || id)}`); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('achievement_unlocked', { id }); return true; }
  function incCounter(name, by = 1) { achState.counters[name] = (Number(achState.counters[name]) || 0) + by; saveAchState(achState); }
  function checkCounters() { achievements.forEach(a => { if (a.type !== 'count') return; const v = Number(achState.counters[a.counter]) || 0; if (v >= a.need) unlockAchievement(a.id); }); }
  function onAchievementEvent(evt) { /* ... */ checkCounters(); }
  function renderAchievements() { /* ... */ }
  function resetAchievements() { achState = { unlocked: {}, counters: {} }; saveAchState(achState); renderAchievements(); }

  // --- –¢–µ–º–∞ –∏ —Ü–≤–µ—Ç (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const THEME_KEY = 'tc_theme';
  function getInitialTheme() { const saved = localStorage.getItem(THEME_KEY); if (saved === 'dark' || saved === 'light') return saved; const tgScheme = (tg?.colorScheme || '').toLowerCase(); return tgScheme === 'light' ? 'light' : 'dark'; }
  function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); localStorage.setItem(THEME_KEY, theme); document.getElementById('theme_icon').textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô'; document.getElementById('theme_text').textContent = t(theme === 'light' ? 'Light' : 'Dark'); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('theme_changed', { theme: theme }); onAchievementEvent('theme_changed'); }
  setTheme(getInitialTheme());
  document.getElementById('theme_toggle').addEventListener('click', () => { const current = document.documentElement.getAttribute('data-theme'); setTheme(current === 'dark' ? 'light' : 'dark'); });
  const COLOR_KEY = 'tc_accent_color';
  const colorOptions = document.querySelectorAll('.color-option');
  function setAccentColor(color) { /* ... */ onAchievementEvent('color_changed'); }
  const savedColor = localStorage.getItem(COLOR_KEY) || '#7CFC00';
  setAccentColor(savedColor);
  colorOptions.forEach(option => { option.addEventListener('click', () => { setAccentColor(option.dataset.color); }); });

  // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
  function safeNum(v) { const x = parseFloat(v); return isFinite(x) ? x : 0; }
  function fmt(v, digits = 8) { if (v === null || v === undefined || !isFinite(v)) return '‚Äî'; const n = Number(v); const abs = Math.abs(n); const d = abs >= 1000 ? 2 : (abs >= 1 ? 6 : digits); return n.toLocaleString(undefined, {maximumFractionDigits: d}); }

  // --- –Ø–∑—ã–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ ---
  const btnRu = document.getElementById('btn_ru');
  const btnEn = document.getElementById('btn_en');
  function syncLangButtons() { btnRu.classList.toggle('active', lang === 'ru'); btnEn.classList.toggle('active', lang === 'en'); }
  syncLangButtons();
  btnRu.addEventListener('click', () => { lang = 'ru'; syncLangButtons(); translateAll(); renderAchievements(); renderHistory(); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('language_changed', { language: 'ru' }); onAchievementEvent('language_changed'); });
  btnEn.addEventListener('click', () => { lang = 'en'; syncLangButtons(); translateAll(); renderAchievements(); renderHistory(); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('language_changed', { language: 'en' }); onAchievementEvent('language_changed'); });

  // --- –ü–æ–¥—Ç–∞–±—ã –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  document.querySelectorAll('.subtab').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.subtab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); const target = btn.dataset.tab; document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(target).classList.add('active'); if (target === 'ind' && !lastIndicators) fetchIndicators(); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('tab_switched', { tab: target }); }); });
  function activeTab() { const act = document.querySelector('.subtab.active'); return act?.dataset?.tab || 'dca'; }

  // --- DCA (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω) ---
  const dcaRowsEl = document.getElementById('dca_rows');
  const dcaAvgEl = document.getElementById('dca_avg');
  const dcaTotalVolEl = document.getElementById('dca_total_vol');
  const dcaTotalCostEl = document.getElementById('dca_total_cost');
  const dcaGoal = document.getElementById('dca_goal');
  const dcaNext = document.getElementById('dca_next_price');
  const dcaNeedVol = document.getElementById('dca_need_vol');
  let dcaRows = [];
  function addDcaRow(p = 0, v = 0) { /* ... */ }
  function clearDCA() { dcaRows = []; dcaRowsEl.innerHTML = ''; addDcaRow(); addDcaRow(); dcaGoal.value = ''; dcaNext.value = ''; calcDCA(); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('dca_cleared'); }
  function calcDCA() { /* ... */ }
  document.getElementById('dca_add').addEventListener('click', () => { addDcaRow(); onAchievementEvent('dca_add'); });
  document.getElementById('dca_clear').addEventListener('click', clearDCA);
  dcaGoal.addEventListener('input', calcDCA);
  dcaNext.addEventListener('input', calcDCA);

  // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  function saveCalculationToHistory(type, summary) { const arr = loadHistory(); arr.unshift({ t: Date.now(), type: type, summary: summary }); if (arr.length > 50) arr.length = 50; saveHistory(arr); renderHistory(); onAchievementEvent('history_saved'); showToast(t('Saved to history')); }
  document.getElementById('dca_save').addEventListener('click', () => { const summary = `DCA: Avg ${dcaAvgEl.textContent}, Vol ${dcaTotalVolEl.textContent}, Cost ${dcaTotalCostEl.textContent}`; saveCalculationToHistory('DCA', summary); });
  document.getElementById('rr_save').addEventListener('click', () => { const summary = `R/R: Gross ${rrGross.textContent}, Net ${rrNet.textContent} (Entry: ${rrEntry.value}, SL: ${rrSl.value}, TP: ${rrTp.value}, Fee: ${rrFee.value}%)`; saveCalculationToHistory('R/R', summary); });
  document.getElementById('cap_save').addEventListener('click', () => { const summary = `Capital: Pos ${capPos.textContent}, Risk $${capRiskUsd.textContent}, Margin $${capMargin.textContent}`; saveCalculationToHistory('Capital', summary); });

  // --- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  async function copyText(text) { if (!text || text === '‚Äî') return false; try { await navigator.clipboard.writeText(String(text)); return true; } catch (e) { return false; } }
  function bindCopy(btn, getVal, getSummary = null) { btn.addEventListener('click', async () => { const val = getVal(); const ok = await copyText(val); if (ok) { showToast(t('Copied!')); onAchievementEvent('value_copied'); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('value_copied', { value: val.substring(0, 30) }); } }); }
  bindCopy(document.getElementById('dca_copy'), () => dcaAvgEl.textContent);
  bindCopy(document.getElementById('dca_need_copy'), () => dcaNeedVol.textContent);

  // --- R/R (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const rrEntry = document.getElementById('rr_entry');
  const rrSl = document.getElementById('rr_sl');
  const rrTp = document.getElementById('rr_tp');
  const rrFee = document.getElementById('rr_fee');
  const rrGross = document.getElementById('rr_gross');
  const rrNet = document.getElementById('rr_net');
  function calcRR() { /* ... */ }
  [rrEntry, rrSl, rrTp, rrFee].forEach(x => x.addEventListener('input', calcRR));
  bindCopy(document.getElementById('rr_copy_gross'), () => rrGross.textContent);
  bindCopy(document.getElementById('rr_copy_net'), () => rrNet.textContent);

  // --- Capital (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const capDep = document.getElementById('cap_dep');
  const capRisk = document.getElementById('cap_risk');
  const capLev = document.getElementById('cap_lev');
  const capEntry = document.getElementById('cap_entry');
  const capSl = document.getElementById('cap_sl');
  const capFee = document.getElementById('cap_fee');
  const capPos = document.getElementById('cap_pos');
  const capRiskUsd = document.getElementById('cap_risk_usd');
  const capMargin = document.getElementById('cap_margin');
  document.querySelectorAll('.chip[data-risk]').forEach(ch => { ch.addEventListener('click', () => { document.querySelectorAll('.chip[data-risk]').forEach(x => x.classList.remove('active')); ch.classList.add('active'); capRisk.value = ch.dataset.risk; calcCap(); }); });
  function calcCap() { /* ... */ }
  [capDep, capRisk, capLev, capEntry, capSl, capFee].forEach(x => x.addEventListener('input', calcCap));
  bindCopy(document.getElementById('cap_copy_pos'), () => capPos.textContent);

  // --- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const fgText = document.getElementById('fg_text');
  const tcapText = document.getElementById('tcap_text');
  const altText = document.getElementById('alt_text');
  const moodEl = document.getElementById('mood');
  const indNote = document.getElementById('ind_note');
  let lastIndicators = null;
  const IND_CACHE_KEY = 'tc_ind_cache';
  function saveIndicatorsCache(data) { try { localStorage.setItem(IND_CACHE_KEY, JSON.stringify({ t: Date.now(), data })); } catch(e) {} }
  function loadIndicatorsCache() { try { const raw = localStorage.getItem(IND_CACHE_KEY); if (!raw) return null; const j = JSON.parse(raw); return j; } catch(e) { return null; } }
  function computeMood(fgValue) { if (!isFinite(fgValue)) return '‚Äî'; if (fgValue >= 70) return lang === 'ru' ? '–ñ–∞–¥–Ω–æ—Å—Ç—å' : 'Greed'; if (fgValue <= 30) return lang === 'ru' ? '–°—Ç—Ä–∞—Ö' : 'Fear'; return lang === 'ru' ? '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' : 'Neutral'; }
  async function fetchIndicators() { /* ... */ }
  function drawGauge(canvas, value) { /* ... */ }
  function drawDonutSplit(canvas, btcDom) { /* ... */ }
  function drawAllIndicatorVisuals(data) { /* ... */ }
  const cached = loadIndicatorsCache();
  if (cached?.data) { lastIndicators = cached.data; fgText.textContent = isFinite(lastIndicators.fgVal) ? `${lastIndicators.fgVal} ¬∑ ${lastIndicators.fgClass}` : '‚Äî'; tcapText.textContent = isFinite(lastIndicators.totalMc) ? '$' + Number(lastIndicators.totalMc).toLocaleString() : '‚Äî'; altText.textContent = isFinite(lastIndicators.altDom) ? lastIndicators.altDom.toFixed(2) + '%' : '‚Äî'; moodEl.textContent = computeMood(lastIndicators.fgVal); indNote.textContent = t('Cached data'); drawAllIndicatorVisuals(lastIndicators); }
  document.getElementById('refresh_ind').addEventListener('click', fetchIndicators);

  // --- –ò—Å—Ç–æ—Ä–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const HISTORY_KEY = 'tc_history';
  function loadHistory() { try { return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; } catch(e) { return []; } }
  function saveHistory(arr) { try { localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); } catch(e) {} }
  function renderHistory() { /* ... */ }

  // --- –°—Å—ã–ª–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  document.getElementById('open_terms').addEventListener('click', () => { window.open('/terms.html', '_blank'); });
  document.getElementById('open_privacy').addEventListener('click', () => { window.open('/privacy.html', '_blank'); });
  document.getElementById('open_support').addEventListener('click', () => { window.open('https://t.me/ChalovSupportBot', '_blank'); });
  document.getElementById('link_telegram').addEventListener('click', (e) => { e.preventDefault(); window.open('https://t.me/ChalovCrypto', '_blank'); });
  document.getElementById('link_youtube').addEventListener('click', (e) => { e.preventDefault(); window.open('https://www.youtube.com/@ChalovCrypto', '_blank'); });

  // --- –ú–æ–¥–∞–ª–∫–∞ Trade Card (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
  const modalBackdrop = document.getElementById('modal_backdrop');
  const modalClose = document.getElementById('modal_close');
  const cardCanvas = document.getElementById('card_canvas');
  const btnSave = document.getElementById('card_save');
  const btnCopyImg = document.getElementById('card_copy');
  function openModal() { modalBackdrop.style.display = 'flex'; }
  function closeModal() { modalBackdrop.style.display = 'none'; }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => { if (e.target === modalBackdrop) closeModal(); });
  function drawCard() { /* ... */ }
  function saveCardUniversal() { /* ... */ }
  btnSave.addEventListener('click', saveCardUniversal);
  btnCopyImg.addEventListener('click', async () => { cardCanvas.toBlob(async (blob) => { try { await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]); showToast(t('Copied!')); if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('card_copied'); } catch (e) { saveCardUniversal(); } }, 'image/png'); });
  document.getElementById('card_btn').addEventListener('click', () => { drawCard(); openModal(); onAchievementEvent('card_opened'); });

  // --- TON Connect (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ payTonPlan) ---
  const TONCONNECT_MANIFEST_URL = 'https://trade-calculator-five.vercel.app/tonconnect-manifest.json';
  const TIP_ADDRESS = 'UQD04FKshVmZaQjZq9y2AtBXWklkzQfK4sEJWrsYfqbNHGGz';
  let tonConnectUI = null;
  function initTonConnect() {
    try {
      if (!window.TON_CONNECT_UI?.TonConnectUI) return;
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({ manifestUrl: TONCONNECT_MANIFEST_URL });
      tonConnectUI.onStatusChange(() => { updateWalletUI(); });
      updateWalletUI();
    } catch(e) { console.error('TON Connect init error:', e); }
  }
  function updateWalletUI() {
    const wBtn = document.getElementById('wallet_btn');
    const tipBtn = document.getElementById('tip_btn');
    if (!tonConnectUI) { wBtn.disabled = true; tipBtn.disabled = true; return; }
    wBtn.disabled = false;
    tipBtn.disabled = !tonConnectUI.connected;
    if (tonConnectUI.connected) { const addr = tonConnectUI.account?.address || ''; wBtn.textContent = addr.slice(0, 6) + '...' + addr.slice(-4); }
    else { wBtn.textContent = t('Connect Wallet'); }
  }
  document.getElementById('wallet_btn').addEventListener('click', async () => {
    if (!tonConnectUI) return;
    if (tonConnectUI.connected) { const confirm = window.confirm(t('Disconnect wallet?')); if (confirm) { await tonConnectUI.disconnect(); updateWalletUI(); } }
    else { await tonConnectUI.openModal(); }
    if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('wallet_action', { action: tonConnectUI.connected ? 'disconnect' : 'connect_attempt' });
  });
  document.getElementById('tip_btn').addEventListener('click', async () => {
    if (!tonConnectUI?.connected) { showToast(t('Connect wallet first')); return; }
    try {
      const tx = { validUntil: Math.floor(Date.now() / 1000) + 600, messages: [{ address: TIP_ADDRESS, amount: '50000000' }] };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('Transaction sent'));
      onAchievementEvent('tip_sent');
      if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('tip_sent');
    } catch(e) { showToast(t('Error')); }
  });
  initTonConnect();

  document.getElementById('premium_back_btn').addEventListener('click', () => setMainTab('calc'));
  document.querySelectorAll('[data-premium-theme]').forEach(btn => {
    btn.addEventListener('click', () => {
      const theme = btn.getAttribute('data-premium-theme');
      if (!requirePremium(t('Premium Themes'))) return;
      document.documentElement.setAttribute('data-premium-theme', theme);
      localStorage.setItem('tc_premium_theme', theme);
      try{ onAchievementEvent('premium_theme_applied'); }catch(e){}
      showToast(`${t('Premium Themes')}: ${theme}`);
    });
  });
  try { const savedTheme = localStorage.getItem('tc_premium_theme'); if (savedTheme) document.documentElement.setAttribute('data-premium-theme', savedTheme); } catch(e){}

  // --- TON Premium ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º order.receiver –∏ order.amountNano ---
  async function createTonOrder(plan){
    const initData = getInitData();
    if (!initData) throw new Error('no_initdata');
    const resp = await fetch(`${API_BASE}/api/ton/order?plan=${encodeURIComponent(plan)}`, {
      method:'GET',
      headers:{ 'X-Telegram-Init-Data': initData }
    });
    const data = await resp.json();
    if (!data?.ok) throw new Error(data?.error || 'order_failed');
    return data;
  }
  async function confirmTonOrder(orderId){
    const initData = getInitData();
    if (!initData) throw new Error('no_initdata');
    const resp = await fetch(`${API_BASE}/api/ton/confirm`, {
      method:'POST',
      headers:{ 'content-type':'application/json', 'X-Telegram-Init-Data': initData },
      body: JSON.stringify({ orderId })
    });
    const data = await resp.json();
    if (!data?.ok) throw new Error(data?.error || 'confirm_failed');
    return data;
  }
  async function payTonPlan(plan){
    if (!tonConnectUI?.connected) { showToast(t('Connect wallet first')); return; }
    try{
      const order = await createTonOrder(plan);
      const tx = {
        validUntil: order.validUntil,
        messages: [{
          address: order.receiver,    // ‚úÖ –ø–æ–ª–µ receiver, –Ω–µ to
          amount: order.amountNano    // ‚úÖ —Å—Ç—Ä–æ–∫–∞ —Å –Ω–∞–Ω–æ-—Å—É–º–º–æ–π
        }]
      };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('Transaction sent'));

      try{
        const res = await confirmTonOrder(order.orderId);
        if (res.granted) {
          showToast(t('Premium activated'));
          await refreshPremiumStatus();
        } else {
          showToast(t('Waiting for confirmation'));
          window.__lastTonOrderId = order.orderId;
        }
      }catch(e){
        window.__lastTonOrderId = order.orderId;
        showToast(t('Waiting for confirmation'));
      }
    }catch(e){
      console.error(e);
      showToast(t('Error'));
    }
  }
  const tonCheckBtn = document.getElementById('ton_check_btn');
  if (tonCheckBtn){
    tonCheckBtn.addEventListener('click', async () => {
      const orderId = window.__lastTonOrderId;
      if (!orderId) { showToast(t('No pending payment')); return; }
      try{
        const res = await confirmTonOrder(orderId);
        if (res.granted) {
          showToast(t('Premium activated'));
          await refreshPremiumStatus();
          window.__lastTonOrderId = null;
        } else { showToast(t('Waiting for confirmation')); }
      }catch(e){ showToast(t('Waiting for confirmation')); }
    });
  }
  document.getElementById('pay_ton_30').addEventListener('click', () => payTonPlan('ton_30d'));
  document.getElementById('pay_ton_life').addEventListener('click', () => payTonPlan('ton_lifetime'));

  // --- Stars Premium (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–∞–±–æ—á–∞—è initData) ---
  async function openStarsInvoice(plan){
    if (!tg || !tg.openInvoice) { showToast('tg.openInvoice not available'); return; }
    const initData = getInitData();
    if (!initData) { showToast('No initData (open inside Telegram)'); return; }
    try{
      const resp = await fetch(`${API_BASE}/api/stars/invoice?plan=${encodeURIComponent(plan)}`, {
        method:'GET',
        headers:{ 'X-Telegram-Init-Data': initData }
      });
      const text = await resp.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}
      if (!resp.ok) { showToast(`API ${resp.status}: ${data?.error || text}`); return; }
      if (!data?.ok || !data.url) { showToast(`API: ${data?.error || text || 'bad response'}`); return; }
      tg.openInvoice(data.url, async (status) => {
        showToast(`Invoice status: ${status}`);
        if (status === 'paid') { await refreshPremiumStatus(); }
      });
    }catch(e){ console.error(e); showToast(`Exception: ${e?.message || e}`); }
  }
  document.getElementById('pay_stars_30').addEventListener('click', () => openStarsInvoice('stars_30d'));
  document.getElementById('pay_stars_life').addEventListener('click', () => openStarsInvoice('stars_lifetime'));

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
  renderPremiumStatus();
  translateAll();
  if (!isUnlocked('first_launch')) unlockAchievement('first_launch');
  renderAchievements();
  clearDCA();
  calcRR();
  calcCap();
  renderHistory();
  if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('app_loaded');
})();
</script>
</body>
</html>
