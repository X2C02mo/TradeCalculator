<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trader Calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
  <script type="module">
    import { init, trackEvent, trackView } from 'https://esm.sh/@telegram-apps/analytics';
    const TG_ANALYTICS_TOKEN = "eyJhcHBfbmFtZSI6InRyYWRlcl9jYWxjdWxhdG9yIiwiYXBwX3VybCI6Imh0dHBzOi8vdC5tZS9DYWxjdWxhdG9yVHJhZGVyQm90IiwiYXBwX2RvbWFpbiI6Imh0dHBzOi8vdHJhZGUtY2FsY3VsYXRvci1maXZlLnZlcmNlbC5hcHAifQ==!+ZTX3Nk0y5cUIMvJ8jWfv22EWL8UPctpRGiFct3mBr0=";
    const TG_ANALYTICS_APP_NAME = "trader_calculator";
    document.addEventListener('DOMContentLoaded', () => {
      try {
        init({
          token: TG_ANALYTICS_TOKEN,
          appName: TG_ANALYTICS_APP_NAME,
          autotrack: true,
          debug: false
        });
        trackEvent('app_launch', {
          platform: navigator.platform,
          userAgent: navigator.userAgent.substring(0, 100)
        });
        trackView('main_screen');
        console.log('Telegram Analytics SDK initialized');
      } catch (error) {
        console.error('Telegram Analytics SDK error:', error);
      }
    });
    window.TelegramAnalytics = { init, trackEvent, trackView };
  </script>
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #111111;
      --border: #252525;
      --text: #ffffff;
      --muted: #a0a0a0;
      --accent: #7CFC00;
      --chip: #1a1a1a;
      --danger: #ff4d4d;
      --success: #22c55e;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
      --input-bg: #0d0d0d;
      --result-bg: #0f0f0f;
      --pulse-color: var(--accent);
    }
    html[data-theme="light"] {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --border: #e1e5eb;
      --text: #1a1a1a;
      --muted: #666666;
      --accent: #2d8cff;
      --chip: #f0f2f5;
      --danger: #ef4444;
      --success: #10b981;
      --shadow: 0 8px 24px rgba(0,0,0,0.08);
      --input-bg: #fafbfc;
      --result-bg: #f8f9fa;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }
    #app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      animation: slideDown 0.3s ease;
    }
    @keyframes slideDown {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .leftbar {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .lang {
      display: flex;
      gap: 4px;
      background: var(--chip);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid var(--border);
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .lang button {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 4px 12px;
      cursor: pointer;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .lang button.active {
      background: var(--accent);
      color: #000;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(124, 252, 0, 0.3);
    }
    .iconbtn {
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
    }
    .iconbtn:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    main {
      flex: 1;
      padding: 16px;
      padding-bottom: 80px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }
    .main-screen {
      display: none;
      animation: fadeIn 0.4s ease;
    }
    .main-screen.active {
      display: block;
    }
    .subtabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .subtab {
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .subtab:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .subtab.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(124, 252, 0, 0.3);
    }
    .panels {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .screen {
      display: none;
      width: 100%;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .screen.active {
      display: block;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      transition: all 0.3s ease;
      animation: cardAppear 0.5s ease;
    }
    @keyframes cardAppear {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    }
    .card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      position: relative;
      padding-left: 12px;
    }
    .card h3::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent);
      border-radius: 2px;
    }
    .field {
      margin-bottom: 12px;
      animation: fadeIn 0.5s ease;
    }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s ease;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 252, 0, 0.1);
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .row > * {
      flex: 1;
      min-width: 150px;
    }
    .result {
      margin-top: 8px;
      padding: 12px;
      border-radius: 8px;
      background: var(--result-bg);
      border: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(124, 252, 0, 0.2); }
      70% { box-shadow: 0 0 0 6px rgba(124, 252, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(124, 252, 0, 0); }
    }
    .result .v {
      color: var(--accent);
      font-weight: 700;
      font-size: 16px;
    }
    .small {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    .btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn.ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-2px);
    }
    .chips {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .chip {
      border: 1px solid var(--border);
      background: var(--chip);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .chip:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .chip.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(124, 252, 0, 0.3);
    }
    .history {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      width: 100%;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    .history:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.3);
    }
    .history h4 {
      margin: 0 0 12px 0;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow: auto;
    }
    .hist-item {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      background: var(--chip);
      transition: all 0.3s ease;
    }
    .hist-item:hover {
      border-color: var(--accent);
      transform: translateX(4px);
    }
    .hist-item b {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .hist-actions {
      display: flex;
      gap: 6px;
    }
    .mini {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .mini:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: scale(1.05);
    }
    .support-wrap {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
      padding: 20px;
    }
    .support-links {
      display: flex;
      gap: 20px;
      margin-top: 16px;
    }
    .support-links a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--chip);
    }
    .support-links a:hover {
      text-decoration: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      background: var(--accent);
      color: #000;
    }
    .bottomnav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--panel);
      display: flex;
      justify-content: center;
      animation: slideUp 0.4s ease;
    }
    .bottomnav .bar {
      width: min(400px, 100%);
      display: flex;
      gap: 12px;
    }
    .main-tab {
      flex: 1;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    .main-tab:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .main-tab.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(124, 252, 0, 0.3);
    }
    #toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100px;
      padding: 12px 20px;
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      z-index: 1000;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px);
    }
    #modal_backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
      animation: fadeIn 0.3s ease;
    }
    #modal {
      width: min(600px, 100%);
      border-radius: 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: var(--shadow);
      animation: scaleIn 0.3s ease;
    }
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    #modal_header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    #modal_header b {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }
    #modal_close {
      border: 1px solid var(--border);
      background: transparent;
      border-radius: 6px;
      color: var(--muted);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    #modal_close:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: rotate(90deg);
    }
    #modal_body {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    #modal_canvas_wrap {
      flex: 1;
      min-width: 200px;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--result-bg);
      transition: all 0.3s ease;
    }
    #modal_canvas_wrap:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    #card_canvas {
      display: block;
      width: 100%;
      height: 200px;
    }
    #modal_right {
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #modal_right .btn {
      width: 100%;
    }
    #modal_help {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
      text-align: center;
    }
    .vizgrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 20px;
    }
    .viz {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      background: var(--chip);
      transition: all 0.3s ease;
    }
    .viz:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    .viz h5 {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    .viz canvas {
      width: 100%;
      height: 120px;
      display: block;
    }
    .color-picker {
      display: flex;
      gap: 8px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    .color-option.active {
      border-color: var(--text);
      transform: scale(1.2);
      box-shadow: 0 0 0 2px var(--accent);
    }
    .color-option.green { background: #7CFC00; }
    .color-option.blue { background: #2d8cff; }
    .color-option.purple { background: #9b59b6; }
    .color-option.orange { background: #ffa500; }
    .color-option.pink { background: #ff6b9d; }
    .color-option.teal { background: #2dd4bf; }
    .color-option.yellow { background: #fbbf24; }
    .color-option.red { background: #ef4444; }
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    .glow {
      animation: glow 2s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent); }
      to { box-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent); }
    }
    @media (max-width: 768px) {
      .panels {
        flex-direction: column;
      }
      .history {
        max-width: 100%;
      }
      .row > * {
        min-width: 100%;
      }
      #modal_body {
        flex-direction: column;
      }
      #modal_right {
        width: 100%;
      }
    }
    @media (max-width: 480px) {
      .subtabs {
        justify-content: center;
      }
      .main-tab span {
        display: inline-flex !important;
        align-items: center;
      }
      .main-tab {
        padding: 8px 10px;
        font-size: 12px;
        gap: 6px;
      }
      .subtab span {
        display: inline !important;
      }
    }
    @media (max-width: 320px) {
      .main-tab {
        font-size: 11px;
        gap: 4px;
        padding: 6px 8px;
      }
      .main-tab span:last-child {
        max-width: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru">RU</button>
        <button id="btn_en" class="active">EN</button>
      </div>
      <button class="iconbtn" id="theme_toggle">
        <span id="theme_icon">üåô</span>
        <span id="theme_text">Dark</span>
      </button>
      <button class="iconbtn" id="share_btn">
        <span>üì§</span>
        <span data-i18n="Share">Share</span>
      </button>
      <button class="iconbtn" id="card_btn">
        <span>üÉè</span>
        <span data-i18n="Card">Card</span>
      </button>
    </div>
  </header>
  <main>
    <section id="main_calc" class="main-screen active">
      <div class="subtabs">
        <button class="subtab active" data-tab="dca">
          <span>üìä</span>
          <span data-i18n="DCA">DCA</span>
        </button>
        <button class="subtab" data-tab="rr">
          <span>‚öñÔ∏è</span>
          <span data-i18n="R/R">R/R</span>
        </button>
        <button class="subtab" data-tab="cap">
          <span>üí∞</span>
          <span data-i18n="Capital">Capital</span>
        </button>
        <button class="subtab" data-tab="ind">
          <span>üìà</span>
          <span data-i18n="Indicators">Indicators</span>
        </button>
      </div>
      <div class="panels">
        <section id="dca" class="screen active">
          <div class="card floating">
            <h3 data-i18n="DCA Calculator">DCA Calculator</h3>
            <div class="small" style="margin-bottom:12px" data-i18n="Add multiple entries to calculate average price, total volume and cost.">
              Add multiple entries to calculate average price, total volume and cost.
            </div>
            <div id="dca_rows"></div>
            <div class="controls">
              <button class="btn" id="dca_add" data-i18n="Add entry">Add entry</button>
              <button class="btn ghost" id="dca_clear" data-i18n="Clear">Clear</button>
            </div>
            <div class="result">
              <div>
                <div class="small" data-i18n="Average price">Average price</div>
                <div><span class="v" id="dca_avg">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="dca_copy" data-i18n="Copy">Copy</button>
            </div>
            <div class="row">
              <div class="result">
                <div>
                  <div class="small" data-i18n="Total volume">Total volume</div>
                  <div><span class="v" id="dca_total_vol">‚Äî</span></div>
                </div>
              </div>
              <div class="result">
                <div>
                  <div class="small" data-i18n="Total cost">Total cost</div>
                  <div><span class="v" id="dca_total_cost">‚Äî</span></div>
                </div>
              </div>
            </div>
            <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                <b style="color:var(--accent);font-weight:700" data-i18n="DCA Goal">DCA Goal</b>
                <span class="small" data-i18n="optional">optional</span>
              </div>
              <div class="row">
                <div class="field">
                  <label data-i18n="Target avg price">Target avg price</label>
                  <input id="dca_goal" type="number" step="any" />
                </div>
                <div class="field">
                  <label data-i18n="Next buy price">Next buy price</label>
                  <input id="dca_next_price" type="number" step="any" />
                </div>
              </div>
              <div class="result">
                <div>
                  <div class="small" data-i18n="Needed volume at next price">Needed volume at next price</div>
                  <div><span class="v" id="dca_need_vol">‚Äî</span></div>
                </div>
                <button class="btn ghost" id="dca_need_copy" data-i18n="Copy">Copy</button>
              </div>
            </div>
          </div>
        </section>
        <section id="rr" class="screen">
          <div class="card">
            <h3 data-i18n="Risk/Reward">Risk/Reward</h3>
            <div class="row">
              <div class="field">
                <label data-i18n="Entry">Entry</label>
                <input id="rr_entry" type="number" step="any" />
              </div>
              <div class="field">
                <label data-i18n="Stop Loss">Stop Loss</label>
                <input id="rr_sl" type="number" step="any" />
              </div>
              <div class="field">
                <label data-i18n="Take Profit">Take Profit</label>
                <input id="rr_tp" type="number" step="any" />
              </div>
            </div>
            <div class="field">
              <label data-i18n="Fee % (entry+exit)">Fee % (entry+exit)</label>
              <input id="rr_fee" type="number" step="any" value="0.2" />
            </div>
            <div class="result">
              <div>
                <div class="small" data-i18n="Gross R/R">Gross R/R</div>
                <div><span class="v" id="rr_gross">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="rr_copy_gross" data-i18n="Copy">Copy</button>
            </div>
            <div class="result">
              <div>
                <div class="small" data-i18n="Net R/R (with fees)">Net R/R (with fees)</div>
                <div><span class="v" id="rr_net">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="rr_copy_net" data-i18n="Copy">Copy</button>
            </div>
          </div>
        </section>
        <section id="cap" class="screen">
          <div class="card">
            <h3 data-i18n="Capital Management">Capital Management</h3>
            <div class="row">
              <div class="field">
                <label data-i18n="Deposit">Deposit</label>
                <input id="cap_dep" type="number" step="any" />
              </div>
              <div class="field">
                <label data-i18n="Risk %">Risk %</label>
                <input id="cap_risk" type="number" step="any" value="1" />
              </div>
              <div class="field">
                <label data-i18n="Leverage">Leverage</label>
                <input id="cap_lev" type="number" step="any" value="1" />
              </div>
            </div>
            <div class="chips">
              <button class="chip" data-risk="0.5">0.5%</button>
              <button class="chip active" data-risk="1">1%</button>
              <button class="chip" data-risk="2">2%</button>
              <button class="chip" data-risk="3">3%</button>
            </div>
            <div class="row">
              <div class="field">
                <label data-i18n="Entry">Entry</label>
                <input id="cap_entry" type="number" step="any" />
              </div>
              <div class="field">
                <label data-i18n="Stop Loss">Stop Loss</label>
                <input id="cap_sl" type="number" step="any" />
              </div>
              <div class="field">
                <label data-i18n="Fee % (entry+exit)">Fee % (entry+exit)</label>
                <input id="cap_fee" type="number" step="any" value="0.2" />
              </div>
            </div>
            <div class="result">
              <div>
                <div class="small" data-i18n="Position size">Position size</div>
                <div><span class="v" id="cap_pos">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="cap_copy_pos" data-i18n="Copy">Copy</button>
            </div>
            <div class="row">
              <div class="result">
                <div>
                  <div class="small" data-i18n="Risk $">Risk $</div>
                  <div><span class="v" id="cap_risk_usd">‚Äî</span></div>
                </div>
              </div>
              <div class="result">
                <div>
                  <div class="small" data-i18n="Margin (with leverage)">Margin (with leverage)</div>
                  <div><span class="v" id="cap_margin">‚Äî</span></div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <section id="ind" class="screen">
          <div class="card">
            <h3 data-i18n="Market Indicators">Market Indicators</h3>
            <div class="row">
              <div class="field">
                <label data-i18n="Fear & Greed Index">Fear & Greed Index</label>
                <div class="result">
                  <div><span class="v" id="fg_text">‚Äî</span></div>
                </div>
              </div>
              <div class="field">
                <label data-i18n="Market Mood">Market Mood</label>
                <div class="result">
                  <div><span class="v" id="mood">‚Äî</span></div>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="field">
                <label data-i18n="Total Market Cap">Total Market Cap</label>
                <div class="result"><span class="v" id="tcap_text">‚Äî</span></div>
              </div>
              <div class="field">
                <label data-i18n="Altcoin Dominance">Altcoin Dominance</label>
                <div class="result"><span class="v" id="alt_text">‚Äî</span></div>
              </div>
            </div>
            <div class="controls">
              <button class="btn" id="refresh_ind" data-i18n="Refresh Data">Refresh Data</button>
              <span class="small" id="ind_note"></span>
            </div>
            <div class="vizgrid">
              <div class="viz">
                <h5 data-i18n="Fear & Greed Gauge">Fear & Greed Gauge</h5>
                <canvas id="fg_canvas" width="600" height="120"></canvas>
                <div style="margin-top:8px;font-weight:700;font-size:18px" id="fg_big">‚Äî</div>
                <div class="small" id="fg_sub">‚Äî</div>
              </div>
              <div class="viz">
                <h5 data-i18n="Dominance Split">Dominance Split</h5>
                <canvas id="dom_canvas" width="600" height="120"></canvas>
                <div style="margin-top:8px;font-weight:700;font-size:18px" id="dom_big">‚Äî</div>
                <div class="small" id="dom_sub">‚Äî</div>
              </div>
            </div>
          </div>
        </section>
        <div class="history">
          <h4>üìú <span data-i18n="History">History</span></h4>
          <div class="history-list" id="history_list"></div>
          <div class="controls">
            <button class="btn ghost" id="clear_history" data-i18n="Clear History">Clear History</button>
          </div>
          <div class="small" data-i18n="Saved locally in your browser">Saved locally in your browser</div>
        </div>
      </div>
    </section>
    <section id="main_support" class="main-screen">
      <div class="support-wrap">
        <div class="card" style="max-width:600px">
          <h3>üí¨ <span data-i18n="Support">Support</span></h3>
          <div class="color-picker">
            <div class="color-option green active" data-color="#7CFC00"></div>
            <div class="color-option blue" data-color="#2d8cff"></div>
            <div class="color-option purple" data-color="#9b59b6"></div>
            <div class="color-option orange" data-color="#ffa500"></div>
            <div class="color-option pink" data-color="#ff6b9d"></div>
            <div class="color-option teal" data-color="#2dd4bf"></div>
            <div class="color-option yellow" data-color="#fbbf24"></div>
            <div class="color-option red" data-color="#ef4444"></div>
          </div>
          <div class="small" style="margin-bottom:16px" data-i18n="Connect your wallet for tips and donations. Contact us through the links below.">
            Connect your wallet for tips and donations. Contact us through the links below.
          </div>
          <div class="controls">
            <button class="btn" id="wallet_btn" data-i18n="Connect Wallet">Connect Wallet</button>
            <button class="btn" id="tip_btn" data-i18n="Tip 0.05 TON">Tip 0.05 TON</button>
          </div>
          <div class="controls" style="margin-top:20px">
            <button class="btn ghost" id="open_terms" data-i18n="Terms">Terms</button>
            <button class="btn ghost" id="open_privacy" data-i18n="Privacy">Privacy</button>
            <button class="btn ghost" id="open_support" data-i18n="Contact">Contact</button>
          </div>
        </div>
        <div style="text-align:center">
          <div style="color:var(--accent);font-weight:700;margin-bottom:12px">AIRDROP ‚Ä¢ NEWS ‚Ä¢ TRADING</div>
          <div class="support-links">
            <a id="link_telegram" href="https://t.me/ChalovCrypto" target="_blank" data-i18n="TELEGRAM">TELEGRAM</a>
            <a id="link_youtube" href="https://www.youtube.com/@ChalovCrypto" target="_blank" data-i18n="YOUTUBE">YOUTUBE</a>
          </div>
        </div>
      </div>
    </section>
  </main>
  <nav class="bottomnav">
    <div class="bar">
      <button id="main_tab_calc" class="main-tab active">
        <span>üßÆ</span>
        <span data-i18n="Calculator">Calculator</span>
      </button>
      <button id="main_tab_support" class="main-tab">
        <span>üí¨</span>
        <span data-i18n="Support">Support</span>
      </button>
    </div>
  </nav>
</div>
<div id="toast">‚Äî</div>
<div id="modal_backdrop">
  <div id="modal">
    <div id="modal_header">
      <b data-i18n="Trade Card">Trade Card</b>
      <button id="modal_close">√ó</button>
    </div>
    <div id="modal_body">
      <div id="modal_canvas_wrap">
        <canvas id="card_canvas" width="600" height="200"></canvas>
      </div>
      <div id="modal_right">
        <button class="btn" id="card_download" data-i18n="Download PNG">Download PNG</button>
        <button class="btn ghost" id="card_copy" data-i18n="Copy">Copy</button>
        <div id="modal_help" data-i18n="If copy doesn't work, use Download PNG">If copy doesn't work, use Download PNG</div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  'use strict';
  const tg = window.Telegram?.WebApp || null;
  if (tg) {
    tg.expand();
    tg.ready();
  }
  const mainCalc = document.getElementById('main_calc');
  const mainSupport = document.getElementById('main_support');
  const mainBtnCalc = document.getElementById('main_tab_calc');
  const mainBtnSupport = document.getElementById('main_tab_support');
  function setMainTab(which){
    mainCalc.classList.toggle('active', which === 'calc');
    mainSupport.classList.toggle('active', which === 'support');
    mainBtnCalc.classList.toggle('active', which === 'calc');
    mainBtnSupport.classList.toggle('active', which === 'support');
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('screen_view', { screen: which });
    }
  }
  mainBtnCalc.addEventListener('click', () => setMainTab('calc'));
  mainBtnSupport.addEventListener('click', () => setMainTab('support'));
  const locales = {
    ru: {
      "Calculator": "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
      "Support": "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
      "DCA Calculator": "DCA –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä",
      "Add multiple entries to calculate average price, total volume and cost.": "–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã, –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏.",
      "Add entry": "–î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥",
      "Clear": "–û—á–∏—Å—Ç–∏—Ç—å",
      "Average price": "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞",
      "Copy": "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      "Total volume": "–û–±—â–∏–π –æ–±—ä—ë–º",
      "Total cost": "–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å",
      "DCA Goal": "–¶–µ–ª—å DCA",
      "optional": "–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ",
      "Target avg price": "–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞",
      "Next buy price": "–°–ª–µ–¥—É—é—â–∞—è —Ü–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏",
      "Needed volume at next price": "–ù—É–∂–Ω—ã–π –æ–±—ä—ë–º –ø–æ —Å–ª–µ–¥—É—é—â–µ–π —Ü–µ–Ω–µ",
      "Risk/Reward": "–†–∏—Å–∫/–î–æ—Ö–æ–¥",
      "Entry": "–í—Ö–æ–¥",
      "Stop Loss": "–°—Ç–æ–ø –õ–æ—Å—Å",
      "Take Profit": "–¢–µ–π–∫ –ü—Ä–æ—Ñ–∏—Ç",
      "Fee % (entry+exit)": "–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)",
      "Gross R/R": "–ë—Ä—É—Ç—Ç–æ R/R",
      "Net R/R (with fees)": "–ù–µ—Ç—Ç–æ R/R (—Å –∫–æ–º–∏—Å—Å–∏—è–º–∏)",
      "Capital Management": "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∞–ø–∏—Ç–∞–ª–æ–º",
      "Deposit": "–î–µ–ø–æ–∑–∏—Ç",
      "Risk %": "–†–∏—Å–∫ %",
      "Leverage": "–ü–ª–µ—á–æ",
      "Position size": "–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏",
      "Risk $": "–†–∏—Å–∫ $",
      "Margin (with leverage)": "–ú–∞—Ä–∂–∞ (—Å –ø–ª–µ—á–æ–º)",
      "Market Indicators": "–†—ã–Ω–æ—á–Ω—ã–µ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
      "Fear & Greed Index": "–ò–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞—Ö–∞ –∏ –∂–∞–¥–Ω–æ—Å—Ç–∏",
      "Market Mood": "–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä—ã–Ω–∫–∞",
      "Total Market Cap": "–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è",
      "Altcoin Dominance": "–î–æ–ª—è –∞–ª—å—Ç–∫–æ–∏–Ω–æ–≤",
      "Refresh Data": "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ",
      "Fear & Greed Gauge": "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä F&G",
      "Dominance Split": "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–ª–∏",
      "History": "–ò—Å—Ç–æ—Ä–∏—è",
      "Saved locally in your browser": "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",
      "Connect your wallet for tips and donations. Contact us through the links below.": "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –¥–æ–Ω–∞—Ç–æ–≤. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –Ω–∏–∂–µ.",
      "Connect Wallet": "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫",
      "Tip 0.05 TON": "–î–æ–Ω–∞—Ç 0.05 TON",
      "Terms": "–£—Å–ª–æ–≤–∏—è",
      "Privacy": "–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å",
      "Contact": "–ö–æ–Ω—Ç–∞–∫—Ç—ã",
      "Share": "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
      "Card": "–ö–∞—Ä—Ç–æ—á–∫–∞",
      "Copied!": "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
      "Dark": "–¢—ë–º–Ω–∞—è",
      "Light": "–°–≤–µ—Ç–ª–∞—è",
      "Color": "–¶–≤–µ—Ç",
      "DCA": "DCA",
      "R/R": "R/R",
      "Capital": "–ö–∞–ø–∏—Ç–∞–ª",
      "Indicators": "–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
      "Trade Card": "–¢–æ—Ä–≥–æ–≤–∞—è –ö–∞—Ä—Ç–æ—á–∫–∞",
      "Download PNG": "–°–∫–∞—á–∞—Ç—å PNG",
      "If copy doesn't work, use Download PNG": "–ï—Å–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –°–∫–∞—á–∞—Ç—å PNG",
      "Clear History": "–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é",
      "Cached data": "–ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
      "Loading...": "–ó–∞–≥—Ä—É–∑–∫–∞...",
      "History cleared": "–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞",
      "TELEGRAM": "–¢–ï–õ–ï–ì–†–ê–ú",
      "YOUTUBE": "–Æ–¢–£–ë"
    },
    en: {
      "Calculator": "Calculator",
      "Support": "Support",
      "DCA Calculator": "DCA Calculator",
      "Add multiple entries to calculate average price, total volume and cost.": "Add multiple entries to calculate average price, total volume and cost.",
      "Add entry": "Add entry",
      "Clear": "Clear",
      "Average price": "Average price",
      "Copy": "Copy",
      "Total volume": "Total volume",
      "Total cost": "Total cost",
      "DCA Goal": "DCA Goal",
      "optional": "optional",
      "Target avg price": "Target avg price",
      "Next buy price": "Next buy price",
      "Needed volume at next price": "Needed volume at next price",
      "Risk/Reward": "Risk/Reward",
      "Entry": "Entry",
      "Stop Loss": "Stop Loss",
      "Take Profit": "Take Profit",
      "Fee % (entry+exit)": "Fee % (entry+exit)",
      "Gross R/R": "Gross R/R",
      "Net R/R (with fees)": "Net R/R (with fees)",
      "Capital Management": "Capital Management",
      "Deposit": "Deposit",
      "Risk %": "Risk %",
      "Leverage": "Leverage",
      "Position size": "Position size",
      "Risk $": "Risk $",
      "Margin (with leverage)": "Margin (with leverage)",
      "Market Indicators": "Market Indicators",
      "Fear & Greed Index": "Fear & Greed Index",
      "Market Mood": "Market Mood",
      "Total Market Cap": "Total Market Cap",
      "Altcoin Dominance": "Altcoin Dominance",
      "Refresh Data": "Refresh Data",
      "Fear & Greed Gauge": "Fear & Greed Gauge",
      "Dominance Split": "Dominance Split",
      "History": "History",
      "Saved locally in your browser": "Saved locally in your browser",
      "Connect your wallet for tips and donations. Contact us through the links below.": "Connect your wallet for tips and donations. Contact us through the links below.",
      "Connect Wallet": "Connect Wallet",
      "Tip 0.05 TON": "Tip 0.05 TON",
      "Terms": "Terms",
      "Privacy": "Privacy",
      "Contact": "Contact",
      "Share": "Share",
      "Card": "Card",
      "Copied!": "Copied!",
      "Dark": "Dark",
      "Light": "Light",
      "Color": "Color",
      "DCA": "DCA",
      "R/R": "R/R",
      "Capital": "Capital",
      "Indicators": "Indicators",
      "Trade Card": "Trade Card",
      "Download PNG": "Download PNG",
      "If copy doesn't work, use Download PNG": "If copy doesn't work, use Download PNG",
      "Clear History": "Clear History",
      "Cached data": "Cached data",
      "Loading...": "Loading...",
      "History cleared": "History cleared",
      "TELEGRAM": "TELEGRAM",
      "YOUTUBE": "YOUTUBE"
    }
  };
  let lang = 'en';
  try {
    const tgl = tg?.initDataUnsafe?.user?.language_code;
    if (tgl && tgl.startsWith('ru')) lang = 'ru';
  } catch(e) {}
  function t(key) {
    const locale = locales[lang] || locales.en;
    return locale[key] || key;
  }
  function translateAll() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const translation = t(key);
      if (el.tagName === 'INPUT') {
        el.placeholder = translation;
      } else {
        el.textContent = translation;
      }
    });
    const elements = document.querySelectorAll('button, label, div, span, h3, h4, h5');
    elements.forEach(el => {
      if (el.textContent in locales.en) {
        el.textContent = t(el.textContent);
      }
    });
    document.getElementById('share_btn').querySelector('span:last-child').textContent = t('Share');
    document.getElementById('card_btn').querySelector('span:last-child').textContent = t('Card');
    document.getElementById('theme_text').textContent = document.documentElement.getAttribute('data-theme') === 'light' ? t('Light') : t('Dark');
    document.querySelectorAll('.subtab').forEach(tab => {
      const tabId = tab.dataset.tab;
      const emoji = tab.querySelector('span:first-child').textContent;
      const textSpan = tab.querySelector('span:last-child');
      if (textSpan) {
        const key = textSpan.getAttribute('data-i18n') || textSpan.textContent;
        textSpan.textContent = t(key);
      }
    });
    document.getElementById('main_tab_calc').querySelector('span:last-child').textContent = t('Calculator');
    document.getElementById('main_tab_support').querySelector('span:last-child').textContent = t('Support');
    document.querySelector('.history h4').querySelector('span').textContent = t('History');
  }
  let toastTimer = null;
  function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2000);
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('toast_shown', { message: msg.substring(0, 50) });
    }
  }
  const THEME_KEY = 'tc_theme';
  function getInitialTheme() {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved === 'dark' || saved === 'light') return saved;
    const tgScheme = (tg?.colorScheme || '').toLowerCase();
    return tgScheme === 'light' ? 'light' : 'dark';
  }
  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    document.getElementById('theme_icon').textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
    document.getElementById('theme_text').textContent = t(theme === 'light' ? 'Light' : 'Dark');
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('theme_changed', { theme: theme });
    }
  }
  setTheme(getInitialTheme());
  document.getElementById('theme_toggle').addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    setTheme(current === 'dark' ? 'light' : 'dark');
  });
  const COLOR_KEY = 'tc_accent_color';
  const colorOptions = document.querySelectorAll('.color-option');
  function setAccentColor(color) {
    document.documentElement.style.setProperty('--accent', color);
    localStorage.setItem(COLOR_KEY, color);
    colorOptions.forEach(option => {
      option.classList.toggle('active', option.dataset.color === color);
    });
    const pulseColor = color === '#7CFC00' ? '#7CFC00' : 
                      color === '#2d8cff' ? '#2d8cff' :
                      color === '#9b59b6' ? '#9b59b6' :
                      color === '#ffa500' ? '#ffa500' :
                      color === '#ff6b9d' ? '#ff6b9d' :
                      color === '#2dd4bf' ? '#2dd4bf' :
                      color === '#fbbf24' ? '#fbbf24' :
                      '#ef4444';
    document.documentElement.style.setProperty('--pulse-color', pulseColor);
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('color_changed', { color: color });
    }
  }
  const savedColor = localStorage.getItem(COLOR_KEY) || '#7CFC00';
  setAccentColor(savedColor);
  colorOptions.forEach(option => {
    option.addEventListener('click', () => {
      setAccentColor(option.dataset.color);
    });
  });
  function safeNum(v) {
    const x = parseFloat(v);
    return isFinite(x) ? x : 0;
  }
  function fmt(v, digits = 8) {
    if (v === null || v === undefined || !isFinite(v)) return '‚Äî';
    const n = Number(v);
    const abs = Math.abs(n);
    const d = abs >= 1000 ? 2 : (abs >= 1 ? 6 : digits);
    return n.toLocaleString(undefined, {maximumFractionDigits: d});
  }
  const btnRu = document.getElementById('btn_ru');
  const btnEn = document.getElementById('btn_en');
  function syncLangButtons() {
    btnRu.classList.toggle('active', lang === 'ru');
    btnEn.classList.toggle('active', lang === 'en');
  }
  syncLangButtons();
  btnRu.addEventListener('click', () => {
    lang = 'ru';
    syncLangButtons();
    translateAll();
    renderHistory();
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('language_changed', { language: 'ru' });
    }
  });
  btnEn.addEventListener('click', () => {
    lang = 'en';
    syncLangButtons();
    translateAll();
    renderHistory();
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('language_changed', { language: 'en' });
    }
  });
  document.querySelectorAll('.subtab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.subtab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.tab;
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
      if (target === 'ind' && !lastIndicators) fetchIndicators();
      if (window.TelegramAnalytics) {
        window.TelegramAnalytics.trackEvent('tab_switched', { tab: target });
      }
    });
  });
  function activeTab() {
    const act = document.querySelector('.subtab.active');
    return act?.dataset?.tab || 'dca';
  }
  const dcaRowsEl = document.getElementById('dca_rows');
  const dcaAvgEl = document.getElementById('dca_avg');
  const dcaTotalVolEl = document.getElementById('dca_total_vol');
  const dcaTotalCostEl = document.getElementById('dca_total_cost');
  const dcaGoal = document.getElementById('dca_goal');
  const dcaNext = document.getElementById('dca_next_price');
  const dcaNeedVol = document.getElementById('dca_need_vol');
  let dcaRows = [];
  function addDcaRow(p = 0, v = 0) {
    const rowId = Date.now() + Math.random();
    const wrap = document.createElement('div');
    wrap.className = 'row';
    wrap.style.marginBottom = '8px';
    wrap.innerHTML = `
      <div class="field" style="flex:2">
        <input type="number" step="any" placeholder="${lang === 'ru' ? '–¶–µ–Ω–∞' : 'Price'}" value="${p || ''}">
      </div>
      <div class="field" style="flex:2">
        <input type="number" step="any" placeholder="${lang === 'ru' ? '–û–±—ä—ë–º' : 'Volume'}" value="${v || ''}">
      </div>
      <div class="field" style="flex:1">
        <button class="btn ghost" type="button" style="width:100%">√ó</button>
      </div>
    `;
    const inputs = wrap.querySelectorAll('input');
    const btnRemove = wrap.querySelector('button');
    const item = { id: rowId, el: wrap, pEl: inputs[0], vEl: inputs[1] };
    inputs.forEach(inp => inp.addEventListener('input', () => {
      calcDCA();
    }));
    btnRemove.addEventListener('click', () => {
      dcaRows = dcaRows.filter(r => r.id !== rowId);
      wrap.remove();
      calcDCA();
    });
    dcaRows.push(item);
    dcaRowsEl.appendChild(wrap);
    calcDCA();
  }
  function clearDCA() {
    dcaRows = [];
    dcaRowsEl.innerHTML = '';
    addDcaRow();
    addDcaRow();
    dcaGoal.value = '';
    dcaNext.value = '';
    calcDCA();
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('dca_cleared');
    }
  }
  function calcDCA() {
    let totalVol = 0;
    let totalCost = 0;
    dcaRows.forEach(r => {
      const p = safeNum(r.pEl.value);
      const v = safeNum(r.vEl.value);
      if (p > 0 && v > 0) {
        totalVol += v;
        totalCost += p * v;
      }
    });
    if (totalVol <= 0) {
      dcaAvgEl.textContent = '‚Äî';
      dcaTotalVolEl.textContent = '‚Äî';
      dcaTotalCostEl.textContent = '‚Äî';
      dcaNeedVol.textContent = '‚Äî';
      return { avg: null, totalVol: 0, totalCost: 0 };
    }
    const avg = totalCost / totalVol;
    dcaAvgEl.textContent = fmt(avg, 10);
    dcaTotalVolEl.textContent = fmt(totalVol, 8);
    dcaTotalCostEl.textContent = fmt(totalCost, 2);
    const target = safeNum(dcaGoal.value);
    const nextP = safeNum(dcaNext.value);
    if (target > 0 && nextP > 0 && nextP !== target) {
      const x = (target * totalVol - totalCost) / (nextP - target);
      dcaNeedVol.textContent = (isFinite(x) && x > 0) ? fmt(x, 8) : '‚Äî';
    } else {
      dcaNeedVol.textContent = '‚Äî';
    }
    if (window.TelegramAnalytics && totalVol > 0) {
      window.TelegramAnalytics.trackEvent('dca_calculated', {
        entries: dcaRows.length,
        totalVol: totalVol
      });
    }
    return { avg, totalVol, totalCost };
  }
  document.getElementById('dca_add').addEventListener('click', () => addDcaRow());
  document.getElementById('dca_clear').addEventListener('click', clearDCA);
  dcaGoal.addEventListener('input', calcDCA);
  dcaNext.addEventListener('input', calcDCA);
  async function copyText(text) {
    if (!text || text === '‚Äî') return false;
    try {
      await navigator.clipboard.writeText(String(text));
      return true;
    } catch (e) {
      return false;
    }
  }
  function getHistoryType(tab) {
    const map = {
      'dca': 'DCA',
      'rr': 'R/R',
      'cap': 'Capital',
      'ind': 'Indicators'
    };
    return map[tab] || tab;
  }
  function bindCopy(btn, getVal, getSummary = null) {
    btn.addEventListener('click', async () => {
      const val = getVal();
      const ok = await copyText(val);
      if (ok) {
        showToast(t('Copied!'));
        if (getSummary) {
          const summary = getSummary();
          const arr = loadHistory();
          arr.unshift({
            t: Date.now(),
            type: getHistoryType(activeTab()),
            summary: summary
          });
          if (arr.length > 50) arr.length = 50;
          saveHistory(arr);
          renderHistory();
        }
        if (window.TelegramAnalytics) {
          window.TelegramAnalytics.trackEvent('value_copied', {
            value: val.substring(0, 30)
          });
        }
      }
    });
  }
  bindCopy(document.getElementById('dca_copy'), () => dcaAvgEl.textContent, () => {
    return `Average: ${dcaAvgEl.textContent}, Volume: ${dcaTotalVolEl.textContent}, Cost: ${dcaTotalCostEl.textContent}`;
  });
  bindCopy(document.getElementById('dca_need_copy'), () => dcaNeedVol.textContent, () => {
    return `Needed volume: ${dcaNeedVol.textContent} at next price ${dcaNext.value}`;
  });
  const rrEntry = document.getElementById('rr_entry');
  const rrSl = document.getElementById('rr_sl');
  const rrTp = document.getElementById('rr_tp');
  const rrFee = document.getElementById('rr_fee');
  const rrGross = document.getElementById('rr_gross');
  const rrNet = document.getElementById('rr_net');
  function calcRR() {
    const e = safeNum(rrEntry.value);
    const sl = safeNum(rrSl.value);
    const tp = safeNum(rrTp.value);
    const fee = safeNum(rrFee.value) / 100;
    if (!e || !sl || !tp || e === sl) {
      rrGross.textContent = '‚Äî';
      rrNet.textContent = '‚Äî';
      return { gross: null, net: null };
    }
    const risk = Math.abs(e - sl);
    const reward = Math.abs(tp - e);
    if (!risk || !reward) {
      rrGross.textContent = '‚Äî';
      rrNet.textContent = '‚Äî';
      return { gross: null, net: null };
    }
    const gross = (reward / risk);
    rrGross.textContent = '1:' + gross.toFixed(2);
    const feeEntry = e * fee;
    const feeExit = tp * fee;
    const netReward = Math.max(0, reward - (feeEntry + feeExit));
    const net = (netReward / (risk + feeEntry));
    rrNet.textContent = '1:' + net.toFixed(2);
    if (window.TelegramAnalytics && e > 0) {
      window.TelegramAnalytics.trackEvent('rr_calculated', {
        gross: gross,
        net: net
      });
    }
    return { gross, net };
  }
  [rrEntry, rrSl, rrTp, rrFee].forEach(x => x.addEventListener('input', calcRR));
  bindCopy(document.getElementById('rr_copy_gross'), () => rrGross.textContent, () => {
    return `Gross R/R: ${rrGross.textContent} (Entry: ${rrEntry.value}, SL: ${rrSl.value}, TP: ${rrTp.value})`;
  });
  bindCopy(document.getElementById('rr_copy_net'), () => rrNet.textContent, () => {
    return `Net R/R: ${rrNet.textContent} (Entry: ${rrEntry.value}, SL: ${rrSl.value}, TP: ${rrTp.value}, Fee: ${rrFee.value}%)`;
  });
  const capDep = document.getElementById('cap_dep');
  const capRisk = document.getElementById('cap_risk');
  const capLev = document.getElementById('cap_lev');
  const capEntry = document.getElementById('cap_entry');
  const capSl = document.getElementById('cap_sl');
  const capFee = document.getElementById('cap_fee');
  const capPos = document.getElementById('cap_pos');
  const capRiskUsd = document.getElementById('cap_risk_usd');
  const capMargin = document.getElementById('cap_margin');
  document.querySelectorAll('.chip[data-risk]').forEach(ch => {
    ch.addEventListener('click', () => {
      document.querySelectorAll('.chip[data-risk]').forEach(x => x.classList.remove('active'));
      ch.classList.add('active');
      capRisk.value = ch.dataset.risk;
      calcCap();
    });
  });
  function calcCap() {
    const dep = safeNum(capDep.value);
    const rp = safeNum(capRisk.value) / 100;
    const lev = Math.max(1, safeNum(capLev.value) || 1);
    const e = safeNum(capEntry.value);
    const sl = safeNum(capSl.value);
    const fee = safeNum(capFee.value) / 100;
    if (dep <= 0 || rp <= 0 || e <= 0 || sl <= 0 || e === sl) {
      capPos.textContent = '‚Äî';
      capRiskUsd.textContent = '‚Äî';
      capMargin.textContent = '‚Äî';
      return { pos: null };
    }
    const riskUsd = dep * rp;
    const move = Math.abs(e - sl) + (e * fee);
    const pos = riskUsd / move;
    capPos.textContent = fmt(pos, 8);
    capRiskUsd.textContent = fmt(riskUsd, 2);
    const notional = pos * e;
    capMargin.textContent = fmt(notional / lev, 2);
    if (window.TelegramAnalytics && dep > 0) {
      window.TelegramAnalytics.trackEvent('cap_calculated', {
        positionSize: pos,
        riskUsd: riskUsd
      });
    }
    return { pos };
  }
  [capDep, capRisk, capLev, capEntry, capSl, capFee].forEach(x => x.addEventListener('input', calcCap));
  bindCopy(document.getElementById('cap_copy_pos'), () => capPos.textContent, () => {
    return `Position: ${capPos.textContent}, Risk: $${capRiskUsd.textContent}, Margin: $${capMargin.textContent}`;
  });
  const fgText = document.getElementById('fg_text');
  const tcapText = document.getElementById('tcap_text');
  const altText = document.getElementById('alt_text');
  const moodEl = document.getElementById('mood');
  const indNote = document.getElementById('ind_note');
  let lastIndicators = null;
  const IND_CACHE_KEY = 'tc_ind_cache';
  function saveIndicatorsCache(data) {
    try {
      localStorage.setItem(IND_CACHE_KEY, JSON.stringify({ t: Date.now(), data }));
    } catch(e) {}
  }
  function loadIndicatorsCache() {
    try {
      const raw = localStorage.getItem(IND_CACHE_KEY);
      if (!raw) return null;
      const j = JSON.parse(raw);
      return j;
    } catch(e) {
      return null;
    }
  }
  function computeMood(fgValue) {
    if (!isFinite(fgValue)) return '‚Äî';
    if (fgValue >= 70) return lang === 'ru' ? '–ñ–∞–¥–Ω–æ—Å—Ç—å' : 'Greed';
    if (fgValue <= 30) return lang === 'ru' ? '–°—Ç—Ä–∞—Ö' : 'Fear';
    return lang === 'ru' ? '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ' : 'Neutral';
  }
  async function fetchIndicators() {
    indNote.textContent = t('Loading...');
    let fgVal = null, fgClass = '‚Äî', totalMc = null, btcDom = null;
    try {
      const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json');
      if (res.ok) {
        const j = await res.json();
        const d = j?.data?.[0];
        fgVal = d ? Number(d.value) : null;
        fgClass = d?.value_classification || '‚Äî';
      }
    } catch(e) {}
    try {
      const res2 = await fetch('https://api.coingecko.com/api/v3/global');
      if (res2.ok) {
        const j2 = await res2.json();
        totalMc = j2?.data?.total_market_cap?.usd ?? null;
        btcDom = j2?.data?.market_cap_percentage?.btc ?? null;
      }
    } catch(e) {}
    fgText.textContent = isFinite(fgVal) ? `${fgVal} ¬∑ ${fgClass}` : '‚Äî';
    tcapText.textContent = isFinite(totalMc) ? '$' + Number(totalMc).toLocaleString() : '‚Äî';
    let altDom = null;
    if (typeof btcDom === 'number' && isFinite(btcDom)) {
      altDom = 100 - btcDom;
      altText.textContent = altDom.toFixed(2) + '%';
    } else {
      altText.textContent = '‚Äî';
    }
    moodEl.textContent = computeMood(fgVal);
    lastIndicators = { fgVal, fgClass, totalMc, btcDom, altDom };
    saveIndicatorsCache(lastIndicators);
    drawAllIndicatorVisuals(lastIndicators);
    indNote.textContent = '';
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('indicators_fetched', {
        fgIndex: fgVal
      });
    }
  }
  function drawGauge(canvas, value) {
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0, 0, w, h);
    const cx = w / 2, cy = h * 0.7;
    const r = Math.min(w * 0.4, h * 0.6);
    const start = Math.PI, end = 0;
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#252525';
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, end, false);
    ctx.stroke();
    if (!isFinite(value)) return;
    const clamped = Math.max(0, Math.min(100, value));
    const angle = start + (end - start) * (clamped / 100);
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7CFC00';
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, angle, false);
    ctx.stroke();
  }
  function drawDonutSplit(canvas, btcDom) {
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0, 0, w, h);
    const cx = w / 2, cy = h / 2, r = Math.min(w, h) * 0.3;
    const inner = r * 0.6;
    const border = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#252525';
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7CFC00';
    ctx.fillStyle = border;
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--chip').trim() || '#1a1a1a';
    ctx.beginPath();
    ctx.arc(cx, cy, inner, 0, Math.PI * 2);
    ctx.fill();
    if (!isFinite(btcDom)) return;
    const btc = Math.max(0, Math.min(100, btcDom));
    const a0 = -Math.PI / 2;
    const aB = a0 + (Math.PI * 2) * (btc / 100);
    ctx.fillStyle = accent;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, a0, aB, false);
    ctx.closePath();
    ctx.fill();
  }
  function drawAllIndicatorVisuals(data) {
    drawGauge(document.getElementById('fg_canvas'), data?.fgVal);
    drawDonutSplit(document.getElementById('dom_canvas'), data?.btcDom);
    const fgBig = document.getElementById('fg_big');
    const fgSub = document.getElementById('fg_sub');
    const domBig = document.getElementById('dom_big');
    const domSub = document.getElementById('dom_sub');
    if (isFinite(data?.fgVal)) {
      fgBig.textContent = String(Math.round(data.fgVal));
      fgSub.textContent = data.fgClass || '‚Äî';
    } else {
      fgBig.textContent = '‚Äî';
      fgSub.textContent = '‚Äî';
    }
    if (typeof data?.btcDom === 'number' && isFinite(data.btcDom)) {
      domBig.textContent = `BTC ${data.btcDom.toFixed(1)}%`;
      domSub.textContent = `ALTS ${(100 - data.btcDom).toFixed(1)}%`;
    } else {
      domBig.textContent = '‚Äî';
      domSub.textContent = '‚Äî';
    }
  }
  const cached = loadIndicatorsCache();
  if (cached?.data) {
    lastIndicators = cached.data;
    fgText.textContent = isFinite(lastIndicators.fgVal) ? `${lastIndicators.fgVal} ¬∑ ${lastIndicators.fgClass}` : '‚Äî';
    tcapText.textContent = isFinite(lastIndicators.totalMc) ? '$' + Number(lastIndicators.totalMc).toLocaleString() : '‚Äî';
    altText.textContent = isFinite(lastIndicators.altDom) ? lastIndicators.altDom.toFixed(2) + '%' : '‚Äî';
    moodEl.textContent = computeMood(lastIndicators.fgVal);
    indNote.textContent = t('Cached data');
    drawAllIndicatorVisuals(lastIndicators);
  }
  document.getElementById('refresh_ind').addEventListener('click', fetchIndicators);
  const HISTORY_KEY = 'tc_history';
  function loadHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
    } catch(e) {
      return [];
    }
  }
  function saveHistory(arr) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    } catch(e) {}
  }
  function renderHistory() {
    const list = document.getElementById('history_list');
    list.innerHTML = '';
    const arr = loadHistory();
    if (!arr.length) {
      list.innerHTML = '<div class="small">' + t('Saved locally in your browser') + '</div>';
      return;
    }
    arr.forEach((it, idx) => {
      if (idx >= 20) return;
      const node = document.createElement('div');
      node.className = 'hist-item';
      const dt = new Date(it.t).toLocaleString();
      const left = document.createElement('div');
      left.innerHTML = `<b>${it.type}</b><div class="small">${dt}</div><div class="small">${it.summary}</div>`;
      const right = document.createElement('div');
      right.className = 'hist-actions';
      const btnCopy = document.createElement('button');
      btnCopy.className = 'mini';
      btnCopy.textContent = t('Copy');
      btnCopy.addEventListener('click', async () => {
        const ok = await copyText(it.summary);
        if (ok) showToast(t('Copied!'));
      });
      right.appendChild(btnCopy);
      node.appendChild(left);
      node.appendChild(right);
      list.appendChild(node);
    });
  }
  document.getElementById('clear_history').addEventListener('click', () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
    showToast(t('History cleared'));
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('history_cleared');
    }
  });
  document.getElementById('open_terms').addEventListener('click', () => {
    window.open('/terms.html', '_blank');
  });
  document.getElementById('open_privacy').addEventListener('click', () => {
    window.open('/privacy.html', '_blank');
  });
  document.getElementById('open_support').addEventListener('click', () => {
    window.open('https://t.me/ChalovSupportBot', '_blank');
  });
  document.getElementById('link_telegram').addEventListener('click', (e) => {
    e.preventDefault();
    window.open('https://t.me/ChalovCrypto', '_blank');
  });
  document.getElementById('link_youtube').addEventListener('click', (e) => {
    e.preventDefault();
    window.open('https://www.youtube.com/@ChalovCrypto', '_blank');
  });
  const modalBackdrop = document.getElementById('modal_backdrop');
  const modalClose = document.getElementById('modal_close');
  const cardCanvas = document.getElementById('card_canvas');
  const btnDownload = document.getElementById('card_download');
  const btnCopyImg = document.getElementById('card_copy');
  function openModal() {
    modalBackdrop.style.display = 'flex';
  }
  function closeModal() {
    modalBackdrop.style.display = 'none';
  }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });
  function drawCard() {
    const ctx = cardCanvas.getContext('2d');
    const w = cardCanvas.width, h = cardCanvas.height;
    ctx.clearRect(0, 0, w, h);
    const theme = document.documentElement.getAttribute('data-theme');
    const bg = theme === 'light' ? '#f5f7fa' : '#0a0a0a';
    const panel = theme === 'light' ? '#ffffff' : '#111111';
    const text = theme === 'light' ? '#1a1a1a' : '#ffffff';
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, w, h);
    ctx.fillStyle = panel;
    ctx.fillRect(20, 20, w - 40, h - 40);
    ctx.fillStyle = text;
    ctx.font = 'bold 24px Inter';
    ctx.fillText('Trader Calculator', 40, 60);
    const tab = activeTab();
    let title = t('Trade Card');
    let data = [];
    if (tab === 'dca') {
      title = 'DCA Calculation';
      data = [
        `AVG: ${dcaAvgEl.textContent}`,
        `VOL: ${dcaTotalVolEl.textContent}`,
        `COST: ${dcaTotalCostEl.textContent}`
      ];
    } else if (tab === 'rr') {
      title = 'Risk/Reward';
      data = [
        `Gross: ${rrGross.textContent}`,
        `Net: ${rrNet.textContent}`
      ];
    } else if (tab === 'cap') {
      title = 'Capital Management';
      data = [
        `POS: ${capPos.textContent}`,
        `Risk: $${capRiskUsd.textContent}`,
        `Margin: $${capMargin.textContent}`
      ];
    }
    ctx.fillStyle = accent;
    ctx.font = 'bold 20px Inter';
    ctx.fillText(title, 40, 100);
    ctx.fillStyle = text;
    ctx.font = '16px Inter';
    data.forEach((line, i) => {
      ctx.fillText(line, 40, 140 + i * 30);
    });
    ctx.fillStyle = accent;
    ctx.beginPath();
    ctx.moveTo(40, 180);
    ctx.lineTo(w - 40, 180);
    ctx.stroke();
    ctx.fillStyle = '#666';
    ctx.font = '12px Inter';
    ctx.fillText(new Date().toLocaleDateString(), 40, h - 30);
  }
  async function canvasToBlob() {
    return new Promise(resolve => cardCanvas.toBlob(resolve, 'image/png'));
  }
  async function downloadPng() {
    const blob = await canvasToBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trade-card.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast('Downloaded');
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('card_downloaded');
    }
  }
  btnDownload.addEventListener('click', downloadPng);
  btnCopyImg.addEventListener('click', async () => {
    const blob = await canvasToBlob();
    try {
      await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
      showToast(t('Copied!'));
      if (window.TelegramAnalytics) {
        window.TelegramAnalytics.trackEvent('card_copied');
      }
    } catch (e) {
      downloadPng();
    }
  });
  document.getElementById('card_btn').addEventListener('click', () => {
    drawCard();
    openModal();
  });
  const TONCONNECT_MANIFEST_URL = 'https://trade-calculator-five.vercel.app/tonconnect-manifest.json';
  const TIP_ADDRESS = 'UQD04FKshVmZaQjZq9y2AtBXWklkzQfK4sEJWrsYfqbNHGGz';
  let tonConnectUI = null;
  function initTonConnect() {
    try {
      if (!window.TON_CONNECT_UI?.TonConnectUI) return;
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
        manifestUrl: TONCONNECT_MANIFEST_URL
      });
      tonConnectUI.onStatusChange(() => {
        updateWalletUI();
      });
      updateWalletUI();
    } catch(e) {
      console.error('TON Connect init error:', e);
    }
  }
  function updateWalletUI() {
    const wBtn = document.getElementById('wallet_btn');
    const tipBtn = document.getElementById('tip_btn');
    if (!tonConnectUI) {
      wBtn.disabled = true;
      tipBtn.disabled = true;
      return;
    }
    wBtn.disabled = false;
    tipBtn.disabled = !tonConnectUI.connected;
    if (tonConnectUI.connected) {
      const addr = tonConnectUI.account?.address || '';
      wBtn.textContent = addr.slice(0, 6) + '...' + addr.slice(-4);
    } else {
      wBtn.textContent = t('Connect Wallet');
    }
  }
  document.getElementById('wallet_btn').addEventListener('click', async () => {
    if (!tonConnectUI) return;
    if (tonConnectUI.connected) {
      const confirm = window.confirm(t('Disconnect wallet?'));
      if (confirm) {
        await tonConnectUI.disconnect();
        updateWalletUI();
      }
    } else {
      await tonConnectUI.openModal();
    }
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('wallet_action', {
        action: tonConnectUI.connected ? 'disconnect' : 'connect_attempt'
      });
    }
  });
  document.getElementById('tip_btn').addEventListener('click', async () => {
    if (!tonConnectUI?.connected) {
      showToast(t('Connect wallet first'));
      return;
    }
    try {
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [{
          address: TIP_ADDRESS,
          amount: '50000000'
        }]
      };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('Transaction sent'));
      if (window.TelegramAnalytics) {
        window.TelegramAnalytics.trackEvent('tip_sent');
      }
    } catch(e) {
      showToast(t('Error'));
    }
  });
  initTonConnect();
  document.getElementById('share_btn').addEventListener('click', async () => {
    const tab = activeTab();
    let text = 'Trader Calculator\n\n';
    if (tab === 'dca') {
      text += `DCA Calculation:\n`;
      text += `Average: ${dcaAvgEl.textContent}\n`;
      text += `Volume: ${dcaTotalVolEl.textContent}\n`;
      text += `Cost: ${dcaTotalCostEl.textContent}\n`;
    } else if (tab === 'rr') {
      text += `Risk/Reward:\n`;
      text += `Gross: ${rrGross.textContent}\n`;
      text += `Net: ${rrNet.textContent}\n`;
    } else if (tab === 'cap') {
      text += `Capital Management:\n`;
      text += `Position: ${capPos.textContent}\n`;
      text += `Risk: $${capRiskUsd.textContent}\n`;
      text += `Margin: $${capMargin.textContent}\n`;
    }
    text += `\nTry it: https://t.me/ChalovCrypto`;
    try {
      await navigator.clipboard.writeText(text);
      showToast(t('Copied!'));
      if (window.TelegramAnalytics) {
        window.TelegramAnalytics.trackEvent('app_shared', { tab: tab });
      }
    } catch(e) {
      showToast('Copy failed');
    }
  });
  translateAll();
  clearDCA();
  calcRR();
  calcCap();
  renderHistory();
  if (window.TelegramAnalytics) {
    window.TelegramAnalytics.trackEvent('app_loaded');
  }
})();
</script>
</body>
</html>
