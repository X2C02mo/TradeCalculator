<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#000;--panel:#0b0b0b;--border:#141414;--text:#fff;--muted:#8a8a8a}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
#app{min-height:100vh;display:flex;flex-direction:column}

/* header */
header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
.tabs{display:flex;gap:14px}
.tab{background:none;border:none;color:var(--muted);font-size:14px;padding:6px 8px;cursor:pointer}
.tab.active{color:var(--text);border-bottom:2px solid var(--text)}
.lang{display:flex;gap:6px}
.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer}
.lang button.active{color:var(--text);border-color:var(--text)}

/* main */
main{flex:1;padding:14px}
.screen{display:none}
.screen.active{display:block}
.card{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:12px}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:8px;background:#050505;border:1px solid var(--border);color:var(--text);border-radius:4px}
.result{margin-top:10px;padding:8px;border:1px solid var(--border);background:#050505;border-radius:4px}

/* footer */
footer{border-top:1px solid var(--border);padding:10px;text-align:center}
.tags{font-size:12px;color:var(--muted);margin-bottom:6px}
.links{display:flex;justify-content:center;gap:20px}
.rainbow{font-weight:700;text-decoration:none;background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);background-size:400% 400%;-webkit-background-clip:text;color:transparent;animation:rain 3s linear infinite}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
/* small screens niceties */
@media(min-width:900px){main{padding:20px}}
</style>
</head>
<body>
<div id="app">

  <header>
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
    </div>
    <div class="lang">
      <button id="btn_ru" class="active">RU</button>
      <button id="btn_en">EN</button>
    </div>
  </header>

  <main>
    <!-- DCA -->
    <section id="dca" class="screen active" aria-labelledby="dca-tab">
      <div class="card">
        <div class="field">
          <label data-i18n="dca.p1">Цена 1</label>
          <input id="dca_p1" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="dca.v1">Объём 1</label>
          <input id="dca_v1" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="dca.p2">Цена 2</label>
          <input id="dca_p2" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="dca.v2">Объём 2</label>
          <input id="dca_v2" type="number" step="any" placeholder="">
        </div>
        <div class="result" id="dca_result" data-i18n="dca.result">Средняя цена: —</div>
      </div>
    </section>

    <!-- R/R -->
    <section id="rr" class="screen" aria-labelledby="rr-tab">
      <div class="card">
        <div class="field">
          <label data-i18n="rr.entry">Entry</label>
          <input id="rr_entry" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="rr.sl">Stop Loss</label>
          <input id="rr_sl" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="rr.tp">Take Profit</label>
          <input id="rr_tp" type="number" step="any" placeholder="">
        </div>
        <div class="result" id="rr_result" data-i18n="rr.result">R/R: —</div>
      </div>
    </section>

    <!-- Capital -->
    <section id="cap" class="screen" aria-labelledby="cap-tab">
      <div class="card">
        <div class="field">
          <label data-i18n="cap.dep">Депозит</label>
          <input id="cap_dep" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="cap.risk">Риск %</label>
          <input id="cap_risk" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="cap.entry">Entry</label>
          <input id="cap_entry" type="number" step="any" placeholder="">
        </div>
        <div class="field">
          <label data-i18n="cap.sl">Stop Loss</label>
          <input id="cap_sl" type="number" step="any" placeholder="">
        </div>
        <div class="result" id="cap_result" data-i18n="cap.result">Объём: —</div>
      </div>
    </section>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">АИРДРОП · НОВОСТИ · ТРЕЙДИНГ</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<script>
/* Safe Telegram init */
const tg = window.Telegram?.WebApp || null;
try { tg && tg.expand && tg.expand(); } catch(e) { /* ignore */ }

/* Translations */
const locales = {
  ru: {
    "tab.dca":"DCA",
    "tab.rr":"R/R",
    "tab.cap":"Capital",
    "dca.p1":"Цена 1",
    "dca.v1":"Объём 1",
    "dca.p2":"Цена 2",
    "dca.v2":"Объём 2",
    "dca.result":"Средняя цена: —",
    "rr.entry":"Entry",
    "rr.sl":"Stop Loss",
    "rr.tp":"Take Profit",
    "rr.result":"R/R: —",
    "cap.dep":"Депозит",
    "cap.risk":"Риск %",
    "cap.entry":"Entry",
    "cap.sl":"Stop Loss",
    "cap.result":"Объём: —",
    "footer.tags":"АИРДРОП · НОВОСТИ · ТРЕЙДИНГ"
  },
  en: {
    "tab.dca":"DCA",
    "tab.rr":"R/R",
    "tab.cap":"Capital",
    "dca.p1":"Price 1",
    "dca.v1":"Volume 1",
    "dca.p2":"Price 2",
    "dca.v2":"Volume 2",
    "dca.result":"Average price: —",
    "rr.entry":"Entry",
    "rr.sl":"Stop Loss",
    "rr.tp":"Take Profit",
    "rr.result":"R/R: —",
    "cap.dep":"Deposit",
    "cap.risk":"Risk %",
    "cap.entry":"Entry",
    "cap.sl":"Stop Loss",
    "cap.result":"Position size: —",
    "footer.tags":"AIRDROP · NEWS · TRADING"
  }
};

/* Language auto-detect: prefer Telegram user language, fallback to browser */
let lang = 'ru';
try {
  const tgLang = tg?.initDataUnsafe?.user?.language_code;
  if (tgLang) {
    if (/^ru|uk|be/i.test(tgLang)) lang = 'ru';
    else lang = 'en';
  } else if (navigator.language) {
    lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
  }
} catch(e){ lang = 'ru'; }

/* translate function */
function translateAll() {
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (locales[lang] && locales[lang][key] !== undefined) {
      el.textContent = locales[lang][key];
    }
  });
  // Also update dynamic results labels (keep values)
  updateDCAResultLabel();
  updateRRResultLabel();
  updateCapResultLabel();
}

/* Tabs: robust switching */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const target = btn.dataset.tab;
    // UI: active class on tabs
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    // show screen
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const screen = document.getElementById(target);
    if (screen) screen.classList.add('active');
    // Update translations (tab labels could be translated)
    translateAll();
  });
});

/* Language buttons */
document.getElementById('btn_ru').addEventListener('click', ()=>{
  lang = 'ru';
  document.getElementById('btn_ru').classList.add('active');
  document.getElementById('btn_en').classList.remove('active');
  translateAll();
});
document.getElementById('btn_en').addEventListener('click', ()=>{
  lang = 'en';
  document.getElementById('btn_en').classList.add('active');
  document.getElementById('btn_ru').classList.remove('active');
  translateAll();
});

/* --- DCA --- */
const dca_p1 = document.getElementById('dca_p1');
const dca_v1 = document.getElementById('dca_v1');
const dca_p2 = document.getElementById('dca_p2');
const dca_v2 = document.getElementById('dca_v2');
const dca_result = document.getElementById('dca_result');

function updateDCAResultLabel() {
  // keep numeric value if present, otherwise show localized placeholder
  const text = dca_result.dataset.i18n || 'dca.result';
  if (dca_result._last !== undefined) {
    // show label with value preserved
    dca_result.textContent = locales[lang]['dca.result'].split(':')[0] + ': ' + dca_result._last;
  } else {
    dca_result.textContent = locales[lang]['dca.result'];
  }
}

function calcDCA(){
  const p1 = parseFloat(dca_p1.value) || 0;
  const v1 = parseFloat(dca_v1.value) || 0;
  const p2 = parseFloat(dca_p2.value) || 0;
  const v2 = parseFloat(dca_v2.value) || 0;
  const totalVol = v1 + v2;
  if (totalVol <= 0) {
    delete dca_result._last;
    dca_result.textContent = locales[lang]['dca.result'];
    return;
  }
  const avg = ((p1 * v1) + (p2 * v2)) / totalVol;
  const display = avg.toFixed(8);
  dca_result._last = display;
  dca_result.textContent = locales[lang]['dca.result'].split(':')[0] + ': ' + display;
}
[dca_p1,dca_v1,dca_p2,dca_v2].forEach(el => el.addEventListener('input', calcDCA));

/* --- R/R --- */
const rr_entry = document.getElementById('rr_entry');
const rr_sl = document.getElementById('rr_sl');
const rr_tp = document.getElementById('rr_tp');
const rr_result = document.getElementById('rr_result');

function updateRRResultLabel() {
  if (rr_result._last !== undefined) {
    rr_result.textContent = locales[lang]['rr.result'].split(':')[0] + ': ' + rr_result._last;
  } else {
    rr_result.textContent = locales[lang]['rr.result'];
  }
}

function calcRR(){
  const e = parseFloat(rr_entry.value);
  const sl = parseFloat(rr_sl.value);
  const tp = parseFloat(rr_tp.value);
  if (!isFinite(e) || !isFinite(sl) || !isFinite(tp) || e === sl) {
    delete rr_result._last;
    rr_result.textContent = locales[lang]['rr.result'];
    return;
  }
  const risk = Math.abs(e - sl);
  const reward = Math.abs(tp - e);
  if (risk === 0) {
    delete rr_result._last;
    rr_result.textContent = locales[lang]['rr.result'];
    return;
  }
  const ratio = (reward / risk).toFixed(2);
  rr_result._last = '1:' + ratio;
  rr_result.textContent = locales[lang]['rr.result'].split(':')[0] + ': ' + rr_result._last;
}
[rr_entry,rr_sl,rr_tp].forEach(el => el.addEventListener('input', calcRR));

/* --- Capital --- */
const cap_dep = document.getElementById('cap_dep');
const cap_risk = document.getElementById('cap_risk');
const cap_entry = document.getElementById('cap_entry');
const cap_sl = document.getElementById('cap_sl');
const cap_result = document.getElementById('cap_result');

function updateCapResultLabel() {
  if (cap_result._last !== undefined) {
    cap_result.textContent = locales[lang]['cap.result'].split(':')[0] + ': ' + cap_result._last;
  } else {
    cap_result.textContent = locales[lang]['cap.result'];
  }
}

function calcCap(){
  const dep = parseFloat(cap_dep.value);
  const riskPercent = parseFloat(cap_risk.value);
  const e = parseFloat(cap_entry.value);
  const sl = parseFloat(cap_sl.value);
  if (!isFinite(dep) || !isFinite(riskPercent) || !isFinite(e) || !isFinite(sl) || e === sl) {
    delete cap_result._last;
    cap_result.textContent = locales[lang]['cap.result'];
    return;
  }
  const riskUsd = dep * (riskPercent / 100);
  const positionSize = riskUsd / Math.abs(e - sl);
  const display = positionSize.toFixed(8);
  cap_result._last = display;
  cap_result.textContent = locales[lang]['cap.result'].split(':')[0] + ': ' + display;
}
[cap_dep,cap_risk,cap_entry,cap_sl].forEach(el => el.addEventListener('input', calcCap));

/* initial translate and safety */
translateAll();
/* ensure first screen translations are applied */
document.querySelectorAll('.tab').forEach(t => {
  const key = t.getAttribute('data-i18n');
  if (key && locales[lang][key]) t.textContent = locales[lang][key];
});

/* handle links inside WebApp if possible */
function openUrl(url){
  try {
    if (tg?.openLink) return tg.openLink(url);
    if (tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
  } catch(e){}
  window.open(url, '_blank');
}
document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

</script>
</body>
</html>
