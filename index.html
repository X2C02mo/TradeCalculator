<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Trader Calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
  <script type="module">
    const TG_ANALYTICS_TOKEN = "eyJhcHBfbmFtZSI6InRyYWRlcl9jYWxjdWxhdG9yIiwiYXBwX3VybCI6Imh0dHBzOi8vdHJhZGUtY2FsY3VsYXRvci1maXZlLnZlcmNlbC5hcHAiLCJkZXZpY2VfaWQiOiIwMWY3ZjZlYS0wMzJmLTRiOTQtODk2Ni1lNTFlYzQ5YzQzZjAiLCJwcm9qZWN0X2lkIjoiMDE5NTkzZTYtM2U1Ni03YjBmLTk3YjMtN2E2ZWY1OTcyYmY0Iiwic2Vzc2lvbl9pZCI6IjAxOTYwMjc1LTFjYmUtNzdlYy04Y2U4LWMyOWJjM2E5OWE2ZCIsInRpbWVzdGFtcCI6MTc0MjYzODY0N30=";

    (function initAnalytics() {
      try {
        const s = document.createElement('script');
        s.src = 'https://tganalytics.xyz/index.js';
        s.async = true;
        s.onload = () => {
          try {
            if (window.TelegramAnalytics) {
              window.TelegramAnalytics.init({ token: TG_ANALYTICS_TOKEN });
            }
          } catch (e) {}
        };
        document.head.appendChild(s);
      } catch (e) {}
    })();
  </script>
  <style>
    :root {
      --bg: #0f1117;
      --panel: #171a23;
      --muted: #9aa3b2;
      --text: #e9eef7;
      --accent: #5cffb0;
      --danger: #ff5c7a;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 16px;
      --glass: rgba(255,255,255,0.04);
    }

    [data-theme="light"] {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --muted: #556070;
      --text: #0b1020;
      --accent: #2bd67b;
      --danger: #d83a5d;
      --border: rgba(0,0,0,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.12);
      --glass: rgba(0,0,0,0.03);
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      padding: 18px 14px 26px;
      max-width: 920px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    a { color: var(--accent); text-decoration: none; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand b {
      font-size: 16px;
      letter-spacing: 0.2px;
    }

    .brand span {
      font-size: 12px;
      color: var(--muted);
    }

    .tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .tab {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: transform 0.08s ease, border-color 0.2s ease;
    }

    .tab:active { transform: scale(0.98); }
    .tab.active { border-color: rgba(92,255,176,0.35); box-shadow: 0 0 0 2px rgba(92,255,176,0.15) inset; }

    .panels {
      display: flex;
      gap: 14px;
      align-items: flex-start;
    }

    .panel {
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      box-sizing: border-box;
      min-width: 0;
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 15px;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
    }

    input, select, textarea {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      outline: none;
      box-sizing: border-box;
    }

    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea {
      background: rgba(0,0,0,0.03);
    }

    textarea { resize: vertical; min-height: 70px; }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn.danger {
      background: var(--danger);
      color: #fff;
    }

    .btn:disabled { opacity: 0.55; cursor: not-allowed; }

    .card {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
    }

    .muted { color: var(--muted); font-size: 12px; line-height: 1.35; }
    .small { font-size: 12px; }

    .result {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
    }

    [data-theme="light"] .pill { background: rgba(0,0,0,0.04); }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    .history {
      max-width: 320px;
      width: 320px;
    }

    .history .item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      margin-bottom: 10px;
    }

    [data-theme="light"] .history .item { background: rgba(0,0,0,0.03); }

    .item b { font-size: 13px; }
    .item span { font-size: 12px; color: var(--muted); }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      max-width: calc(100vw - 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 9999;
    }

    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }

    .premium-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(92,255,176,0.25);
      background: rgba(92,255,176,0.08);
      font-size: 12px;
    }

    .premium-badge b { font-size: 12px; }

    .plan {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .plan-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .plan-row b { font-size: 13px; }

    .ach-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .ach {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    [data-theme="light"] .ach { background: rgba(0,0,0,0.03); }
    .ach.locked { opacity: 0.55; }
    .ach .icon { font-size: 18px; width: 24px; text-align: center; }
    .ach .meta { display: flex; flex-direction: column; gap: 2px; }
    .ach .meta b { font-size: 13px; }
    .ach .meta span { font-size: 12px; color: var(--muted); }

    .themes {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }
    .theme-btn {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 72px;
    }
    [data-theme="light"] .theme-btn { background: rgba(0,0,0,0.03); }
    .theme-btn b { font-size: 13px; }
    .theme-btn span { font-size: 12px; color: var(--muted); }

    @media (max-width: 768px) {
      .panels { flex-direction: column; }
      .history { max-width: 100%; width: auto; }
      .grid2 { grid-template-columns: 1fr; }
      .themes { grid-template-columns: 1fr 1fr; }
      .ach-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 480px) {
      .plan .row { flex-direction: column; }
      .plan .row .btn { width: 100%; }
      .plan-row { flex-direction: column; align-items: stretch; }
      .plan-row .pill { align-self: flex-start; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <b>Trade Calculator</b>
      <span class="muted" id="subtitle">Risk/Reward â€¢ DCA â€¢ Cap</span>
    </div>
    <div class="tabs">
      <button class="tab active" id="tab_calc" data-i18n="Calculator">Calculator</button>
      <button class="tab" id="tab_support" data-i18n="Support">Support</button>
      <button class="tab" id="tab_premium" data-i18n="Premium">Premium</button>
      <button class="tab" id="tab_settings" data-i18n="Settings">Settings</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div id="view_calc">
    <div class="panels">
      <div class="panel">
        <h2 data-i18n="Risk/Reward">Risk/Reward</h2>

        <div class="grid2">
          <div class="card">
            <div class="field">
              <label data-i18n="Entry price">Entry price</label>
              <input id="rr_entry" type="number" step="any" value="100" />
            </div>
            <div class="field">
              <label data-i18n="Stop loss">Stop loss</label>
              <input id="rr_stop" type="number" step="any" value="95" />
            </div>
            <div class="field">
              <label data-i18n="Take profit">Take profit</label>
              <input id="rr_take" type="number" step="any" value="115" />
            </div>
            <div class="row">
              <button class="btn" id="rr_calc" data-i18n="Calculate">Calculate</button>
              <button class="btn secondary" id="rr_copy" data-i18n="Copy">Copy</button>
            </div>
            <div class="result" id="rr_result"></div>
          </div>

          <div class="card">
            <h2 data-i18n="Position Sizing">Position Sizing</h2>
            <div class="field">
              <label data-i18n="Balance">Balance</label>
              <input id="cap_balance" type="number" step="any" value="1000" />
            </div>
            <div class="field">
              <label data-i18n="Risk %">Risk %</label>
              <input id="cap_risk_pct" type="number" step="any" value="2" />
            </div>
            <div class="field">
              <label data-i18n="Stop loss %">Stop loss %</label>
              <input id="cap_stop_pct" type="number" step="any" value="5" />
            </div>
            <div class="row">
              <button class="btn" id="cap_calc" data-i18n="Calculate">Calculate</button>
              <button class="btn secondary" id="cap_copy" data-i18n="Copy">Copy</button>
            </div>
            <div class="result" id="cap_result"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <h2 data-i18n="DCA Calculator">DCA Calculator</h2>
          <div class="muted" data-i18n="Add multiple entries to calculate average price, total volume and cost.">
            Add multiple entries to calculate average price, total volume and cost.
          </div>
          <div class="divider"></div>
          <div id="dca_list"></div>
          <div class="row">
            <button class="btn" id="dca_add" data-i18n="Add entry">Add entry</button>
            <button class="btn secondary" id="dca_clear" data-i18n="Clear">Clear</button>
          </div>
          <div class="divider"></div>
          <div class="result" id="dca_result"></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn secondary" id="share_btn" data-i18n="Share">Share</button>
          <button class="btn secondary" id="open_premium_btn" data-i18n="Open Premium">Open Premium</button>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="plan-row">
            <b data-i18n="Market indicators">Market indicators</b>
            <button class="btn secondary" id="ind_refresh" data-i18n="Refresh">Refresh</button>
          </div>
          <div class="muted" id="ind_info">â€”</div>
          <div class="divider"></div>
          <div class="row">
            <span class="pill" id="ind_btc">BTC: â€”</span>
            <span class="pill" id="ind_eth">ETH: â€”</span>
            <span class="pill" id="ind_dom">DOM: â€”</span>
          </div>
        </div>
      </div>

      <div class="panel history">
        <h2 data-i18n="History">History</h2>
        <div id="history_list"></div>
        <div class="row">
          <button class="btn secondary" id="history_clear" data-i18n="Clear">Clear</button>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="plan-row">
            <b data-i18n="Trade Card">Trade Card</b>
            <button class="btn secondary" id="trade_card_open" data-i18n="Open">Open</button>
          </div>
          <div class="muted" data-i18n="Generate a simple trade card with your RR values.">Generate a simple trade card with your RR values.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="view_support" style="display:none;">
    <div class="panel">
      <h2 data-i18n="Support">Support</h2>
      <div class="muted" data-i18n="Support note">
        This project is built by one person. If you find it useful, you can support development.
      </div>
      <div class="divider"></div>

      <div class="row">
        <button class="btn secondary" id="wallet_btn" data-i18n="Connect Wallet">Connect Wallet</button>
        <button class="btn" id="tip_btn" data-i18n="Donate 0.05 TON">Donate 0.05 TON</button>
      </div>

      <div class="divider"></div>

      <div class="card">
        <h2 data-i18n="Achievements">Achievements</h2>
        <div class="muted" data-i18n="Achievements note">Unlock achievements by using features. Premium achievements are marked.</div>
        <div class="divider"></div>
        <div class="ach-grid" id="ach_grid"></div>
      </div>
    </div>
  </div>

  <div id="view_premium" style="display:none;">
    <div class="panel">
      <div class="plan-row">
        <h2 data-i18n="Premium Features">Premium Features</h2>
        <button class="btn secondary" id="premium_back_btn" data-i18n="Back to Calculator">Back to Calculator</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <span class="premium-badge">
          <b data-i18n="Status">Status</b>
          <span id="premium_status_text" class="muted">â€”</span>
        </span>
        <button class="btn secondary" id="ton_check_btn" data-i18n="Check payment">Check payment</button>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <div class="card glass">
          <h3 data-i18n="Plans">Plans</h3>
          <div class="plan">
            <div class="plan-row">
              <b data-i18n="30 days access">Premium-status for 30 days</b>
              <span class="pill">1 TON</span>
              <span class="pill">89 Stars</span>
            </div>
            <div class="muted" data-i18n="30d note">Unlock all premium features for 30 days.</div>
            <div class="row">
              <button class="btn" id="pay_ton_30">Pay 1 TON</button>
              <button class="btn" id="pay_stars_30">Pay 89 Stars</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="plan">
            <div class="plan-row">
              <b data-i18n="Lifetime">Lifetime</b>
              <span class="pill">4 TON</span>
              <span class="pill">389 Stars</span>
            </div>
            <div class="muted" data-i18n="Lifetime note">One-time purchase, no expiration.</div>
            <div class="row">
              <button class="btn" id="pay_ton_life">Pay 4 TON</button>
              <button class="btn" id="pay_stars_life">Pay 389 Stars</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted" data-i18n="Payment note">
            Payments are processed inside Telegram. After successful payment, Premium will be activated on this device.
          </div>
        </div>

        <div class="card glass">
          <h3 data-i18n="What you get">What you get</h3>
          <div class="row">
            <span class="pill" data-i18n="Advanced Analytics">Advanced Analytics (strongest)</span>
            <span class="pill" data-i18n="AI Tips">AI tips for trades</span>
            <span class="pill" data-i18n="Secret Achievements">Secret achievements + ranks</span>
            <span class="pill" data-i18n="PDF Report">PDF report</span>
            <span class="pill" data-i18n="Personalization">Interface personalization</span>
            <span class="pill" data-i18n="Premium Themes">Premium themes</span>
          </div>

          <div class="divider"></div>

          <h3 data-i18n="Premium Themes">Premium Themes</h3>
          <div class="muted" data-i18n="Themes note">Themes apply instantly (premium required).</div>
          <div class="divider"></div>
          <div class="themes">
            <div class="theme-btn" data-premium-theme="neon">
              <b>Neon</b>
              <span class="muted">Electric accents</span>
            </div>
            <div class="theme-btn" data-premium-theme="sunset">
              <b>Sunset</b>
              <span class="muted">Warm gradients</span>
            </div>
            <div class="theme-btn" data-premium-theme="ice">
              <b>Ice</b>
              <span class="muted">Cool minimal</span>
            </div>
          </div>

          <div class="divider"></div>

          <h3 data-i18n="Premium roadmap">Premium roadmap</h3>
          <div class="muted" data-i18n="Roadmap text">
            Premium is designed to be useful, not decorative. Analytics, reports and pro tools will appear here as they launch.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="view_settings" style="display:none;">
    <div class="panel">
      <h2 data-i18n="Settings">Settings</h2>
      <div class="muted" data-i18n="Settings note">Language and theme are saved to your account.</div>

      <div class="divider"></div>

      <div class="grid2">
        <div class="card">
          <h2 data-i18n="Language">Language</h2>
          <div class="row">
            <button class="btn secondary" id="lang_ru">RU</button>
            <button class="btn secondary" id="lang_en">EN</button>
          </div>
        </div>

        <div class="card">
          <h2 data-i18n="Theme">Theme</h2>
          <div class="row">
            <button class="btn secondary" id="theme_dark" data-i18n="Dark">Dark</button>
            <button class="btn secondary" id="theme_light" data-i18n="Light">Light</button>
          </div>
          <div class="divider"></div>
          <div class="field">
            <label data-i18n="Accent color">Accent color</label>
            <input id="accent_color" type="color" value="#5cffb0" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (async () => {
  const API_BASE = 'https://tg-stars-premium-worker.reserv-g123.workers.dev';
  const tg = window.Telegram?.WebApp;
  try { tg?.ready?.(); } catch(e) {}
  try { tg?.expand?.(); } catch(e) {}

  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    if (!toastEl) return;
    toastEl.textContent = String(msg || '');
    toastEl.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2200);
  }

  function getInitData(){
    const initData = tg?.initData || '';
    return initData || '';
  }

  const STORAGE_KEY = 'tc_user_storage_v1';
  let __mem = {};
  let __saveTimer = null;
  let __storageLoaded = false;

  async function fetchUserStorage(){
    const initData = getInitData();
    if (!initData) throw new Error("No initData");
    const r = await fetch(`${API_BASE}/api/user/storage`, {
      method: 'GET',
      headers: { 'X-Telegram-Init-Data': initData }
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{}
    if (!r.ok) throw new Error(j?.error || txt || `HTTP ${r.status}`);
    if (!j?.ok) throw new Error(j?.error || 'bad response');
    return j.data || {};
  }

  async function putUserStorage(data){
    const initData = getInitData();
    if (!initData) throw new Error("No initData");
    const r = await fetch(`${API_BASE}/api/user/storage`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Telegram-Init-Data': initData
      },
      body: JSON.stringify(data)
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{}
    if (!r.ok) throw new Error(j?.error || txt || `HTTP ${r.status}`);
    if (!j?.ok) throw new Error(j?.error || 'bad response');
    return true;
  }

  function scheduleSave(){
    if (!__storageLoaded) return;
    clearTimeout(__saveTimer);
    __saveTimer = setTimeout(async () => {
      try { await putUserStorage(__mem); } catch(e) {}
    }, 600);
  }

  async function loadServerStorage(){
    try{
      const data = await fetchUserStorage();
      __mem = data || {};
      __storageLoaded = true;
    }catch(e){
      __mem = {};
      __storageLoaded = true;
    }
  }

  const realLocalStorage = window.localStorage;
  const localStorageShim = {
    getItem(k){
      try {
        if (!__storageLoaded) return null;
        const v = __mem[k];
        return (typeof v === 'undefined') ? null : String(v);
      } catch(e) { return null; }
    },
    setItem(k, v){
      try {
        __mem[k] = String(v);
        scheduleSave();
      } catch(e) {}
    },
    removeItem(k){
      try {
        delete __mem[k];
        scheduleSave();
      } catch(e) {}
    }
  };
  try { Object.defineProperty(window, 'localStorage', { value: localStorageShim }); } catch(e) {}
  await loadServerStorage();

  async function refreshPremiumStatus(){
    const initData = getInitData();
    if (!initData) return;
    try{
      const r = await fetch(`${API_BASE}/api/premium/status`, { method:'GET', headers:{ 'X-Telegram-Init-Data': initData }});
      const j = await r.json().catch(()=>null);
      if (j?.ok){
        const p = loadPremium();
        p.lifetime = !!j.lifetime;
        p.expiresAt = j.expiresAt ? Number(j.expiresAt) : 0;
        p.plan = j.lifetime ? 'lifetime' : (j.active ? 'days' : '');
        savePremium(p);
        renderPremiumStatus();
      }
    }catch(e){}
  }

  const mainCalc = document.getElementById('view_calc');
  const mainSupport = document.getElementById('view_support');
  const mainPremium = document.getElementById('view_premium');
  const mainSettings = document.getElementById('view_settings');

  const tabCalc = document.getElementById('tab_calc');
  const tabSupport = document.getElementById('tab_support');
  const tabPremium = document.getElementById('tab_premium');
  const tabSettings = document.getElementById('tab_settings');

  function setActiveTab(btn){
    [tabCalc, tabSupport, tabPremium, tabSettings].forEach(x => x?.classList.remove('active'));
    btn?.classList.add('active');
  }

  function setMainTab(name){
    mainCalc.style.display = name === 'calc' ? '' : 'none';
    mainSupport.style.display = name === 'support' ? '' : 'none';
    mainPremium.style.display = name === 'premium' ? '' : 'none';
    mainSettings.style.display = name === 'settings' ? '' : 'none';
    if (name === 'calc') setActiveTab(tabCalc);
    if (name === 'support') setActiveTab(tabSupport);
    if (name === 'premium') setActiveTab(tabPremium);
    if (name === 'settings') setActiveTab(tabSettings);
  }

  const locales = {
    ru: {
      "Calculator": "ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€",
      "Support": "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°",
      "Settings": "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
      "Settings note": "Ð¯Ð·Ñ‹Ðº Ð¸ Ñ‚ÐµÐ¼Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð² Ð²Ð°ÑˆÐµÐ¼ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ðµ.",
      "Check payment": "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ",
      "Waiting for confirmation": "ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ",
      "No pending payment": "ÐÐµÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰ÐµÐ¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹",
      "Payment successful": "ÐžÐ¿Ð»Ð°Ñ‚Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð°",
      "Cancelled": "ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾",
      "Premium activated": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½",
      "Premium": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼",
      "Premium Features": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼-Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸",
      "Back to Calculator": "ÐÐ°Ð·Ð°Ð´ Ðº ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ñƒ",
      "Plans": "Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹",
      "30 days access": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼-ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ð° 30 Ð´Ð½ÐµÐ¹",
      "30d note": "ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼-Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½Ð° 30 Ð´Ð½ÐµÐ¹.",
      "Lifetime": "ÐÐ°Ð²ÑÐµÐ³Ð´Ð°",
      "Lifetime note": "Ð Ð°Ð·Ð¾Ð²Ð°Ñ Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ°, Ð±ÐµÐ· ÑÑ€Ð¾ÐºÐ° Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ.",
      "Payment note": "ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ Telegram. ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð½Ð° ÑÑ‚Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ.",
      "What you get": "Ð§Ñ‚Ð¾ Ð²Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚Ðµ",
      "Advanced Analytics": "Advanced Analytics (ÑÐ°Ð¼Ð¾Ðµ ÑÐ¸Ð»ÑŒÐ½Ð¾Ðµ)",
      "AI Tips": "AI-Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ¸ Ð¿Ð¾ ÑÐ´ÐµÐ»ÐºÐ°Ð¼",
      "Secret Achievements": "Ð¡ÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ + Ñ€Ð°Ð½Ð³Ð¸",
      "PDF Report": "PDF Ð¾Ñ‚Ñ‡Ñ‘Ñ‚",
      "Personalization": "ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°",
      "Premium Themes": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ñ‚ÐµÐ¼Ñ‹",
      "Themes note": "Ð¢ÐµÐ¼Ñ‹ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ ÑÑ€Ð°Ð·Ñƒ (Ð½ÑƒÐ¶ÐµÐ½ Premium).",
      "Premium roadmap": "ÐŸÐ»Ð°Ð½ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ Premium",
      "Roadmap text": "ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼ Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ð¼, Ð° Ð½Ðµ Ð´ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¼: Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°, Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹ Ð¸ pro-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾ÑÐ²Ð»ÑÑ‚ÑŒÑÑ Ð·Ð´ÐµÑÑŒ Ð¿Ð¾ Ð¼ÐµÑ€Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð².",
      "Premium active until": "Premium Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½ Ð´Ð¾",
      "Premium lifetime": "Premium Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°",
      "Premium inactive": "Premium Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²ÐµÐ½",
      "Premium activated": "Premium Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½",
      "Premium required": "ÐÑƒÐ¶ÐµÐ½ Premium",
      "Open Premium": "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Premium",
      "DCA Calculator": "DCA ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€",
      "Add multiple entries to calculate average price, total volume and cost.": "Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ñ…Ð¾Ð´Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°ÑÑ‡Ñ‘Ñ‚Ð° ÑÑ€ÐµÐ´Ð½ÐµÐ¹ Ñ†ÐµÐ½Ñ‹, Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¾Ð±ÑŠÑ‘Ð¼Ð° Ð¸ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸.",
      "Add entry": "Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð²Ñ…Ð¾Ð´",
      "Clear": "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ",
      "Average price": "Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ñ†ÐµÐ½Ð°",
      "Copy": "ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ",
      "Calculate": "Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ",
      "Risk/Reward": "Ð Ð¸ÑÐº/ÐŸÑ€Ð¸Ð±Ñ‹Ð»ÑŒ",
      "Entry price": "Ð¦ÐµÐ½Ð° Ð²Ñ…Ð¾Ð´Ð°",
      "Stop loss": "Ð¡Ñ‚Ð¾Ð¿-Ð»Ð¾ÑÑ",
      "Take profit": "Ð¢ÐµÐ¹Ðº-Ð¿Ñ€Ð¾Ñ„Ð¸Ñ‚",
      "Position Sizing": "Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸",
      "Balance": "Ð‘Ð°Ð»Ð°Ð½Ñ",
      "Risk %": "Ð Ð¸ÑÐº %",
      "Stop loss %": "Ð¡Ñ‚Ð¾Ð¿-Ð»Ð¾ÑÑ %",
      "Share": "ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ",
      "Refresh": "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ",
      "Market indicators": "Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ñ€Ñ‹Ð½ÐºÐ°",
      "History": "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ",
      "No history yet": "Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿ÑƒÑÑ‚Ð°",
      "Trade Card": "Trade Card",
      "Open": "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ",
      "Generate a simple trade card with your RR values.": "Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¾ÑÑ‚ÑƒÑŽ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÑƒ ÑÐ´ÐµÐ»ÐºÐ¸ Ð¿Ð¾ Ð²Ð°ÑˆÐ¸Ð¼ RR Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼.",
      "Language": "Ð¯Ð·Ñ‹Ðº",
      "Theme": "Ð¢ÐµÐ¼Ð°",
      "Dark": "Ð¢Ñ‘Ð¼Ð½Ð°Ñ",
      "Light": "Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ",
      "Accent color": "Ð¦Ð²ÐµÑ‚ Ð°ÐºÑ†ÐµÐ½Ñ‚Ð°",
      "Status": "Ð¡Ñ‚Ð°Ñ‚ÑƒÑ",
      "Connect Wallet": "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾ÑˆÐµÐ»Ñ‘Ðº",
      "Donate 0.05 TON": "Ð”Ð¾Ð½Ð°Ñ‚ 0.05 TON",
      "Support note": "Ð­Ñ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð´ÐµÐ»Ð°ÐµÑ‚ÑÑ Ð¾Ð´Ð½Ð¸Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ð¼. Ð•ÑÐ»Ð¸ Ð¾Ð½ Ð¿Ð¾Ð»ÐµÐ·ÐµÐ½ â€” Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ðµ.",
      "Achievements": "Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ",
      "Achievements note": "ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸. ÐŸÑ€ÐµÐ¼Ð¸ÑƒÐ¼-Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð¼ÐµÑ‡ÐµÐ½Ñ‹.",
      "Disconnect wallet?": "ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾ÑˆÐµÐ»Ñ‘Ðº?",
      "Connect wallet first": "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÐºÐ¾ÑˆÐµÐ»Ñ‘Ðº",
      "Transaction sent": "Ð¢Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð°",
      "Error": "ÐžÑˆÐ¸Ð±ÐºÐ°",
      "Risk": "Ð Ð¸ÑÐº",
      "Reward": "ÐÐ°Ð³Ñ€Ð°Ð´Ð°",
      "Copied!": "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾!",
      "Achievement unlocked": "Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾",
      "ACH_WELCOME_TITLE": "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ",
      "ACH_WELCOME_DESC": "ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð¼Ð¸Ð½Ð¸-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð²Ð¿ÐµÑ€Ð²Ñ‹Ðµ.",
      "ACH_STYLE_TITLE": "Ð¡Ñ‚Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ñ€ÐµÐ¹Ð´ÐµÑ€",
      "ACH_STYLE_DESC": "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ñ‚ÐµÐ¼Ñƒ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ.",
      "ACH_COLOR_TITLE": "ÐšÐ¾Ð»Ð¾Ñ€Ð¸ÑÑ‚",
      "ACH_COLOR_DESC": "Ð¡Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ñ†Ð²ÐµÑ‚ Ð°ÐºÑ†ÐµÐ½Ñ‚Ð° 3 Ñ€Ð°Ð·Ð°.",
      "ACH_BILINGUAL_TITLE": "Ð‘Ð¸Ð»Ð¸Ð½Ð³Ð²",
      "ACH_BILINGUAL_DESC": "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°.",
      "ACH_DCA_TITLE": "DCA-ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÐµÐ»ÑŒ",
      "ACH_DCA_DESC": "Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº Ð² DCA.",
      "ACH_COPY_TITLE": "ÐšÐ¾Ð¿Ð¸Ð¿Ð°ÑÑ‚ÐµÑ€",
      "ACH_COPY_DESC": "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ 5 Ñ€Ð°Ð·.",
      "ACH_DATA_TITLE": "Ð¡Ð²ÐµÐ¶Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ",
      "ACH_DATA_DESC": "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ñ€Ñ‹Ð½ÐºÐ°.",
      "ACH_CARD_TITLE": "ÐšÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° Ñ‚Ñ€ÐµÐ¹Ð´ÐµÑ€Ð°",
      "ACH_CARD_DESC": "ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Trade Card.",
      "ACH_SHARE_TITLE": "ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ",
      "ACH_SHARE_DESC": "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Â«ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑÂ».",
      "ACH_TIP_TITLE": "ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°",
      "ACH_TIP_DESC": "ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð´Ð¾Ð½Ð°Ñ‚ 0.05 TON.",
      "ACH_HISTORY_TITLE": "Ð›ÐµÑ‚Ð¾Ð¿Ð¸ÑÐµÑ†",
      "ACH_HISTORY_DESC": "Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ 10 Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸.",
      "ACH_PREMIUM_TITLE": "ÐÐ»Ð¼Ð°Ð·Ð½Ñ‹Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ",
      "ACH_PREMIUM_DESC": "ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Premium.",
      "ACH_THEME_TITLE": "ÐŸÐ¾Ð²ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ Ñ‚ÐµÐ¼",
      "ACH_THEME_DESC": "ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ 3 Ð¿Ñ€ÐµÐ¼Ð¸ÑƒÐ¼ Ñ‚ÐµÐ¼Ñ‹."
    },
    en: {
      "Calculator": "Calculator",
      "Support": "Support",
      "Settings": "Settings",
      "Settings note": "Language and theme are saved to your account.",
      "Check payment": "Check payment",
      "Waiting for confirmation": "Waiting for confirmation",
      "No pending payment": "No pending payment",
      "Payment successful": "Payment successful",
      "Cancelled": "Cancelled",
      "Premium activated": "Premium activated",
      "Premium": "Premium",
      "Premium Features": "Premium Features",
      "Back to Calculator": "Back to Calculator",
      "Plans": "Plans",
      "30 days access": "Premium status for 30 days",
      "30d note": "Unlock all premium features for 30 days.",
      "Lifetime": "Lifetime",
      "Lifetime note": "One-time purchase, no expiration.",
      "Payment note": "Payments are processed inside Telegram. After successful payment, Premium will be activated on this device.",
      "What you get": "What you get",
      "Advanced Analytics": "Advanced Analytics (strongest)",
      "AI Tips": "AI tips for trades",
      "Secret Achievements": "Secret achievements + ranks",
      "PDF Report": "PDF report",
      "Personalization": "Interface personalization",
      "Premium Themes": "Premium themes",
      "Themes note": "Themes apply instantly (premium required).",
      "Premium roadmap": "Premium roadmap",
      "Roadmap text": "Premium is designed to be useful, not decorative. Analytics, reports and pro tools will appear here as they launch.",
      "Premium active until": "Premium active until",
      "Premium lifetime": "Premium lifetime",
      "Premium inactive": "Premium inactive",
      "Premium activated": "Premium activated",
      "Premium required": "Premium required",
      "Open Premium": "Open Premium",
      "DCA Calculator": "DCA Calculator",
      "Add multiple entries to calculate average price, total volume and cost.": "Add multiple entries to calculate average price, total volume and cost.",
      "Add entry": "Add entry",
      "Clear": "Clear",
      "Average price": "Average price",
      "Copy": "Copy",
      "Calculate": "Calculate",
      "Risk/Reward": "Risk/Reward",
      "Entry price": "Entry price",
      "Stop loss": "Stop loss",
      "Take profit": "Take profit",
      "Position Sizing": "Position Sizing",
      "Balance": "Balance",
      "Risk %": "Risk %",
      "Stop loss %": "Stop loss %",
      "Share": "Share",
      "Refresh": "Refresh",
      "Market indicators": "Market indicators",
      "History": "History",
      "No history yet": "No history yet",
      "Trade Card": "Trade Card",
      "Open": "Open",
      "Generate a simple trade card with your RR values.": "Generate a simple trade card with your RR values.",
      "Language": "Language",
      "Theme": "Theme",
      "Dark": "Dark",
      "Light": "Light",
      "Accent color": "Accent color",
      "Status": "Status",
      "Connect Wallet": "Connect Wallet",
      "Donate 0.05 TON": "Donate 0.05 TON",
      "Support note": "This project is built by one person. If you find it useful, you can support development.",
      "Achievements": "Achievements",
      "Achievements note": "Unlock achievements by using features. Premium achievements are marked.",
      "Disconnect wallet?": "Disconnect wallet?",
      "Connect wallet first": "Connect wallet first",
      "Transaction sent": "Transaction sent",
      "Error": "Error",
      "Risk": "Risk",
      "Reward": "Reward",
      "Copied!": "Copied!",
      "Achievement unlocked": "Achievement unlocked",
      "ACH_WELCOME_TITLE": "Welcome",
      "ACH_WELCOME_DESC": "Open the mini app for the first time.",
      "ACH_STYLE_TITLE": "Stylish trader",
      "ACH_STYLE_DESC": "Switch the theme.",
      "ACH_COLOR_TITLE": "Colorist",
      "ACH_COLOR_DESC": "Change accent color 3 times.",
      "ACH_BILINGUAL_TITLE": "Bilingual",
      "ACH_BILINGUAL_DESC": "Switch the interface language.",
      "ACH_DCA_TITLE": "DCA builder",
      "ACH_DCA_DESC": "Add 5 rows to DCA.",
      "ACH_COPY_TITLE": "Copypaster",
      "ACH_COPY_DESC": "Copy values 5 times.",
      "ACH_DATA_TITLE": "Fresh data",
      "ACH_DATA_DESC": "Refresh market indicators.",
      "ACH_CARD_TITLE": "Trade card",
      "ACH_CARD_DESC": "Open Trade Card.",
      "ACH_SHARE_TITLE": "Share",
      "ACH_SHARE_DESC": "Press Share.",
      "ACH_TIP_TITLE": "Support the project",
      "ACH_TIP_DESC": "Send a 0.05 TON donation.",
      "ACH_HISTORY_TITLE": "Chronicler",
      "ACH_HISTORY_DESC": "Save 10 actions to history.",
      "ACH_PREMIUM_TITLE": "Diamond status",
      "ACH_PREMIUM_DESC": "Activate Premium.",
      "ACH_THEME_TITLE": "Theme master",
      "ACH_THEME_DESC": "Apply 3 premium themes."
    }
  };

  let currentLang = localStorage.getItem('tc_lang') || 'ru';
  function t(key){
    const dict = locales[currentLang] || locales.ru;
    return dict[key] || key;
  }
  function translateAll(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (!key) return;
      el.textContent = t(key);
    });
    try{ updateWalletUI(); }catch(e){}
    try{ renderPremiumStatus(); }catch(e){}
  }

  function setLang(lang){
    currentLang = lang;
    localStorage.setItem('tc_lang', lang);
    translateAll();
    showToast(lang.toUpperCase());
    try{ onAchievementEvent('lang_switched'); }catch(e){}
  }

  document.getElementById('lang_ru').addEventListener('click', () => setLang('ru'));
  document.getElementById('lang_en').addEventListener('click', () => setLang('en'));

  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('tc_theme', theme);
    translateAll();
    showToast(theme);
    try{ onAchievementEvent('theme_switched'); }catch(e){}
  }

  document.getElementById('theme_dark').addEventListener('click', () => setTheme('dark'));
  document.getElementById('theme_light').addEventListener('click', () => setTheme('light'));

  const savedTheme = localStorage.getItem('tc_theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);

  const accentInput = document.getElementById('accent_color');
  const savedAccent = localStorage.getItem('tc_accent') || '#5cffb0';
  try{ accentInput.value = savedAccent; }catch(e){}
  document.documentElement.style.setProperty('--accent', savedAccent);
  accentInput.addEventListener('input', (e) => {
    const v = e.target.value;
    document.documentElement.style.setProperty('--accent', v);
    localStorage.setItem('tc_accent', v);
    try{ onAchievementEvent('color_changed'); }catch(e){}
  });

  const rrEntry = document.getElementById('rr_entry');
  const rrStop = document.getElementById('rr_stop');
  const rrTake = document.getElementById('rr_take');
  const rrRes = document.getElementById('rr_result');

  function fmt(n){
    if (!isFinite(n)) return 'â€”';
    return (Math.round(n * 100000) / 100000).toString();
  }

  function calcRR(){
    const entry = Number(rrEntry.value);
    const stop = Number(rrStop.value);
    const take = Number(rrTake.value);
    const risk = Math.abs(entry - stop);
    const reward = Math.abs(take - entry);
    const rr = risk > 0 ? reward / risk : 0;
    rrRes.innerHTML = `
      <span class="pill">${t('Risk/Reward')}: <b>${fmt(rr)}</b></span>
      <span class="pill">${t('Risk')} <b>${fmt(risk)}</b></span>
      <span class="pill">${t('Reward')} <b>${fmt(reward)}</b></span>
    `;
    pushHistory('RR', `${fmt(rr)} | risk ${fmt(risk)} reward ${fmt(reward)}`);
  }

  document.getElementById('rr_calc').addEventListener('click', calcRR);
  document.getElementById('rr_copy').addEventListener('click', () => {
    try{
      navigator.clipboard.writeText(rrRes.innerText || '');
      showToast(t('Copied'));
      onAchievementEvent('value_copied');
    }catch(e){
      showToast(t('Error'));
    }
  });

  const capBalance = document.getElementById('cap_balance');
  const capRiskPct = document.getElementById('cap_risk_pct');
  const capStopPct = document.getElementById('cap_stop_pct');
  const capRes = document.getElementById('cap_result');

  function calcCap(){
    const bal = Number(capBalance.value);
    const riskPct = Number(capRiskPct.value);
    const stopPct = Number(capStopPct.value);
    const riskAmt = bal * (riskPct / 100);
    const pos = stopPct > 0 ? riskAmt / (stopPct / 100) : 0;
    capRes.innerHTML = `
      <span class="pill">${t('Risk amount')}: <b>${fmt(riskAmt)}</b></span>
      <span class="pill">${t('Position size')}: <b>${fmt(pos)}</b></span>
    `;
    pushHistory('CAP', `risk ${fmt(riskAmt)} pos ${fmt(pos)}`);
  }

  document.getElementById('cap_calc').addEventListener('click', calcCap);
  document.getElementById('cap_copy').addEventListener('click', () => {
    try{
      navigator.clipboard.writeText(capRes.innerText || '');
      showToast(t('Copied'));
      onAchievementEvent('value_copied');
    }catch(e){
      showToast(t('Error'));
    }
  });

  const DCA_KEY = 'tc_dca_rows_v1';
  const dcaList = document.getElementById('dca_list');
  const dcaRes = document.getElementById('dca_result');

  function loadDCA(){
    try{
      const raw = localStorage.getItem(DCA_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveDCA(arr){
    try{ localStorage.setItem(DCA_KEY, JSON.stringify(arr)); }catch(e){}
  }

  function renderDCA(){
    const arr = loadDCA();
    dcaList.innerHTML = '';
    arr.forEach((row, idx) => {
      const div = document.createElement('div');
      div.className = 'row';
      div.style.alignItems = 'center';
      div.style.marginBottom = '10px';
      div.innerHTML = `
        <input style="flex:1;min-width:120px" type="number" step="any" placeholder="Price" value="${row.price ?? ''}" data-idx="${idx}" data-k="price">
        <input style="flex:1;min-width:120px" type="number" step="any" placeholder="Amount" value="${row.amount ?? ''}" data-idx="${idx}" data-k="amount">
        <button class="btn danger" data-del="${idx}">Ã—</button>
      `;
      dcaList.appendChild(div);
    });
    recalcDCA();
  }

  function recalcDCA(){
    const arr = loadDCA();
    let totalCost = 0;
    let totalAmt = 0;
    for (const r of arr){
      const p = Number(r.price);
      const a = Number(r.amount);
      if (!isFinite(p) || !isFinite(a)) continue;
      totalCost += p * a;
      totalAmt += a;
    }
    const avg = totalAmt > 0 ? totalCost / totalAmt : 0;
    dcaRes.innerHTML = `
      <span class="pill">${t('Average price')}: <b>${fmt(avg)}</b></span>
      <span class="pill">${t('Total amount')}: <b>${fmt(totalAmt)}</b></span>
      <span class="pill">${t('Total cost')}: <b>${fmt(totalCost)}</b></span>
    `;
  }

  function addDCA(){
    const arr = loadDCA();
    arr.push({ price: '', amount: '' });
    saveDCA(arr);
    renderDCA();
    onAchievementEvent('dca_add');
  }

  function clearDCA(){
    saveDCA([]);
    renderDCA();
  }

  dcaList.addEventListener('input', (e) => {
    const tEl = e.target;
    if (!tEl?.dataset) return;
    const idx = Number(tEl.dataset.idx);
    const k = tEl.dataset.k;
    if (!isFinite(idx) || !k) return;
    const arr = loadDCA();
    if (!arr[idx]) return;
    arr[idx][k] = tEl.value;
    saveDCA(arr);
    recalcDCA();
  });

  dcaList.addEventListener('click', (e) => {
    const btn = e.target;
    const del = btn?.getAttribute?.('data-del');
    if (del === null) return;
    const idx = Number(del);
    const arr = loadDCA();
    arr.splice(idx, 1);
    saveDCA(arr);
    renderDCA();
  });

  document.getElementById('dca_add').addEventListener('click', addDCA);
  document.getElementById('dca_clear').addEventListener('click', clearDCA);

  const HISTORY_KEY = 'tc_history_v1';
  function loadHistory(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveHistory(arr){
    try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){}
  }
  function pushHistory(type, text){
    const arr = loadHistory();
    arr.unshift({ type, text, ts: Date.now() });
    arr.splice(25);
    saveHistory(arr);
    renderHistory();
    onAchievementEvent('history_saved');
  }
  function renderHistory() {
    const list = document.getElementById('history_list');
    list.innerHTML = '';
    const arr = loadHistory();
    if (!arr.length) {
      list.innerHTML = '<div class="small">' + t('No history yet') + '</div>';
      return;
    }
    arr.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item';
      const d = new Date(item.ts);
      div.innerHTML = `<b>${item.type}</b><span>${item.text}</span><span>${d.toLocaleString()}</span>`;
      list.appendChild(div);
    });
  }
  document.getElementById('history_clear').addEventListener('click', () => {
    saveHistory([]);
    renderHistory();
  });

  document.getElementById('share_btn').addEventListener('click', () => {
    try{
      const txt = `Trade Calculator\nRR: ${rrRes.innerText}\nCAP: ${capRes.innerText}`;
      if (tg?.shareMessage) {
        tg.shareMessage(txt);
      } else {
        navigator.clipboard.writeText(txt);
        showToast(t('Copied'));
      }
      onAchievementEvent('shared');
    } catch(e) {
      showToast(t('Error'));
    }
  });

  document.getElementById('open_premium_btn').addEventListener('click', () => setMainTab('premium'));

  async function refreshIndicators(){
    try{
      const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
      const j = await r.json();
      document.getElementById('ind_btc').textContent = `BTC: ${fmt(Number(j.price))}`;
      const r2 = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT');
      const j2 = await r2.json();
      document.getElementById('ind_eth').textContent = `ETH: ${fmt(Number(j2.price))}`;
      document.getElementById('ind_dom').textContent = `DOM: â€”`;
      document.getElementById('ind_info').textContent = new Date().toLocaleString();
      onAchievementEvent('indicators_refreshed');
    }catch(e){
      showToast(t('Error'));
    }
  }
  document.getElementById('ind_refresh').addEventListener('click', refreshIndicators);

  document.getElementById('trade_card_open').addEventListener('click', () => {
    try{
      const w = window.open('', '_blank');
      const html = `
        <html><head><meta charset="utf-8"><title>Trade Card</title></head>
        <body style="font-family:Arial;padding:20px;background:#111;color:#fff">
          <h2>Trade Card</h2>
          <pre>${rrRes.innerText}</pre>
          <pre>${capRes.innerText}</pre>
        </body></html>
      `;
      w.document.write(html);
      w.document.close();
      onAchievementEvent('card_opened');
    }catch(e){ showToast(t('Error')); }
  });

  const PREMIUM_KEY = 'tc_premium_v1';
  function loadPremium(){
    try{
      const raw = localStorage.getItem(PREMIUM_KEY);
      if (!raw) return { lifetime:false, expiresAt:0, plan:'', tx:'' };
      const j = JSON.parse(raw);
      return { lifetime: !!j.lifetime, expiresAt: Number(j.expiresAt)||0, plan: j.plan||'', tx: j.tx||'' };
    }catch(e){ return { lifetime:false, expiresAt:0, plan:'', tx:'' }; }
  }
  function savePremium(p){
    try{ localStorage.setItem(PREMIUM_KEY, JSON.stringify(p)); }catch(e){}
  }
  function isPremiumActive(p){
    return !!p && (p.lifetime || (p.expiresAt && Date.now() < p.expiresAt));
  }
  function premiumStatusText(){
    const p = loadPremium();
    if (p.lifetime) return t('Premium lifetime');
    if (p.expiresAt && Date.now() < p.expiresAt) {
      const d = new Date(p.expiresAt);
      return `${t('Premium active until')} ${d.toLocaleString()}`;
    }
    return t('Premium inactive');
  }
  function renderPremiumStatus(){
    const el = document.getElementById('premium_status_text');
    if (el) el.textContent = premiumStatusText();
  }
  function activatePremiumDays(days, plan, tx){
    const p = loadPremium();
    const now = Date.now();
    p.lifetime = false;
    p.expiresAt = now + days * 86400000;
    p.plan = plan || `days_${days}`;
    p.tx = tx || '';
    savePremium(p);
    renderPremiumStatus();
    try{ onAchievementEvent('premium_user'); }catch(e){}
    showToast(t('Premium activated'));
  }
  function activatePremiumLifetime(plan, tx){
    const p = loadPremium();
    p.lifetime = true;
    p.expiresAt = 0;
    p.plan = plan || 'lifetime';
    p.tx = tx || '';
    savePremium(p);
    renderPremiumStatus();
    try{ onAchievementEvent('premium_user'); }catch(e){}
    showToast(t('Premium activated'));
  }
  function resetPremium(){
    localStorage.removeItem(PREMIUM_KEY);
    renderPremiumStatus();
    showToast(t('Premium inactive'));
  }
  function requirePremium(reason){
    const p = loadPremium();
    if (isPremiumActive(p)) return true;
    showToast(`${t('Premium required')} â€¢ ${reason || ''}`.trim());
    setMainTab('premium');
    return false;
  }

  const ACH_KEY = 'tc_achievements_v1';
  function loadAchState() {
    try {
      const raw = localStorage.getItem(ACH_KEY);
      if (!raw) return { unlocked: {}, counters: {} };
      const j = JSON.parse(raw);
      return { unlocked: j?.unlocked || {}, counters: j?.counters || {} };
    } catch(e) {
      return { unlocked: {}, counters: {} };
    }
  }
  function saveAchState(state) {
    try { localStorage.setItem(ACH_KEY, JSON.stringify(state)); } catch(e) {}
  }
  const achievements = [
    { id: 'first_launch', icon: 'âœ¨', titleKey: 'ACH_WELCOME_TITLE', descKey: 'ACH_WELCOME_DESC', type: 'one' },
    { id: 'theme_switch', icon: 'ðŸŒ“', titleKey: 'ACH_STYLE_TITLE', descKey: 'ACH_STYLE_DESC', type: 'one' },
    { id: 'color_3', icon: 'ðŸŽ¨', titleKey: 'ACH_COLOR_TITLE', descKey: 'ACH_COLOR_DESC', type: 'count', counter: 'color_changes', need: 3 },
    { id: 'lang_switch', icon: 'ðŸŒ', titleKey: 'ACH_BILINGUAL_TITLE', descKey: 'ACH_BILINGUAL_DESC', type: 'one' },
    { id: 'dca_5', icon: 'ðŸ§±', titleKey: 'ACH_DCA_TITLE', descKey: 'ACH_DCA_DESC', type: 'count', counter: 'dca_adds', need: 5 },
    { id: 'copy_5', icon: 'ðŸ“‹', titleKey: 'ACH_COPY_TITLE', descKey: 'ACH_COPY_DESC', type: 'count', counter: 'copies', need: 5 },
    { id: 'ind_refresh', icon: 'ðŸ›°ï¸', titleKey: 'ACH_DATA_TITLE', descKey: 'ACH_DATA_DESC', type: 'one' },
    { id: 'card_open', icon: 'ðŸƒ', titleKey: 'ACH_CARD_TITLE', descKey: 'ACH_CARD_DESC', type: 'one' },
    { id: 'share', icon: 'ðŸ“¤', titleKey: 'ACH_SHARE_TITLE', descKey: 'ACH_SHARE_DESC', type: 'one' },
    { id: 'tip', icon: 'ðŸ’Ž', titleKey: 'ACH_TIP_TITLE', descKey: 'ACH_TIP_DESC', type: 'one' },
    { id: 'history_10', icon: 'ðŸ“œ', titleKey: 'ACH_HISTORY_TITLE', descKey: 'ACH_HISTORY_DESC', type: 'count', counter: 'history_saved', need: 10 },
    { id: 'premium_user', icon: 'ðŸ’Ž', titleKey: 'ACH_PREMIUM_TITLE', descKey: 'ACH_PREMIUM_DESC', type: 'one', premium: true },
    { id: 'theme_master', icon: 'ðŸŒˆ', titleKey: 'ACH_THEME_TITLE', descKey: 'ACH_THEME_DESC', type: 'count', counter: 'premium_themes', need: 3, premium: true }
  ];
  let achState = loadAchState();

  function isUnlocked(id) { return !!achState.unlocked[id]; }

  function unlockAchievement(id) {
    if (isUnlocked(id)) return false;
    achState.unlocked[id] = Date.now();
    saveAchState(achState);
    renderAchievements();
    const a = achievements.find(x => x.id === id);
    showToast(`${t('Achievement unlocked')}: ${t(a?.titleKey || id)}`);
    if (window.TelegramAnalytics) window.TelegramAnalytics.trackEvent('achievement_unlocked', { id });
    return true;
  }

  function incCounter(name, by = 1) {
    achState.counters[name] = (Number(achState.counters[name]) || 0) + by;
    saveAchState(achState);
  }

  function checkCounters() {
    achievements.forEach(a => {
      if (a.type !== 'count') return;
      const v = Number(achState.counters[a.counter]) || 0;
      if (v >= a.need) unlockAchievement(a.id);
    });
  }

  function onAchievementEvent(evt) {
    if (evt === 'color_changed') incCounter('color_changes', 1);
    if (evt === 'dca_add') incCounter('dca_adds', 1);
    if (evt === 'value_copied') incCounter('copies', 1);
    if (evt === 'history_saved') incCounter('history_saved', 1);
    if (evt === 'lang_switched') unlockAchievement('lang_switch');
    if (evt === 'theme_switched') unlockAchievement('theme_switch');
    if (evt === 'indicators_refreshed') unlockAchievement('ind_refresh');
    if (evt === 'card_opened') unlockAchievement('card_open');
    if (evt === 'shared') unlockAchievement('share');
    if (evt === 'tip_sent') unlockAchievement('tip');
    if (evt === 'premium_user') unlockAchievement('premium_user');
    if (evt === 'premium_theme_applied') incCounter('premium_themes', 1);
    checkCounters();
  }

  function renderAchievements(){
    const grid = document.getElementById('ach_grid');
    if (!grid) return;
    grid.innerHTML = '';
    achievements.forEach(a => {
      const locked = !isUnlocked(a.id);
      const div = document.createElement('div');
      div.className = 'ach' + (locked ? ' locked' : '');
      div.innerHTML = `
        <div class="icon">${a.icon}</div>
        <div class="meta">
          <b>${t(a.titleKey)}</b>
          <span>${t(a.descKey)}</span>
          ${a.premium ? `<span class="pill">Premium</span>` : ``}
        </div>
      `;
      grid.appendChild(div);
    });
  }

  const TONCONNECT_MANIFEST_URL = 'https://trade-calculator-five.vercel.app/tonconnect-manifest.json';
  const TIP_ADDRESS = 'UQD04FKshVmZaQjZq9y2AtBXWklkzQfK4sEJWrsYfqbNHGGz';
  let tonConnectUI = null;
  function initTonConnect() {
    try {
      if (!window.TON_CONNECT_UI?.TonConnectUI) return;
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
        manifestUrl: TONCONNECT_MANIFEST_URL
      });
      tonConnectUI.onStatusChange(() => {
        updateWalletUI();
      });
      updateWalletUI();
    } catch(e) {}
  }
  function updateWalletUI() {
    const wBtn = document.getElementById('wallet_btn');
    const tipBtn = document.getElementById('tip_btn');
    if (!tonConnectUI) {
      wBtn.disabled = true;
      tipBtn.disabled = true;
      return;
    }
    wBtn.disabled = false;
    tipBtn.disabled = !tonConnectUI.connected;
    if (tonConnectUI.connected) {
      const addr = tonConnectUI.account?.address || '';
      wBtn.textContent = addr.slice(0, 6) + '.' + addr.slice(-4);
    } else {
      wBtn.textContent = t('Connect Wallet');
    }
  }
  document.getElementById('wallet_btn').addEventListener('click', async () => {
    if (!tonConnectUI) return;
    if (tonConnectUI.connected) {
      const confirm = window.confirm(t('Disconnect wallet?'));
      if (confirm) {
        await tonConnectUI.disconnect();
        updateWalletUI();
      }
    } else {
      await tonConnectUI.openModal();
    }
    if (window.TelegramAnalytics) {
      window.TelegramAnalytics.trackEvent('wallet_action', {
        action: tonConnectUI.connected ? 'disconnect' : 'connect_attempt'
      });
    }
  });
  document.getElementById('tip_btn').addEventListener('click', async () => {
    if (!tonConnectUI?.connected) {
      showToast(t('Connect wallet first'));
      return;
    }
    try {
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [{
          address: TIP_ADDRESS,
          amount: '50000000'
        }]
      };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('Transaction sent'));
      onAchievementEvent('tip_sent');
      if (window.TelegramAnalytics) {
        window.TelegramAnalytics.trackEvent('tip_sent');
      }
    } catch(e) {
      showToast(`${t('Error')}: ${e?.message || e}`);
    }
  });
  initTonConnect();

  document.getElementById('premium_back_btn').addEventListener('click', () => setMainTab('calc'));

  document.querySelectorAll('[data-premium-theme]').forEach(btn => {
    btn.addEventListener('click', () => {
      const theme = btn.getAttribute('data-premium-theme');
      if (!requirePremium(t('Premium Themes'))) return;
      document.documentElement.setAttribute('data-premium-theme', theme);
      localStorage.setItem('tc_premium_theme', theme);
      try{ onAchievementEvent('premium_theme_applied'); }catch(e){}
      showToast(theme);
    });
  });

  const savedPremiumTheme = localStorage.getItem('tc_premium_theme');
  if (savedPremiumTheme) document.documentElement.setAttribute('data-premium-theme', savedPremiumTheme);

  function mainTabHandlers(){
    tabCalc.addEventListener('click', () => setMainTab('calc'));
    tabSupport.addEventListener('click', () => setMainTab('support'));
    tabPremium.addEventListener('click', () => setMainTab('premium'));
    tabSettings.addEventListener('click', () => setMainTab('settings'));
  }
  mainTabHandlers();

  async function createTonOrder(plan){
    const initData = getInitData();
    const r = await fetch(`${API_BASE}/api/ton/order?plan=${encodeURIComponent(plan)}`, {
      method:'GET',
      headers:{ 'X-Telegram-Init-Data': initData }
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{}
    if (!r.ok) throw new Error(j?.error || txt || `HTTP ${r.status}`);
    if (!j?.ok) throw new Error(j?.error || 'bad response');
    return j;
  }

  async function confirmTonOrder(orderId){
    const initData = getInitData();
    const r = await fetch(`${API_BASE}/api/ton/confirm`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-Telegram-Init-Data': initData
      },
      body: JSON.stringify({ orderId })
    });
    const txt = await r.text();
    let j = null;
    try{ j = JSON.parse(txt); }catch{}
    if (!r.ok) throw new Error(j?.error || txt || `HTTP ${r.status}`);
    return j || { ok:false, error: txt || 'bad response' };
  }

  async function payTonPlan(plan){
    if (!tonConnectUI?.connected) { showToast(t('Connect wallet first')); return; }
    try{
      const order = await createTonOrder(plan);
      const amountNano = String(Math.round(Number(order.amountTon) * 1e9));
      const tx = {
        validUntil: Number(order.validUntil) || (Math.floor(Date.now() / 1000) + 900),
        messages: [{
          address: order.receiver,
          amount: amountNano
        }]
      };
      await tonConnectUI.sendTransaction(tx);
      try{
        const res = await confirmTonOrder(order.orderId);
        if (res?.ok && res.granted) {
          showToast(t('Premium activated'));
          await refreshPremiumStatus();
        } else if (res?.error) {
          showToast(String(res.error));
          window.__lastTonOrderId = order.orderId;
        } else {
          showToast(t('Waiting for confirmation'));
          window.__lastTonOrderId = order.orderId;
        }
      }catch(e){
        window.__lastTonOrderId = order.orderId;
        showToast(t('Waiting for confirmation'));
      }
    }catch(e){
      showToast(`${t('Error')}: ${e?.message || e}`);
    }
  }

  const tonCheckBtn = document.getElementById('ton_check_btn');
  if (tonCheckBtn) {
    tonCheckBtn.addEventListener('click', async () => {
      const last = window.__lastTonOrderId;
      if (!last) { showToast(t('No pending payment')); return; }
      try{
        const res = await confirmTonOrder(last);
        if (res.granted) {
          showToast(t('Payment successful'));
          window.__lastTonOrderId = null;
          await refreshPremiumStatus();
        } else {
          showToast(t('Waiting for confirmation'));
        }
      }catch(e){
        showToast(`${t('Error')}: ${e?.message || e}`);
      }
    });
  }

  document.getElementById('pay_ton_30').addEventListener('click', () => payTonPlan('ton_30d'));
  document.getElementById('pay_ton_life').addEventListener('click', () => payTonPlan('ton_lifetime'));

  async function openStarsInvoice(plan){
    if (!tg || !tg.openInvoice) { showToast(t('Error')); return; }
    const initData = getInitData();
    if (!initData) { showToast(t('Error')); return; }
    try{
      const resp = await fetch(`${API_BASE}/api/stars/invoice?plan=${encodeURIComponent(plan)}`, {
        method:'GET',
        headers:{ 'X-Telegram-Init-Data': initData }
      });
      const data = await resp.json();
      if (!data?.ok || !data.url) { showToast(t('Error')); return; }

      tg.openInvoice(data.url, async (status) => {
        if (status === 'paid') {
          showToast(t('Payment successful'));
          await refreshPremiumStatus();
        } else if (status === 'cancelled') {
          showToast(t('Cancelled'));
        } else {
          showToast(status);
        }
      });
    }catch(e){
      showToast(`${t('Error')}: ${e?.message || e}`);
    }
  }
  document.getElementById('pay_stars_30').addEventListener('click', () => openStarsInvoice('stars_30d'));
  document.getElementById('pay_stars_life').addEventListener('click', () => openStarsInvoice('stars_lifetime'));

  await refreshPremiumStatus();
  renderPremiumStatus();
  translateAll();

  if (!isUnlocked('first_launch')) unlockAchievement('first_launch');
  renderAchievements();
  renderDCA();
  calcRR();
  calcCap();
  renderHistory();

  if (window.TelegramAnalytics) {
    window.TelegramAnalytics.trackEvent('app_loaded');
  }
  })();
  </script>
</body>
</html>
