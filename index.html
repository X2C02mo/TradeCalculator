<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator + Indicators</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  /* dark */
  --bg:#000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#fff;
  --muted:#9a9a9a;
  --accent:#7CFC00;
  --danger:#ff4d4f;

  --input-bg:#070707;
  --result-bg:#060606;
  --chip-bg:#0a0a0a;

  --shadow: 0 12px 40px rgba(0,0,0,.45);
}
:root[data-theme="light"]{
  --bg:#ffffff;
  --panel:#f6f6f6;
  --border:#e6e6e6;
  --text:#111111;
  --muted:#666666;
  --accent:#0bbf5e;
  --danger:#d9363e;

  --input-bg:#ffffff;
  --result-bg:#ffffff;
  --chip-bg:#f1f1f1;

  --shadow: 0 12px 40px rgba(0,0,0,.12);
}

*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
body{padding-bottom:env(safe-area-inset-bottom); padding-top:env(safe-area-inset-top)}
#app{min-height:100vh;display:flex;flex-direction:column}

/* header */
header{
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:var(--bg);
}
.leftbar{display:flex;gap:8px;align-items:center}
.lang{display:flex;gap:6px;align-items:center}
.lang button{
  background:none;border:1px solid var(--border);color:var(--muted);
  padding:4px 8px;cursor:pointer;border-radius:10px
}
.lang button.active{color:var(--accent);border-color:var(--accent)}

.iconbtn{
  background:none;border:1px solid var(--border);color:var(--muted);
  padding:6px 10px;cursor:pointer;border-radius:12px;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
}
.iconbtn:active{transform:translateY(1px)}
.iconbtn .ico{font-size:14px;line-height:1}
.iconbtn.active{border-color:var(--accent);color:var(--accent)}

.tabs{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  margin-left:auto;
}
.tab{
  background:none;border:none;color:var(--muted);
  font-size:13px;padding:6px 10px;cursor:pointer;border-radius:10px
}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}

main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}

.card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:12px;max-width:820px
}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{
  width:100%;padding:10px;background:var(--input-bg);
  border:1px solid var(--border);color:var(--text);
  border-radius:12px;font-size:14px;outline:none
}
input:focus{border-color:color-mix(in oklab, var(--accent) 45%, var(--border))}

.row{
  display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
  padding:10px; border:1px solid var(--border); border-radius:14px;
  background:color-mix(in oklab, var(--panel) 75%, var(--bg));
}
.row .col{flex:1; min-width:130px}
.row .mini{
  width:40px; height:40px; display:flex; align-items:center; justify-content:center;
  border-radius:14px; border:1px solid var(--border);
  background:var(--chip-bg); cursor:pointer; color:var(--muted);
}
.row .mini:hover{border-color:color-mix(in oklab, var(--accent) 25%, var(--border))}
.row .mini:active{transform:translateY(1px)}

.result{
  margin-top:8px;padding:10px;border-radius:14px;
  background:var(--result-bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:10px
}
.res-left{display:flex;flex-direction:column;gap:3px}
.res-label{color:var(--muted);font-size:12px}
.res-value{font-weight:900;font-size:14px}
.res-value.muted{color:var(--muted);font-weight:700}
.res-value.danger{color:var(--danger)}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  background:transparent;color:var(--accent);
  border:1px solid #2b2b2b;padding:8px 10px;border-radius:14px;
  cursor:pointer;font-weight:800
}
:root[data-theme="light"] .btn{border-color:var(--border)}
.btn:active{transform:translateY(1px)}
.btn.ghost{color:var(--muted);border-color:var(--border)}
.btn.small{padding:6px 10px;border-radius:999px;font-weight:900}
.btn:disabled{opacity:.45; cursor:not-allowed}

.note{font-size:12px;color:var(--muted);line-height:1.35}
.small{font-size:11px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--border);
  background:var(--chip-bg);
  padding:6px 10px;border-radius:999px;
  color:var(--muted);font-size:12px
}
.hr{height:1px;background:var(--border);margin:12px 0}

/* Indicator visuals */
.viz-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.viz{
  flex:1; min-width:240px;
  background:color-mix(in oklab, var(--panel) 60%, var(--bg));
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
}
.viz-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.viz-title b{font-size:12px}
.viz-title span{font-size:11px;color:var(--muted)}
.viz canvas{width:100%;height:140px;display:block;border-radius:12px;background:var(--result-bg);border:1px solid var(--border)}

/* right panel */
.history{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px;max-width:420px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}

/* footer */
footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px}
.links{display:flex;gap:18px;margin-top:2px}
.rainbow{
  display:inline-block;font-weight:900;text-decoration:none;
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;color:transparent;
  animation:rain 3.5s linear infinite
}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
@media(min-width:900px){main{flex-direction:row}}

/* Toast */
#toast{
  position:fixed; left:50%; bottom:18px;
  transform:translateX(-50%);
  background:color-mix(in oklab, var(--panel) 85%, var(--bg));
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 12px;
  border-radius:999px;
  box-shadow:var(--shadow);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  z-index:9999;
  font-weight:900;
  font-size:13px;
}
#toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}

/* Modal */
#modalOverlay{
  position:fixed; inset:0; z-index:9998;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:14px;
}
#modalOverlay.show{display:flex}
#modal{
  width:min(920px, 100%);
  background:color-mix(in oklab, var(--panel) 90%, var(--bg));
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
#modalHeader{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px;
  border-bottom:1px solid var(--border);
}
#modalHeader b{font-size:14px}
#modalBody{padding:12px}
#modalFooter{
  padding:12px;
  border-top:1px solid var(--border);
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
}
#modalImg{
  width:100%;
  max-height:70vh;
  object-fit:contain;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--result-bg);
}
#modalText{
  width:100%;
  min-height:260px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--input-bg);
  color:var(--text);
  padding:10px;
  font-size:13px;
  resize:vertical;
}
</style>
</head>

<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru" class="active">RU</button>
        <button id="btn_en">EN</button>
      </div>

      <button class="iconbtn" id="theme_toggle" aria-label="Theme" title="Theme">
        <span class="ico" id="theme_icon">üåô</span>
        <span class="small" id="theme_text" data-i18n="theme.dark">Dark</span>
      </button>

      <button class="iconbtn" id="share_btn" aria-label="Share" title="Share">
        <span class="ico">üìã</span>
        <span class="small" data-i18n="share">Share</span>
      </button>

      <button class="iconbtn" id="card_btn" aria-label="Trade Card PNG" title="Trade Card PNG">
        <span class="ico">üñºÔ∏è</span>
        <span class="small" data-i18n="cardpng">Card PNG</span>
      </button>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1">
      <!-- DCA -->
      <section id="dca" class="screen active">
        <div class="card">
          <div class="note" data-i18n="dca.tip">–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.</div>

          <div style="height:10px"></div>
          <div id="dca_rows"></div>

          <div class="controls">
            <button class="btn" id="dca_add" data-i18n="dca.add">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥</button>
            <button class="btn ghost" id="dca_clear" data-i18n="common.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="result">
            <div class="res-left">
              <span class="res-label" data-i18n="dca.avg">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</span>
              <span class="res-value muted" id="dca_avg">‚Äî</span>
            </div>
            <button class="btn small ghost" id="dca_copy" data-i18n="common.copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.totalVol">–û–±—â–∏–π –æ–±—ä—ë–º</span>: <b id="dca_totalVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.totalCost">–°—É–º–º–∞</span>: <b id="dca_totalCost">‚Äî</b></span>
          </div>

          <div class="small" id="dca_hint" style="margin-top:8px"></div>

          <div class="hr"></div>

          <h4 style="margin:0 0 8px 0" data-i18n="dca.goal.title">DCA Goal: Target Average</h4>
          <div class="note" data-i18n="dca.goal.note">–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞: –ø–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.</div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="col">
              <label data-i18n="dca.goal.price">–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)</label>
              <input id="dca_goal_price" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="dca.goal.avg">–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)</label>
              <input id="dca_goal_avg" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col" style="min-width:160px">
              <label data-i18n="dca.goal.fee">–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %</label>
              <input id="dca_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.goal.needVol">–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å</span>: <b id="dca_needVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.needCost">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>: <b id="dca_needCost">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.status">–°—Ç–∞—Ç—É—Å</span>: <b id="dca_goalStatus">‚Äî</b></span>
          </div>

          <div class="small" id="dca_goal_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- R/R -->
      <section id="rr" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="rr.entry">Entry</label>
              <input id="rr_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.sl">Stop Loss</label>
              <input id="rr_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.tp">Take Profit</label>
              <input id="rr_tp" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="rr.fee">–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)</label>
              <input id="rr_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col" style="min-width:240px">
              <div class="note" data-i18n="rr.feeNote">–ü–æ–∫–∞–∂–µ—Ç net R/R: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞—Å—á—ë—Ç–µ.</div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="rr_clear" data-i18n="common.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="rr.gross">Gross R/R</span>: <b id="rr_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="rr.net">Net R/R (fees)</span>: <b id="rr_net">‚Äî</b></span>
          </div>

          <div class="small" id="rr_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Capital -->
      <section id="cap" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="cap.dep">–î–µ–ø–æ–∑–∏—Ç</label>
              <input id="cap_dep" type="number" inputmode="decimal" step="any" min="0" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.risk">–†–∏—Å–∫ %</label>
              <input id="cap_risk" type="number" inputmode="decimal" step="any" min="0" max="100" placeholder="1">
            </div>
            <div class="col">
              <label data-i18n="cap.entry">Entry</label>
              <input id="cap_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="cap.sl">Stop Loss</label>
              <input id="cap_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="cap.fee">–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)</label>
              <input id="cap_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.lev">–ü–ª–µ—á–æ (–¥–ª—è –º–∞—Ä–∂–∏)</label>
              <input id="cap_lev" type="number" inputmode="decimal" step="any" min="1" max="200" placeholder="1">
            </div>
            <div class="col" style="min-width:260px">
              <label data-i18n="cap.presets">–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏</label>
              <div class="controls" style="margin-top:0">
                <button class="btn small ghost cap_preset" data-v="0.5">0.5%</button>
                <button class="btn small ghost cap_preset" data-v="1">1%</button>
                <button class="btn small ghost cap_preset" data-v="2">2%</button>
                <button class="btn small ghost cap_preset" data-v="3">3%</button>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="cap_clear" data-i18n="common.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="cap.pos">Position size</span>: <b id="cap_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.riskUsd">Risk $</span>: <b id="cap_riskUsd">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.margin">Margin (lev)</span>: <b id="cap_margin">‚Äî</b></span>
          </div>

          <div class="small" id="cap_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Indicators -->
      <section id="ind" class="screen">
        <div class="card">
          <h3 style="margin:0 0 10px 0" data-i18n="ind.title">Indicators</h3>

          <div class="field">
            <label data-i18n="ind.fg.label">Fear &amp; Greed</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.fg.valueLabel">Value</span>
                <span class="res-value muted" id="fg_value">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.tcap.label">Total Market Cap (USD)</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.tcap.valueLabel">USD</span>
                <span class="res-value muted" id="tcap">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.alt.label">Alt dominance (proxy Altseason)</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.alt.valueLabel">Alt %</span>
                <span class="res-value muted" id="alt_dom">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.mood.label">Market Mood</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.mood.hint">Derived from F&G + Alt dom</span>
                <span class="res-value muted" id="mood_value">‚Äî</span>
              </div>
            </div>
          </div>

          <!-- visual images -->
          <div class="viz-grid">
            <div class="viz">
              <div class="viz-title">
                <b data-i18n="ind.viz.fg">F&G Gauge</b>
                <span id="fg_viz_text">‚Äî</span>
              </div>
              <canvas id="fg_canvas"></canvas>
            </div>
            <div class="viz">
              <div class="viz-title">
                <b data-i18n="ind.viz.cap">Market Cap</b>
                <span id="cap_viz_text">‚Äî</span>
              </div>
              <canvas id="cap_canvas"></canvas>
            </div>
            <div class="viz">
              <div class="viz-title">
                <b data-i18n="ind.viz.alt">Alt Dom</b>
                <span id="alt_viz_text">‚Äî</span>
              </div>
              <canvas id="alt_canvas"></canvas>
            </div>
          </div>

          <div class="controls" style="margin-top:12px">
            <button class="btn" id="refresh_ind" data-i18n="ind.refresh">Refresh</button>
          </div>

          <div class="note" id="ind_note"></div>
        </div>
      </section>
    </div>

    <!-- History -->
    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>

      <div class="controls" style="margin-top:8px">
        <button class="btn ghost" id="clear_history" data-i18n="hist.clear">Clear</button>
        <button class="btn" id="export_history" data-i18n="hist.export">Export .txt</button>
      </div>

      <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<!-- Toast -->
<div id="toast">‚Äî</div>

<!-- Modal -->
<div id="modalOverlay" role="dialog" aria-modal="true">
  <div id="modal">
    <div id="modalHeader">
      <b id="modalTitle">‚Äî</b>
      <button class="btn small ghost" id="modalClose">‚úï</button>
    </div>
    <div id="modalBody">
      <img id="modalImg" alt="preview" style="display:none" />
      <textarea id="modalText" style="display:none" readonly></textarea>
      <div class="note" id="modalHint" style="margin-top:10px"></div>
    </div>
    <div id="modalFooter">
      <button class="btn ghost" id="modalCopy" style="display:none" data-i18n="modal.copy">Copy</button>
      <button class="btn ghost" id="modalOpen" style="display:none" data-i18n="modal.open">Open</button>
      <button class="btn" id="modalShare" style="display:none" data-i18n="modal.share">Share</button>
      <button class="btn ghost" id="modalDownload" style="display:none" data-i18n="modal.download">Download</button>
      <button class="btn" id="modalOk" data-i18n="modal.ok">OK</button>
    </div>
  </div>
</div>

<script>
/* Telegram init */
const tg = window.Telegram?.WebApp || null;
try{ tg?.expand?.(); }catch(e){}

/* UA helpers */
const UA = navigator.userAgent || '';
const IS_IOS = /iPad|iPhone|iPod/i.test(UA) || (UA.includes('Mac') && 'ontouchend' in document);
const IS_ANDROID = /Android/i.test(UA);
const IN_TG = !!tg;

/* i18n */
const locales = {
  ru:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "theme.dark":"–¢—ë–º–Ω–∞—è","theme.light":"–°–≤–µ—Ç–ª–∞—è",
    "share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
    "cardpng":"–ö–∞—Ä—Ç–æ—á–∫–∞ PNG",

    "common.clear":"–û—á–∏—Å—Ç–∏—Ç—å",
    "common.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
    "common.copiedToast":"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
    "common.opened":"–û—Ç–∫—Ä—ã—Ç–æ",

    "dca.tip":"–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.",
    "dca.add":"+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥",
    "dca.row.price":"–¶–µ–Ω–∞","dca.row.vol":"–û–±—ä—ë–º",
    "dca.avg":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.totalVol":"–û–±—â–∏–π –æ–±—ä—ë–º","dca.totalCost":"–°—É–º–º–∞",
    "dca.hint.empty":"–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π –≤—Ö–æ–¥ (—Ü–µ–Ω–∞ + –æ–±—ä—ë–º > 0).",
    "dca.hint.partial":"–ß–∞—Å—Ç—å —Å—Ç—Ä–æ–∫ –Ω–µ —É—á—Ç–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å —Ü–µ–Ω—É/–æ–±—ä—ë–º).",
    "dca.goal.title":"DCA Goal: Target Average",
    "dca.goal.note":"–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞: –ø–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.",
    "dca.goal.price":"–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)",
    "dca.goal.avg":"–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)",
    "dca.goal.fee":"–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %",
    "dca.goal.needVol":"–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å",
    "dca.goal.needCost":"–°—Ç–æ–∏–º–æ—Å—Ç—å",
    "dca.goal.status":"–°—Ç–∞—Ç—É—Å",
    "dca.goal.status.na":"‚Äî",
    "dca.goal.status.ok":"–í–æ–∑–º–æ–∂–Ω–æ",
    "dca.goal.status.already":"–£–∂–µ –Ω–∞ —Ü–µ–ª–∏",
    "dca.goal.status.impossible":"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ —ç—Ç–æ–π —Ü–µ–Ω–µ",
    "dca.goal.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ X –∏ Y, –∏ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—Ö–æ–¥ –≤—ã—à–µ.",
    "dca.goal.hint.math":"–ï—Å–ª–∏ X = Y ‚Äî –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å, –ø–æ–º–µ–Ω—è–π –∑–Ω–∞—á–µ–Ω–∏—è.",

    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
    "rr.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)",
    "rr.feeNote":"–ü–æ–∫–∞–∂–µ—Ç net R/R: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞—Å—á—ë—Ç–µ.",
    "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
    "rr.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è",
    "rr.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

    "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
    "cap.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)",
    "cap.lev":"–ü–ª–µ—á–æ (–¥–ª—è –º–∞—Ä–∂–∏)",
    "cap.presets":"–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏",
    "cap.pos":"–û–±—ä—ë–º –ø–æ–∑–∏—Ü–∏–∏",
    "cap.riskUsd":"–†–∏—Å–∫ $",
    "cap.margin":"–ú–∞—Ä–∂–∞ (–ø–ª–µ—á–æ)",
    "cap.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è",
    "cap.hint.invalid":"–ü—Ä–æ–≤–µ—Ä—å –∑–Ω–∞—á–µ–Ω–∏—è",
    "cap.hint.riskRange":"–†–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0‚Äì100%",
    "cap.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

    "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
    "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
    "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)","ind.tcap.valueLabel":"USD",
    "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy Altseason)","ind.alt.valueLabel":"Alt %",
    "ind.mood.label":"Market Mood",
    "ind.mood.hint":"–ù–∞ –æ—Å–Ω–æ–≤–µ F&G + –¥–æ–º–∏–Ω–∞—Ü–∏–∏ –∞–ª—å—Ç–æ–≤",
    "ind.refresh":"–û–±–Ω–æ–≤–∏—Ç—å",
    "ind.loading":"–û–±–Ω–æ–≤–ª—è—é‚Ä¶",
    "ind.cached":"–ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞",
    "ind.rate":"–õ–∏–º–∏—Ç/–æ—à–∏–±–∫–∞ API ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ",
    "ind.viz.fg":"F&G Gauge",
    "ind.viz.cap":"Market Cap",
    "ind.viz.alt":"Alt Dom",

    "hist.title":"–ò—Å—Ç–æ—Ä–∏—è",
    "hist.clear":"–û—á–∏—Å—Ç–∏—Ç—å",
    "hist.export":"–≠–∫—Å–ø–æ—Ä—Ç .txt",
    "hist.note":"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",

    "footer.tags":"–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì",

    "modal.ok":"OK",
    "modal.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
    "modal.open":"–û—Ç–∫—Ä—ã—Ç—å",
    "modal.share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",
    "modal.download":"–°–∫–∞—á–∞—Ç—å",

    "file.hint.image":"–ï—Å–ª–∏ –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å –º–µ–Ω—é ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª, –∑–∞–∂–º–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –≤—ã–±–µ—Ä–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.",
    "file.hint.text":"–ï—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –Ω–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ ¬´–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å¬ª."
  },
  en:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "theme.dark":"Dark","theme.light":"Light",
    "share":"Share",
    "cardpng":"Card PNG",

    "common.clear":"Clear",
    "common.copy":"Copy",
    "common.copiedToast":"Copied!",
    "common.opened":"Opened",

    "dca.tip":"Tip: add multiple entries ‚Äî it will calculate average price, total size and total cost.",
    "dca.add":"+ Add entry",
    "dca.row.price":"Price","dca.row.vol":"Volume",
    "dca.avg":"Average price","dca.totalVol":"Total volume","dca.totalCost":"Total cost",
    "dca.hint.empty":"Add at least one valid entry (price + volume > 0).",
    "dca.hint.partial":"Some rows were ignored (check price/volume).",
    "dca.goal.title":"DCA Goal: Target Average",
    "dca.goal.note":"Unique: calculate how much to buy at price X to reach target average Y.",
    "dca.goal.price":"Add price (X)",
    "dca.goal.avg":"Target average (Y)",
    "dca.goal.fee":"Buy fee %",
    "dca.goal.needVol":"Need volume",
    "dca.goal.needCost":"Cost",
    "dca.goal.status":"Status",
    "dca.goal.status.na":"‚Äî",
    "dca.goal.status.ok":"Possible",
    "dca.goal.status.already":"Already at target",
    "dca.goal.status.impossible":"Impossible at this price",
    "dca.goal.hint.fill":"Fill X and Y, and add at least one entry above.",
    "dca.goal.hint.math":"If X = Y ‚Äî division by zero; change values.",

    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
    "rr.fee":"Fee % (approx)",
    "rr.feeNote":"Shows net R/R: approximates entry+exit fees.",
    "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
    "rr.hint.fill":"Fill the fields",
    "rr.hint.entryEqSl":"Entry and SL must differ",

    "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss",
    "cap.fee":"Fee % (entry+exit)",
    "cap.lev":"Leverage (margin)",
    "cap.presets":"Quick risks",
    "cap.pos":"Position size",
    "cap.riskUsd":"Risk $",
    "cap.margin":"Margin (lev)",
    "cap.hint.fill":"Fill the fields",
    "cap.hint.invalid":"Check values",
    "cap.hint.riskRange":"Risk must be 0‚Äì100%",
    "cap.hint.entryEqSl":"Entry and SL must differ",

    "ind.title":"Indicators",
    "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value",
    "ind.tcap.label":"Total Market Cap (USD)","ind.tcap.valueLabel":"USD",
    "ind.alt.label":"Alt dominance (proxy Altseason)","ind.alt.valueLabel":"Alt %",
    "ind.mood.label":"Market Mood",
    "ind.mood.hint":"Derived from F&G + Alt dom",
    "ind.refresh":"Refresh",
    "ind.loading":"Refreshing‚Ä¶",
    "ind.cached":"Showing cached data",
    "ind.rate":"API limit/error ‚Äî try later",
    "ind.viz.fg":"F&G Gauge",
    "ind.viz.cap":"Market Cap",
    "ind.viz.alt":"Alt Dom",

    "hist.title":"History",
    "hist.clear":"Clear",
    "hist.export":"Export .txt",
    "hist.note":"Saved locally in your browser",

    "footer.tags":"AIRDROP ¬∑ NEWS ¬∑ TRADING",

    "modal.ok":"OK",
    "modal.copy":"Copy",
    "modal.open":"Open",
    "modal.share":"Share",
    "modal.download":"Download",

    "file.hint.image":"If Share menu doesn‚Äôt appear, long-press the image to Save/Share.",
    "file.hint.text":"If download is unavailable, tap Open or just Copy."
  }
};

let lang = 'en';
try{
  const tgl = tg?.initDataUnsafe?.user?.language_code;
  if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
  else lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
}catch(e){ lang='en'; }

function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }
function translateAll(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    if(locales[lang] && locales[lang][k] !== undefined) el.textContent = locales[lang][k];
  });
  updateThemeUI();
}

/* Toast */
let toastTimer = null;
function showToast(msg){
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>el.classList.remove('show'), 1200);
}

/* Modal */
const modalOverlay = document.getElementById('modalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalImg = document.getElementById('modalImg');
const modalText = document.getElementById('modalText');
const modalHint = document.getElementById('modalHint');
const modalClose = document.getElementById('modalClose');
const modalOk = document.getElementById('modalOk');
const modalCopy = document.getElementById('modalCopy');
const modalOpen = document.getElementById('modalOpen');
const modalShare = document.getElementById('modalShare');
const modalDownload = document.getElementById('modalDownload');

let modalState = { kind:null, url:null, blob:null, filename:null, mime:null, text:null };

function closeModal(){
  modalOverlay.classList.remove('show');
  // do not revoke immediately - user may still open/share
}
modalClose.addEventListener('click', closeModal);
modalOk.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', (e)=>{ if(e.target === modalOverlay) closeModal(); });

function openModal({title, kind, url, blob, filename, mime, text, hint}){
  modalState = { kind, url, blob, filename, mime, text };

  modalTitle.textContent = title || '‚Äî';
  modalHint.textContent = hint || '';

  modalImg.style.display = 'none';
  modalText.style.display = 'none';

  modalCopy.style.display = 'none';
  modalOpen.style.display = 'none';
  modalShare.style.display = 'none';
  modalDownload.style.display = 'none';

  if(kind === 'image'){
    modalImg.src = url;
    modalImg.style.display = 'block';
    modalOpen.style.display = 'inline-flex';
    modalShare.style.display = canShareFiles(blob, filename, mime) ? 'inline-flex' : 'none';
    modalDownload.style.display = (!IN_TG && !IS_IOS) ? 'inline-flex' : 'none';
  }
  if(kind === 'text'){
    modalText.value = text || '';
    modalText.style.display = 'block';
    modalCopy.style.display = 'inline-flex';
    modalOpen.style.display = 'inline-flex';
    modalShare.style.display = canShareFiles(blob, filename, mime) ? 'inline-flex' : 'none';
    modalDownload.style.display = (!IN_TG && !IS_IOS) ? 'inline-flex' : 'none';
  }

  modalOverlay.classList.add('show');
}

modalOpen.addEventListener('click', ()=>{
  if(!modalState.url) return;
  try{
    const w = window.open(modalState.url, "_blank", "noopener");
    if(!w) window.location.href = modalState.url;
  }catch(e){
    try{ window.location.href = modalState.url; }catch(_){}
  }
  showToast(t('common.opened'));
});
modalCopy.addEventListener('click', async ()=>{
  const ok = await copyText(modalState.text || '');
  if(ok) showToast(t('common.copiedToast'));
});
modalShare.addEventListener('click', async ()=>{
  if(!modalState.blob) return;
  await shareFile(modalState.blob, modalState.filename, modalState.mime, modalTitle.textContent);
});
modalDownload.addEventListener('click', ()=>{
  if(!modalState.url || !modalState.filename) return;
  downloadByLink(modalState.url, modalState.filename);
});

/* theme toggle */
const THEME_KEY = 'tc_theme_v4';
function getInitialTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === 'dark' || saved === 'light') return saved;
  const tgScheme = (tg?.colorScheme || '').toLowerCase();
  if(tgScheme === 'dark' || tgScheme === 'light') return tgScheme;
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}
function setTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem(THEME_KEY, theme);
  updateThemeUI();
  // redraw indicator canvases with new colors
  drawAllIndicatorVisuals(lastIndicators);
}
function updateThemeUI(){
  const theme = document.documentElement.getAttribute('data-theme') || 'dark';
  const icon = document.getElementById('theme_icon');
  const text = document.getElementById('theme_text');
  const btn = document.getElementById('theme_toggle');
  if(theme === 'light'){
    icon.textContent = '‚òÄÔ∏è';
    text.textContent = t('theme.light');
    btn.classList.add('active');
  }else{
    icon.textContent = 'üåô';
    text.textContent = t('theme.dark');
    btn.classList.remove('active');
  }
}
document.getElementById('theme_toggle').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  setTheme(cur === 'dark' ? 'light' : 'dark');
  haptic('impact','light');
});

/* tabs */
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', ()=>{
  document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
  btn.classList.add('active');
  const target = btn.dataset.tab;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(target).classList.add('active');
  if(target === 'ind' && document.getElementById('tcap').textContent.trim() === '‚Äî') fetchIndicators();
  translateAll();
}));

/* language buttons */
const btn_ru = document.getElementById('btn_ru');
const btn_en = document.getElementById('btn_en');
function syncLangButtons(){
  if(lang === 'ru'){ btn_ru.classList.add('active'); btn_en.classList.remove('active'); }
  else { btn_en.classList.add('active'); btn_ru.classList.remove('active'); }
}
btn_ru.addEventListener('click', ()=>{
  lang='ru'; syncLangButtons();
  translateAll(); renderHistory(); refreshAll();
});
btn_en.addEventListener('click', ()=>{
  lang='en'; syncLangButtons();
  translateAll(); renderHistory(); refreshAll();
});

/* utils */
function safeNum(v){
  const x = parseFloat(v);
  return Number.isFinite(x) ? x : NaN;
}
function fmt(n, maxFrac=8){
  if(!Number.isFinite(n)) return '‚Äî';
  return n.toLocaleString(undefined, { maximumFractionDigits:maxFrac });
}
function fmtMoney(n){
  if(!Number.isFinite(n)) return '‚Äî';
  return '$' + n.toLocaleString(undefined, { maximumFractionDigits:0 });
}
function cssVar(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
function haptic(kind='impact', style='light'){
  try{
    if(!tg?.HapticFeedback) return;
    if(kind==='impact') tg.HapticFeedback.impactOccurred(style);
    if(kind==='notify') tg.HapticFeedback.notificationOccurred(style);
  }catch(e){}
}

/* COPY: one tap, stable */
async function copyText(text){
  if(!text || text === '‚Äî') return false;

  // 1) try modern clipboard
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      return true;
    }
  }catch(e){ /* continue */ }

  // 2) fallback execCommand
  try{
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.setAttribute('readonly','');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    ta.style.top = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return !!ok;
  }catch(err){
    return false;
  }
}

/* Files: share / download / preview (works across devices) */
function canShareFiles(blob, filename, mime){
  try{
    const file = new File([blob], filename, { type: mime });
    return !!(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share);
  }catch(e){ return false; }
}
async function shareFile(blob, filename, mime, title){
  try{
    const file = new File([blob], filename, { type: mime });
    if(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
      await navigator.share({ files:[file], title: title || filename });
      haptic('notify','success');
      return true;
    }
  }catch(e){}
  return false;
}
function downloadByLink(url, filename){
  try{
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.rel = 'noopener';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    return true;
  }catch(e){ return false; }
}

async function saveBlobSmart({blob, filename, mime, title, kind, textForPreview}){
  // 1) best: share files (phones)
  if(canShareFiles(blob, filename, mime)){
    const ok = await shareFile(blob, filename, mime, title);
    if(ok) return true;
  }

  // 2) desktop browser: download attribute is fine
  const url = URL.createObjectURL(blob);

  if(!IN_TG && !IS_IOS){
    const ok = downloadByLink(url, filename);
    if(ok){
      showToast('OK');
      setTimeout(()=>URL.revokeObjectURL(url), 60_000);
      return true;
    }
  }

  // 3) fallback: preview modal + open/share if possible
  const hint = kind === 'image' ? t('file.hint.image') : t('file.hint.text');
  openModal({
    title: title || filename,
    kind: kind,
    url,
    blob,
    filename,
    mime,
    text: textForPreview || '',
    hint
  });

  setTimeout(()=>URL.revokeObjectURL(url), 120_000);
  return false;
}

/* History */
const HISTORY_KEY = 'trader_calc_history_v6';
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY))||[] }catch(e){ return [] } }
function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }
function pushHistory(item){
  const arr = loadHistory();
  arr.unshift(item);
  if(arr.length > 120) arr.pop();
  saveHistory(arr);
}
function renderHistory(){
  const list = document.getElementById('history_list');
  list.innerHTML = '';
  const arr = loadHistory();
  if(!arr.length){
    const el = document.createElement('div');
    el.className = 'note';
    el.textContent = t('hist.note');
    list.appendChild(el);
    return;
  }
  arr.forEach(it=>{
    const node = document.createElement('div');
    node.style.padding='10px';
    node.style.border='1px solid var(--border)';
    node.style.borderRadius='16px';
    node.style.background='color-mix(in oklab, var(--panel) 75%, var(--bg))';
    node.innerHTML = `
      <div style="font-weight:900">${it.type}</div>
      <div class="note">${it.summary || ''}</div>
      <div class="small">${new Date(it.t).toLocaleString()}</div>
    `;
    list.appendChild(node);
  });
}
document.getElementById('clear_history').addEventListener('click', ()=>{
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
  haptic('notify','success');
});
document.getElementById('export_history').addEventListener('click', async ()=>{
  const arr = loadHistory();
  const lines = arr.map(it=>{
    const ts = new Date(it.t).toLocaleString();
    const type = (it.type || '').toString();
    const sum = (it.summary || '').toString().replace(/\s+/g,' ').trim();
    return `${ts} | ${type} | ${sum}`;
  });
  const txt = lines.join('\n') || '';
  const blob = new Blob([txt], { type:'text/plain;charset=utf-8' });

  haptic('impact','light');
  await saveBlobSmart({
    blob,
    filename:'history.txt',
    mime:'text/plain',
    title:'Trader Calculator ‚Äî History',
    kind:'text',
    textForPreview: txt
  });
});

/* auto-save debounce */
const state = { lastSaved:{ DCA:null, DCA_GOAL:null, RR:null, CAP:null }, timers:{} };
function scheduleSave(type, summary, value){
  if(!value || value === '‚Äî') return;
  clearTimeout(state.timers[type]);
  state.timers[type] = setTimeout(()=>{
    if(state.lastSaved[type] === value) return;
    state.lastSaved[type] = value;
    pushHistory({ type, summary, t: Date.now() });
  }, 650);
}

/* DCA (multi-entry) */
const dcaRowsEl = document.getElementById('dca_rows');
const dcaAvgEl = document.getElementById('dca_avg');
const dcaTotalVolEl = document.getElementById('dca_totalVol');
const dcaTotalCostEl = document.getElementById('dca_totalCost');
const dcaHintEl = document.getElementById('dca_hint');
const dcaCopyBtn = document.getElementById('dca_copy');

const dcaGoalPrice = document.getElementById('dca_goal_price');
const dcaGoalAvg = document.getElementById('dca_goal_avg');
const dcaFee = document.getElementById('dca_fee');
const dcaNeedVol = document.getElementById('dca_needVol');
const dcaNeedCost = document.getElementById('dca_needCost');
const dcaGoalStatus = document.getElementById('dca_goalStatus');
const dcaGoalHint = document.getElementById('dca_goal_hint');

function dcaRowTemplate(price='', vol=''){
  const wrap = document.createElement('div');
  wrap.className = 'row';
  wrap.innerHTML = `
    <div class="col">
      <label data-i18n="dca.row.price">${t('dca.row.price')}</label>
      <input class="dca_price" type="number" inputmode="decimal" step="any" placeholder="0.00" value="${price}">
    </div>
    <div class="col">
      <label data-i18n="dca.row.vol">${t('dca.row.vol')}</label>
      <input class="dca_vol" type="number" inputmode="decimal" step="any" min="0" placeholder="0" value="${vol}">
    </div>
    <button class="mini dca_remove" title="Remove" aria-label="Remove">‚úï</button>
  `;
  return wrap;
}
function ensureAtLeastOneRow(){
  if(dcaRowsEl.children.length === 0){
    dcaRowsEl.appendChild(dcaRowTemplate());
    dcaRowsEl.appendChild(dcaRowTemplate());
  }
}
function getDcaLegs(){
  const rows = Array.from(dcaRowsEl.querySelectorAll('.row'));
  let valid = [];
  let ignored = 0;
  rows.forEach(r=>{
    const p = safeNum(r.querySelector('.dca_price')?.value);
    const v = safeNum(r.querySelector('.dca_vol')?.value);
    if(Number.isFinite(p) && Number.isFinite(v) && v > 0){
      valid.push({ p, v });
    }else{
      const pv = r.querySelector('.dca_price')?.value?.trim();
      const vv = r.querySelector('.dca_vol')?.value?.trim();
      if((pv && !Number.isFinite(p)) || (vv && !Number.isFinite(v)) || (pv && vv && !(v>0))) ignored++;
    }
  });
  return { valid, ignored };
}
function getDcaBaseSafe(){
  const { valid } = getDcaLegs();
  if(!valid.length) return null;
  let totalVol=0,totalCost=0;
  for(const leg of valid){ totalVol+=leg.v; totalCost+=leg.p*leg.v; }
  const avg = totalCost/totalVol;
  return { totalVol, totalCost, avg };
}
function calcDCA(){
  const { valid, ignored } = getDcaLegs();
  if(valid.length === 0){
    dcaAvgEl.textContent = '‚Äî';
    dcaTotalVolEl.textContent = '‚Äî';
    dcaTotalCostEl.textContent = '‚Äî';
    dcaHintEl.textContent = t('dca.hint.empty');
    dcaCopyBtn.disabled = true;
    calcDcaGoal(null);
    return;
  }
  let totalVol = 0, totalCost = 0;
  for(const leg of valid){ totalVol += leg.v; totalCost += leg.p * leg.v; }
  const avg = totalCost / totalVol;
  const avgText = fmt(avg, 8);

  dcaAvgEl.textContent = avgText;
  dcaTotalVolEl.textContent = fmt(totalVol, 8);
  dcaTotalCostEl.textContent = fmtMoney(totalCost);
  dcaHintEl.textContent = ignored > 0 ? t('dca.hint.partial') : '';
  dcaCopyBtn.disabled = false;

  scheduleSave('DCA', `AVG ${avgText} ¬∑ vol ${fmt(totalVol, 8)} ¬∑ cost ${fmtMoney(totalCost)}`, avgText);
  calcDcaGoal({ totalVol, totalCost, avg });
}
function calcDcaGoal(base){
  const X = safeNum(dcaGoalPrice.value);
  const Y = safeNum(dcaGoalAvg.value);
  const feePct = safeNum(dcaFee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct) / 100 : 0;

  dcaNeedVol.textContent = '‚Äî';
  dcaNeedCost.textContent = '‚Äî';
  dcaGoalStatus.textContent = t('dca.goal.status.na');
  dcaGoalHint.textContent = '';

  if(!base){ dcaGoalHint.textContent = t('dca.goal.hint.fill'); return; }
  if(!Number.isFinite(X) || !Number.isFinite(Y)){ dcaGoalHint.textContent = t('dca.goal.hint.fill'); return; }
  if(X === Y){
    dcaGoalHint.textContent = t('dca.goal.hint.math');
    dcaGoalStatus.textContent = t('dca.goal.status.impossible');
    return;
  }

  const Xeff = X * (1 + fee);
  const numerator = (Y * base.totalVol) - base.totalCost;
  const denom = (Xeff - Y);

  if(Math.abs(base.avg - Y) / (Math.abs(Y) || 1) < 1e-10){
    dcaGoalStatus.textContent = t('dca.goal.status.already');
    dcaNeedVol.textContent = '0';
    dcaNeedCost.textContent = '$0';
    return;
  }

  const v = numerator / denom;
  if(!Number.isFinite(v) || v <= 0){
    dcaGoalStatus.textContent = t('dca.goal.status.impossible');
    return;
  }

  const needCost = Xeff * v;
  dcaNeedVol.textContent = fmt(v, 8);
  dcaNeedCost.textContent = fmtMoney(needCost);
  dcaGoalStatus.textContent = t('dca.goal.status.ok');

  scheduleSave('DCA_GOAL', `Need ${fmt(v, 8)} @ ${X} to target ${Y}`, fmt(v, 8));
}

document.getElementById('dca_add').addEventListener('click', ()=>{
  dcaRowsEl.appendChild(dcaRowTemplate());
  translateAll(); calcDCA();
  haptic('impact','light');
});
document.getElementById('dca_clear').addEventListener('click', ()=>{
  dcaRowsEl.innerHTML = '';
  ensureAtLeastOneRow();
  translateAll(); calcDCA();
  haptic('notify','success');
});
dcaRowsEl.addEventListener('input', (e)=>{
  if(e.target.classList.contains('dca_price') || e.target.classList.contains('dca_vol')) calcDCA();
});
dcaRowsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('.dca_remove');
  if(!btn) return;
  const row = btn.closest('.row');
  if(!row) return;
  if(dcaRowsEl.children.length <= 1){
    row.querySelector('.dca_price').value = '';
    row.querySelector('.dca_vol').value = '';
  }else{
    row.remove();
  }
  calcDCA();
  haptic('impact','light');
});
dcaCopyBtn.addEventListener('click', async ()=>{
  const val = dcaAvgEl.textContent.trim();
  const ok = await copyText(val);
  if(ok){
    showToast(t('common.copiedToast'));
    haptic('notify','success');
  }
});
[dcaGoalPrice, dcaGoalAvg, dcaFee].forEach(el=>el.addEventListener('input', ()=>calcDcaGoal(getDcaBaseSafe())));

/* R/R */
const rr_entry=document.getElementById('rr_entry');
const rr_sl=document.getElementById('rr_sl');
const rr_tp=document.getElementById('rr_tp');
const rr_fee=document.getElementById('rr_fee');
const rr_value=document.getElementById('rr_value');
const rr_net=document.getElementById('rr_net');
const rr_hint=document.getElementById('rr_hint');

function calcRR(){
  const e=safeNum(rr_entry.value), sl=safeNum(rr_sl.value), tp=safeNum(rr_tp.value);
  const feePct=safeNum(rr_fee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

  rr_value.textContent = '‚Äî';
  rr_net.textContent = '‚Äî';
  rr_hint.textContent = '';

  if([e,sl,tp].some(x=>Number.isNaN(x))){ rr_hint.textContent = t('rr.hint.fill'); return; }
  if(e === sl){ rr_hint.textContent = t('rr.hint.entryEqSl'); return; }

  const risk = Math.abs(e - sl);
  const reward = Math.abs(tp - e);
  if(!(risk > 0)) return;

  const gross = (reward / risk).toFixed(2);
  rr_value.textContent = `1:${gross}`;

  const riskNet = risk + fee * (Math.abs(e) + Math.abs(sl));
  const rewardNet = reward - fee * (Math.abs(e) + Math.abs(tp));
  rr_net.textContent = (rewardNet <= 0) ? '0.00' : (rewardNet / riskNet).toFixed(2);

  scheduleSave('RR', `Gross 1:${gross} ¬∑ Net ${rr_net.textContent}`, gross);
}
[rr_entry,rr_sl,rr_tp,rr_fee].forEach(i=>i.addEventListener('input', calcRR));
document.getElementById('rr_clear').addEventListener('click', ()=>{
  rr_entry.value=''; rr_sl.value=''; rr_tp.value=''; rr_fee.value='';
  calcRR();
  haptic('notify','success');
});

/* Capital */
const cap_dep=document.getElementById('cap_dep');
const cap_risk=document.getElementById('cap_risk');
const cap_entry=document.getElementById('cap_entry');
const cap_sl=document.getElementById('cap_sl');
const cap_fee=document.getElementById('cap_fee');
const cap_lev=document.getElementById('cap_lev');

const cap_value=document.getElementById('cap_value');
const cap_riskUsd=document.getElementById('cap_riskUsd');
const cap_margin=document.getElementById('cap_margin');
const cap_hint=document.getElementById('cap_hint');

function calcCap(){
  const dep=safeNum(cap_dep.value);
  const rp=safeNum(cap_risk.value);
  const e=safeNum(cap_entry.value);
  const sl=safeNum(cap_sl.value);

  const feePct=safeNum(cap_fee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

  const levRaw=safeNum(cap_lev.value);
  const lev = Number.isFinite(levRaw) ? Math.max(1, levRaw) : 1;

  cap_value.textContent = '‚Äî';
  cap_riskUsd.textContent = '‚Äî';
  cap_margin.textContent = '‚Äî';
  cap_hint.textContent = '';

  if([dep,rp,e,sl].some(x=>Number.isNaN(x))){ cap_hint.textContent = t('cap.hint.fill'); return; }
  if(dep <= 0){ cap_hint.textContent = t('cap.hint.invalid'); return; }
  if(rp <= 0 || rp > 100){ cap_hint.textContent = t('cap.hint.riskRange'); return; }
  if(e === sl){ cap_hint.textContent = t('cap.hint.entryEqSl'); return; }

  const riskUsd = dep * (rp/100);
  const perUnit = Math.abs(e - sl) + fee*(Math.abs(e) + Math.abs(sl));
  const size = riskUsd / perUnit;

  if(!Number.isFinite(size) || size <= 0){ cap_hint.textContent = t('cap.hint.invalid'); return; }

  cap_value.textContent = size.toFixed(8);
  cap_riskUsd.textContent = '$' + riskUsd.toFixed(2);

  const notional = Math.abs(size * e);
  cap_margin.textContent = fmtMoney(notional / lev);

  scheduleSave('CAP', `Size ${size.toFixed(8)} ¬∑ Risk $${riskUsd.toFixed(2)} ¬∑ Margin ${cap_margin.textContent}`, size.toFixed(8));
}
[cap_dep,cap_risk,cap_entry,cap_sl,cap_fee,cap_lev].forEach(i=>i.addEventListener('input', calcCap));
document.getElementById('cap_clear').addEventListener('click', ()=>{
  cap_dep.value=''; cap_risk.value=''; cap_entry.value=''; cap_sl.value='';
  cap_fee.value=''; cap_lev.value='';
  calcCap();
  haptic('notify','success');
});
document.querySelectorAll('.cap_preset').forEach(b=>b.addEventListener('click', ()=>{
  cap_risk.value = b.dataset.v;
  calcCap();
  haptic('impact','light');
});

/* Indicators with cache + visuals */
const fgEl = document.getElementById('fg_value');
const tcapEl = document.getElementById('tcap');
const altDomEl = document.getElementById('alt_dom');
const moodEl = document.getElementById('mood_value');
const indNote = document.getElementById('ind_note');

const fgVizText = document.getElementById('fg_viz_text');
const capVizText = document.getElementById('cap_viz_text');
const altVizText = document.getElementById('alt_viz_text');

const IND_CACHE_KEY = 'trader_ind_cache_v5';
const IND_CACHE_TTL_MS = 60_000;
let indInFlight = false;

let lastIndicators = null;

function getIndCache(){ try{ return JSON.parse(localStorage.getItem(IND_CACHE_KEY)) }catch(e){ return null } }
function setIndCache(data){ localStorage.setItem(IND_CACHE_KEY, JSON.stringify({ t: Date.now(), data })); }

function computeMood(fngValue, altDom){
  if(!Number.isFinite(fngValue) || !Number.isFinite(altDom)) return '‚Äî';
  if(fngValue >= 60 && altDom >= 55) return 'üü¢ Risk-on';
  if(fngValue <= 40 && altDom <= 45) return 'üî¥ Risk-off';
  return 'üü° Neutral';
}
function applyIndicators(data){
  fgEl.textContent = data.fgText || '‚Äî';
  tcapEl.textContent = data.totalMc ? fmtMoney(Number(data.totalMc)) : '‚Äî';
  altDomEl.textContent = (typeof data.altDom === 'number') ? (data.altDom.toFixed(2) + '%') : '‚Äî';
  moodEl.textContent = computeMood(data.fngValue, data.altDom);

  fgVizText.textContent = Number.isFinite(data.fngValue) ? String(data.fngValue) : '‚Äî';
  capVizText.textContent = data.totalMc ? fmtMoney(Number(data.totalMc)) : '‚Äî';
  altVizText.textContent = (typeof data.altDom === 'number') ? (data.altDom.toFixed(2) + '%') : '‚Äî';

  lastIndicators = data;
  drawAllIndicatorVisuals(data);
}

async function fetchIndicators(){
  if(indInFlight) return;
  indInFlight = true;
  indNote.textContent = t('ind.loading');

  const cache = getIndCache();
  if(cache && (Date.now() - cache.t) < IND_CACHE_TTL_MS){
    applyIndicators(cache.data);
    indNote.textContent = t('ind.cached');
    indInFlight = false;
    return;
  }

  const out = { fgText:null, fngValue:NaN, totalMc:null, altDom:NaN };
  let hadErr = false;

  try{
    const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json', { cache:'no-store' });
    if(!res.ok) throw new Error('FNG failed');
    const j = await res.json();
    const d = j?.data?.[0];
    if(d?.value){
      out.fngValue = Number(d.value);
      out.fgText = `${d.value} ¬∑ ${d.value_classification || ''}`.trim();
    }
  }catch(e){ hadErr = true; }

  try{
    const res2 = await fetch('https://api.coingecko.com/api/v3/global', { cache:'no-store' });
    if(!res2.ok) throw new Error('CG global failed');
    const j2 = await res2.json();
    out.totalMc = j2?.data?.total_market_cap?.usd ?? null;
    const btcDom = (typeof j2?.data?.market_cap_percentage?.btc === 'number') ? j2.data.market_cap_percentage.btc : null;
    if(typeof btcDom === 'number') out.altDom = 100 - btcDom;
  }catch(e){ hadErr = true; }

  applyIndicators(out);
  setIndCache(out);
  indNote.textContent = hadErr ? t('ind.rate') : '';
  indInFlight = false;
}
document.getElementById('refresh_ind').addEventListener('click', ()=>{
  try{ localStorage.removeItem(IND_CACHE_KEY); }catch(e){}
  fetchIndicators();
  haptic('impact','light');
});

/* Indicator canvas drawing */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const w = Math.max(10, canvas.clientWidth);
  const h = Math.max(10, canvas.clientHeight);
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return { ctx, w, h };
}
function drawFGGauge(value){
  const canvas = document.getElementById('fg_canvas');
  const { ctx, w, h } = setupCanvas(canvas);

  const bg = cssVar('--result-bg');
  const border = cssVar('--border');
  const muted = cssVar('--muted');
  const text = cssVar('--text');
  const accent = cssVar('--accent');
  const danger = cssVar('--danger');

  // background
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,w,h);

  // frame
  ctx.strokeStyle = border;
  ctx.lineWidth = 2;
  ctx.strokeRect(1,1,w-2,h-2);

  const cx = w/2;
  const cy = h*0.86;
  const r = Math.min(w*0.38, h*0.8);

  // base arc
  ctx.beginPath();
  ctx.strokeStyle = colorMix(muted, border, 0.55);
  ctx.lineWidth = 12;
  ctx.lineCap = 'round';
  ctx.arc(cx, cy, r, Math.PI, 0, false);
  ctx.stroke();

  if(Number.isFinite(value)){
    const v = Math.max(0, Math.min(100, value));
    const end = Math.PI - (Math.PI * (v/100));
    ctx.beginPath();
    ctx.strokeStyle = v < 35 ? danger : (v > 65 ? accent : colorMix(accent, muted, 0.55));
    ctx.lineWidth = 12;
    ctx.lineCap = 'round';
    ctx.arc(cx, cy, r, Math.PI, end, false);
    ctx.stroke();

    // needle
    const ang = Math.PI - (Math.PI * (v/100));
    const nx = cx + Math.cos(ang) * (r - 8);
    const ny = cy + Math.sin(ang) * (r - 8);

    ctx.beginPath();
    ctx.strokeStyle = text;
    ctx.lineWidth = 3;
    ctx.moveTo(cx, cy);
    ctx.lineTo(nx, ny);
    ctx.stroke();

    ctx.beginPath();
    ctx.fillStyle = text;
    ctx.arc(cx, cy, 5, 0, Math.PI*2);
    ctx.fill();

    // label
    ctx.fillStyle = text;
    ctx.font = '900 16px Inter, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`F&G: ${v}`, cx, 26);

    ctx.fillStyle = muted;
    ctx.font = '700 12px Inter, Arial, sans-serif';
    ctx.fillText(v <= 25 ? 'Extreme Fear' : v <= 45 ? 'Fear' : v <= 55 ? 'Neutral' : v <= 75 ? 'Greed' : 'Extreme Greed', cx, 46);
  }else{
    ctx.fillStyle = muted;
    ctx.font = '900 16px Inter, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‚Äî', cx, 30);
  }
}
function drawMarketCap(totalMc){
  const canvas = document.getElementById('cap_canvas');
  const { ctx, w, h } = setupCanvas(canvas);

  const bg = cssVar('--result-bg');
  const border = cssVar('--border');
  const muted = cssVar('--muted');
  const text = cssVar('--text');
  const accent = cssVar('--accent');

  ctx.fillStyle = bg;
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle = border;
  ctx.lineWidth = 2;
  ctx.strokeRect(1,1,w-2,h-2);

  const pad = 14;
  const barX = pad, barY = h/2 - 10, barW = w - pad*2, barH = 20;

  // bar bg
  ctx.fillStyle = colorMix(muted, border, 0.75);
  roundRectCanvas(ctx, barX, barY, barW, barH, 10);
  ctx.fill();

  if(Number.isFinite(totalMc) && totalMc > 0){
    // normalize with log scale up to 10T for stability
    const max = 10_000_000_000_000; // 10T
    const norm = Math.min(1, Math.log10(totalMc) / Math.log10(max));
    const fillW = Math.max(8, barW * norm);

    ctx.fillStyle = accent;
    roundRectCanvas(ctx, barX, barY, fillW, barH, 10);
    ctx.fill();

    ctx.fillStyle = text;
    ctx.font = '900 16px Inter, Arial, sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Total Cap', barX, 28);

    ctx.fillStyle = muted;
    ctx.font = '700 12px Inter, Arial, sans-serif';
    ctx.fillText('log scale (0..10T)', barX, 46);
  }else{
    ctx.fillStyle = muted;
    ctx.font = '900 16px Inter, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‚Äî', w/2, h/2 + 6);
  }
}
function drawAltDonut(altDom){
  const canvas = document.getElementById('alt_canvas');
  const { ctx, w, h } = setupCanvas(canvas);

  const bg = cssVar('--result-bg');
  const border = cssVar('--border');
  const muted = cssVar('--muted');
  const text = cssVar('--text');
  const accent = cssVar('--accent');

  ctx.fillStyle = bg;
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle = border;
  ctx.lineWidth = 2;
  ctx.strokeRect(1,1,w-2,h-2);

  const cx = w/2;
  const cy = h/2 + 6;
  const r = Math.min(w,h) * 0.28;

  // base circle
  ctx.beginPath();
  ctx.strokeStyle = colorMix(muted, border, 0.65);
  ctx.lineWidth = 16;
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.stroke();

  if(Number.isFinite(altDom)){
    const v = Math.max(0, Math.min(100, altDom));
    const start = -Math.PI/2;
    const end = start + (Math.PI*2) * (v/100);

    ctx.beginPath();
    ctx.strokeStyle = accent;
    ctx.lineWidth = 16;
    ctx.lineCap = 'round';
    ctx.arc(cx, cy, r, start, end);
    ctx.stroke();

    ctx.fillStyle = text;
    ctx.font = '900 18px Inter, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`${v.toFixed(2)}%`, cx, 28);

    ctx.fillStyle = muted;
    ctx.font = '700 12px Inter, Arial, sans-serif';
    ctx.fillText('Alt dominance', cx, 46);

    // legend
    ctx.textAlign = 'left';
    ctx.fillStyle = accent;
    ctx.fillRect(14, h-28, 10, 10);
    ctx.fillStyle = muted;
    ctx.fillText('Alt', 30, h-19);

    ctx.fillStyle = colorMix(muted, border, 0.65);
    ctx.fillRect(80, h-28, 10, 10);
    ctx.fillStyle = muted;
    ctx.fillText('BTC', 96, h-19);
  }else{
    ctx.fillStyle = muted;
    ctx.font = '900 16px Inter, Arial, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('‚Äî', cx, cy+6);
  }
}
function drawAllIndicatorVisuals(data){
  if(!data){
    drawFGGauge(NaN);
    drawMarketCap(NaN);
    drawAltDonut(NaN);
    return;
  }
  drawFGGauge(data.fngValue);
  drawMarketCap(Number(data.totalMc));
  drawAltDonut(data.altDom);
}

/* small helpers for canvas */
function roundRectCanvas(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function colorMix(a, b, t){
  // very simple mix for hex/rgb strings: fall back to computed by drawing
  // We'll use canvas to mix if needed; simplest: return b when unknown.
  try{
    const c = document.createElement('canvas');
    c.width = c.height = 1;
    const x = c.getContext('2d');
    x.fillStyle = a; x.fillRect(0,0,1,1);
    const A = x.getImageData(0,0,1,1).data;
    x.clearRect(0,0,1,1);
    x.fillStyle = b; x.fillRect(0,0,1,1);
    const B = x.getImageData(0,0,1,1).data;
    const r = Math.round(A[0] + (B[0]-A[0]) * t);
    const g = Math.round(A[1] + (B[1]-A[1]) * t);
    const bl = Math.round(A[2] + (B[2]-A[2]) * t);
    return `rgb(${r},${g},${bl})`;
  }catch(e){
    return b;
  }
}

/* Share button: native share text on phones, else copy text */
document.getElementById('share_btn').addEventListener('click', async ()=>{
  const activeTab = document.querySelector('.tab.active')?.dataset?.tab || 'dca';
  let text = 'üìä Trader Calculator\n';

  if(activeTab === 'dca'){
    text += `DCA AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}\n`;
    if(dcaNeedVol.textContent && dcaNeedVol.textContent !== '‚Äî'){
      text += `\nüéØ Goal\nNeed: ${dcaNeedVol.textContent}\nCost: ${dcaNeedCost.textContent}\n`;
    }
  }
  if(activeTab === 'rr'){ text += `R/R Gross: ${rr_value.textContent}\nR/R Net: ${rr_net.textContent}\n`; }
  if(activeTab === 'cap'){ text += `Size: ${cap_value.textContent}\nRisk: ${cap_riskUsd.textContent}\nMargin: ${cap_margin.textContent}\n`; }
  if(activeTab === 'ind'){ text += `F&G: ${fgEl.textContent}\nAlt dom: ${altDomEl.textContent}\nMood: ${moodEl.textContent}\n`; }

  try{
    if(navigator.share){
      await navigator.share({ text, title:'Trader Calculator' });
      haptic('notify','success');
      return;
    }
  }catch(e){ /* ignore */ }

  const ok = await copyText(text);
  if(ok){
    showToast(t('common.copiedToast'));
    haptic('notify','success');
  }
});

/* Trade Card PNG */
function roundRectPath(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines=10){
  const words = String(text || '').split(' ');
  let line = '';
  let lines = 0;
  for(let n=0; n<words.length; n++){
    const testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    if(metrics.width > maxWidth && n > 0){
      ctx.fillText(line.trim(), x, y);
      line = words[n] + ' ';
      y += lineHeight;
      lines++;
      if(lines >= maxLines) return y;
    }else{
      line = testLine;
    }
  }
  ctx.fillText(line.trim(), x, y);
  return y + lineHeight;
}
function activeTabId(){ return document.querySelector('.tab.active')?.dataset?.tab || 'dca'; }

function getCardPayload(){
  const tab = activeTabId();
  const dt = new Date().toLocaleString();
  const brand = 'InvestTraderTrade';
  const tgLink = '@InvestTraderTrade';

  let title = 'Trader Calculator';
  let subtitle = `${tab.toUpperCase()} ¬∑ ${dt}`;
  let lines = [];

  if(tab === 'dca'){
    const avg = dcaAvgEl.textContent.trim();
    const vol = dcaTotalVolEl.textContent.trim();
    const cost = dcaTotalCostEl.textContent.trim();
    if(avg === '‚Äî' && vol === '‚Äî') return null;
    lines.push({k:'AVG', v:avg});
    lines.push({k:'VOL', v:vol});
    lines.push({k:'COST', v:cost});
    const goalVol = dcaNeedVol.textContent.trim();
    if(goalVol && goalVol !== '‚Äî'){
      lines.push({k:'GOAL NEED', v:goalVol});
      lines.push({k:'GOAL COST', v:dcaNeedCost.textContent.trim()});
      lines.push({k:'STATUS', v:dcaGoalStatus.textContent.trim()});
    }
  }
  if(tab === 'rr'){
    const g = rr_value.textContent.trim();
    const n = rr_net.textContent.trim();
    if(g === '‚Äî' && n === '‚Äî') return null;
    lines.push({k:'GROSS', v:g});
    lines.push({k:'NET', v:n});
  }
  if(tab === 'cap'){
    const s = cap_value.textContent.trim();
    const r = cap_riskUsd.textContent.trim();
    const m = cap_margin.textContent.trim();
    if(s === '‚Äî' && r === '‚Äî') return null;
    lines.push({k:'SIZE', v:s});
    lines.push({k:'RISK', v:r});
    lines.push({k:'MARGIN', v:m});
  }
  if(tab === 'ind'){
    const fg = fgEl.textContent.trim();
    const ad = altDomEl.textContent.trim();
    const mood = moodEl.textContent.trim();
    if(fg === '‚Äî' && ad === '‚Äî') return null;
    lines.push({k:'F&G', v:fg});
    lines.push({k:'ALT DOM', v:ad});
    lines.push({k:'MOOD', v:mood});
  }

  return { title, subtitle, lines, brand, tgLink, tab };
}

async function exportCardPNG(){
  const payload = getCardPayload();
  if(!payload){
    showToast('‚Äî');
    try{ tg?.showAlert?.(lang==='ru' ? '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏' : 'No data for card'); }catch(e){}
    return;
  }

  // square 1080
  const W = 1080, H = 1080;
  const scale = 2;
  const canvas = document.createElement('canvas');
  canvas.width = W * scale;
  canvas.height = H * scale;
  const ctx = canvas.getContext('2d');
  ctx.scale(scale, scale);

  const bg = cssVar('--bg') || '#000';
  const panel = cssVar('--panel') || '#0b0b0b';
  const border = cssVar('--border') || '#151515';
  const text = cssVar('--text') || '#fff';
  const muted = cssVar('--muted') || '#9a9a9a';
  const accent = cssVar('--accent') || '#7CFC00';

  ctx.fillStyle = bg;
  ctx.fillRect(0,0,W,H);

  const pad = 70;
  const cardX = pad, cardY = pad, cardW = W - pad*2, cardH = H - pad*2;

  ctx.fillStyle = panel;
  roundRectPath(ctx, cardX, cardY, cardW, cardH, 36);
  ctx.fill();

  ctx.strokeStyle = border;
  ctx.lineWidth = 3;
  ctx.stroke();

  ctx.fillStyle = accent;
  roundRectPath(ctx, cardX+28, cardY+28, 10, cardH-56, 10);
  ctx.fill();

  ctx.fillStyle = text;
  ctx.font = '900 54px Inter, Arial, sans-serif';
  ctx.fillText(payload.title, cardX+60, cardY+90);

  ctx.fillStyle = muted;
  ctx.font = '700 28px Inter, Arial, sans-serif';
  ctx.fillText(payload.subtitle, cardX+60, cardY+135);

  let y = cardY + 210;
  const left = cardX + 60;
  const right = cardX + cardW - 60;

  ctx.font = '800 34px Inter, Arial, sans-serif';
  payload.lines.slice(0, 12).forEach((row)=>{
    ctx.fillStyle = muted;
    ctx.textAlign = 'left';
    ctx.fillText(String(row.k), left, y);

    ctx.fillStyle = text;
    ctx.textAlign = 'right';
    const value = String(row.v ?? '');
    const maxW = 560;

    if(ctx.measureText(value).width <= maxW){
      ctx.fillText(value, right, y);
      y += 70;
    }else{
      ctx.textAlign = 'left';
      const boxW = maxW;
      const startX = right - boxW;
      ctx.fillStyle = text;
      ctx.font = '800 28px Inter, Arial, sans-serif';
      y = wrapText(ctx, value, startX, y-6, boxW, 36, 3);
      ctx.font = '800 34px Inter, Arial, sans-serif';
      y += 18;
    }
  });

  ctx.textAlign = 'left';
  ctx.fillStyle = muted;
  ctx.font = '700 26px Inter, Arial, sans-serif';
  ctx.fillText(payload.tgLink, cardX+60, cardY+cardH-60);

  ctx.textAlign = 'right';
  ctx.fillText(payload.brand, cardX+cardW-60, cardY+cardH-60);

  // export via smart saver
  const filename = `trade_card_${payload.tab}_${Date.now()}.png`;

  const blob = await new Promise((resolve)=>canvas.toBlob(resolve, 'image/png'));
  if(!blob){
    try{ tg?.showAlert?.('PNG error'); }catch(e){}
    return;
  }

  await saveBlobSmart({
    blob,
    filename,
    mime:'image/png',
    title:'Trade Card PNG',
    kind:'image',
    textForPreview:''
  });
}
document.getElementById('card_btn').addEventListener('click', ()=>{ exportCardPNG(); });

/* links */
function openUrl(url){
  try{
    if(tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
    if(tg?.openLink) return tg.openLink(url);
  }catch(e){}
  window.open(url,'_blank','noopener');
}
document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

/* init */
function refreshAll(){ calcDCA(); calcRR(); calcCap(); }

setTheme(getInitialTheme());
syncLangButtons();
translateAll();

ensureAtLeastOneRow();
renderHistory();

calcDCA(); calcRR(); calcCap();
fetchIndicators();

// draw empty indicator canvases immediately
drawAllIndicatorVisuals(null);

// redraw canvases on resize
let resizeTimer = null;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>drawAllIndicatorVisuals(lastIndicators), 150);
});
</script>
</body>
</html>
