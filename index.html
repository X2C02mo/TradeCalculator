<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trader Calculator</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
  
  function initAnalytics() {
    try{
      if(!window.telegramAnalytics) return;
      const token='REPLACE_WITH_YOUR_TG_ANALYTICS_TOKEN';
      const appName='REPLACE_WITH_YOUR_ANALYTICS_IDENTIFIER';
      if(token.startsWith('REPLACE_') || appName.startsWith('REPLACE_')) return;
      window.telegramAnalytics.init({ token, appName });
    }catch(e){}
  }
</script>
<script async src="https://tganalytics.xyz/index.js" onload="initAnalytics()" type="text/javascript"></script>


<script src="https://unpkg.com/@tonconnect/ui@2.3.1/dist/tonconnect-ui.min.js"></script>
<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#fff;
  --muted:#9a9a9a;
  --accent:#7CFC00;

  --chip:#111;
  --chip2:#0f0f0f;
  --danger:#ff4d4d;

  --radius:14px;
  --shadow:0 12px 30px rgba(0,0,0,.55);

  --input-bg:#070707;
  --result-bg:#060606;
  --chip-bg:#0a0a0a;
}

html[data-theme="light"]{
  --bg:#f6f7fb;
  --panel:#ffffff;
  --border:#e6e8ee;
  --text:#0b0b0b;
  --muted:#5f6675;
  --accent:#2d8cff;

  --chip:#f0f2f8;
  --chip2:#eef1f7;
  --danger:#d90429;

  --shadow:0 12px 30px rgba(10,20,40,.10);

  --input-bg:#fbfcff;
  --result-bg:#f7f9ff;
  --chip-bg:#f1f4fb;
}

*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
#app{min-height:100vh;display:flex;flex-direction:column}

/* --- header --- */
header{
  position:sticky;top:0;z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
}
html[data-theme="light"] header{background:rgba(255,255,255,.7)}

.leftbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

.lang{display:flex;gap:6px;align-items:center}
.lang button{
  background:transparent;border:1px solid var(--border);
  color:var(--muted);padding:5px 9px;cursor:pointer;border-radius:12px;
  font-weight:800;font-size:12px;letter-spacing:.4px;
}
.lang button.active{border-color:var(--accent);color:var(--accent)}

.iconbtn{
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  padding:6px 10px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  line-height:1.1;
  min-height:34px;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.iconbtn:hover{border-color:color-mix(in srgb, var(--accent) 50%, var(--border))}
.iconbtn .ico{font-size:15px}
.iconbtn .lbl{font-size:12px;font-weight:800;white-space:nowrap}
.iconbtn.active{border-color:var(--accent);color:var(--accent)}

.tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center}
.tab{
  background:none;border:none;
  color:var(--muted);
  font-size:13px;
  padding:6px 10px;
  cursor:pointer;
  border-radius:12px;
  font-weight:900;
  border:1px solid transparent;
}
.tab:hover{border-color:var(--border)}
.tab.active{color:var(--accent);border-color:var(--accent)}

/* --- layout --- */
main{flex:1;padding:12px;display:flex;gap:14px;flex-direction:column}
@media(min-width:980px){ main{flex-direction:row;align-items:flex-start} }

.panels{display:flex;gap:14px;flex-wrap:wrap;flex:1}
.screen{display:none;width:100%}
.screen.active{display:block}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px;
  max-width:820px;
  box-shadow:var(--shadow);
}
.card h3{margin:0 0 10px 0}

.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:800}
input, select{
  width:100%;
  padding:11px 10px;
  background:var(--input-bg);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:12px;
  font-size:15px;
  outline:none;
}
input:focus, select:focus{border-color:color-mix(in srgb, var(--accent) 60%, var(--border))}

.row{display:flex;gap:10px;flex-wrap:wrap}
.row > *{flex:1;min-width:150px}

.result{
  margin-top:8px;
  padding:10px;
  border-radius:12px;
  background:var(--result-bg);
  border:1px solid var(--border);
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:space-between;
  font-weight:900;
}
.result .v{color:var(--accent)}
.small{font-size:12px;color:var(--muted);font-weight:700}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  background:transparent;
  color:var(--accent);
  border:1px solid color-mix(in srgb, var(--border) 80%, var(--accent));
  padding:9px 12px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
}
.btn:hover{border-color:var(--accent)}
.btn.ghost{color:var(--muted);border-color:var(--border)}
.btn.danger{color:var(--danger);border-color:color-mix(in srgb, var(--danger) 40%, var(--border))}
.btn:disabled{opacity:.45;cursor:not-allowed}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.chip{
  border:1px solid var(--border);
  background:var(--chip-bg);
  padding:7px 10px;
  border-radius:999px;
  cursor:pointer;
  color:var(--muted);
  font-weight:900;
  font-size:12px;
}
.chip:hover{border-color:color-mix(in srgb, var(--accent) 50%, var(--border))}
.chip.active{border-color:var(--accent);color:var(--accent)}

.history{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:10px;
  width:100%;
  max-width:460px;
  box-shadow:var(--shadow);
}
.history h4{margin:0 0 8px 0}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:4px}
.hist-item{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
}
html[data-theme="light"] .hist-item{background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0))}
.hist-item b{display:block;font-size:13px}
.hist-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.mini{
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  padding:6px 9px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  font-size:12px;
}
.mini:hover{border-color:color-mix(in srgb, var(--accent) 45%, var(--border)); color:var(--accent)}
.note{font-size:12px;color:var(--muted);font-weight:700;margin-top:8px}

footer{
  border-top:1px solid var(--border);
  padding:12px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px
}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px;font-weight:900}
.links{display:flex;gap:18px;margin-top:2px;flex-wrap:wrap;justify-content:center}
.rainbow{
  display:inline-block;
  font-weight:1000;
  text-decoration:none;
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rain 3.5s linear infinite
}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}

/* toast */
#toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:14px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(0,0,0,.75);
  color:#fff;
  font-weight:900;
  font-size:13px;
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  z-index:999;
}
html[data-theme="light"] #toast{background:rgba(0,0,0,.72)}
#toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}

/* modal */
#modal_backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:998;
  padding:12px;
}
#modal{
  width:min(680px, 100%);
  border-radius:18px;
  border:1px solid var(--border);
  background:var(--panel);
  box-shadow:var(--shadow);
  padding:12px;
}
#modal_header{display:flex;justify-content:space-between;align-items:center;gap:10px}
#modal_header b{font-size:14px}
#modal_close{border:1px solid var(--border);background:transparent;border-radius:12px;color:var(--muted);padding:6px 10px;cursor:pointer;font-weight:1000}
#modal_body{margin-top:10px;display:flex;gap:12px;flex-wrap:wrap}
#modal_canvas_wrap{flex:1;min-width:280px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:var(--result-bg)}
#modal_right{width:240px;min-width:240px;display:flex;flex-direction:column;gap:8px}
#modal_right .btn{width:100%}
#modal_help{font-size:12px;color:var(--muted);font-weight:700}

/* indicators visuals */
.vizgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
@media(max-width:520px){ .vizgrid{grid-template-columns:1fr} }
.viz{
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
}
html[data-theme="light"] .viz{background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,0))}
.viz h5{margin:0 0 8px 0;font-size:12px;color:var(--muted);font-weight:1000;letter-spacing:.3px}
.viz canvas{width:100%;height:130px;display:block}
.viz .big{font-size:22px;font-weight:1000}
.viz .sub{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}

@media(max-width:420px){
  .iconbtn .lbl{display:none}
  .tabs{gap:6px}
  .tab{padding:6px 8px}
}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru">RU</button>
        <button id="btn_en">EN</button>
      </div>

      <button class="iconbtn" id="wallet_btn" type="button" aria-label="TON Wallet">
        <span class="ico">üëõ</span>
        <span class="lbl" data-i18n="wallet">Wallet</span>
      </button>

      <button class="iconbtn" id="tip_btn" type="button" aria-label="Tip TON">
        <span class="ico">üíé</span>
        <span class="lbl" data-i18n="tip">Tip TON</span>
      </button>


      <button class="iconbtn" id="theme_toggle" type="button" aria-label="Theme">
        <span class="ico" id="theme_icon">üåô</span>
        <span class="lbl" id="theme_text">Dark</span>
      </button>

      <button class="iconbtn" id="share_btn" type="button" aria-label="Share">
        <span class="ico">üìã</span>
        <span class="lbl" data-i18n="share">Share</span>
      </button>

      <button class="iconbtn" id="card_btn" type="button" aria-label="Trade Card PNG">
        <span class="ico">üñºÔ∏è</span>
        <span class="lbl" data-i18n="cardpng">Card PNG</span>
      </button>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca" type="button">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr" type="button">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap" type="button">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind" type="button">Indicators</button>
    </div>
  </header>

  <main>
    <div class="panels">
      <!-- DCA -->
      <section id="dca" class="screen active">
        <div class="card">
          <div class="small" style="margin-bottom:10px" data-i18n="dca.tip">
            Tip: add multiple entries ‚Äî app will calculate avg, total volume and cost.
          </div>

          <div id="dca_rows"></div>

          <div class="controls" style="margin-top:10px">
            <button class="btn" id="dca_add" type="button" data-i18n="dca.add">+ Add entry</button>
            <button class="btn ghost" id="dca_clear" type="button" data-i18n="common.clear">Clear</button>
          </div>

          <div class="result" style="margin-top:12px">
            <div>
              <div class="small" data-i18n="dca.avg">Average price</div>
              <div><span class="v" id="dca_avg">‚Äî</span></div>
            </div>
            <button class="btn ghost" id="dca_copy" type="button" data-i18n="common.copy">Copy</button>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="result" style="flex:1">
              <div>
                <div class="small" data-i18n="dca.vol">Total volume</div>
                <div><span class="v" id="dca_total_vol">‚Äî</span></div>
              </div>
            </div>
            <div class="result" style="flex:1">
              <div>
                <div class="small" data-i18n="dca.cost">Total cost</div>
                <div><span class="v" id="dca_total_cost">‚Äî</span></div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px">
            <div class="small" style="margin-bottom:8px" data-i18n="dca.goalTitle">Target average (optional)</div>
            <div class="row">
              <div class="field" style="margin:0">
                <label data-i18n="dca.goalPrice">Target avg price</label>
                <input id="dca_goal" type="number" step="any" inputmode="decimal" />
              </div>
              <div class="field" style="margin:0">
                <label data-i18n="dca.nextPrice">Next buy price</label>
                <input id="dca_next_price" type="number" step="any" inputmode="decimal" />
              </div>
            </div>
            <div class="result">
              <div>
                <div class="small" data-i18n="dca.need">Needed volume at next price</div>
                <div><span class="v" id="dca_need_vol">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="dca_need_copy" type="button" data-i18n="common.copy">Copy</button>
            </div>
          </div>
        </div>
      </section>

      <!-- R/R -->
      <section id="rr" class="screen">
        <div class="card">
          <div class="row">
            <div class="field" style="flex:1">
              <label data-i18n="rr.entry">Entry</label>
              <input id="rr_entry" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field" style="flex:1">
              <label data-i18n="rr.sl">Stop Loss</label>
              <input id="rr_sl" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field" style="flex:1">
              <label data-i18n="rr.tp">Take Profit</label>
              <input id="rr_tp" type="number" step="any" inputmode="decimal" />
            </div>
          </div>

          <div class="row">
            <div class="field" style="flex:1">
              <label data-i18n="rr.fee">Fee % (entry+exit)</label>
              <input id="rr_fee" type="number" step="any" inputmode="decimal" value="0.2" />
              <div class="small" data-i18n="rr.feeNote" style="margin-top:4px">
                Shows net R/R: approximates entry+exit fees.
              </div>
            </div>
          </div>

          <div class="result">
            <div>
              <div class="small" data-i18n="rr.gross">Gross R/R</div>
              <div><span class="v" id="rr_gross">‚Äî</span></div>
            </div>
            <button class="btn ghost" id="rr_copy_gross" type="button" data-i18n="common.copy">Copy</button>
          </div>

          <div class="result">
            <div>
              <div class="small" data-i18n="rr.net">Net R/R (fees)</div>
              <div><span class="v" id="rr_net">‚Äî</span></div>
            </div>
            <button class="btn ghost" id="rr_copy_net" type="button" data-i18n="common.copy">Copy</button>
          </div>
        </div>
      </section>

      <!-- Capital -->
      <section id="cap" class="screen">
        <div class="card">
          <div class="row">
            <div class="field">
              <label data-i18n="cap.dep">Deposit</label>
              <input id="cap_dep" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field">
              <label data-i18n="cap.risk">Risk %</label>
              <input id="cap_risk" type="number" step="any" inputmode="decimal" value="1" />
            </div>
            <div class="field">
              <label data-i18n="cap.lev">Leverage</label>
              <input id="cap_lev" type="number" step="any" inputmode="decimal" value="1" />
            </div>
          </div>

          <div class="chips" aria-label="Risk presets">
            <div class="small" style="width:100%" data-i18n="cap.presets">Quick risks</div>
            <button class="chip" data-risk="0.5" type="button">0.5%</button>
            <button class="chip active" data-risk="1" type="button">1%</button>
            <button class="chip" data-risk="2" type="button">2%</button>
            <button class="chip" data-risk="3" type="button">3%</button>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="field">
              <label data-i18n="cap.entry">Entry</label>
              <input id="cap_entry" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field">
              <label data-i18n="cap.sl">Stop Loss</label>
              <input id="cap_sl" type="number" step="any" inputmode="decimal" />
            </div>
            <div class="field">
              <label data-i18n="cap.fee">Fee % (entry+exit)</label>
              <input id="cap_fee" type="number" step="any" inputmode="decimal" value="0.2" />
            </div>
          </div>

          <div class="row">
            <div class="result" style="flex:1">
              <div>
                <div class="small" data-i18n="cap.pos">Position size</div>
                <div><span class="v" id="cap_pos">‚Äî</span></div>
              </div>
              <button class="btn ghost" id="cap_copy_pos" type="button" data-i18n="common.copy">Copy</button>
            </div>
          </div>

          <div class="row">
            <div class="result" style="flex:1">
              <div>
                <div class="small" data-i18n="cap.riskUsd">Risk $</div>
                <div><span class="v" id="cap_risk_usd">‚Äî</span></div>
              </div>
            </div>
            <div class="result" style="flex:1">
              <div>
                <div class="small" data-i18n="cap.margin">Margin (lev)</div>
                <div><span class="v" id="cap_margin">‚Äî</span></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Indicators -->
      <section id="ind" class="screen">
        <div class="card">
          <h3 data-i18n="ind.title">Indicators</h3>

          <div class="row">
            <div class="field" style="flex:1">
              <label data-i18n="ind.fg.label">Fear &amp; Greed</label>
              <div id="fg_value" class="result">
                <div>
                  <div class="small" data-i18n="ind.fg.valueLabel">Value</div>
                  <div><span class="v" id="fg_text">‚Äî</span></div>
                </div>
              </div>
            </div>
            <div class="field" style="flex:1">
              <label data-i18n="ind.mood.label">Market Mood</label>
              <div class="result">
                <div>
                  <div class="small" data-i18n="ind.mood.hint">Derived from F&G + Alt dom</div>
                  <div><span class="v" id="mood">‚Äî</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field" style="flex:1">
              <label data-i18n="ind.tcap.label">Total Market Cap (USD)</label>
              <div id="tcap" class="result"><span class="v" id="tcap_text">‚Äî</span></div>
            </div>
            <div class="field" style="flex:1">
              <label data-i18n="ind.alt.label">Alt dominance (proxy Altseason)</label>
              <div id="alt_dom" class="result"><span class="v" id="alt_text">‚Äî</span></div>
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="refresh_ind" type="button" data-i18n="ind.refresh">Refresh</button>
            <span class="small" id="ind_note"></span>
          </div>

          <div class="vizgrid">
            <div class="viz">
              <h5 data-i18n="ind.viz.fg">F&G Gauge</h5>
              <canvas id="fg_canvas" width="600" height="260"></canvas>
              <div class="big" id="fg_big">‚Äî</div>
              <div class="sub" id="fg_sub">‚Äî</div>
            </div>
            <div class="viz">
              <h5 data-i18n="ind.viz.dom">Dominance Split</h5>
              <canvas id="dom_canvas" width="600" height="260"></canvas>
              <div class="big" id="dom_big">‚Äî</div>
              <div class="sub" id="dom_sub">‚Äî</div>
            </div>
          </div>

        </div>
      </section>

    </div>

    <!-- history -->
    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>
      <div class="controls" style="margin-top:8px">
        <button class="btn ghost" id="clear_history" type="button" data-i18n="hist.clear">Clear</button>
      </div>
      <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">AIRDROP ¬∑ NEWS ¬∑ TRADING</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<div id="toast">‚Äî</div>

<!-- card modal -->
<div id="modal_backdrop" role="dialog" aria-modal="true">
  <div id="modal">
    <div id="modal_header">
      <b data-i18n="card.title">Trade Card</b>
      <button id="modal_close" type="button">‚úï</button>
    </div>
    <div id="modal_body">
      <div id="modal_canvas_wrap">
        <canvas id="card_canvas" width="900" height="600"></canvas>
      </div>
      <div id="modal_right">
        <button class="btn" id="card_download" type="button" data-i18n="card.download">Download PNG</button>
        <button class="btn ghost" id="card_copy" type="button" data-i18n="card.copy">Copy</button>
        <div id="modal_help" data-i18n="card.help">If copy doesn't work on your device, use Download PNG.</div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- telegram init ---------- */
  const tg = window.Telegram?.WebApp || null;
  try{ tg?.expand?.(); }catch(e){}
  try{ tg?.disableVerticalSwipes?.(); }catch(e){} // reduce accidental position changes in TWA
  try{ tg?.ready?.(); }catch(e){}

  /* ---------- i18n ---------- */
  const locales = {
    ru:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è","cardpng":"–ö–∞—Ä—Ç–æ—á–∫–∞ PNG","wallet":"–ö–æ—à–µ–ª—ë–∫","tip":"–î–æ–Ω–∞—Ç TON","wallet.disconnectQ":"–û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª—ë–∫?","toast.walletNeed":"–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏ –∫–æ—à–µ–ª—ë–∫","toast.sent":"–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞","toast.fail":"–û—à–∏–±–∫–∞","toast.tonManifest":"–£–∫–∞–∂–∏ manifest URL",
      "common.clear":"–û—á–∏—Å—Ç–∏—Ç—å","common.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      "toast.copied":"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!","toast.saved":"–ì–æ—Ç–æ–≤–æ",
      "theme.dark":"–¢—ë–º–Ω–∞—è","theme.light":"–°–≤–µ—Ç–ª–∞—è",
      "dca.tip":"–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.",
      "dca.add":"+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥","dca.avg":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.vol":"–û–±—â–∏–π –æ–±—ä—ë–º","dca.cost":"–°—É–º–º–∞",
      "dca.goalTitle":"–¶–µ–ª—å –ø–æ —Å—Ä–µ–¥–Ω–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)","dca.goalPrice":"–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.nextPrice":"–¶–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∫—É–ø–∫–∏","dca.need":"–ù—É–∂–Ω—ã–π –æ–±—ä—ë–º –ø–æ next-price",
      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)","rr.feeNote":"–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç net R/R —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–º–µ—Ä–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏.",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)","cap.lev":"–ü–ª–µ—á–æ","cap.presets":"–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏",
      "cap.pos":"–û–±—ä—ë–º –ø–æ–∑–∏—Ü–∏–∏","cap.riskUsd":"–†–∏—Å–∫ $","cap.margin":"–ú–∞—Ä–∂–∞ (–ø–ª–µ—á–æ)",
      "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
      "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)",
      "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy Altseason)",
      "ind.mood.label":"–†–µ–∂–∏–º —Ä—ã–Ω–∫–∞",
      "ind.mood.hint":"–°—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ F&G + –¥–æ–º–∏–Ω–∞—Ü–∏–∏",
      "ind.refresh":"–û–±–Ω–æ–≤–∏—Ç—å",
      "ind.loading":"–û–±–Ω–æ–≤–ª—è—é‚Ä¶",
      "ind.cached":"–ü–æ–∫–∞–∑–∞–Ω—ã –∫—ç—à-–¥–∞–Ω–Ω—ã–µ",
      "ind.rate":"–õ–∏–º–∏—Ç API/–æ—à–∏–±–∫–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ",
      "ind.viz.fg":"F&G Gauge",
      "ind.viz.dom":"Split –¥–æ–º–∏–Ω–∞—Ü–∏–∏",
      "hist.title":"–ò—Å—Ç–æ—Ä–∏—è","hist.clear":"–û—á–∏—Å—Ç–∏—Ç—å","hist.note":"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",
      "footer.tags":"–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì",
      "card.title":"Trade Card",
      "card.download":"–°–∫–∞—á–∞—Ç—å PNG",
      "card.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      "card.help":"–ï—Å–ª–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –°–∫–∞—á–∞—Ç—å PNG."
    },
    en:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "share":"Share","cardpng":"Card PNG","wallet":"Wallet","tip":"Tip TON","wallet.disconnectQ":"Disconnect wallet?","toast.walletNeed":"Connect wallet first","toast.sent":"Transaction sent","toast.fail":"Error","toast.tonManifest":"Set manifest URL",
      "common.clear":"Clear","common.copy":"Copy",
      "toast.copied":"Copied!","toast.saved":"Done",
      "theme.dark":"Dark","theme.light":"Light",
      "dca.tip":"Tip: add multiple entries ‚Äî app will calculate avg, total volume and cost.",
      "dca.add":"+ Add entry","dca.avg":"Average price","dca.vol":"Total volume","dca.cost":"Total cost",
      "dca.goalTitle":"Target average (optional)","dca.goalPrice":"Target avg price","dca.nextPrice":"Next buy price","dca.need":"Needed volume at next price",
      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"Fee % (entry+exit)","rr.feeNote":"Shows net R/R: approximates entry+exit fees.",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"Fee % (entry+exit)","cap.lev":"Leverage","cap.presets":"Quick risks",
      "cap.pos":"Position size","cap.riskUsd":"Risk $","cap.margin":"Margin (lev)",
      "ind.title":"Indicators",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value",
      "ind.tcap.label":"Total Market Cap (USD)",
      "ind.alt.label":"Alt dominance (proxy Altseason)",
      "ind.mood.label":"Market Mood",
      "ind.mood.hint":"Derived from F&G + Alt dom",
      "ind.refresh":"Refresh",
      "ind.loading":"Refreshing‚Ä¶",
      "ind.cached":"Showing cached data",
      "ind.rate":"API limit/error ‚Äî try later",
      "ind.viz.fg":"F&G Gauge",
      "ind.viz.dom":"Dominance Split",
      "hist.title":"History","hist.clear":"Clear","hist.note":"Saved locally in your browser",
      "footer.tags":"AIRDROP ¬∑ NEWS ¬∑ TRADING",
      "card.title":"Trade Card",
      "card.download":"Download PNG",
      "card.copy":"Copy",
      "card.help":"If copy doesn't work on your device, use Download PNG."
    }
  };

  let lang = 'en';
  try{
    const tgl = tg?.initDataUnsafe?.user?.language_code;
    if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
  }catch(e){ lang='en'; }

  function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }
  function translateAll(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n');
      if(locales[lang] && locales[lang][k] !== undefined){
        el.textContent = locales[lang][k];
      }
    });
    // also update theme label
    updateThemeUI();
  }

  /* ---------- toast ---------- */
  let toastTimer=null;
  function showToast(msg){
    const el=document.getElementById('toast');
    el.textContent=msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>el.classList.remove('show'), 1200);
  }

  /* ---------- theme ---------- */
  const THEME_KEY='tc_theme_v10';
  function getInitialTheme(){
    const saved=localStorage.getItem(THEME_KEY);
    if(saved==='dark'||saved==='light') return saved;
    const tgScheme=(tg?.colorScheme||'').toLowerCase();
    if(tgScheme==='light') return 'light';
    return 'dark';
  }
  function setTheme(theme){
    if(theme!=='dark' && theme!=='light') theme='dark';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    updateThemeUI();
    drawAllIndicatorVisuals(lastIndicators);
  }
  function updateThemeUI(){
    const theme=document.documentElement.getAttribute('data-theme')||'dark';
    const icon=document.getElementById('theme_icon');
    const text=document.getElementById('theme_text');
    const btn=document.getElementById('theme_toggle');
    if(theme==='light'){
      icon.textContent='‚òÄÔ∏è';
      text.textContent=t('theme.light');
      btn.classList.add('active');
    }else{
      icon.textContent='üåô';
      text.textContent=t('theme.dark');
      btn.classList.remove('active');
    }
  }
  setTheme(getInitialTheme());
  document.getElementById('theme_toggle').addEventListener('click', ()=>{
    const current=document.documentElement.getAttribute('data-theme')||'dark';
    setTheme(current==='dark'?'light':'dark');
  });

  /* ---------- utils ---------- */
  function safeNum(v){ const x=parseFloat(v); return isFinite(x)?x:0; }
  function fmt(v, digits=8){
    if(v===null || v===undefined || !isFinite(v)) return '‚Äî';
    const n=Number(v);
    const abs=Math.abs(n);
    const d = abs>=1000 ? 2 : (abs>=1 ? 6 : digits);
    return n.toLocaleString(undefined,{maximumFractionDigits:d});
  }
  function now(){ return Date.now(); }

  function haptic(type='impact', style='light'){
    try{
      if(!tg?.HapticFeedback) return;
      if(type==='impact') tg.HapticFeedback.impactOccurred(style);
      if(type==='notify') tg.HapticFeedback.notificationOccurred(style);
    }catch(e){}
  }

  /* ---------- language buttons ---------- */
  const btnRu=document.getElementById('btn_ru');
  const btnEn=document.getElementById('btn_en');
  function syncLangButtons(){
    if(lang==='ru'){ btnRu.classList.add('active'); btnEn.classList.remove('active'); }
    else { btnEn.classList.add('active'); btnRu.classList.remove('active'); }
  }
  // Set the correct active state on first load
  syncLangButtons();
  btnRu.addEventListener('click', ()=>{ lang='ru'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); (typeof updateWalletUI==='function') && updateWalletUI(); });
  btnEn.addEventListener('click', ()=>{ lang='en'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); (typeof updateWalletUI==='function') && updateWalletUI(); });

  /* ---------- tabs ---------- */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
      btn.classList.add('active');
      const target=btn.dataset.tab;
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(target)?.classList.add('active');
      if(target==='ind' && document.getElementById('tcap').textContent.trim()==='‚Äî') fetchIndicators();
    });
  });
  function activeTab(){
    const act=document.querySelector('.tab.active');
    return act?.dataset?.tab || 'dca';
  }

  /* ---------- DCA dynamic rows ---------- */
  const dcaRowsEl=document.getElementById('dca_rows');
  const dcaAvgEl=document.getElementById('dca_avg');
  const dcaTotalVolEl=document.getElementById('dca_total_vol');
  const dcaTotalCostEl=document.getElementById('dca_total_cost');
  const dcaGoal=document.getElementById('dca_goal');
  const dcaNext=document.getElementById('dca_next_price');
  const dcaNeedVol=document.getElementById('dca_need_vol');

  let dcaRows=[];

  function addDcaRow(p=0,v=0){
    const rowId=String(Math.random()).slice(2);
    const wrap=document.createElement('div');
    wrap.className='row';
    wrap.style.marginBottom='8px';
    wrap.innerHTML=`
      <div class="field" style="flex:1;margin:0">
        <label>${lang==='ru'?'–¶–µ–Ω–∞':'Price'}</label>
        <input type="number" step="any" inputmode="decimal" value="${p||''}">
      </div>
      <div class="field" style="flex:1;margin:0">
        <label>${lang==='ru'?'–û–±—ä—ë–º':'Volume'}</label>
        <input type="number" step="any" inputmode="decimal" value="${v||''}">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button class="btn ghost" type="button" aria-label="remove" style="padding:9px 12px">√ó</button>
      </div>
    `;
    const inputs=wrap.querySelectorAll('input');
    const btnRemove=wrap.querySelector('button');
    const item={id:rowId, el:wrap, pEl:inputs[0], vEl:inputs[1]};
    inputs.forEach(inp=>inp.addEventListener('input', calcDCA));
    btnRemove.addEventListener('click', ()=>{
      dcaRows = dcaRows.filter(r=>r.id!==rowId);
      wrap.remove();
      calcDCA();
    });
    dcaRows.push(item);
    dcaRowsEl.appendChild(wrap);
    calcDCA();
  }

  function clearDCA(){
    dcaRows=[];
    dcaRowsEl.innerHTML='';
    addDcaRow();
    addDcaRow();
    dcaGoal.value='';
    dcaNext.value='';
    calcDCA();
  }

  function calcDCA(){
    let totalVol=0;
    let totalCost=0;
    dcaRows.forEach(r=>{
      const p=safeNum(r.pEl.value);
      const v=safeNum(r.vEl.value);
      if(p>0 && v>0){
        totalVol += v;
        totalCost += p*v;
      }
    });

    if(totalVol<=0){
      dcaAvgEl.textContent='‚Äî';
      dcaTotalVolEl.textContent='‚Äî';
      dcaTotalCostEl.textContent='‚Äî';
      dcaNeedVol.textContent='‚Äî';
      return {avg:null, totalVol:0, totalCost:0};
    }

    const avg=totalCost/totalVol;
    dcaAvgEl.textContent = fmt(avg, 10);
    dcaTotalVolEl.textContent = fmt(totalVol, 8);
    dcaTotalCostEl.textContent = fmt(totalCost, 2);

    // goal calc: find needed volume at next price to reach target average
    const target=safeNum(dcaGoal.value);
    const nextP=safeNum(dcaNext.value);
    if(target>0 && nextP>0 && nextP!==target){
      // (totalCost + nextP*x) / (totalVol + x) = target  => x = (target*totalVol - totalCost) / (nextP - target)
      const x=(target*totalVol - totalCost) / (nextP - target);
      if(isFinite(x) && x>0){
        dcaNeedVol.textContent = fmt(x, 8);
      }else dcaNeedVol.textContent='‚Äî';
    }else dcaNeedVol.textContent='‚Äî';

    return {avg, totalVol, totalCost};
  }

  document.getElementById('dca_add').addEventListener('click', ()=>addDcaRow());
  document.getElementById('dca_clear').addEventListener('click', clearDCA);
  dcaGoal.addEventListener('input', calcDCA);
  dcaNext.addEventListener('input', calcDCA);

  /* ---------- copy helpers ---------- */
  async function copyText(text){
    if(!text || text==='‚Äî') return false;
    try{
      await navigator.clipboard.writeText(String(text));
      return true;
    }catch(e){
      try{
        const ta=document.createElement('textarea');
        ta.value=String(text);
        ta.style.position='fixed';
        ta.style.top='-1000px';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        const ok=document.execCommand('copy');
        ta.remove();
        return !!ok;
      }catch(e2){ return false; }
    }
  }

  function bindCopy(btn, getVal){
    btn.addEventListener('click', async ()=>{
      const val=getVal();
      const ok = await copyText(val);
      if(ok){
        showToast(t('toast.copied'));
        haptic('notify','success');
      }
    });
  }

  const dcaCopyBtn=document.getElementById('dca_copy');
  const dcaNeedCopyBtn=document.getElementById('dca_need_copy');
  bindCopy(dcaCopyBtn, ()=>dcaAvgEl.textContent);
  bindCopy(dcaNeedCopyBtn, ()=>dcaNeedVol.textContent);

  /* ---------- RR ---------- */
  const rrEntry=document.getElementById('rr_entry');
  const rrSl=document.getElementById('rr_sl');
  const rrTp=document.getElementById('rr_tp');
  const rrFee=document.getElementById('rr_fee');
  const rrGross=document.getElementById('rr_gross');
  const rrNet=document.getElementById('rr_net');

  function calcRR(){
    const e=safeNum(rrEntry.value), sl=safeNum(rrSl.value), tp=safeNum(rrTp.value);
    const fee=safeNum(rrFee.value)/100;
    if(!e || !sl || !tp || e===sl){
      rrGross.textContent='‚Äî';
      rrNet.textContent='‚Äî';
      return {gross:null, net:null};
    }
    const risk=Math.abs(e-sl);
    const reward=Math.abs(tp-e);
    if(!risk || !reward){
      rrGross.textContent='‚Äî'; rrNet.textContent='‚Äî'; return {gross:null, net:null};
    }
    const gross=(reward/risk);
    rrGross.textContent = '1:' + gross.toFixed(2);

    // net: approximate fees reduce reward and increase risk slightly
    const feeEntry = e*fee;
    const feeExit  = tp*fee;
    const netReward = Math.max(0, reward - (feeEntry+feeExit));
    const net=(netReward / (risk + feeEntry)); // conservative
    rrNet.textContent = '1:' + net.toFixed(2);
    return {gross, net};
  }
  [rrEntry,rrSl,rrTp,rrFee].forEach(x=>x.addEventListener('input', ()=>{ calcRR(); pushHistoryIfReady(); }));
  bindCopy(document.getElementById('rr_copy_gross'), ()=>rrGross.textContent);
  bindCopy(document.getElementById('rr_copy_net'), ()=>rrNet.textContent);

  /* ---------- Capital ---------- */
  const capDep=document.getElementById('cap_dep');
  const capRisk=document.getElementById('cap_risk');
  const capLev=document.getElementById('cap_lev');
  const capEntry=document.getElementById('cap_entry');
  const capSl=document.getElementById('cap_sl');
  const capFee=document.getElementById('cap_fee');
  const capPos=document.getElementById('cap_pos');
  const capRiskUsd=document.getElementById('cap_risk_usd');
  const capMargin=document.getElementById('cap_margin');

  document.querySelectorAll('.chip[data-risk]').forEach(ch=>{
    ch.addEventListener('click', ()=>{
      document.querySelectorAll('.chip[data-risk]').forEach(x=>x.classList.remove('active'));
      ch.classList.add('active');
      capRisk.value=ch.dataset.risk;
      calcCap();
      pushHistoryIfReady();
    });
  });

  function calcCap(){
    const dep=safeNum(capDep.value);
    const rp=safeNum(capRisk.value)/100;
    const lev=Math.max(1, safeNum(capLev.value)||1);
    const e=safeNum(capEntry.value);
    const sl=safeNum(capSl.value);
    const fee=safeNum(capFee.value)/100;

    if(dep<=0 || rp<=0 || e<=0 || sl<=0 || e===sl){
      capPos.textContent='‚Äî';
      capRiskUsd.textContent='‚Äî';
      capMargin.textContent='‚Äî';
      return {pos:null};
    }

    const riskUsd=dep*rp;
    // price movement per 1 unit position, include fee estimate
    const move=Math.abs(e-sl) + (e*fee); // entry fee increases effective risk
    const pos = riskUsd / move;

    capPos.textContent = fmt(pos, 8);
    capRiskUsd.textContent = fmt(riskUsd, 2);

    // margin estimate (simplified): notional / leverage
    const notional = pos * e;
    capMargin.textContent = fmt(notional/lev, 2);
    return {pos};
  }
  [capDep,capRisk,capLev,capEntry,capSl,capFee].forEach(x=>x.addEventListener('input', ()=>{ calcCap(); pushHistoryIfReady(); }));
  bindCopy(document.getElementById('cap_copy_pos'), ()=>capPos.textContent);

  /* ---------- Indicators ---------- */
  const fgText=document.getElementById('fg_text');
  const tcapText=document.getElementById('tcap_text');
  const altText=document.getElementById('alt_text');
  const moodEl=document.getElementById('mood');
  const indNote=document.getElementById('ind_note');

  let lastIndicators=null;
  const IND_CACHE_KEY='tc_ind_cache_v2';

  function saveIndicatorsCache(data){
    try{ localStorage.setItem(IND_CACHE_KEY, JSON.stringify({t:Date.now(), data})); }catch(e){}
  }
  function loadIndicatorsCache(){
    try{
      const raw=localStorage.getItem(IND_CACHE_KEY);
      if(!raw) return null;
      const j=JSON.parse(raw);
      if(!j?.data) return null;
      return j;
    }catch(e){ return null; }
  }

  function computeMood(fgValue, altDom){
    if(!isFinite(fgValue) || !isFinite(altDom)) return '‚Äî';
    // simple heuristic
    if(fgValue>=70 && altDom<45) return lang==='ru'?'–†–∏—Å–∫-–æ–Ω (BTC —Ñ–æ–∫—É—Å)':'Risk-on (BTC focus)';
    if(fgValue>=70 && altDom>=45) return lang==='ru'?'–ê–ª—å—Ç-—Ä–æ—Å—Ç':'Alt rally';
    if(fgValue<=30 && altDom<45) return lang==='ru'?'–°—Ç—Ä–∞—Ö / –∑–∞—â–∏—Ç–Ω—ã–π —Ä–µ–∂–∏–º':'Fear / defensive';
    if(fgValue<=30 && altDom>=45) return lang==='ru'?'–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (–∞–ª—å—Ç—ã –ø—Ä–∏ —Å—Ç—Ä–∞—Ö–µ)':'High risk (alts in fear)';
    return lang==='ru'?'–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ':'Neutral';
  }

  async function fetchIndicators(){
    indNote.textContent = t('ind.loading');
    let fgVal=null, fgClass='‚Äî', totalMc=null, btcDom=null;

    try{
      const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json', {cache:'no-store'});
      if(!res.ok) throw new Error('FNG');
      const j = await res.json();
      const d=j?.data?.[0];
      fgVal = d ? Number(d.value) : null;
      fgClass = d?.value_classification || '‚Äî';
    }catch(e){
      // ignore
    }

    try{
      const res2 = await fetch('https://api.coingecko.com/api/v3/global', {cache:'no-store'});
      if(!res2.ok) throw new Error('CG');
      const j2 = await res2.json();
      totalMc = j2?.data?.total_market_cap?.usd ?? null;
      btcDom = j2?.data?.market_cap_percentage?.btc ?? null;
    }catch(e){
      // ignore
    }

    // apply
    if(isFinite(fgVal)){
      fgText.textContent = `${fgVal} ¬∑ ${fgClass}`;
    }else{
      fgText.textContent = '‚Äî';
    }
    if(isFinite(totalMc)){
      tcapText.textContent = '$' + Number(totalMc).toLocaleString(undefined,{maximumFractionDigits:0});
    }else tcapText.textContent='‚Äî';

    let altDom=null;
    if(typeof btcDom==='number' && isFinite(btcDom)){
      altDom = 100 - btcDom;
      altText.textContent = altDom.toFixed(2) + '%';
    }else altText.textContent='‚Äî';

    moodEl.textContent = computeMood(fgVal ?? NaN, altDom ?? NaN);
    lastIndicators = { fgVal, fgClass, totalMc, btcDom, altDom };
    saveIndicatorsCache(lastIndicators);

    drawAllIndicatorVisuals(lastIndicators);
    indNote.textContent='';
  }

  document.getElementById('refresh_ind').addEventListener('click', fetchIndicators);

  /* visuals */
  function drawGauge(canvas, value){
    if(!canvas) return;
    const ctx=canvas.getContext('2d');
    const w=canvas.width, h=canvas.height;
    ctx.clearRect(0,0,w,h);

    // background arc
    const cx=w/2, cy=h*0.9;
    const r=Math.min(w*0.42, h*0.75);
    const start=Math.PI, end=0;

    ctx.lineWidth = Math.max(18, r*0.12);
    ctx.lineCap='round';

    // base
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#222';
    ctx.beginPath();
    ctx.arc(cx,cy,r,start,end,false);
    ctx.stroke();

    if(!isFinite(value)) return;

    const clamped=Math.max(0, Math.min(100, value));
    const angle = start + (end-start) * (clamped/100);

    // active
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7CFC00';
    ctx.beginPath();
    ctx.arc(cx,cy,r,start,angle,false);
    ctx.stroke();

    // needle
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle - Math.PI);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#fff';
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(r*0.72, -4);
    ctx.lineTo(r*0.72, 4);
    ctx.closePath();
    ctx.fill();
    ctx.restore();

    // center dot
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#fff';
    ctx.beginPath();
    ctx.arc(cx,cy,6,0,Math.PI*2);
    ctx.fill();
  }

  function drawDonutSplit(canvas, btcDom){
    if(!canvas) return;
    const ctx=canvas.getContext('2d');
    const w=canvas.width, h=canvas.height;
    ctx.clearRect(0,0,w,h);

    const cx=w/2, cy=h/2, r=Math.min(w,h)*0.32;
    const inner=r*0.62;

    const border=getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || '#222';
    const accent=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#7CFC00';
    const muted=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#999';

    // base ring
    ctx.fillStyle = border;
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#0b0b0b';
    ctx.beginPath();
    ctx.arc(cx,cy,inner,0,Math.PI*2);
    ctx.fill();

    if(!isFinite(btcDom)) return;

    const btc = Math.max(0, Math.min(100, btcDom));
    const alt = 100 - btc;

    const a0=-Math.PI/2;
    const aB = a0 + (Math.PI*2)*(btc/100);

    // BTC slice
    ctx.fillStyle = accent;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,aB,false);
    ctx.closePath();
    ctx.fill();

    // ALT slice
    ctx.fillStyle = muted;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,aB,a0+Math.PI*2,false);
    ctx.closePath();
    ctx.fill();

    // inner cutout
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel').trim() || '#0b0b0b';
    ctx.beginPath();
    ctx.arc(cx,cy,inner,0,Math.PI*2);
    ctx.fill();
  }

  function drawAllIndicatorVisuals(data){
    const fgCanvas=document.getElementById('fg_canvas');
    const domCanvas=document.getElementById('dom_canvas');
    drawGauge(fgCanvas, data?.fgVal);
    drawDonutSplit(domCanvas, data?.btcDom);

    const fgBig=document.getElementById('fg_big');
    const fgSub=document.getElementById('fg_sub');
    const domBig=document.getElementById('dom_big');
    const domSub=document.getElementById('dom_sub');

    if(isFinite(data?.fgVal)){
      fgBig.textContent = String(Math.round(data.fgVal));
      fgSub.textContent = data.fgClass || '‚Äî';
    }else{
      fgBig.textContent='‚Äî'; fgSub.textContent='‚Äî';
    }

    if(typeof data?.btcDom==='number' && isFinite(data.btcDom)){
      domBig.textContent = `BTC ${data.btcDom.toFixed(2)}%`;
      const alt = (100 - data.btcDom);
      domSub.textContent = `ALT ${alt.toFixed(2)}%`;
    }else{
      domBig.textContent='‚Äî'; domSub.textContent='‚Äî';
    }
  }

  // initial cache
  const cached=loadIndicatorsCache();
  if(cached?.data){
    lastIndicators=cached.data;
    fgText.textContent = isFinite(lastIndicators.fgVal) ? `${lastIndicators.fgVal} ¬∑ ${lastIndicators.fgClass||'‚Äî'}` : '‚Äî';
    tcapText.textContent = isFinite(lastIndicators.totalMc) ? '$' + Number(lastIndicators.totalMc).toLocaleString(undefined,{maximumFractionDigits:0}) : '‚Äî';
    altText.textContent = (typeof lastIndicators.btcDom==='number' && isFinite(lastIndicators.btcDom)) ? ((100-lastIndicators.btcDom).toFixed(2)+'%') : '‚Äî';
    moodEl.textContent = computeMood(lastIndicators.fgVal ?? NaN, lastIndicators.altDom ?? NaN);
    indNote.textContent = t('ind.cached');
    drawAllIndicatorVisuals(lastIndicators);
  }

  /* ---------- history ---------- */
  const HISTORY_KEY='tc_history_v10';
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY))||[] }catch(e){return[]} }
  function saveHistory(arr){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){} }
  function pushHistory(item){
    const arr=loadHistory();
    arr.unshift(item);
    if(arr.length>60) arr.pop();
    saveHistory(arr);
    renderHistory();
  }

  function renderHistory(){
    const list=document.getElementById('history_list');
    list.innerHTML='';
    const arr=loadHistory();
    if(!arr.length){
      const el=document.createElement('div');
      el.className='note';
      el.textContent=t('hist.note');
      list.appendChild(el);
      return;
    }
    arr.forEach((it, idx)=>{
      const node=document.createElement('div');
      node.className='hist-item';
      const dt=new Date(it.t).toLocaleString();
      const left=document.createElement('div');
      left.innerHTML = `<b>${it.type}</b><div class="small">${dt}</div><div class="small">${it.summary||''}</div>`;
      const right=document.createElement('div');
      right.className='hist-actions';

      const btnCard=document.createElement('button');
      btnCard.className='mini';
      btnCard.type='button';
      btnCard.textContent='PNG';
      btnCard.addEventListener('click', ()=>{
        exportCardPNG({fromHistory:true, historyItem:it});
      });

      const btnCopy=document.createElement('button');
      btnCopy.className='mini';
      btnCopy.type='button';
      btnCopy.textContent=t('common.copy');
      btnCopy.addEventListener('click', async ()=>{
        const ok = await copyText(it.summary || '');
        if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
      });

      right.appendChild(btnCard);
      right.appendChild(btnCopy);

      node.appendChild(left);
      node.appendChild(right);
      list.appendChild(node);
    });
  }
  document.getElementById('clear_history').addEventListener('click', ()=>{
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
  });

  // history push throttled (avoid spam on every keystroke)
  let lastPushAt=0;
  function pushHistoryIfReady(){
    const tnow=Date.now();
    if(tnow-lastPushAt<900) return;
    lastPushAt=tnow;

    const tab=activeTab();
    if(tab==='dca'){
      const r=calcDCA();
      if(r.avg){
        pushHistory({
          t:tnow,
          type:'DCA',
          summary:`AVG ${dcaAvgEl.textContent} | VOL ${dcaTotalVolEl.textContent} | COST ${dcaTotalCostEl.textContent}`
        });
      }
    }
    if(tab==='rr'){
      const r=calcRR();
      if(r.gross){
        pushHistory({
          t:tnow,
          type:'R/R',
          summary:`Gross ${rrGross.textContent} | Net ${rrNet.textContent}`
        });
      }
    }
    if(tab==='cap'){
      const r=calcCap();
      if(r.pos){
        pushHistory({
          t:tnow,
          type:'Capital',
          summary:`POS ${capPos.textContent} | Risk $${capRiskUsd.textContent} | Margin $${capMargin.textContent}`
        });
      }
    }
  }

  /* ---------- links ---------- */
  function openUrl(url){
    try{
      if(tg?.openLink) return tg.openLink(url);
      if(tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
    }catch(e){}
    window.open(url,'_blank');
  }
  document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade');});
  document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE');});

  /* ---------- trade card PNG ---------- */
  const modalBackdrop=document.getElementById('modal_backdrop');
  const modalClose=document.getElementById('modal_close');
  const cardCanvas=document.getElementById('card_canvas');
  const btnDownload=document.getElementById('card_download');
  const btnCopyImg=document.getElementById('card_copy');

  function openModal(){ modalBackdrop.style.display='flex'; }
  function closeModal(){ modalBackdrop.style.display='none'; }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  function drawCard({title, lines}){
    const ctx=cardCanvas.getContext('2d');
    const w=cardCanvas.width, h=cardCanvas.height;
    ctx.clearRect(0,0,w,h);

    const theme=document.documentElement.getAttribute('data-theme')||'dark';
    const bg = theme==='light' ? '#f6f7fb' : '#0a0a0a';
    const panel = theme==='light' ? '#ffffff' : '#0f0f0f';
    const border = theme==='light' ? '#e6e8ee' : '#1a1a1a';
    const text = theme==='light' ? '#0b0b0b' : '#ffffff';
    const muted = theme==='light' ? '#5f6675' : '#a8a8a8';
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || (theme==='light' ? '#2d8cff' : '#7CFC00');

    // bg
    ctx.fillStyle=bg;
    ctx.fillRect(0,0,w,h);

    // panel
    const pad=30;
    const r=24;
    roundRect(ctx, pad, pad, w-pad*2, h-pad*2, r);
    ctx.fillStyle=panel;
    ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeStyle=border;
    ctx.stroke();

    // header
    ctx.fillStyle=text;
    ctx.font='800 44px Inter, Arial';
    ctx.fillText('Trader Calculator', pad+28, pad+64);

    ctx.font='900 36px Inter, Arial';
    ctx.fillStyle=accent;
    ctx.fillText(title, pad+28, pad+118);

    // lines
    ctx.fillStyle=text;
    ctx.font='800 30px Inter, Arial';
    let y=pad+175;
    lines.forEach(line=>{
      ctx.fillStyle=muted;
      ctx.font='800 26px Inter, Arial';
      ctx.fillText(line.k, pad+28, y);
      ctx.fillStyle=text;
      ctx.font='900 28px Inter, Arial';
      ctx.fillText(line.v, pad+330, y);
      y+=46;
    });

    // footer tag
    ctx.fillStyle=muted;
    ctx.font='900 22px Inter, Arial';
    ctx.fillText('AIRDROP ¬∑ NEWS ¬∑ TRADING', pad+28, h-pad-22);
  }

  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  function buildCardData({fromHistory, historyItem}){
    if(fromHistory && historyItem){
      return {
        title: historyItem.type,
        lines: [
          {k:'Time', v: new Date(historyItem.t).toLocaleString()},
          {k:'Summary', v: historyItem.summary || '‚Äî'}
        ]
      };
    }
    const tab=activeTab();
    if(tab==='dca'){
      return {
        title:'DCA',
        lines:[
          {k:'AVG', v: dcaAvgEl.textContent},
          {k:'VOL', v: dcaTotalVolEl.textContent},
          {k:'COST', v: dcaTotalCostEl.textContent},
          {k:'GOAL NEED', v: dcaNeedVol.textContent}
        ]
      };
    }
    if(tab==='rr'){
      return {
        title:'R/R',
        lines:[
          {k:'Gross', v: rrGross.textContent},
          {k:'Net', v: rrNet.textContent}
        ]
      };
    }
    if(tab==='cap'){
      return {
        title:'Capital',
        lines:[
          {k:'POS', v: capPos.textContent},
          {k:'Risk $', v: capRiskUsd.textContent},
          {k:'Margin $', v: capMargin.textContent}
        ]
      };
    }
    return {title:'Trader', lines:[{k:'‚Äî',v:'‚Äî'}]};
  }

  async function canvasToBlob(){
    return await new Promise(resolve=>cardCanvas.toBlob(resolve,'image/png'));
  }

  async function tryCopyImage(){
    try{
      const blob = await canvasToBlob();
      if(!blob) throw new Error('no blob');
      if(!navigator.clipboard || !window.ClipboardItem) throw new Error('no clipboard api');
      await navigator.clipboard.write([new ClipboardItem({[blob.type]: blob})]);
      return true;
    }catch(e){ return false; }
  }

  async function downloadPng(){
    const blob = await canvasToBlob();
    if(!blob) return;
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download='trade-card.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast(t('toast.saved'));
    haptic('notify','success');
  }

  async function exportCardPNG({fromHistory=false, historyItem=null}){
    const data=buildCardData({fromHistory, historyItem});
    drawCard(data);
    openModal();
  }

  btnDownload.addEventListener('click', downloadPng);
  btnCopyImg.addEventListener('click', async ()=>{
    const ok = await tryCopyImage();
    if(ok){
      showToast(t('toast.copied'));
      haptic('notify','success');
    }else{
      // fallback to download
      await downloadPng();
    }
  });

  document.getElementById('card_btn').addEventListener('click', ()=>{ exportCardPNG({fromHistory:false}); });

  /* ---------- TON Connect (TON-only wallet via TON Connect SDK) ---------- */
  // 1) Create https://YOUR_DOMAIN/tonconnect-manifest.json (see manifest template below).
  // 2) Put the manifest URL here:
  const TONCONNECT_MANIFEST_URL = 'https://YOUR_DOMAIN/tonconnect-manifest.json';
  // Optional: TON tip settings (set your TON address)
  const TIP_ADDRESS = 'REPLACE_WITH_YOUR_TON_ADDRESS';
  const TIP_AMOUNT_TON = 0.05;

  let tonConnectUI = null;

  function shortAddr(addr){
    if(!addr) return '';
    return addr.length > 12 ? (addr.slice(0,4) + '‚Ä¶' + addr.slice(-4)) : addr;
  }

  function toNanoStr(ton){
    const v = Number(ton);
    if(!isFinite(v) || v <= 0) return '0';
    return String(Math.floor(v * 1e9));
  }

  async function confirmDialog(text){
    try{
      if(tg?.showConfirm){
        return await new Promise(resolve => tg.showConfirm(text, ok => resolve(!!ok)));
      }
    }catch(e){}
    return window.confirm(text);
  }

  function updateWalletUI(){
    const wBtn = document.getElementById('wallet_btn');
    const tipBtn = document.getElementById('tip_btn');
    if(!wBtn || !tipBtn) return;

    const lbl = wBtn.querySelector('.lbl');
    if(!tonConnectUI){
      wBtn.disabled = true;
      tipBtn.disabled = true;
      if(lbl) lbl.textContent = t('wallet');
      return;
    }
    wBtn.disabled = false;

    if(tonConnectUI.connected){
      const addr = tonConnectUI.account?.address || '';
      if(lbl) lbl.textContent = shortAddr(addr) || t('wallet');
      tipBtn.disabled = false;
    }else{
      if(lbl) lbl.textContent = t('wallet');
      tipBtn.disabled = true;
    }
  }

  function initTonConnect(){
    try{
      if(TONCONNECT_MANIFEST_URL.includes('YOUR_DOMAIN')){
        tonConnectUI = null;
        updateWalletUI();
        return;
      }
      if(!window.TON_CONNECT_UI?.TonConnectUI) return;
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({
        manifestUrl: TONCONNECT_MANIFEST_URL
      });

      // React to connect/disconnect
      tonConnectUI.onStatusChange(() => {
        updateWalletUI();
        haptic('notify','success');
      });

      // Restore previous session if any
      tonConnectUI.connectionRestored?.then(() => updateWalletUI()).catch(() => {});
      updateWalletUI();
    }catch(e){
      tonConnectUI = null;
      updateWalletUI();
    }
  }

  document.getElementById('wallet_btn')?.addEventListener('click', async ()=>{
    if(!tonConnectUI){
      showToast(t('toast.tonManifest'));
      return;
    }
    try{
      if(tonConnectUI.connected){
        const ok = await confirmDialog(t('wallet.disconnectQ'));
        if(ok){
          await tonConnectUI.disconnect();
          updateWalletUI();
          showToast(t('toast.saved'));
        }
      }else{
        await tonConnectUI.openModal();
        // UI will update via onStatusChange
      }
    }catch(e){
      // some abort errors are uncaught by sdk on certain wallets; keep UI stable
      updateWalletUI();
    }
  });

  document.getElementById('tip_btn')?.addEventListener('click', async ()=>{
    if(!tonConnectUI?.connected){
      showToast(t('toast.walletNeed'));
      haptic('notify','warning');
      return;
    }
    if(!TIP_ADDRESS || TIP_ADDRESS.startsWith('REPLACE_')){
      showToast('Set TIP_ADDRESS');
      return;
    }
    try{
      const tx = {
        validUntil: Math.floor(Date.now()/1000) + 600,
        messages: [{ address: TIP_ADDRESS, amount: toNanoStr(TIP_AMOUNT_TON) }]
      };
      await tonConnectUI.sendTransaction(tx);
      showToast(t('toast.sent'));
      haptic('notify','success');
    }catch(e){
      showToast(t('toast.fail'));
      haptic('notify','error');
    }
  });

  initTonConnect();


  /* ---------- Share text (clipboard / share sheet) ---------- */
  document.getElementById('share_btn').addEventListener('click', async ()=>{
    const tab=activeTab();
    let text='üìä Trader Calculator\n';
    if(tab==='dca'){
      text += `DCA AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}\n`;
      if(dcaNeedVol.textContent.trim()!=='‚Äî') text += `\nüéØ Goal\nNeed: ${dcaNeedVol.textContent}`;
    }
    if(tab==='rr'){
      text += `Gross: ${rrGross.textContent}\nNet: ${rrNet.textContent}\n`;
    }
    if(tab==='cap'){
      text += `POS: ${capPos.textContent}\nRisk$: ${capRiskUsd.textContent}\nMargin$: ${capMargin.textContent}\n`;
    }

    // try share sheet in Telegram / Web
    try{
      if(navigator.share){
        await navigator.share({text});
        return;
      }
    }catch(e){}

    const ok = await copyText(text);
    if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
  });

  /* ---------- init ---------- */
  function refreshAll(){
    // ensure labels in dynamic DCA rows match language (simple update)
    dcaRows.forEach(r=>{
      const labels=r.el.querySelectorAll('label');
      if(labels[0]) labels[0].textContent = (lang==='ru'?'–¶–µ–Ω–∞':'Price');
      if(labels[1]) labels[1].textContent = (lang==='ru'?'–û–±—ä—ë–º':'Volume');
    });
    calcDCA();
    calcRR();
    calcCap();
    drawAllIndicatorVisuals(lastIndicators);
  }

  // initial content
  translateAll();
  clearDCA(); // creates 2 rows
  calcRR(); calcCap();
  renderHistory();

  // gentle first refresh after render
  setTimeout(()=>{ try{ refreshAll(); }catch(e){} }, 60);

  // auto refresh indicators when opening Indicators tab first time
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='visible'){
      // optional: refresh cached visuals
      drawAllIndicatorVisuals(lastIndicators);
    }
  });

  window.refreshAll = refreshAll; // for safety
  window.addEventListener('resize', ()=>{ drawAllIndicatorVisuals(lastIndicators); });

  // If opened directly in browser, you can still use app.
  // In Telegram, keep stable layout
  try{
    tg?.onEvent?.('viewportChanged', ()=>{
      // prevent layout jumps
      setTimeout(()=>drawAllIndicatorVisuals(lastIndicators), 150);
    });
  }catch(e){}
})();
</script>
</body>
</html>
