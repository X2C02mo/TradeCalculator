<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#fff;
  --muted:#9a9a9a;
  --accent:#7CFC00; /* neon green accent */
  --danger:#ff5c5c;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
#app{min-height:100vh;display:flex;flex-direction:column}

/* header */
header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
.tabs{display:flex;gap:12px;align-items:center}
.tab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:4px}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
.lang{display:flex;gap:6px;align-items:center}
.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer;border-radius:4px}
.lang button.active{color:var(--accent);border-color:var(--accent)}

/* main */
main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}
.card{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;max-width:720px}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:10px;background:#070707;border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:14px}
.result{margin-top:8px;padding:10px;border-radius:6px;background:#060606;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{background:transparent;color:var(--accent);border:1px solid #2b2b2b;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600}
.btn.ghost{color:var(--muted);border-color:var(--border)}
.btn.danger{color:var(--danger);border-color:rgba(255,92,92,0.12)}
.small{padding:6px 8px;font-size:13px}

/* history panel */
.history {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  max-width:420px;
}
.history h4{margin:0 0 8px 0;color:var(--muted);font-size:13px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto}
.history-item{padding:8px;border-radius:6px;background:#050505;border:1px solid rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.meta{font-size:12px;color:var(--muted)}

/* footer */
footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px}
.tags{font-size:12px;color:var(--muted)}
.links{display:flex;gap:18px}
.rainbow{font-weight:700;text-decoration:none;background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);background-size:400% 400%;-webkit-background-clip:text;color:transparent;animation:rain 3.5s linear infinite}

/* tiny */
.note{font-size:12px;color:var(--muted);margin-top:6px}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
@media(min-width:900px){main{flex-direction:row}}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
    </div>
    <div class="lang">
      <button id="btn_ru" class="active">RU</button>
      <button id="btn_en">EN</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1">
      <!-- DCA -->
      <section id="dca" class="screen active">
        <div class="card">
          <div class="field"><label data-i18n="dca.p1">Цена 1</label><input id="dca_p1" type="number" step="any" /></div>
          <div class="field"><label data-i18n="dca.v1">Объём 1</label><input id="dca_v1" type="number" step="any" /></div>
          <div class="field"><label data-i18n="dca.p2">Цена 2</label><input id="dca_p2" type="number" step="any" /></div>
          <div class="field"><label data-i18n="dca.v2">Объём 2</label><input id="dca_v2" type="number" step="any" /></div>
          <div class="result" id="dca_result" data-i18n="dca.result">Средняя цена: —</div>
          <div class="controls">
            <button class="btn small" id="dca_copy" data-i18n="btn.copy">Copy</button>
            <button class="btn small ghost" id="dca_save" data-i18n="btn.save">Save</button>
            <button class="btn small ghost" id="dca_share" data-i18n="btn.share">Share</button>
          </div>
          <div class="note" id="dca_note"></div>
        </div>
      </section>

      <!-- R/R -->
      <section id="rr" class="screen">
        <div class="card">
          <div class="field"><label data-i18n="rr.entry">Entry</label><input id="rr_entry" type="number" step="any" /></div>
          <div class="field"><label data-i18n="rr.sl">Stop Loss</label><input id="rr_sl" type="number" step="any" /></div>
          <div class="field"><label data-i18n="rr.tp">Take Profit</label><input id="rr_tp" type="number" step="any" /></div>
          <div class="result" id="rr_result" data-i18n="rr.result">R/R: —</div>
          <div class="controls">
            <button class="btn small" id="rr_copy" data-i18n="btn.copy">Copy</button>
            <button class="btn small ghost" id="rr_save" data-i18n="btn.save">Save</button>
            <button class="btn small ghost" id="rr_share" data-i18n="btn.share">Share</button>
          </div>
          <div class="note" id="rr_note"></div>
        </div>
      </section>

      <!-- Capital -->
      <section id="cap" class="screen">
        <div class="card">
          <div class="field"><label data-i18n="cap.dep">Депозит</label><input id="cap_dep" type="number" step="any" /></div>
          <div class="field">
            <label data-i18n="cap.risk">Риск %</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="cap_risk" type="number" step="any" style="flex:1" />
              <div style="display:flex;gap:6px">
                <button class="btn small ghost" data-risk="0.5">0.5%</button>
                <button class="btn small ghost" data-risk="1">1%</button>
                <button class="btn small ghost" data-risk="2">2%</button>
                <button class="btn small ghost" data-risk="5">5%</button>
              </div>
            </div>
          </div>
          <div class="field"><label data-i18n="cap.entry">Entry</label><input id="cap_entry" type="number" step="any" /></div>
          <div class="field"><label data-i18n="cap.sl">Stop Loss</label><input id="cap_sl" type="number" step="any" /></div>
          <div class="result" id="cap_result" data-i18n="cap.result">Объём: —</div>
          <div class="controls">
            <button class="btn small" id="cap_copy" data-i18n="btn.copy">Copy</button>
            <button class="btn small ghost" id="cap_save" data-i18n="btn.save">Save</button>
            <button class="btn small ghost" id="cap_share" data-i18n="btn.share">Share</button>
          </div>
          <div class="note" id="cap_note"></div>
        </div>
      </section>
    </div>

    <!-- right side: history -->
    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn small ghost" id="clear_history" data-i18n="hist.clear">Clear</button>
        <button class="btn small" id="export_history" data-i18n="hist.export">Export</button>
      </div>
      <div class="note" style="margin-top:8px" data-i18n="hist.note">Saved calculations are stored locally in your browser.</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">АИРДРОП · НОВОСТИ · ТРЕЙДИНГ</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<script>
/* Safe Telegram WebApp init */
const tg = window.Telegram?.WebApp || null;
try{ tg && tg.expand && tg.expand(); }catch(e){}

/* locales */
const locales = {
  ru:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital",
    "dca.p1":"Цена 1","dca.v1":"Объём 1","dca.p2":"Цена 2","dca.v2":"Объём 2","dca.result":"Средняя цена",
    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.result":"R/R",
    "cap.dep":"Депозит","cap.risk":"Риск %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.result":"Объём",
    "btn.copy":"Скопировать","btn.save":"Сохранить","btn.share":"Поделиться",
    "hist.title":"История","hist.clear":"Очистить","hist.export":"Экспорт","hist.note":"Сохранено локально в браузере",
    "footer.tags":"АИРДРОП · НОВОСТИ · ТРЕЙДИНГ"
  },
  en:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital",
    "dca.p1":"Price 1","dca.v1":"Volume 1","dca.p2":"Price 2","dca.v2":"Volume 2","dca.result":"Average price",
    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.result":"R/R",
    "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.result":"Position size",
    "btn.copy":"Copy","btn.save":"Save","btn.share":"Share",
    "hist.title":"History","hist.clear":"Clear","hist.export":"Export","hist.note":"Saved locally in your browser",
    "footer.tags":"AIRDROP · NEWS · TRADING"
  }
};

/* language detection: prefer Telegram user language */
let lang = 'en';
try{
  const tgLang = tg?.initDataUnsafe?.user?.language_code;
  if (tgLang) lang = /^ru|uk|be/i.test(tgLang) ? 'ru' : 'en';
  else lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
}catch(e){ lang='en' }

/* translate all labelled elements */
function translateAll(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (locales[lang] && locales[lang][key] !== undefined) el.textContent = locales[lang][key];
  });
  // update dynamic results display labels if need
  updateDCAResultLabel(); updateRRResultLabel(); updateCapResultLabel();
}

/* Tabs switching */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    const target = btn.dataset.tab;
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const scr = document.getElementById(target);
    if (scr) scr.classList.add('active');
  });
});

/* Language buttons */
const btn_ru = document.getElementById('btn_ru');
const btn_en = document.getElementById('btn_en');
btn_ru.addEventListener('click', ()=>{ lang='ru'; btn_ru.classList.add('active'); btn_en.classList.remove('active'); translateAll(); });
btn_en.addEventListener('click', ()=>{ lang='en'; btn_en.classList.add('active'); btn_ru.classList.remove('active'); translateAll(); });

/* Utility: clipboard */
async function copyText(txt, feedbackEl){
  try{
    await navigator.clipboard.writeText(txt);
    if (feedbackEl) feedbackEl.textContent = (lang==='ru'?'Скопировано':'Copied');
    setTimeout(()=>{ if(feedbackEl) feedbackEl.textContent=''; }, 1500);
  }catch(e){
    if (feedbackEl) feedbackEl.textContent = (lang==='ru'?'Не удалось скопировать':'Copy failed');
    setTimeout(()=>{ if(feedbackEl) feedbackEl.textContent=''; }, 1500);
  }
}

/* History: localStorage */
const HISTORY_KEY = 'trader_calc_history_v1';
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }catch(e){ return []; } }
function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }

function pushHistory(item){
  const arr = loadHistory();
  arr.unshift(item);
  if (arr.length>50) arr.pop();
  saveHistory(arr);
}

function renderHistory(){
  const list = document.getElementById('history_list');
  list.innerHTML = '';
  const arr = loadHistory();
  if (!arr.length){
    const el = document.createElement('div'); el.className='meta'; el.textContent = locales[lang]['hist.note']; list.appendChild(el); return;
  }
  arr.forEach((it, idx)=>{
    const node = document.createElement('div'); node.className='history-item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:600">${it.type} · ${new Date(it.t).toLocaleString()}</div><div class="meta">${it.summary}</div>`;
    const right = document.createElement('div');
    const btnSend = document.createElement('button'); btnSend.className='btn small ghost'; btnSend.textContent = locales[lang]['btn.share']; btnSend.onclick = ()=>sharePayload(it.payload);
    const btnCopy = document.createElement('button'); btnCopy.className='btn small'; btnCopy.textContent = locales[lang]['btn.copy']; btnCopy.onclick = ()=>copyText(JSON.stringify(it.payload), null);
    right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='6px';
    right.appendChild(btnSend); right.appendChild(btnCopy);
    node.appendChild(left); node.appendChild(right);
    list.appendChild(node);
  });
}

/* Export & Clear */
document.getElementById('clear_history').addEventListener('click', ()=>{
  localStorage.removeItem(HISTORY_KEY); renderHistory();
});
document.getElementById('export_history').addEventListener('click', ()=>{
  const data = JSON.stringify(loadHistory(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'trader_history.json'; a.click(); URL.revokeObjectURL(url);
});

/* --- DCA logic --- */
const dca_p1 = document.getElementById('dca_p1'), dca_v1 = document.getElementById('dca_v1'),
      dca_p2 = document.getElementById('dca_p2'), dca_v2 = document.getElementById('dca_v2'),
      dca_result = document.getElementById('dca_result'),
      dca_copy = document.getElementById('dca_copy'), dca_save = document.getElementById('dca_save'), dca_share = document.getElementById('dca_share'),
      dca_note = document.getElementById('dca_note');

function updateDCAResultLabel(){ if (dca_result._last !== undefined) dca_result.textContent = locales[lang]['dca.result']+': '+dca_result._last; else dca_result.textContent = locales[lang]['dca.result']+': —'; }
function calcDCA(){
  const p1 = parseFloat(dca_p1.value) || 0, v1 = parseFloat(dca_v1.value) || 0,
        p2 = parseFloat(dca_p2.value) || 0, v2 = parseFloat(dca_v2.value) || 0;
  const vol = v1+v2;
  if (vol <= 0){ delete dca_result._last; updateDCAResultLabel(); dca_note.textContent=''; return; }
  const avg = ((p1*v1)+(p2*v2))/vol;
  dca_result._last = avg.toFixed(8);
  updateDCAResultLabel();
  dca_note.textContent = '';
}
[dca_p1,dca_v1,dca_p2,dca_v2].forEach(i=>i.addEventListener('input', calcDCA));
dca_copy.addEventListener('click', ()=>{ copyText(dca_result._last || '', dca_note); });
dca_save.addEventListener('click', ()=>{
  if (!dca_result._last){ dca_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  const payload = {type:'DCA', payload:{p1:dca_p1.value,v1:dca_v1.value,p2:dca_p2.value,v2:dca_v2.value,avg:dca_result._last}, t:Date.now(), summary:`avg ${dca_result._last}`};
  pushHistory(payload); dca_note.textContent = (lang==='ru'?'Сохранено':'Saved');
});
dca_share.addEventListener('click', ()=>{
  if (!dca_result._last){ dca_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  const data = {action:'share', type:'DCA', p1:dca_p1.value,v1:dca_v1.value,p2:dca_p2.value,v2:dca_v2.value,avg:dca_result._last};
  sharePayload(data);
});

/* --- R/R logic --- */
const rr_entry = document.getElementById('rr_entry'), rr_sl = document.getElementById('rr_sl'), rr_tp = document.getElementById('rr_tp'), rr_result = document.getElementById('rr_result'),
      rr_copy = document.getElementById('rr_copy'), rr_save = document.getElementById('rr_save'), rr_share = document.getElementById('rr_share'), rr_note = document.getElementById('rr_note');

function updateRRResultLabel(){ if (rr_result._last !== undefined) rr_result.textContent = locales[lang]['rr.result']+': '+rr_result._last; else rr_result.textContent = locales[lang]['rr.result']+': —'; }
function calcRR(){
  const e = parseFloat(rr_entry.value), sl = parseFloat(rr_sl.value), tp = parseFloat(rr_tp.value);
  if (!isFinite(e) || !isFinite(sl) || !isFinite(tp) || e === sl){ delete rr_result._last; updateRRResultLabel(); rr_note.textContent=''; return; }
  const risk = Math.abs(e - sl), reward = Math.abs(tp - e);
  if (risk === 0){ delete rr_result._last; updateRRResultLabel(); rr_note.textContent=''; return; }
  const ratio = (reward / risk).toFixed(2);
  rr_result._last = '1:'+ratio;
  updateRRResultLabel();
  rr_note.textContent = '';
}
[rr_entry,rr_sl,rr_tp].forEach(i=>i.addEventListener('input', calcRR));
rr_copy.addEventListener('click', ()=>{ copyText(rr_result._last || '', rr_note); });
rr_save.addEventListener('click', ()=>{
  if (!rr_result._last){ rr_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  const payload = {type:'RR', payload:{entry:rr_entry.value,sl:rr_sl.value,tp:rr_tp.value,rr:rr_result._last}, t:Date.now(), summary:`${rr_result._last}`};
  pushHistory(payload); rr_note.textContent = (lang==='ru'?'Сохранено':'Saved');
});
rr_share.addEventListener('click', ()=>{
  if (!rr_result._last){ rr_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  sharePayload({action:'share', type:'RR', entry:rr_entry.value,sl:rr_sl.value,tp:rr_tp.value,rr:rr_result._last});
});

/* --- Capital logic --- */
const cap_dep = document.getElementById('cap_dep'), cap_risk = document.getElementById('cap_risk'), cap_entry = document.getElementById('cap_entry'), cap_sl = document.getElementById('cap_sl'), cap_result = document.getElementById('cap_result'),
      cap_copy = document.getElementById('cap_copy'), cap_save = document.getElementById('cap_save'), cap_share = document.getElementById('cap_share'), cap_note = document.getElementById('cap_note');

function updateCapResultLabel(){ if (cap_result._last !== undefined) cap_result.textContent = locales[lang]['cap.result']+': '+cap_result._last; else cap_result.textContent = locales[lang]['cap.result']+': —'; }
function calcCap(){
  const dep = parseFloat(cap_dep.value), riskP = parseFloat(cap_risk.value), e = parseFloat(cap_entry.value), sl = parseFloat(cap_sl.value);
  if (!isFinite(dep) || !isFinite(riskP) || !isFinite(e) || !isFinite(sl) || e === sl){ delete cap_result._last; updateCapResultLabel(); cap_note.textContent=''; return; }
  const riskUsd = dep * (riskP/100);
  if (Math.abs(e - sl) === 0){ delete cap_result._last; updateCapResultLabel(); cap_note.textContent=''; return; }
  const size = (riskUsd / Math.abs(e - sl)).toFixed(8);
  cap_result._last = size;
  updateCapResultLabel();
  cap_note.textContent = '';
}
[cap_dep,cap_risk,cap_entry,cap_sl].forEach(i=>i.addEventListener('input', calcCap));
/* risk preset buttons */
document.querySelectorAll('[data-risk]').forEach(b=>{
  b.addEventListener('click', ()=>{ cap_risk.value = b.getAttribute('data-risk'); calcCap(); });
});
cap_copy.addEventListener('click', ()=>{ copyText(cap_result._last || '', cap_note); });
cap_save.addEventListener('click', ()=>{
  if (!cap_result._last){ cap_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  const payload = {type:'CAP', payload:{dep:cap_dep.value,risk:cap_risk.value,entry:cap_entry.value,sl:cap_sl.value,size:cap_result._last}, t:Date.now(), summary:`size ${cap_result._last}`};
  pushHistory(payload); cap_note.textContent = (lang==='ru'?'Сохранено':'Saved');
});
cap_share.addEventListener('click', ()=>{
  if (!cap_result._last){ cap_note.textContent = (lang==='ru'?'Нет результата':'No result'); return; }
  sharePayload({action:'share', type:'CAP', dep:cap_dep.value,risk:cap_risk.value,entry:cap_entry.value,sl:cap_sl.value,size:cap_result._last});
});

/* share payload: prefer tg.sendData, fallback copy */
function sharePayload(obj){
  const payload = JSON.stringify(obj);
  try{
    if (tg && tg.sendData){
      tg.sendData(payload); // bot receives in updates via WebApp
      // show small toast via alert fallback
      alert(lang==='ru'?'Отправлено боту':'Sent to bot');
      return;
    }
  }catch(e){}
  // fallback - copy to clipboard for manual sharing
  copyText(payload, null);
  alert(lang==='ru'?'Данные скопированы. Вставьте в чат с ботом':'Data copied. Paste into chat with bot');
}

/* initial render */
translateAll();
renderHistory();

/* ensure translated tab labels */
document.querySelectorAll('.tab').forEach(t=>{
  const key = t.getAttribute('data-i18n');
  if (key && locales[lang][key]) t.textContent = locales[lang][key];
});

/* wire history item actions created earlier in renderHistory: expose share helper for nodes */
function shareHistoryByIndex(i){
  const arr = loadHistory();
  if (arr[i]) sharePayload(arr[i].payload || arr[i]);
}

/* links handling */
function openUrl(url){
  try{
    if (tg?.openLink) return tg.openLink(url);
    if (tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
  }catch(e){}
  window.open(url, '_blank');
}
document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

/* defensive: re-render history on storage changes (may be in another tab) */
window.addEventListener('storage', ()=>renderHistory());

</script>
</body>
</html>
