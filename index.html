<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator + Indicators</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  /* dark */
  --bg:#000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#fff;
  --muted:#9a9a9a;
  --accent:#7CFC00;
  --danger:#ff4d4f;

  --input-bg:#070707;
  --result-bg:#060606;
  --chip-bg:#0a0a0a;
}

:root[data-theme="light"]{
  --bg:#ffffff;
  --panel:#f6f6f6;
  --border:#e6e6e6;
  --text:#111111;
  --muted:#666666;
  --accent:#0bbf5e;
  --danger:#d9363e;

  --input-bg:#ffffff;
  --result-bg:#ffffff;
  --chip-bg:#f1f1f1;
}

*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
body{padding-bottom:env(safe-area-inset-bottom); padding-top:env(safe-area-inset-top)}
#app{min-height:100vh;display:flex;flex-direction:column}

/* header */
header{
  position:sticky; top:0; z-index:10;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:var(--bg);
}
.leftbar{display:flex;gap:8px;align-items:center}
.lang{display:flex;gap:6px;align-items:center}
.lang button{
  background:none;border:1px solid var(--border);color:var(--muted);
  padding:4px 8px;cursor:pointer;border-radius:8px
}
.lang button.active{color:var(--accent);border-color:var(--accent)}

.iconbtn{
  background:none;border:1px solid var(--border);color:var(--muted);
  padding:6px 10px;cursor:pointer;border-radius:10px;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
}
.iconbtn:active{transform:translateY(1px)}
.iconbtn .ico{font-size:14px;line-height:1}
.iconbtn.active{border-color:var(--accent);color:var(--accent)}

.tabs{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  margin-left:auto;
}
.tab{
  background:none;border:none;color:var(--muted);
  font-size:13px;padding:6px 10px;cursor:pointer;border-radius:8px
}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}

main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}

.card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:12px;max-width:820px
}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{
  width:100%;padding:10px;background:var(--input-bg);
  border:1px solid var(--border);color:var(--text);
  border-radius:10px;font-size:14px;outline:none
}
input:focus{border-color:color-mix(in oklab, var(--accent) 45%, var(--border))}

.row{
  display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;
  padding:10px; border:1px solid var(--border); border-radius:12px;
  background:color-mix(in oklab, var(--panel) 75%, var(--bg));
}
.row .col{flex:1; min-width:130px}
.row .mini{
  width:40px; height:40px; display:flex; align-items:center; justify-content:center;
  border-radius:12px; border:1px solid var(--border);
  background:var(--chip-bg); cursor:pointer; color:var(--muted);
}
.row .mini:hover{border-color:color-mix(in oklab, var(--accent) 25%, var(--border))}
.row .mini:active{transform:translateY(1px)}

.result{
  margin-top:8px;padding:10px;border-radius:12px;
  background:var(--result-bg);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:10px
}
.res-left{display:flex;flex-direction:column;gap:3px}
.res-label{color:var(--muted);font-size:12px}
.res-value{font-weight:900;font-size:14px}
.res-value.muted{color:var(--muted);font-weight:700}
.res-value.danger{color:var(--danger)}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  background:transparent;color:var(--accent);
  border:1px solid #2b2b2b;padding:8px 10px;border-radius:12px;
  cursor:pointer;font-weight:800
}
:root[data-theme="light"] .btn{border-color:var(--border)}
.btn:active{transform:translateY(1px)}
.btn.ghost{color:var(--muted);border-color:var(--border)}
.btn.small{padding:6px 10px;border-radius:999px;font-weight:900}

.note{font-size:12px;color:var(--muted);line-height:1.35}
.small{font-size:11px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--border);
  background:var(--chip-bg);
  padding:6px 10px;border-radius:999px;
  color:var(--muted);font-size:12px
}
.hr{height:1px;background:var(--border);margin:12px 0}

/* right panel */
.history{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;max-width:420px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}

/* footer */
footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px}
.links{display:flex;gap:18px;margin-top:2px}
.rainbow{
  display:inline-block;font-weight:900;text-decoration:none;
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;color:transparent;
  animation:rain 3.5s linear infinite
}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}

@media(min-width:900px){main{flex-direction:row}}
</style>
</head>

<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru" class="active">RU</button>
        <button id="btn_en">EN</button>
      </div>

      <button class="iconbtn" id="theme_toggle" aria-label="Theme" title="Theme">
        <span class="ico" id="theme_icon">üåô</span>
        <span class="small" id="theme_text" data-i18n="theme.dark">Dark</span>
      </button>

      <button class="iconbtn" id="share_btn" aria-label="Share" title="Share">
        <span class="ico">üìã</span>
        <span class="small" data-i18n="share">Share</span>
      </button>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1">
      <!-- DCA -->
      <section id="dca" class="screen active">
        <div class="card">
          <div class="note" data-i18n="dca.tip">
            –°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.
          </div>

          <div style="height:10px"></div>
          <div id="dca_rows"></div>

          <div class="controls">
            <button class="btn" id="dca_add" data-i18n="dca.add">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥</button>
            <button class="btn ghost" id="dca_clear" data-i18n="common.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div class="result">
            <div class="res-left">
              <span class="res-label" data-i18n="dca.avg">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</span>
              <span class="res-value muted" id="dca_avg">‚Äî</span>
            </div>
            <button class="btn small ghost" id="dca_copy" data-i18n="common.copy">Copy</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.totalVol">–û–±—â–∏–π –æ–±—ä—ë–º</span>: <b id="dca_totalVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.totalCost">–°—É–º–º–∞</span>: <b id="dca_totalCost">‚Äî</b></span>
          </div>

          <div class="small" id="dca_hint" style="margin-top:8px"></div>

          <div class="hr"></div>

          <!-- DCA GOAL / Target average -->
          <h4 style="margin:0 0 8px 0" data-i18n="dca.goal.title">DCA Goal: Target Average</h4>
          <div class="note" data-i18n="dca.goal.note">
            –£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞: –ø–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="col">
              <label data-i18n="dca.goal.price">–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)</label>
              <input id="dca_goal_price" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="dca.goal.avg">–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)</label>
              <input id="dca_goal_avg" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col" style="min-width:160px">
              <label data-i18n="dca.goal.fee">–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %</label>
              <input id="dca_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.goal.needVol">–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å</span>: <b id="dca_needVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.needCost">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>: <b id="dca_needCost">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.status">–°—Ç–∞—Ç—É—Å</span>: <b id="dca_goalStatus">‚Äî</b></span>
          </div>

          <div class="small" id="dca_goal_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- R/R -->
      <section id="rr" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="rr.entry">Entry</label>
              <input id="rr_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.sl">Stop Loss</label>
              <input id="rr_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.tp">Take Profit</label>
              <input id="rr_tp" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="rr.fee">–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)</label>
              <input id="rr_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col" style="min-width:240px">
              <div class="note" data-i18n="rr.feeNote">
                –ü–æ–∫–∞–∂–µ—Ç net R/R: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞—Å—á—ë—Ç–µ.
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="rr_clear" data-i18n="common.clear">Clear</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="rr.gross">Gross R/R</span>: <b id="rr_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="rr.net">Net R/R (fees)</span>: <b id="rr_net">‚Äî</b></span>
          </div>

          <div class="small" id="rr_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Capital -->
      <section id="cap" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="cap.dep">–î–µ–ø–æ–∑–∏—Ç</label>
              <input id="cap_dep" type="number" inputmode="decimal" step="any" min="0" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.risk">–†–∏—Å–∫ %</label>
              <input id="cap_risk" type="number" inputmode="decimal" step="any" min="0" max="100" placeholder="1">
            </div>
            <div class="col">
              <label data-i18n="cap.entry">Entry</label>
              <input id="cap_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="cap.sl">Stop Loss</label>
              <input id="cap_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="cap.fee">–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)</label>
              <input id="cap_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.lev">–ü–ª–µ—á–æ (–¥–ª—è –º–∞—Ä–∂–∏)</label>
              <input id="cap_lev" type="number" inputmode="decimal" step="any" min="1" max="200" placeholder="1">
            </div>
            <div class="col" style="min-width:260px">
              <label data-i18n="cap.presets">–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏</label>
              <div class="controls" style="margin-top:0">
                <button class="btn small ghost cap_preset" data-v="0.5">0.5%</button>
                <button class="btn small ghost cap_preset" data-v="1">1%</button>
                <button class="btn small ghost cap_preset" data-v="2">2%</button>
                <button class="btn small ghost cap_preset" data-v="3">3%</button>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="cap_clear" data-i18n="common.clear">Clear</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="cap.pos">Position size</span>: <b id="cap_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.riskUsd">Risk $</span>: <b id="cap_riskUsd">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.margin">Margin (lev)</span>: <b id="cap_margin">‚Äî</b></span>
          </div>

          <div class="small" id="cap_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Indicators -->
      <section id="ind" class="screen">
        <div class="card">
          <h3 style="margin:0 0 10px 0" data-i18n="ind.title">Indicators</h3>

          <div class="field">
            <label data-i18n="ind.fg.label">Fear &amp; Greed</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.fg.valueLabel">Value</span>
                <span class="res-value muted" id="fg_value">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.tcap.label">Total Market Cap (USD)</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.tcap.valueLabel">USD</span>
                <span class="res-value muted" id="tcap">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.alt.label">Alt dominance (proxy Altseason)</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.alt.valueLabel">Alt %</span>
                <span class="res-value muted" id="alt_dom">‚Äî</span>
              </div>
            </div>
          </div>

          <!-- Unique: Market Mood -->
          <div class="field">
            <label data-i18n="ind.mood.label">Market Mood</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.mood.hint">Derived from F&G + Alt dom</span>
                <span class="res-value muted" id="mood_value">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="controls" style="margin-top:8px">
            <button class="btn" id="refresh_ind" data-i18n="ind.refresh">Refresh</button>
          </div>

          <div class="note" id="ind_note"></div>
        </div>
      </section>
    </div>

    <!-- History -->
    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>

      <div class="controls" style="margin-top:8px">
        <button class="btn ghost" id="clear_history" data-i18n="hist.clear">Clear</button>
        <button class="btn" id="export_history" data-i18n="hist.export">Export</button>
      </div>

      <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<script>
/* Telegram init */
const tg = window.Telegram?.WebApp || null;
try{ tg?.expand?.(); }catch(e){}

/* i18n */
const locales = {
  ru:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "theme.dark":"–¢—ë–º–Ω–∞—è","theme.light":"–°–≤–µ—Ç–ª–∞—è",
    "share":"–®–µ—Ä",
    "common.clear":"–û—á–∏—Å—Ç–∏—Ç—å","common.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å","common.copied":"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ",

    "dca.tip":"–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.",
    "dca.add":"+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥",
    "dca.row.price":"–¶–µ–Ω–∞","dca.row.vol":"–û–±—ä—ë–º",
    "dca.avg":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.totalVol":"–û–±—â–∏–π –æ–±—ä—ë–º","dca.totalCost":"–°—É–º–º–∞",
    "dca.hint.empty":"–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π –≤—Ö–æ–¥ (—Ü–µ–Ω–∞ + –æ–±—ä—ë–º > 0).",
    "dca.hint.partial":"–ß–∞—Å—Ç—å —Å—Ç—Ä–æ–∫ –Ω–µ —É—á—Ç–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å —Ü–µ–Ω—É/–æ–±—ä—ë–º).",
    "dca.goal.title":"DCA Goal: Target Average",
    "dca.goal.note":"–£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Ñ–∏—á–∞: –ø–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.",
    "dca.goal.price":"–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)",
    "dca.goal.avg":"–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)",
    "dca.goal.fee":"–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %",
    "dca.goal.needVol":"–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å",
    "dca.goal.needCost":"–°—Ç–æ–∏–º–æ—Å—Ç—å",
    "dca.goal.status":"–°—Ç–∞—Ç—É—Å",
    "dca.goal.status.na":"‚Äî",
    "dca.goal.status.ok":"–í–æ–∑–º–æ–∂–Ω–æ",
    "dca.goal.status.already":"–£–∂–µ –Ω–∞ —Ü–µ–ª–∏",
    "dca.goal.status.impossible":"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ —ç—Ç–æ–π —Ü–µ–Ω–µ",
    "dca.goal.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ X –∏ Y, –∏ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—Ö–æ–¥ –≤—ã—à–µ.",
    "dca.goal.hint.math":"–ï—Å–ª–∏ X = Y ‚Äî –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å, –ø–æ–º–µ–Ω—è–π –∑–Ω–∞—á–µ–Ω–∏—è.",

    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
    "rr.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)",
    "rr.feeNote":"–ü–æ–∫–∞–∂–µ—Ç net R/R: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é –≤ —Ä–∞—Å—á—ë—Ç–µ.",
    "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
    "rr.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è",
    "rr.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

    "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
    "cap.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)",
    "cap.lev":"–ü–ª–µ—á–æ (–¥–ª—è –º–∞—Ä–∂–∏)",
    "cap.presets":"–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏",
    "cap.pos":"–û–±—ä—ë–º –ø–æ–∑–∏—Ü–∏–∏",
    "cap.riskUsd":"–†–∏—Å–∫ $",
    "cap.margin":"–ú–∞—Ä–∂–∞ (–ø–ª–µ—á–æ)",
    "cap.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è",
    "cap.hint.invalid":"–ü—Ä–æ–≤–µ—Ä—å –∑–Ω–∞—á–µ–Ω–∏—è",
    "cap.hint.riskRange":"–†–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0‚Äì100%",
    "cap.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

    "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
    "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
    "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)","ind.tcap.valueLabel":"USD",
    "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy Altseason)","ind.alt.valueLabel":"Alt %",
    "ind.mood.label":"Market Mood",
    "ind.mood.hint":"–ù–∞ –æ—Å–Ω–æ–≤–µ F&G + –¥–æ–º–∏–Ω–∞—Ü–∏–∏ –∞–ª—å—Ç–æ–≤",
    "ind.refresh":"–û–±–Ω–æ–≤–∏—Ç—å",
    "ind.loading":"–û–±–Ω–æ–≤–ª—è—é‚Ä¶",
    "ind.cached":"–ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞",
    "ind.rate":"–õ–∏–º–∏—Ç/–æ—à–∏–±–∫–∞ API ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ",

    "hist.title":"–ò—Å—Ç–æ—Ä–∏—è","hist.clear":"–û—á–∏—Å—Ç–∏—Ç—å","hist.export":"–≠–∫—Å–ø–æ—Ä—Ç",
    "hist.note":"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",
    "footer.tags":"–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì"
  },
  en:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "theme.dark":"Dark","theme.light":"Light",
    "share":"Share",
    "common.clear":"Clear","common.copy":"Copy","common.copied":"Copied",

    "dca.tip":"Tip: add multiple entries ‚Äî it will calculate average price, total size and total cost.",
    "dca.add":"+ Add entry",
    "dca.row.price":"Price","dca.row.vol":"Volume",
    "dca.avg":"Average price","dca.totalVol":"Total volume","dca.totalCost":"Total cost",
    "dca.hint.empty":"Add at least one valid entry (price + volume > 0).",
    "dca.hint.partial":"Some rows were ignored (check price/volume).",
    "dca.goal.title":"DCA Goal: Target Average",
    "dca.goal.note":"Unique: calculate how much to buy at price X to reach target average Y.",
    "dca.goal.price":"Add price (X)",
    "dca.goal.avg":"Target average (Y)",
    "dca.goal.fee":"Buy fee %",
    "dca.goal.needVol":"Need volume",
    "dca.goal.needCost":"Cost",
    "dca.goal.status":"Status",
    "dca.goal.status.na":"‚Äî",
    "dca.goal.status.ok":"Possible",
    "dca.goal.status.already":"Already at target",
    "dca.goal.status.impossible":"Impossible at this price",
    "dca.goal.hint.fill":"Fill X and Y, and add at least one entry above.",
    "dca.goal.hint.math":"If X = Y ‚Äî division by zero; change values.",

    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
    "rr.fee":"Fee % (approx)",
    "rr.feeNote":"Shows net R/R: approximates entry+exit fees.",
    "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
    "rr.hint.fill":"Fill the fields",
    "rr.hint.entryEqSl":"Entry and SL must differ",

    "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss",
    "cap.fee":"Fee % (entry+exit)",
    "cap.lev":"Leverage (margin)",
    "cap.presets":"Quick risks",
    "cap.pos":"Position size",
    "cap.riskUsd":"Risk $",
    "cap.margin":"Margin (lev)",
    "cap.hint.fill":"Fill the fields",
    "cap.hint.invalid":"Check values",
    "cap.hint.riskRange":"Risk must be 0‚Äì100%",
    "cap.hint.entryEqSl":"Entry and SL must differ",

    "ind.title":"Indicators",
    "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value",
    "ind.tcap.label":"Total Market Cap (USD)","ind.tcap.valueLabel":"USD",
    "ind.alt.label":"Alt dominance (proxy Altseason)","ind.alt.valueLabel":"Alt %",
    "ind.mood.label":"Market Mood",
    "ind.mood.hint":"Derived from F&G + Alt dom",
    "ind.refresh":"Refresh",
    "ind.loading":"Refreshing‚Ä¶",
    "ind.cached":"Showing cached data",
    "ind.rate":"API limit/error ‚Äî try later",

    "hist.title":"History","hist.clear":"Clear","hist.export":"Export",
    "hist.note":"Saved locally in your browser",
    "footer.tags":"AIRDROP ¬∑ NEWS ¬∑ TRADING"
  }
};

let lang = 'en';
try{
  const tgl = tg?.initDataUnsafe?.user?.language_code;
  if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
  else lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
}catch(e){ lang='en'; }

function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }
function translateAll(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    if(locales[lang] && locales[lang][k] !== undefined) el.textContent = locales[lang][k];
  });
  updateThemeUI();
}

/* theme toggle */
const THEME_KEY = 'tc_theme_v2';
function getInitialTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === 'dark' || saved === 'light') return saved;
  const tgScheme = (tg?.colorScheme || '').toLowerCase();
  if(tgScheme === 'dark' || tgScheme === 'light') return tgScheme;
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
}
function setTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem(THEME_KEY, theme);
  updateThemeUI();
}
function updateThemeUI(){
  const theme = document.documentElement.getAttribute('data-theme') || 'dark';
  const icon = document.getElementById('theme_icon');
  const text = document.getElementById('theme_text');
  const btn = document.getElementById('theme_toggle');
  if(theme === 'light'){
    icon.textContent = '‚òÄÔ∏è';
    text.textContent = t('theme.light');
    btn.classList.add('active');
  }else{
    icon.textContent = 'üåô';
    text.textContent = t('theme.dark');
    btn.classList.remove('active');
  }
}
document.getElementById('theme_toggle').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  setTheme(cur === 'dark' ? 'light' : 'dark');
  haptic('impact','light');
});

/* tabs */
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', ()=>{
  document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
  btn.classList.add('active');
  const target = btn.dataset.tab;
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(target).classList.add('active');
  if(target === 'ind' && document.getElementById('tcap').textContent.trim() === '‚Äî') fetchIndicators();
  translateAll();
}));

/* language */
const btn_ru = document.getElementById('btn_ru');
const btn_en = document.getElementById('btn_en');
btn_ru.addEventListener('click', ()=>{
  lang='ru'; btn_ru.classList.add('active'); btn_en.classList.remove('active');
  translateAll(); renderHistory(); refreshAll();
});
btn_en.addEventListener('click', ()=>{
  lang='en'; btn_en.classList.add('active'); btn_ru.classList.remove('active');
  translateAll(); renderHistory(); refreshAll();
});

/* utils */
function safeNum(v){
  const x = parseFloat(v);
  return Number.isFinite(x) ? x : NaN;
}
function fmt(n, maxFrac=8){
  if(!Number.isFinite(n)) return '‚Äî';
  return n.toLocaleString(undefined, { maximumFractionDigits:maxFrac });
}
function fmtMoney(n){
  if(!Number.isFinite(n)) return '‚Äî';
  return '$' + n.toLocaleString(undefined, { maximumFractionDigits:0 });
}
function haptic(kind='impact', style='light'){
  try{
    if(!tg?.HapticFeedback) return;
    if(kind==='impact') tg.HapticFeedback.impactOccurred(style);
    if(kind==='notify') tg.HapticFeedback.notificationOccurred(style);
  }catch(e){}
}
async function copyText(text){
  try{
    if(!text || text === '‚Äî') return false;
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    }catch(err){ return false; }
  }
}

/* History */
const HISTORY_KEY = 'trader_calc_history_v4';
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY))||[] }catch(e){ return [] } }
function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }
function pushHistory(item){
  const arr = loadHistory();
  arr.unshift(item);
  if(arr.length > 80) arr.pop();
  saveHistory(arr);
}
function renderHistory(){
  const list = document.getElementById('history_list');
  list.innerHTML = '';
  const arr = loadHistory();
  if(!arr.length){
    const el = document.createElement('div');
    el.className = 'note';
    el.textContent = t('hist.note');
    list.appendChild(el);
    return;
  }
  arr.forEach(it=>{
    const node = document.createElement('div');
    node.style.padding='10px';
    node.style.border='1px solid var(--border)';
    node.style.borderRadius='14px';
    node.style.background='color-mix(in oklab, var(--panel) 75%, var(--bg))';
    node.innerHTML = `
      <div style="font-weight:900">${it.type}</div>
      <div class="note">${it.summary || ''}</div>
      <div class="small">${new Date(it.t).toLocaleString()}</div>
    `;
    list.appendChild(node);
  });
}
document.getElementById('clear_history').addEventListener('click', ()=>{
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
  haptic('notify','success');
});
document.getElementById('export_history').addEventListener('click', ()=>{
  const data = JSON.stringify(loadHistory(), null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'history.json';
  a.click();
  URL.revokeObjectURL(url);
  haptic('impact','light');
});

/* auto-save debounce */
const state = { lastSaved:{ DCA:null, DCA_GOAL:null, RR:null, CAP:null }, timers:{} };
function scheduleSave(type, summary, value){
  if(!value || value === '‚Äî') return;
  clearTimeout(state.timers[type]);
  state.timers[type] = setTimeout(()=>{
    if(state.lastSaved[type] === value) return;
    state.lastSaved[type] = value;
    pushHistory({ type, summary, t: Date.now() });
  }, 650);
}

/* DCA (multi-entry) */
const dcaRowsEl = document.getElementById('dca_rows');
const dcaAvgEl = document.getElementById('dca_avg');
const dcaTotalVolEl = document.getElementById('dca_totalVol');
const dcaTotalCostEl = document.getElementById('dca_totalCost');
const dcaHintEl = document.getElementById('dca_hint');
const dcaCopyBtn = document.getElementById('dca_copy');

const dcaGoalPrice = document.getElementById('dca_goal_price');
const dcaGoalAvg = document.getElementById('dca_goal_avg');
const dcaFee = document.getElementById('dca_fee');
const dcaNeedVol = document.getElementById('dca_needVol');
const dcaNeedCost = document.getElementById('dca_needCost');
const dcaGoalStatus = document.getElementById('dca_goalStatus');
const dcaGoalHint = document.getElementById('dca_goal_hint');

function dcaRowTemplate(price='', vol=''){
  const wrap = document.createElement('div');
  wrap.className = 'row';
  wrap.innerHTML = `
    <div class="col">
      <label data-i18n="dca.row.price">${t('dca.row.price')}</label>
      <input class="dca_price" type="number" inputmode="decimal" step="any" placeholder="0.00" value="${price}">
    </div>
    <div class="col">
      <label data-i18n="dca.row.vol">${t('dca.row.vol')}</label>
      <input class="dca_vol" type="number" inputmode="decimal" step="any" min="0" placeholder="0" value="${vol}">
    </div>
    <button class="mini dca_remove" title="Remove" aria-label="Remove">‚úï</button>
  `;
  return wrap;
}
function ensureAtLeastOneRow(){
  if(dcaRowsEl.children.length === 0){
    dcaRowsEl.appendChild(dcaRowTemplate());
    dcaRowsEl.appendChild(dcaRowTemplate());
  }
}
function getDcaLegs(){
  const rows = Array.from(dcaRowsEl.querySelectorAll('.row'));
  let valid = [];
  let ignored = 0;

  rows.forEach(r=>{
    const p = safeNum(r.querySelector('.dca_price')?.value);
    const v = safeNum(r.querySelector('.dca_vol')?.value);

    if(Number.isFinite(p) && Number.isFinite(v) && v > 0){
      valid.push({ p, v });
    }else{
      const pv = r.querySelector('.dca_price')?.value?.trim();
      const vv = r.querySelector('.dca_vol')?.value?.trim();
      if((pv && !Number.isFinite(p)) || (vv && !Number.isFinite(v)) || (pv && vv && !(v>0))) ignored++;
    }
  });
  return { valid, ignored };
}

function calcDCA(){
  const { valid, ignored } = getDcaLegs();

  if(valid.length === 0){
    dcaAvgEl.textContent = '‚Äî';
    dcaTotalVolEl.textContent = '‚Äî';
    dcaTotalCostEl.textContent = '‚Äî';
    dcaHintEl.textContent = t('dca.hint.empty');
    dcaCopyBtn.disabled = true;
    calcDcaGoal(null);
    return;
  }

  let totalVol = 0;
  let totalCost = 0;
  for(const leg of valid){
    totalVol += leg.v;
    totalCost += leg.p * leg.v;
  }

  const avg = totalCost / totalVol;
  const avgText = fmt(avg, 8);

  dcaAvgEl.textContent = avgText;
  dcaTotalVolEl.textContent = fmt(totalVol, 8);
  dcaTotalCostEl.textContent = fmtMoney(totalCost);

  dcaHintEl.textContent = ignored > 0 ? t('dca.hint.partial') : '';
  dcaCopyBtn.disabled = false;

  scheduleSave('DCA', `AVG ${avgText} ¬∑ vol ${fmt(totalVol, 8)} ¬∑ cost ${fmtMoney(totalCost)}`, avgText);

  calcDcaGoal({ totalVol, totalCost, avg });
}

function calcDcaGoal(base){
  // base = { totalVol, totalCost, avg } or null
  const X = safeNum(dcaGoalPrice.value);
  const Y = safeNum(dcaGoalAvg.value);
  const feePct = safeNum(dcaFee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct) / 100 : 0;

  // default UI
  dcaNeedVol.textContent = '‚Äî';
  dcaNeedCost.textContent = '‚Äî';
  dcaGoalStatus.textContent = t('dca.goal.status.na');
  dcaGoalHint.textContent = '';

  if(!base){
    dcaGoalHint.textContent = t('dca.goal.hint.fill');
    return;
  }
  if(!Number.isFinite(X) || !Number.isFinite(Y)){
    dcaGoalHint.textContent = t('dca.goal.hint.fill');
    return;
  }
  if(X === Y){
    dcaGoalHint.textContent = t('dca.goal.hint.math');
    dcaGoalStatus.textContent = t('dca.goal.status.impossible');
    return;
  }

  // include buy fee into added cost (approx): effective add price = X*(1+fee)
  const Xeff = X * (1 + fee);

  // Solve for v:
  // (totalCost + Xeff*v) / (totalVol + v) = Y
  // totalCost + Xeff*v = Y*totalVol + Y*v
  // v*(Xeff - Y) = Y*totalVol - totalCost
  const numerator = (Y * base.totalVol) - base.totalCost;
  const denom = (Xeff - Y);

  const v = numerator / denom;

  // already at target (within tiny tolerance)
  if(Math.abs(base.avg - Y) / (Math.abs(Y) || 1) < 1e-9){
    dcaGoalStatus.textContent = t('dca.goal.status.already');
    dcaNeedVol.textContent = '0';
    dcaNeedCost.textContent = '$0';
    return;
  }

  // Need positive volume to "buy". Negative means you'd need to "sell" or it's not achievable by buying at X.
  if(!Number.isFinite(v) || v <= 0){
    dcaGoalStatus.textContent = t('dca.goal.status.impossible');
    return;
  }

  const needCost = Xeff * v;
  dcaNeedVol.textContent = fmt(v, 8);
  dcaNeedCost.textContent = fmtMoney(needCost);
  dcaGoalStatus.textContent = t('dca.goal.status.ok');

  // small smart hint
  if (Xeff > base.avg && Y < base.avg){
    dcaGoalHint.textContent = (lang==='ru')
      ? '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ —Ü–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ä–µ–¥–Ω–µ–π, —Å—Ä–µ–¥–Ω—é—é ‚Äú—Å–Ω–∏–∑–∏—Ç—å‚Äù –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è –ø–æ–∫—É–ø–∫–æ–π.'
      : 'Tip: if add price is above current average, you cannot lower average by buying.';
  } else if (Xeff < base.avg && Y > base.avg){
    dcaGoalHint.textContent = (lang==='ru')
      ? '–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ —Ü–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Å—Ä–µ–¥–Ω–µ–π, —Å—Ä–µ–¥–Ω—é—é ‚Äú–ø–æ–¥–Ω—è—Ç—å‚Äù –ø–æ–∫—É–ø–∫–æ–π —Å–ª–æ–∂–Ω–æ ‚Äî —Ü–µ–ª—å –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π.'
      : 'Tip: if add price is below current average, raising the average by buying is tricky.';
  } else {
    dcaGoalHint.textContent = '';
  }

  scheduleSave('DCA_GOAL', `Need vol ${fmt(v, 8)} @ ${X} to target ${Y}`, fmt(v, 8));
}

document.getElementById('dca_add').addEventListener('click', ()=>{
  dcaRowsEl.appendChild(dcaRowTemplate());
  translateAll();
  calcDCA();
  haptic('impact','light');
});
document.getElementById('dca_clear').addEventListener('click', ()=>{
  dcaRowsEl.innerHTML = '';
  ensureAtLeastOneRow();
  translateAll();
  calcDCA();
  haptic('notify','success');
});
dcaRowsEl.addEventListener('input', (e)=>{
  if(e.target.classList.contains('dca_price') || e.target.classList.contains('dca_vol')) calcDCA();
});
dcaRowsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('.dca_remove');
  if(!btn) return;
  const row = btn.closest('.row');
  if(!row) return;

  if(dcaRowsEl.children.length <= 1){
    row.querySelector('.dca_price').value = '';
    row.querySelector('.dca_vol').value = '';
  }else{
    row.remove();
  }
  calcDCA();
  haptic('impact','light');
});
dcaCopyBtn.addEventListener('click', async ()=>{
  const val = dcaAvgEl.textContent.trim();
  const ok = await copyText(val);
  if(ok){
    dcaCopyBtn.textContent = t('common.copied');
    setTimeout(()=>dcaCopyBtn.textContent = t('common.copy'), 900);
    haptic('notify','success');
  }
});

[dcaGoalPrice, dcaGoalAvg, dcaFee].forEach(el=>el.addEventListener('input', ()=>calcDcaGoal(getDcaBaseSafe())));
function getDcaBaseSafe(){
  const { valid } = getDcaLegs();
  if(!valid.length) return null;
  let totalVol=0,totalCost=0;
  for(const leg of valid){ totalVol+=leg.v; totalCost+=leg.p*leg.v; }
  const avg = totalCost/totalVol;
  return { totalVol, totalCost, avg };
}

/* R/R (gross + net with fees) */
const rr_entry=document.getElementById('rr_entry');
const rr_sl=document.getElementById('rr_sl');
const rr_tp=document.getElementById('rr_tp');
const rr_fee=document.getElementById('rr_fee');
const rr_value=document.getElementById('rr_value');
const rr_net=document.getElementById('rr_net');
const rr_hint=document.getElementById('rr_hint');

function calcRR(){
  const e=safeNum(rr_entry.value), sl=safeNum(rr_sl.value), tp=safeNum(rr_tp.value);
  const feePct=safeNum(rr_fee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

  rr_value.textContent = '‚Äî';
  rr_net.textContent = '‚Äî';
  rr_hint.textContent = '';

  if([e,sl,tp].some(x=>Number.isNaN(x))){
    rr_hint.textContent = t('rr.hint.fill');
    return;
  }
  if(e === sl){
    rr_hint.textContent = t('rr.hint.entryEqSl');
    return;
  }

  const risk = Math.abs(e - sl);
  const reward = Math.abs(tp - e);
  if(!(risk > 0)) return;

  const gross = (reward / risk).toFixed(2);
  rr_value.textContent = `1:${gross}`;

  // fees-aware approximation:
  // riskNet = risk + fee*(e + sl)
  // rewardNet = reward - fee*(e + tp)
  const riskNet = risk + fee * (Math.abs(e) + Math.abs(sl));
  const rewardNet = reward - fee * (Math.abs(e) + Math.abs(tp));
  if(rewardNet <= 0){
    rr_net.textContent = '0.00';
  }else{
    const net = (rewardNet / riskNet);
    rr_net.textContent = net.toFixed(2);
  }

  scheduleSave('RR', `Gross 1:${gross} ¬∑ Net ${rr_net.textContent}`, gross);
}
[rr_entry,rr_sl,rr_tp,rr_fee].forEach(i=>i.addEventListener('input', calcRR));
document.getElementById('rr_clear').addEventListener('click', ()=>{
  rr_entry.value=''; rr_sl.value=''; rr_tp.value=''; rr_fee.value='';
  calcRR();
  haptic('notify','success');
});

/* Capital (position size + risk $ + margin) */
const cap_dep=document.getElementById('cap_dep');
const cap_risk=document.getElementById('cap_risk');
const cap_entry=document.getElementById('cap_entry');
const cap_sl=document.getElementById('cap_sl');
const cap_fee=document.getElementById('cap_fee');
const cap_lev=document.getElementById('cap_lev');

const cap_value=document.getElementById('cap_value');
const cap_riskUsd=document.getElementById('cap_riskUsd');
const cap_margin=document.getElementById('cap_margin');
const cap_hint=document.getElementById('cap_hint');

function calcCap(){
  const dep=safeNum(cap_dep.value);
  const rp=safeNum(cap_risk.value);
  const e=safeNum(cap_entry.value);
  const sl=safeNum(cap_sl.value);

  const feePct=safeNum(cap_fee.value);
  const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

  const levRaw=safeNum(cap_lev.value);
  const lev = Number.isFinite(levRaw) ? Math.max(1, levRaw) : 1;

  cap_value.textContent = '‚Äî';
  cap_riskUsd.textContent = '‚Äî';
  cap_margin.textContent = '‚Äî';
  cap_hint.textContent = '';

  if([dep,rp,e,sl].some(x=>Number.isNaN(x))){
    cap_hint.textContent = t('cap.hint.fill');
    return;
  }
  if(dep <= 0){
    cap_hint.textContent = t('cap.hint.invalid');
    return;
  }
  if(rp <= 0 || rp > 100){
    cap_hint.textContent = t('cap.hint.riskRange');
    return;
  }
  if(e === sl){
    cap_hint.textContent = t('cap.hint.entryEqSl');
    return;
  }

  const riskUsd = dep * (rp/100);

  // per-unit risk includes approximate fees on entry+exit at SL:
  // feeCost per unit ~ fee*(e + sl)
  const perUnit = Math.abs(e - sl) + fee*(Math.abs(e) + Math.abs(sl));
  const size = riskUsd / perUnit;

  if(!Number.isFinite(size) || size <= 0){
    cap_hint.textContent = t('cap.hint.invalid');
    return;
  }

  cap_value.textContent = size.toFixed(8);
  cap_riskUsd.textContent = '$' + riskUsd.toFixed(2);

  // margin estimate (spot/linear): notional = size*entry; margin = notional/lev
  const notional = Math.abs(size * e);
  cap_margin.textContent = fmtMoney(notional / lev);

  scheduleSave('CAP', `Size ${size.toFixed(8)} ¬∑ Risk $${riskUsd.toFixed(2)} ¬∑ Margin ${cap_margin.textContent}`, size.toFixed(8));
}

[cap_dep,cap_risk,cap_entry,cap_sl,cap_fee,cap_lev].forEach(i=>i.addEventListener('input', calcCap));
document.getElementById('cap_clear').addEventListener('click', ()=>{
  cap_dep.value=''; cap_risk.value=''; cap_entry.value=''; cap_sl.value='';
  cap_fee.value=''; cap_lev.value='';
  calcCap();
  haptic('notify','success');
});
document.querySelectorAll('.cap_preset').forEach(b=>b.addEventListener('click', ()=>{
  cap_risk.value = b.dataset.v;
  calcCap();
  haptic('impact','light');
}));

/* Indicators with cache + Market Mood */
const fgEl = document.getElementById('fg_value');
const tcapEl = document.getElementById('tcap');
const altDomEl = document.getElementById('alt_dom');
const moodEl = document.getElementById('mood_value');
const indNote = document.getElementById('ind_note');

const IND_CACHE_KEY = 'trader_ind_cache_v3';
const IND_CACHE_TTL_MS = 60_000;
let indInFlight = false;

function getIndCache(){ try{ return JSON.parse(localStorage.getItem(IND_CACHE_KEY)) }catch(e){ return null } }
function setIndCache(data){ localStorage.setItem(IND_CACHE_KEY, JSON.stringify({ t: Date.now(), data })); }

function computeMood(fngValue, altDom){
  if(!Number.isFinite(fngValue) || !Number.isFinite(altDom)) return '‚Äî';
  // simple but useful heuristic
  if(fngValue >= 60 && altDom >= 55) return 'üü¢ Risk-on';
  if(fngValue <= 40 && altDom <= 45) return 'üî¥ Risk-off';
  return 'üü° Neutral';
}

function applyIndicators(data){
  fgEl.textContent = data.fgText || '‚Äî';
  tcapEl.textContent = data.totalMc ? fmtMoney(Number(data.totalMc)) : '‚Äî';
  altDomEl.textContent = (typeof data.altDom === 'number') ? (data.altDom.toFixed(2) + '%') : '‚Äî';
  moodEl.textContent = computeMood(data.fngValue, data.altDom);
}

async function fetchIndicators(){
  if(indInFlight) return;
  indInFlight = true;
  indNote.textContent = t('ind.loading');

  const cache = getIndCache();
  if(cache && (Date.now() - cache.t) < IND_CACHE_TTL_MS){
    applyIndicators(cache.data);
    indNote.textContent = t('ind.cached');
    indInFlight = false;
    return;
  }

  const out = { fgText:null, fngValue:NaN, totalMc:null, altDom:NaN };
  let hadErr = false;

  try{
    const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json', { cache:'no-store' });
    if(!res.ok) throw new Error('FNG failed');
    const j = await res.json();
    const d = j?.data?.[0];
    if(d?.value){
      out.fngValue = Number(d.value);
      out.fgText = `${d.value} ¬∑ ${d.value_classification || ''}`.trim();
    }
  }catch(e){ hadErr = true; }

  try{
    const res2 = await fetch('https://api.coingecko.com/api/v3/global', { cache:'no-store' });
    if(!res2.ok) throw new Error('CG global failed');
    const j2 = await res2.json();
    out.totalMc = j2?.data?.total_market_cap?.usd ?? null;
    const btcDom = (typeof j2?.data?.market_cap_percentage?.btc === 'number') ? j2.data.market_cap_percentage.btc : null;
    if(typeof btcDom === 'number') out.altDom = 100 - btcDom;
  }catch(e){ hadErr = true; }

  applyIndicators(out);
  setIndCache(out);
  indNote.textContent = hadErr ? t('ind.rate') : '';
  indInFlight = false;
}
document.getElementById('refresh_ind').addEventListener('click', ()=>{
  try{ localStorage.removeItem(IND_CACHE_KEY); }catch(e){}
  fetchIndicators();
  haptic('impact','light');
});

/* Share snapshot (copies current tab summary) */
document.getElementById('share_btn').addEventListener('click', async ()=>{
  const activeTab = document.querySelector('.tab.active')?.dataset?.tab || 'dca';
  let text = 'üìä Trader Calculator\n';

  if(activeTab === 'dca'){
    text += `DCA AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}\n`;
    const nv = dcaNeedVol.textContent;
    if(nv && nv !== '‚Äî'){
      text += `\nüéØ Goal\nNeed: ${nv}\nCost: ${dcaNeedCost.textContent}\n`;
    }
  }
  if(activeTab === 'rr'){
    text += `R/R Gross: ${rr_value.textContent}\nR/R Net: ${rr_net.textContent}\n`;
  }
  if(activeTab === 'cap'){
    text += `Size: ${cap_value.textContent}\nRisk: ${cap_riskUsd.textContent}\nMargin: ${cap_margin.textContent}\n`;
  }
  if(activeTab === 'ind'){
    text += `F&G: ${fgEl.textContent}\nAlt dom: ${altDomEl.textContent}\nMood: ${moodEl.textContent}\n`;
  }

  const ok = await copyText(text);
  if(ok) haptic('notify','success');
});

/* links */
function openUrl(url){
  try{
    if(tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
    if(tg?.openLink) return tg.openLink(url);
  }catch(e){}
  window.open(url,'_blank','noopener');
}
document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

/* init */
function refreshAll(){ calcDCA(); calcRR(); calcCap(); }
setTheme(getInitialTheme());
translateAll();
ensureAtLeastOneRow();
renderHistory();
calcDCA(); calcRR(); calcCap();
fetchIndicators();
</script>
</body>
</html>
