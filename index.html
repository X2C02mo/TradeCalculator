<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Trader Calculator</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#fff;
  --muted:#9a9a9a;
  --accent:#7CFC00;
  --danger:#ff4d4f;

  --input-bg:#070707;
  --result-bg:#060606;
  --chip-bg:#0a0a0a;

  --shadow:0 12px 40px rgba(0,0,0,.45);
}
:root[data-theme="light"]{
  --bg:#ffffff;
  --panel:#f6f6f6;
  --border:#e6e6e6;
  --text:#111;
  --muted:#666;
  --accent:#0bbf5e;
  --danger:#d9363e;

  --input-bg:#ffffff;
  --result-bg:#ffffff;
  --chip-bg:#f1f1f1;

  --shadow:0 12px 40px rgba(0,0,0,.12);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
button,input,textarea{font-family:inherit}
#app{height:100vh;display:flex;flex-direction:column;overflow:hidden}

/* hide global scrollbars */
*::-webkit-scrollbar{width:0;height:0}
*{scrollbar-width:none}

/* header */
header{
  position:sticky;top:0;z-index:10;
  background:var(--bg);
  border-bottom:1px solid var(--border);
  padding:10px 12px;
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.leftbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.lang{display:flex;gap:6px;align-items:center}
.lang button{
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  padding:6px 10px;
  border-radius:12px;
  cursor:pointer;
  font-weight:800;
  line-height:1.1;
  white-space:nowrap;
}
.lang button.active{border-color:var(--accent);color:var(--accent)}

.iconbtn{
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  padding:6px 10px;
  border-radius:12px;
  cursor:pointer;
  font-weight:900;
  line-height:1.1;
  min-height:34px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  white-space:nowrap;
  max-width:100%;
  overflow:hidden;
}
.iconbtn .ico{font-size:14px;line-height:1;flex:0 0 auto}
.iconbtn .lbl{font-size:12px;flex:1 1 auto;overflow:hidden;text-overflow:ellipsis}
.iconbtn:active{transform:translateY(1px)}
.iconbtn.active{border-color:var(--accent);color:var(--accent)}

.tabs{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-left:auto;
}
.tab{
  background:none;border:none;
  color:var(--muted);
  font-size:13px;
  padding:6px 10px;
  cursor:pointer;
  border-radius:12px;
  white-space:nowrap;
}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}

/* main layout */
main{
  flex:1;
  padding:14px;
  display:flex;
  gap:16px;
  flex-direction:column;
  overflow-y:auto;
  overflow-x:hidden;
}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  max-width:860px;
}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{
  width:100%;
  padding:10px;
  background:var(--input-bg);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:14px;
  font-size:14px;
  outline:none;
}
input:focus{border-color:color-mix(in oklab, var(--accent) 45%, var(--border))}

.row{
  display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;
  padding:10px;
  border:1px solid var(--border);
  border-radius:16px;
  background:color-mix(in oklab, var(--panel) 75%, var(--bg));
}
.row .col{flex:1;min-width:140px}
.mini{
  width:40px;height:40px;
  display:flex;align-items:center;justify-content:center;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--chip-bg);
  cursor:pointer;
  color:var(--muted);
  flex:0 0 auto;
}
.mini:active{transform:translateY(1px)}

.result{
  margin-top:10px;
  padding:10px;
  border-radius:16px;
  background:var(--result-bg);
  border:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.res-left{display:flex;flex-direction:column;gap:3px;min-width:0}
.res-label{font-size:12px;color:var(--muted)}
.res-value{font-size:14px;font-weight:900;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.res-value.muted{color:var(--muted);font-weight:800}

.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{
  border:1px solid var(--border);
  background:transparent;
  color:var(--accent);
  padding:8px 12px;
  border-radius:14px;
  cursor:pointer;
  font-weight:900;
  line-height:1.1;
  min-height:36px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:100%;
}
.btn.ghost{color:var(--muted)}
.btn.small{padding:6px 10px;border-radius:999px;min-height:32px;font-size:12px}
.btn:active{transform:translateY(1px)}
.btn:disabled{opacity:.45;cursor:not-allowed}

.note{font-size:12px;color:var(--muted);line-height:1.35}
.small{font-size:11px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{
  display:inline-flex;align-items:center;gap:6px;
  border:1px solid var(--border);
  background:var(--chip-bg);
  padding:6px 10px;border-radius:999px;
  color:var(--muted);font-size:12px;
  max-width:100%;
  overflow:hidden;
}
.chip b{color:var(--text);max-width:100%;overflow:hidden;text-overflow:ellipsis}
.hr{height:1px;background:var(--border);margin:12px 0}

/* indicator visuals */
.viz-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.viz{
  flex:1;min-width:240px;
  background:color-mix(in oklab, var(--panel) 60%, var(--bg));
  border:1px solid var(--border);
  border-radius:16px;
  padding:10px;
}
.viz-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:10px}
.viz-title b{font-size:12px}
.viz-title span{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.viz canvas{
  width:100%;
  height:140px;
  display:block;
  border-radius:14px;
  background:var(--result-bg);
  border:1px solid var(--border);
}

/* history */
.history{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:10px;
  max-width:420px;
  flex:0 0 auto;
}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
.hitem{
  padding:10px;
  border:1px solid var(--border);
  border-radius:16px;
  background:color-mix(in oklab, var(--panel) 75%, var(--bg));
}
.hitem-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
.hitem-title{font-weight:900}
.hitem-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.hitem .note{margin-top:4px}
.hitem .small{margin-top:4px}

/* footer */
footer{
  border-top:1px solid var(--border);
  padding:12px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  background:var(--bg);
}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px}
.links{display:flex;gap:18px;margin-top:2px;flex-wrap:wrap;justify-content:center}
.rainbow{
  display:inline-block;font-weight:900;text-decoration:none;
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;color:transparent;
  animation:rain 3.5s linear infinite;
}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}

@media(min-width:900px){main{flex-direction:row}}
@media(max-width:420px){
  .iconbtn .lbl{display:none}
  .tabs{gap:6px}
  .tab{padding:6px 8px}
}

/* toast */
#toast{
  position:fixed;left:50%;bottom:18px;
  transform:translateX(-50%);
  background:color-mix(in oklab, var(--panel) 85%, var(--bg));
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 12px;
  border-radius:999px;
  box-shadow:var(--shadow);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  z-index:9999;
  font-weight:900;
  font-size:13px;
  max-width:92vw;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}

/* modal */
#modalOverlay{
  position:fixed;inset:0;z-index:9998;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:14px;
}
#modalOverlay.show{display:flex}
#modal{
  width:min(920px, 100%);
  background:color-mix(in oklab, var(--panel) 90%, var(--bg));
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
#modalHeader{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:12px;border-bottom:1px solid var(--border);
}
#modalHeader b{font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#modalBody{padding:12px}
#modalFooter{
  padding:12px;border-top:1px solid var(--border);
  display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
}
#modalImg{
  width:100%;
  max-height:70vh;
  object-fit:contain;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--result-bg);
}
#modalHint{margin-top:10px}
</style>
</head>

<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru">RU</button>
        <button id="btn_en">EN</button>
      </div>

      <button class="iconbtn" id="theme_toggle" type="button" aria-label="Theme">
        <span class="ico" id="theme_icon">üåô</span>
        <span class="lbl" id="theme_text">Dark</span>
      </button>

      <button class="iconbtn" id="share_btn" type="button" aria-label="Share">
        <span class="ico">üìã</span>
        <span class="lbl" data-i18n="share">Share</span>
      </button>

      <button class="iconbtn" id="card_btn" type="button" aria-label="Trade Card PNG">
        <span class="ico">üñºÔ∏è</span>
        <span class="lbl" data-i18n="cardpng">Card PNG</span>
      </button>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca" type="button">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr" type="button">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap" type="button">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind" type="button">Indicators</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1;min-width:0">
      <!-- DCA -->
      <section id="dca" class="screen active">
        <div class="card">
          <div class="note" data-i18n="dca.tip">Tip‚Ä¶</div>
          <div style="height:10px"></div>

          <div id="dca_rows"></div>

          <div class="controls">
            <button class="btn" id="dca_add" type="button" data-i18n="dca.add">+ Add</button>
            <button class="btn ghost" id="dca_clear" type="button" data-i18n="common.clear">Clear</button>
          </div>

          <div class="result">
            <div class="res-left">
              <span class="res-label" data-i18n="dca.avg">Average</span>
              <span class="res-value muted" id="dca_avg">‚Äî</span>
            </div>
            <button class="btn small ghost" id="dca_copy" type="button" data-i18n="common.copy">Copy</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.totalVol">Vol</span>: <b id="dca_totalVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.totalCost">Cost</span>: <b id="dca_totalCost">‚Äî</b></span>
          </div>

          <div class="small" id="dca_hint" style="margin-top:8px"></div>

          <div class="hr"></div>

          <h4 style="margin:0 0 8px 0" data-i18n="dca.goal.title">DCA Goal</h4>
          <div class="note" data-i18n="dca.goal.note">‚Ä¶</div>

          <div style="height:10px"></div>
          <div class="row">
            <div class="col">
              <label data-i18n="dca.goal.price">Add price X</label>
              <input id="dca_goal_price" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="dca.goal.avg">Target avg Y</label>
              <input id="dca_goal_avg" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col" style="min-width:170px">
              <label data-i18n="dca.goal.fee">Fee %</label>
              <input id="dca_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="dca.goal.needVol">Need vol</span>: <b id="dca_needVol">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.needCost">Cost</span>: <b id="dca_needCost">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.status">Status</span>: <b id="dca_goalStatus">‚Äî</b></span>
          </div>
          <div class="small" id="dca_goal_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- R/R -->
      <section id="rr" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="rr.entry">Entry</label>
              <input id="rr_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.sl">Stop Loss</label>
              <input id="rr_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="rr.tp">Take Profit</label>
              <input id="rr_tp" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="rr.fee">Fee %</label>
              <input id="rr_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col" style="min-width:240px">
              <div class="note" data-i18n="rr.feeNote">‚Ä¶</div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="rr_clear" type="button" data-i18n="common.clear">Clear</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="rr.gross">Gross</span>: <b id="rr_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="rr.net">Net</span>: <b id="rr_net">‚Äî</b></span>
          </div>

          <div class="small" id="rr_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Capital -->
      <section id="cap" class="screen">
        <div class="card">
          <div class="row">
            <div class="col">
              <label data-i18n="cap.dep">Deposit</label>
              <input id="cap_dep" type="number" inputmode="decimal" step="any" min="0" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.risk">Risk %</label>
              <input id="cap_risk" type="number" inputmode="decimal" step="any" min="0" max="100" placeholder="1">
            </div>
            <div class="col">
              <label data-i18n="cap.entry">Entry</label>
              <input id="cap_entry" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="cap.sl">Stop Loss</label>
              <input id="cap_sl" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <label data-i18n="cap.fee">Fee %</label>
              <input id="cap_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
            <div class="col">
              <label data-i18n="cap.lev">Leverage</label>
              <input id="cap_lev" type="number" inputmode="decimal" step="any" min="1" max="200" placeholder="1">
            </div>
            <div class="col" style="min-width:260px">
              <label data-i18n="cap.presets">Quick</label>
              <div class="controls" style="margin-top:0">
                <button class="btn small ghost cap_preset" type="button" data-v="0.5">0.5%</button>
                <button class="btn small ghost cap_preset" type="button" data-v="1">1%</button>
                <button class="btn small ghost cap_preset" type="button" data-v="2">2%</button>
                <button class="btn small ghost cap_preset" type="button" data-v="3">3%</button>
              </div>
            </div>
          </div>

          <div class="controls">
            <button class="btn ghost" id="cap_clear" type="button" data-i18n="common.clear">Clear</button>
          </div>

          <div class="chips">
            <span class="chip"><span data-i18n="cap.pos">Position</span>: <b id="cap_value">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.riskUsd">Risk $</span>: <b id="cap_riskUsd">‚Äî</b></span>
            <span class="chip"><span data-i18n="cap.margin">Margin</span>: <b id="cap_margin">‚Äî</b></span>
          </div>

          <div class="small" id="cap_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <!-- Indicators -->
      <section id="ind" class="screen">
        <div class="card">
          <h3 style="margin:0 0 10px 0" data-i18n="ind.title">Indicators</h3>

          <div class="field">
            <label data-i18n="ind.fg.label">Fear &amp; Greed</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.fg.valueLabel">Value</span>
                <span class="res-value muted" id="fg_value">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.tcap.label">Total Market Cap (USD)</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label">USD</span>
                <span class="res-value muted" id="tcap">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.alt.label">Alt dominance</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label">Alt %</span>
                <span class="res-value muted" id="alt_dom">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="field">
            <label data-i18n="ind.mood.label">Market Mood</label>
            <div class="result">
              <div class="res-left">
                <span class="res-label" data-i18n="ind.mood.hint">Derived</span>
                <span class="res-value muted" id="mood_value">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="viz-grid">
            <div class="viz">
              <div class="viz-title"><b data-i18n="ind.viz.fg">F&G Gauge</b><span id="fg_viz_text">‚Äî</span></div>
              <canvas id="fg_canvas"></canvas>
            </div>
            <div class="viz">
              <div class="viz-title"><b data-i18n="ind.viz.cap">Market Cap</b><span id="cap_viz_text">‚Äî</span></div>
              <canvas id="cap_canvas"></canvas>
            </div>
            <div class="viz">
              <div class="viz-title"><b data-i18n="ind.viz.alt">Alt Dom</b><span id="alt_viz_text">‚Äî</span></div>
              <canvas id="alt_canvas"></canvas>
            </div>
          </div>

          <div class="controls" style="margin-top:12px">
            <button class="btn" id="refresh_ind" type="button" data-i18n="ind.refresh">Refresh</button>
          </div>
          <div class="note" id="ind_note"></div>
        </div>
      </section>
    </div>

    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>
      <div class="controls" style="margin-top:8px">
        <button class="btn ghost" id="clear_history" type="button" data-i18n="hist.clear">Clear</button>
      </div>
      <div class="note" data-i18n="hist.note">Saved locally</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<div id="toast">‚Äî</div>

<!-- Modal (PNG preview only; no "Open") -->
<div id="modalOverlay" role="dialog" aria-modal="true">
  <div id="modal">
    <div id="modalHeader">
      <b id="modalTitle">‚Äî</b>
      <button class="btn small ghost" id="modalClose" type="button">‚úï</button>
    </div>
    <div id="modalBody">
      <img id="modalImg" alt="preview" />
      <div class="note" id="modalHint"></div>
    </div>
    <div id="modalFooter">
      <button class="btn ghost" id="modalCopySummary" type="button" data-i18n="modal.copy">Copy</button>
      <button class="btn" id="modalShare" type="button" data-i18n="modal.share">Share</button>
      <button class="btn" id="modalOk" type="button" data-i18n="modal.ok">OK</button>
    </div>
  </div>
</div>

<script>
/* ========= Robust bootstrap ========= */
(function(){
  const tg = window.Telegram?.WebApp || null;
  try{ tg?.ready?.(); tg?.expand?.(); tg?.disableVerticalSwipes?.(); }catch(e){}

  /* ---------- i18n ---------- */
  const locales = {
    ru:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è","cardpng":"–ö–∞—Ä—Ç–æ—á–∫–∞ PNG",
      "common.clear":"–û—á–∏—Å—Ç–∏—Ç—å","common.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
      "toast.copied":"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!","toast.saved":"–ì–æ—Ç–æ–≤–æ",
      "theme.dark":"–¢—ë–º–Ω–∞—è","theme.light":"–°–≤–µ—Ç–ª–∞—è",
      "dca.tip":"–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.",
      "dca.add":"+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥",
      "dca.avg":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.totalVol":"–û–±—â–∏–π –æ–±—ä—ë–º","dca.totalCost":"–°—É–º–º–∞",
      "dca.row.price":"–¶–µ–Ω–∞","dca.row.vol":"–û–±—ä—ë–º",
      "dca.hint.empty":"–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π –≤—Ö–æ–¥ (—Ü–µ–Ω–∞ + –æ–±—ä—ë–º > 0).",
      "dca.hint.partial":"–ß–∞—Å—Ç—å —Å—Ç—Ä–æ–∫ –Ω–µ —É—á—Ç–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å —Ü–µ–Ω—É/–æ–±—ä—ë–º).",
      "dca.goal.title":"DCA Goal: Target Average",
      "dca.goal.note":"–ü–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.",
      "dca.goal.price":"–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)",
      "dca.goal.avg":"–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)",
      "dca.goal.fee":"–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %",
      "dca.goal.needVol":"–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å",
      "dca.goal.needCost":"–°—Ç–æ–∏–º–æ—Å—Ç—å",
      "dca.goal.status":"–°—Ç–∞—Ç—É—Å",
      "dca.goal.status.na":"‚Äî",
      "dca.goal.status.ok":"–í–æ–∑–º–æ–∂–Ω–æ",
      "dca.goal.status.already":"–£–∂–µ –Ω–∞ —Ü–µ–ª–∏",
      "dca.goal.status.impossible":"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ —ç—Ç–æ–π —Ü–µ–Ω–µ",
      "dca.goal.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ X –∏ Y, –∏ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—Ö–æ–¥ —Å–≤–µ—Ä—Ö—É.",
      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)",
      "rr.feeNote":"–ü–æ–∫–∞–∂–µ—Ç net R/R: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é (–ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ).",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)","cap.lev":"–ü–ª–µ—á–æ","cap.presets":"–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏",
      "cap.pos":"–û–±—ä—ë–º –ø–æ–∑–∏—Ü–∏–∏","cap.riskUsd":"–†–∏—Å–∫ $","cap.margin":"–ú–∞—Ä–∂–∞ (–ø–ª–µ—á–æ)",
      "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
      "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)",
      "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy Altseason)",
      "ind.mood.label":"Market Mood",
      "ind.mood.hint":"–ù–∞ –æ—Å–Ω–æ–≤–µ F&G + –¥–æ–º–∏–Ω–∞—Ü–∏–∏ –∞–ª—å—Ç–æ–≤",
      "ind.refresh":"–û–±–Ω–æ–≤–∏—Ç—å",
      "ind.loading":"–û–±–Ω–æ–≤–ª—è—é‚Ä¶",
      "ind.cached":"–ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞",
      "ind.rate":"–õ–∏–º–∏—Ç/–æ—à–∏–±–∫–∞ API ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ",
      "ind.viz.fg":"F&G Gauge",
      "ind.viz.cap":"Market Cap",
      "ind.viz.alt":"Alt Dom",
      "hist.title":"–ò—Å—Ç–æ—Ä–∏—è",
      "hist.clear":"–û—á–∏—Å—Ç–∏—Ç—å",
      "hist.note":"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ",
      "footer.tags":"–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì",
      "modal.ok":"OK",
      "modal.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç",
      "modal.share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è PNG",
      "modal.hint":"–ï—Å–ª–∏ –º–µ–Ω—é ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å ‚Äî —Å–¥–µ–ª–∞–π –¥–æ–ª–≥–∏–π —Ç–∞–ø –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ –∏ –≤—ã–±–µ—Ä–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å / –ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª."
    },
    en:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "share":"Share","cardpng":"Card PNG",
      "common.clear":"Clear","common.copy":"Copy",
      "toast.copied":"Copied!","toast.saved":"Done",
      "theme.dark":"Dark","theme.light":"Light",
      "dca.tip":"Tip: add multiple entries ‚Äî it will calculate average price, total volume and cost.",
      "dca.add":"+ Add entry",
      "dca.avg":"Average price","dca.totalVol":"Total volume","dca.totalCost":"Total cost",
      "dca.row.price":"Price","dca.row.vol":"Volume",
      "dca.hint.empty":"Add at least one valid entry (price + volume > 0).",
      "dca.hint.partial":"Some rows were ignored (check price/volume).",
      "dca.goal.title":"DCA Goal: Target Average",
      "dca.goal.note":"Calculate how much to buy at price X to reach target average Y.",
      "dca.goal.price":"Add price (X)",
      "dca.goal.avg":"Target average (Y)",
      "dca.goal.fee":"Buy fee %",
      "dca.goal.needVol":"Need volume",
      "dca.goal.needCost":"Cost",
      "dca.goal.status":"Status",
      "dca.goal.status.na":"‚Äî",
      "dca.goal.status.ok":"Possible",
      "dca.goal.status.already":"Already at target",
      "dca.goal.status.impossible":"Impossible at this price",
      "dca.goal.hint.fill":"Fill X and Y and add at least one entry above.",
      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"Fee % (approx)",
      "rr.feeNote":"Shows net R/R: approximates entry+exit fees.",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"Fee % (entry+exit)","cap.lev":"Leverage","cap.presets":"Quick risks",
      "cap.pos":"Position size","cap.riskUsd":"Risk $","cap.margin":"Margin (lev)",
      "ind.title":"Indicators",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value",
      "ind.tcap.label":"Total Market Cap (USD)",
      "ind.alt.label":"Alt dominance (proxy Altseason)",
      "ind.mood.label":"Market Mood",
      "ind.mood.hint":"Derived from F&G + Alt dom",
      "ind.refresh":"Refresh",
      "ind.loading":"Refreshing‚Ä¶",
      "ind.cached":"Showing cached data",
      "ind.rate":"API limit/error ‚Äî try later",
      "ind.viz.fg":"F&G Gauge",
      "ind.viz.cap":"Market Cap",
      "ind.viz.alt":"Alt Dom",
      "hist.title":"History",
      "hist.clear":"Clear",
      "hist.note":"Saved locally",
      "footer.tags":"AIRDROP ¬∑ NEWS ¬∑ TRADING",
      "modal.ok":"OK",
      "modal.copy":"Copy text",
      "modal.share":"Share PNG",
      "modal.hint":"If Share menu doesn‚Äôt appear ‚Äî long-press the image to Save/Share."
    }
  };

  let lang = 'en';
  try{
    const tgl = tg?.initDataUnsafe?.user?.language_code;
    if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
    else lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
  }catch(e){ lang='en'; }

  function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }
  function translateAll(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      if(locales[lang] && locales[lang][k] !== undefined) el.textContent = locales[lang][k];
    });
    updateThemeUI();
  }

  /* ---------- toast ---------- */
  let toastTimer=null;
  function showToast(msg){
    const el=document.getElementById('toast');
    el.textContent=msg;
    el.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>el.classList.remove('show'), 1200);
  }

  /* ---------- theme ---------- */
  const THEME_KEY='tc_theme_v10';
  function getInitialTheme(){
    const saved=localStorage.getItem(THEME_KEY);
    if(saved==='dark'||saved==='light') return saved;
    const tgScheme=(tg?.colorScheme||'').toLowerCase();
    if(tgScheme==='dark'||tgScheme==='light') return tgScheme;
    return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
  }
  function setTheme(theme){
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem(THEME_KEY, theme);
    updateThemeUI();
    drawAllIndicatorVisuals(lastIndicators);
  }
  function updateThemeUI(){
    const theme=document.documentElement.getAttribute('data-theme')||'dark';
    const icon=document.getElementById('theme_icon');
    const text=document.getElementById('theme_text');
    const btn=document.getElementById('theme_toggle');
    if(theme==='light'){
      icon.textContent='‚òÄÔ∏è';
      text.textContent=t('theme.light');
      btn.classList.add('active');
    }else{
      icon.textContent='üåô';
      text.textContent=t('theme.dark');
      btn.classList.remove('active');
    }
  }

  /* ---------- helpers ---------- */
  function safeNum(v){ const x=parseFloat(v); return Number.isFinite(x)?x:NaN; }
  function fmt(n, maxFrac=8){ return Number.isFinite(n)?n.toLocaleString(undefined,{maximumFractionDigits:maxFrac}):'‚Äî'; }
  function fmtMoney(n){ return Number.isFinite(n)?('$'+n.toLocaleString(undefined,{maximumFractionDigits:0})):'‚Äî'; }

  async function copyText(text){
    if(!text || text==='‚Äî') return false;
    try{
      if(navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta=document.createElement('textarea');
      ta.value=text;
      ta.setAttribute('readonly','');
      ta.style.position='fixed';
      ta.style.left='-9999px';
      document.body.appendChild(ta);
      ta.select();
      const ok=document.execCommand('copy');
      document.body.removeChild(ta);
      return !!ok;
    }catch(e){ return false; }
  }

  function haptic(type='impact', style='light'){
    try{
      if(!tg?.HapticFeedback) return;
      if(type==='impact') tg.HapticFeedback.impactOccurred(style);
      if(type==='notify') tg.HapticFeedback.notificationOccurred(style);
    }catch(e){}
  }

  /* ---------- language buttons ---------- */
  const btnRu=document.getElementById('btn_ru');
  const btnEn=document.getElementById('btn_en');
  function syncLangButtons(){
    if(lang==='ru'){ btnRu.classList.add('active'); btnEn.classList.remove('active'); }
    else { btnEn.classList.add('active'); btnRu.classList.remove('active'); }
  }
  btnRu.addEventListener('click', ()=>{ lang='ru'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); });
  btnEn.addEventListener('click', ()=>{ lang='en'; syncLangButtons(); translateAll(); renderHistory(); refreshAll(); });

  /* ---------- tabs ---------- */
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
      btn.classList.add('active');
      const target=btn.dataset.tab;
      document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
      document.getElementById(target)?.classList.add('active');
      if(target==='ind' && document.getElementById('tcap').textContent.trim()==='‚Äî') fetchIndicators();
    });
  });

  /* ---------- DCA rows ---------- */
  const dcaRowsEl=document.getElementById('dca_rows');
  const dcaAvgEl=document.getElementById('dca_avg');
  const dcaTotalVolEl=document.getElementById('dca_totalVol');
  const dcaTotalCostEl=document.getElementById('dca_totalCost');
  const dcaHintEl=document.getElementById('dca_hint');
  const dcaCopyBtn=document.getElementById('dca_copy');

  const dcaGoalPrice=document.getElementById('dca_goal_price');
  const dcaGoalAvg=document.getElementById('dca_goal_avg');
  const dcaFee=document.getElementById('dca_fee');
  const dcaNeedVol=document.getElementById('dca_needVol');
  const dcaNeedCost=document.getElementById('dca_needCost');
  const dcaGoalStatus=document.getElementById('dca_goalStatus');
  const dcaGoalHint=document.getElementById('dca_goal_hint');

  function dcaRowEl(price='', vol=''){
    const wrap=document.createElement('div');
    wrap.className='row';
    wrap.innerHTML=`
      <div class="col">
        <label data-i18n="dca.row.price">${t('dca.row.price')}</label>
        <input class="dca_price" type="number" inputmode="decimal" step="any" placeholder="0.00" value="${price}">
      </div>
      <div class="col">
        <label data-i18n="dca.row.vol">${t('dca.row.vol')}</label>
        <input class="dca_vol" type="number" inputmode="decimal" step="any" min="0" placeholder="0" value="${vol}">
      </div>
      <button class="mini dca_remove" type="button" aria-label="Remove">‚úï</button>
    `;
    return wrap;
  }
  function ensureRows(){
    if(dcaRowsEl.children.length===0){
      dcaRowsEl.appendChild(dcaRowEl());
      dcaRowsEl.appendChild(dcaRowEl());
      translateAll();
    }
  }

  function getDcaLegs(){
    const rows=[...dcaRowsEl.querySelectorAll('.row')];
    let valid=[], ignored=0;
    for(const r of rows){
      const p=safeNum(r.querySelector('.dca_price')?.value);
      const v=safeNum(r.querySelector('.dca_vol')?.value);
      if(Number.isFinite(p) && Number.isFinite(v) && v>0){
        valid.push({p,v});
      }else{
        const pv=(r.querySelector('.dca_price')?.value||'').trim();
        const vv=(r.querySelector('.dca_vol')?.value||'').trim();
        if(pv || vv) ignored++;
      }
    }
    return {valid, ignored};
  }

  function dcaBase(){
    const {valid}=getDcaLegs();
    if(!valid.length) return null;
    let totalVol=0,totalCost=0;
    for(const leg of valid){ totalVol+=leg.v; totalCost+=leg.p*leg.v; }
    return {totalVol,totalCost,avg: totalCost/totalVol};
  }

  function calcDCA(){
    const {valid, ignored}=getDcaLegs();
    if(!valid.length){
      dcaAvgEl.textContent='‚Äî';
      dcaTotalVolEl.textContent='‚Äî';
      dcaTotalCostEl.textContent='‚Äî';
      dcaHintEl.textContent=t('dca.hint.empty');
      dcaCopyBtn.disabled=true;
      calcDcaGoal(null);
      return;
    }
    let totalVol=0,totalCost=0;
    for(const leg of valid){ totalVol+=leg.v; totalCost+=leg.p*leg.v; }
    const avg=totalCost/totalVol;

    dcaAvgEl.textContent=fmt(avg, 8);
    dcaTotalVolEl.textContent=fmt(totalVol, 8);
    dcaTotalCostEl.textContent=fmtMoney(totalCost);
    dcaHintEl.textContent=ignored>0 ? t('dca.hint.partial') : '';
    dcaCopyBtn.disabled=false;

    scheduleSave('DCA', buildSummary('DCA', {avg, totalVol, totalCost}), {avg, totalVol, totalCost});
    calcDcaGoal({avg,totalVol,totalCost});
  }

  function calcDcaGoal(base){
    dcaNeedVol.textContent='‚Äî';
    dcaNeedCost.textContent='‚Äî';
    dcaGoalStatus.textContent=t('dca.goal.status.na');
    dcaGoalHint.textContent='';
    if(!base){ dcaGoalHint.textContent=t('dca.goal.hint.fill'); return; }

    const X=safeNum(dcaGoalPrice.value);
    const Y=safeNum(dcaGoalAvg.value);
    const feePct=safeNum(dcaFee.value);
    const fee=Number.isFinite(feePct)?Math.max(0, feePct)/100:0;

    if(!Number.isFinite(X) || !Number.isFinite(Y)){ dcaGoalHint.textContent=t('dca.goal.hint.fill'); return; }
    if(X===Y){ dcaGoalStatus.textContent=t('dca.goal.status.impossible'); return; }

    const Xeff=X*(1+fee);
    // base.avg == base.totalCost/base.totalVol
    if(Math.abs(base.avg - Y) / (Math.abs(Y) || 1) < 1e-12){
      dcaGoalStatus.textContent=t('dca.goal.status.already');
      dcaNeedVol.textContent='0';
      dcaNeedCost.textContent='$0';
      return;
    }

    const numerator=(Y*base.totalVol) - base.totalCost;
    const denom=(Xeff - Y);
    const v=numerator/denom;

    if(!Number.isFinite(v) || v<=0){
      dcaGoalStatus.textContent=t('dca.goal.status.impossible');
      return;
    }
    dcaNeedVol.textContent=fmt(v, 8);
    dcaNeedCost.textContent=fmtMoney(Xeff*v);
    dcaGoalStatus.textContent=t('dca.goal.status.ok');

    scheduleSave('DCA_GOAL', buildSummary('DCA_GOAL', {needVol:v, addPrice:X, targetAvg:Y}), {needVol:v, addPrice:X, targetAvg:Y});
  }

  document.getElementById('dca_add').addEventListener('click', ()=>{
    dcaRowsEl.appendChild(dcaRowEl());
    translateAll();
    calcDCA();
    haptic('impact','light');
  });
  document.getElementById('dca_clear').addEventListener('click', ()=>{
    dcaRowsEl.innerHTML='';
    ensureRows();
    calcDCA();
    haptic('notify','success');
  });
  dcaRowsEl.addEventListener('input', (e)=>{
    if(e.target.classList.contains('dca_price') || e.target.classList.contains('dca_vol')) calcDCA();
  });
  dcaRowsEl.addEventListener('click', (e)=>{
    const rm=e.target.closest('.dca_remove');
    if(!rm) return;
    const row=rm.closest('.row');
    if(row) row.remove();
    ensureRows();
    calcDCA();
    haptic('impact','light');
  });
  dcaCopyBtn.addEventListener('click', async ()=>{
    const ok=await copyText(dcaAvgEl.textContent.trim());
    if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
  });
  [dcaGoalPrice,dcaGoalAvg,dcaFee].forEach(el=>el.addEventListener('input', ()=>calcDcaGoal(dcaBase())));

  /* ---------- R/R ---------- */
  const rr_entry=document.getElementById('rr_entry');
  const rr_sl=document.getElementById('rr_sl');
  const rr_tp=document.getElementById('rr_tp');
  const rr_fee=document.getElementById('rr_fee');
  const rr_value=document.getElementById('rr_value');
  const rr_net=document.getElementById('rr_net');
  const rr_hint=document.getElementById('rr_hint');

  function calcRR(){
    rr_value.textContent='‚Äî';
    rr_net.textContent='‚Äî';
    rr_hint.textContent='';
    const e=safeNum(rr_entry.value), sl=safeNum(rr_sl.value), tp=safeNum(rr_tp.value);
    const feePct=safeNum(rr_fee.value);
    const fee=Number.isFinite(feePct)?Math.max(0, feePct)/100:0;

    if([e,sl,tp].some(x=>Number.isNaN(x))) return;
    if(e===sl) return;

    const risk=Math.abs(e-sl);
    const reward=Math.abs(tp-e);
    if(!(risk>0)) return;

    const gross=(reward/risk);
    rr_value.textContent=`1:${gross.toFixed(2)}`;

    const riskNet=risk + fee*(Math.abs(e)+Math.abs(sl));
    const rewardNet=reward - fee*(Math.abs(e)+Math.abs(tp));
    rr_net.textContent = (rewardNet<=0)?'0.00':(rewardNet/riskNet).toFixed(2);

    scheduleSave('RR', buildSummary('RR', {gross, net:parseFloat(rr_net.textContent)}), {gross, net:parseFloat(rr_net.textContent)});
  }
  [rr_entry,rr_sl,rr_tp,rr_fee].forEach(el=>el.addEventListener('input', calcRR));
  document.getElementById('rr_clear').addEventListener('click', ()=>{
    rr_entry.value=''; rr_sl.value=''; rr_tp.value=''; rr_fee.value='';
    calcRR();
    haptic('notify','success');
  });

  /* ---------- Capital ---------- */
  const cap_dep=document.getElementById('cap_dep');
  const cap_risk=document.getElementById('cap_risk');
  const cap_entry=document.getElementById('cap_entry');
  const cap_sl=document.getElementById('cap_sl');
  const cap_fee=document.getElementById('cap_fee');
  const cap_lev=document.getElementById('cap_lev');

  const cap_value=document.getElementById('cap_value');
  const cap_riskUsd=document.getElementById('cap_riskUsd');
  const cap_margin=document.getElementById('cap_margin');
  const cap_hint=document.getElementById('cap_hint');

  function calcCap(){
    cap_value.textContent='‚Äî';
    cap_riskUsd.textContent='‚Äî';
    cap_margin.textContent='‚Äî';
    cap_hint.textContent='';

    const dep=safeNum(cap_dep.value);
    const rp=safeNum(cap_risk.value);
    const e=safeNum(cap_entry.value);
    const sl=safeNum(cap_sl.value);
    const feePct=safeNum(cap_fee.value);
    const fee=Number.isFinite(feePct)?Math.max(0, feePct)/100:0;
    const levRaw=safeNum(cap_lev.value);
    const lev=Number.isFinite(levRaw)?Math.max(1, levRaw):1;

    if([dep,rp,e,sl].some(x=>Number.isNaN(x))) return;
    if(dep<=0) return;
    if(rp<=0 || rp>100) return;
    if(e===sl) return;

    const riskUsd = dep*(rp/100);
    const perUnit = Math.abs(e-sl) + fee*(Math.abs(e)+Math.abs(sl));
    const size = riskUsd/perUnit;
    if(!Number.isFinite(size) || size<=0) return;

    cap_value.textContent=size.toFixed(8);
    cap_riskUsd.textContent='$'+riskUsd.toFixed(2);
    cap_margin.textContent=fmtMoney(Math.abs(size*e)/lev);

    scheduleSave('CAP', buildSummary('CAP', {size, riskUsd, margin:Math.abs(size*e)/lev}), {size, riskUsd, margin:Math.abs(size*e)/lev});
  }
  [cap_dep,cap_risk,cap_entry,cap_sl,cap_fee,cap_lev].forEach(el=>el.addEventListener('input', calcCap));
  document.getElementById('cap_clear').addEventListener('click', ()=>{
    cap_dep.value=''; cap_risk.value=''; cap_entry.value=''; cap_sl.value=''; cap_fee.value=''; cap_lev.value='';
    calcCap();
    haptic('notify','success');
  });
  document.querySelectorAll('.cap_preset').forEach(b=>b.addEventListener('click', ()=>{
    cap_risk.value=b.dataset.v;
    calcCap();
    haptic('impact','light');
  }));

  /* ---------- Indicators ---------- */
  const fgEl=document.getElementById('fg_value');
  const tcapEl=document.getElementById('tcap');
  const altDomEl=document.getElementById('alt_dom');
  const moodEl=document.getElementById('mood_value');
  const indNote=document.getElementById('ind_note');

  const fgVizText=document.getElementById('fg_viz_text');
  const capVizText=document.getElementById('cap_viz_text');
  const altVizText=document.getElementById('alt_viz_text');

  const IND_CACHE_KEY='tc_ind_cache_v10';
  const IND_CACHE_TTL=60_000;
  let indBusy=false;
  let lastIndicators=null;

  function cacheGet(){ try{ return JSON.parse(localStorage.getItem(IND_CACHE_KEY)||'null'); }catch(e){ return null; } }
  function cacheSet(data){ localStorage.setItem(IND_CACHE_KEY, JSON.stringify({t:Date.now(), data})); }

  function computeMood(fng, alt){
    if(!Number.isFinite(fng) || !Number.isFinite(alt)) return '‚Äî';
    if(fng>=60 && alt>=55) return 'üü¢ Risk-on';
    if(fng<=40 && alt<=45) return 'üî¥ Risk-off';
    return 'üü° Neutral';
  }
  function applyIndicators(d){
    const fgText = d.fgText || '‚Äî';
    fgEl.textContent=fgText;
    tcapEl.textContent = d.totalMc ? fmtMoney(Number(d.totalMc)) : '‚Äî';
    altDomEl.textContent = (typeof d.altDom==='number') ? (d.altDom.toFixed(2)+'%') : '‚Äî';
    moodEl.textContent = computeMood(d.fngValue, d.altDom);

    fgVizText.textContent = Number.isFinite(d.fngValue) ? String(d.fngValue) : '‚Äî';
    capVizText.textContent = d.totalMc ? fmtMoney(Number(d.totalMc)) : '‚Äî';
    altVizText.textContent = (typeof d.altDom==='number') ? (d.altDom.toFixed(2)+'%') : '‚Äî';

    lastIndicators=d;
    drawAllIndicatorVisuals(d);
  }

  async function fetchIndicators(){
    if(indBusy) return;
    indBusy=true;
    indNote.textContent=t('ind.loading');

    const c=cacheGet();
    if(c && (Date.now()-c.t)<IND_CACHE_TTL){
      applyIndicators(c.data);
      indNote.textContent=t('ind.cached');
      indBusy=false;
      return;
    }

    const out={fgText:null, fngValue:NaN, totalMc:null, altDom:NaN};
    let err=false;

    try{
      const r=await fetch('https://api.alternative.me/fng/?limit=1&format=json', {cache:'no-store'});
      if(!r.ok) throw new Error('fng');
      const j=await r.json();
      const d=j?.data?.[0];
      if(d?.value){
        out.fngValue=Number(d.value);
        out.fgText=`${d.value} ¬∑ ${d.value_classification||''}`.trim();
      }
    }catch(e){ err=true; }

    try{
      const r=await fetch('https://api.coingecko.com/api/v3/global', {cache:'no-store'});
      if(!r.ok) throw new Error('cg');
      const j=await r.json();
      out.totalMc = j?.data?.total_market_cap?.usd ?? null;
      const btcDom = (typeof j?.data?.market_cap_percentage?.btc==='number') ? j.data.market_cap_percentage.btc : null;
      if(typeof btcDom==='number') out.altDom = 100 - btcDom;
    }catch(e){ err=true; }

    applyIndicators(out);
    cacheSet(out);
    indNote.textContent = err ? t('ind.rate') : '';
    indBusy=false;
  }
  document.getElementById('refresh_ind').addEventListener('click', ()=>{
    try{ localStorage.removeItem(IND_CACHE_KEY); }catch(e){}
    fetchIndicators();
    haptic('impact','light');
  });

  /* indicator drawing */
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function setupCanvas(canvas){
    const dpr=window.devicePixelRatio||1;
    const w=Math.max(10, canvas.clientWidth);
    const h=Math.max(10, canvas.clientHeight);
    canvas.width=Math.floor(w*dpr);
    canvas.height=Math.floor(h*dpr);
    const ctx=canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx,w,h};
  }
  function roundRect(ctx,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }
  function mix(a,b,t){
    try{
      const c=document.createElement('canvas'); c.width=c.height=1;
      const x=c.getContext('2d');
      x.fillStyle=a; x.fillRect(0,0,1,1); const A=x.getImageData(0,0,1,1).data;
      x.clearRect(0,0,1,1);
      x.fillStyle=b; x.fillRect(0,0,1,1); const B=x.getImageData(0,0,1,1).data;
      const r=Math.round(A[0]+(B[0]-A[0])*t);
      const g=Math.round(A[1]+(B[1]-A[1])*t);
      const bl=Math.round(A[2]+(B[2]-A[2])*t);
      return `rgb(${r},${g},${bl})`;
    }catch(e){ return b; }
  }
  function drawFG(value){
    const canvas=document.getElementById('fg_canvas');
    const {ctx,w,h}=setupCanvas(canvas);
    const bg=cssVar('--result-bg'), border=cssVar('--border'), muted=cssVar('--muted'), text=cssVar('--text'), accent=cssVar('--accent'), danger=cssVar('--danger');

    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle=border; ctx.lineWidth=2; ctx.strokeRect(1,1,w-2,h-2);

    const cx=w/2, cy=h*0.86, r=Math.min(w*0.38, h*0.8);
    ctx.beginPath();
    ctx.strokeStyle=mix(muted,border,.55);
    ctx.lineWidth=12; ctx.lineCap='round';
    ctx.arc(cx,cy,r,Math.PI,0,false);
    ctx.stroke();

    if(Number.isFinite(value)){
      const v=Math.max(0,Math.min(100,value));
      const end=Math.PI-(Math.PI*(v/100));
      ctx.beginPath();
      ctx.strokeStyle= v<35?danger:(v>65?accent:mix(accent,muted,.55));
      ctx.lineWidth=12; ctx.lineCap='round';
      ctx.arc(cx,cy,r,Math.PI,end,false);
      ctx.stroke();

      const ang=Math.PI-(Math.PI*(v/100));
      const nx=cx+Math.cos(ang)*(r-8);
      const ny=cy+Math.sin(ang)*(r-8);
      ctx.beginPath();
      ctx.strokeStyle=text; ctx.lineWidth=3;
      ctx.moveTo(cx,cy); ctx.lineTo(nx,ny); ctx.stroke();
      ctx.beginPath();
      ctx.fillStyle=text; ctx.arc(cx,cy,5,0,Math.PI*2); ctx.fill();

      ctx.fillStyle=text; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='center';
      ctx.fillText(`F&G: ${v}`, cx, 26);

      ctx.fillStyle=muted; ctx.font='700 12px Inter, Arial, sans-serif';
      const lbl = v<=25?'Extreme Fear':v<=45?'Fear':v<=55?'Neutral':v<=75?'Greed':'Extreme Greed';
      ctx.fillText(lbl, cx, 46);
    }else{
      ctx.fillStyle=muted; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='center';
      ctx.fillText('‚Äî', cx, 30);
    }
  }
  function drawCap(totalMc){
    const canvas=document.getElementById('cap_canvas');
    const {ctx,w,h}=setupCanvas(canvas);
    const bg=cssVar('--result-bg'), border=cssVar('--border'), muted=cssVar('--muted'), text=cssVar('--text'), accent=cssVar('--accent');

    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle=border; ctx.lineWidth=2; ctx.strokeRect(1,1,w-2,h-2);

    const pad=14;
    const barX=pad, barY=h/2-10, barW=w-pad*2, barH=20;

    ctx.fillStyle=mix(muted,border,.75);
    roundRect(ctx, barX, barY, barW, barH, 10); ctx.fill();

    if(Number.isFinite(totalMc) && totalMc>0){
      const max=10_000_000_000_000;
      const norm=Math.min(1, Math.log10(totalMc)/Math.log10(max));
      const fillW=Math.max(8, barW*norm);
      ctx.fillStyle=accent;
      roundRect(ctx, barX, barY, fillW, barH, 10); ctx.fill();

      ctx.fillStyle=text; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='left';
      ctx.fillText('Total Cap', barX, 28);
      ctx.fillStyle=muted; ctx.font='700 12px Inter, Arial, sans-serif';
      ctx.fillText('log scale (0..10T)', barX, 46);
    }else{
      ctx.fillStyle=muted; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='center';
      ctx.fillText('‚Äî', w/2, h/2+6);
    }
  }
  function drawAlt(altDom){
    const canvas=document.getElementById('alt_canvas');
    const {ctx,w,h}=setupCanvas(canvas);
    const bg=cssVar('--result-bg'), border=cssVar('--border'), muted=cssVar('--muted'), text=cssVar('--text'), accent=cssVar('--accent');

    ctx.fillStyle=bg; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle=border; ctx.lineWidth=2; ctx.strokeRect(1,1,w-2,h-2);

    const cx=w/2, cy=h/2+6, r=Math.min(w,h)*0.28;

    ctx.beginPath();
    ctx.strokeStyle=mix(muted,border,.65);
    ctx.lineWidth=16;
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.stroke();

    if(Number.isFinite(altDom)){
      const v=Math.max(0,Math.min(100,altDom));
      const start=-Math.PI/2;
      const end=start+(Math.PI*2)*(v/100);

      ctx.beginPath();
      ctx.strokeStyle=accent;
      ctx.lineWidth=16;
      ctx.lineCap='round';
      ctx.arc(cx,cy,r,start,end);
      ctx.stroke();

      ctx.fillStyle=text; ctx.font='900 18px Inter, Arial, sans-serif'; ctx.textAlign='center';
      ctx.fillText(`${v.toFixed(2)}%`, cx, 28);

      ctx.fillStyle=muted; ctx.font='700 12px Inter, Arial, sans-serif';
      ctx.fillText('Alt dominance', cx, 46);
    }else{
      ctx.fillStyle=muted; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='center';
      ctx.fillText('‚Äî', cx, cy+6);
    }
  }
  function drawAllIndicatorVisuals(d){
    if(!d){ drawFG(NaN); drawCap(NaN); drawAlt(NaN); return; }
    drawFG(d.fngValue);
    drawCap(Number(d.totalMc));
    drawAlt(d.altDom);
  }

  /* ---------- History (no export; clear must work) ---------- */
  const HISTORY_KEY='tc_history_v10';
  const historyList=document.getElementById('history_list');

  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]') || []; }catch(e){ return []; } }
  function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
  function pushHistory(item){
    const arr=loadHistory();
    arr.unshift(item);
    if(arr.length>120) arr.pop();
    saveHistory(arr);
    renderHistory();
  }

  function buildSummary(type, data){
    if(type==='DCA') return `AVG ${fmt(data.avg,8)} ¬∑ vol ${fmt(data.totalVol,8)} ¬∑ cost ${fmtMoney(data.totalCost)}`;
    if(type==='DCA_GOAL') return `Need ${fmt(data.needVol,8)} @ ${data.addPrice} ‚Üí avg ${data.targetAvg}`;
    if(type==='RR') return `Gross 1:${data.gross.toFixed(2)} ¬∑ Net ${Number.isFinite(data.net)?data.net.toFixed(2):'‚Äî'}`;
    if(type==='CAP') return `Size ${data.size.toFixed(8)} ¬∑ Risk ${data.riskUsd.toFixed(2)} ¬∑ Margin ${fmtMoney(data.margin)}`;
    if(type==='IND') return `F&G ${fgEl.textContent} ¬∑ Alt ${altDomEl.textContent} ¬∑ Mood ${moodEl.textContent}`;
    return '';
  }

  function scheduleSave(type, summary, payload){
    // debounce per type
    scheduleSave._t = scheduleSave._t || {};
    scheduleSave._last = scheduleSave._last || {};
    clearTimeout(scheduleSave._t[type]);
    scheduleSave._t[type]=setTimeout(()=>{
      const key = JSON.stringify(payload || {});
      if(scheduleSave._last[type] === key) return;
      scheduleSave._last[type] = key;
      pushHistory({
        id: String(Date.now()) + '_' + Math.random().toString(16).slice(2),
        type,
        summary,
        t: Date.now(),
        payload
      });
    }, 650);
  }

  function renderHistory(){
    const arr=loadHistory();
    historyList.innerHTML='';
    if(!arr.length){
      const el=document.createElement('div');
      el.className='note';
      el.textContent=t('hist.note');
      historyList.appendChild(el);
      return;
    }
    for(const it of arr){
      const card=document.createElement('div');
      card.className='hitem';
      const when=new Date(it.t).toLocaleString();
      card.innerHTML=`
        <div class="hitem-top">
          <div class="hitem-title">${escapeHtml(it.type || '')}</div>
          <div class="hitem-actions">
            <button class="btn small" type="button" data-action="card" data-id="${it.id}">${lang==='ru'?'–ö–∞—Ä—Ç–æ—á–∫–∞':'Card'}</button>
          </div>
        </div>
        <div class="note">${escapeHtml(it.summary || '')}</div>
        <div class="small">${escapeHtml(when)}</div>
      `;
      historyList.appendChild(card);
    }
  }

  document.getElementById('clear_history').addEventListener('click', ()=>{
    try{
      localStorage.removeItem(HISTORY_KEY);
    }catch(e){}
    renderHistory();
    showToast(t('toast.saved'));
    haptic('notify','success');
  });

  historyList.addEventListener('click', (e)=>{
    const btn=e.target.closest('button[data-action="card"]');
    if(!btn) return;
    const id=btn.getAttribute('data-id');
    const arr=loadHistory();
    const it=arr.find(x=>x.id===id);
    if(!it) return;
    exportCardPNG({fromHistory:true, item:it});
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c]));
  }

  /* ---------- Modal for PNG (no open) ---------- */
  const modalOverlay=document.getElementById('modalOverlay');
  const modalTitle=document.getElementById('modalTitle');
  const modalImg=document.getElementById('modalImg');
  const modalHint=document.getElementById('modalHint');
  const modalClose=document.getElementById('modalClose');
  const modalOk=document.getElementById('modalOk');
  const modalCopySummary=document.getElementById('modalCopySummary');
  const modalShare=document.getElementById('modalShare');

  let modalState={ blob:null, filename:null, summary:'' };

  function openModal({title, url, blob, filename, summary}){
    modalTitle.textContent=title || 'Trade Card';
    modalImg.src=url;
    modalHint.textContent=t('modal.hint');
    modalOverlay.classList.add('show');
    modalState={ blob, filename, summary: summary || '' };
  }
  function closeModal(){ modalOverlay.classList.remove('show'); }
  modalClose.addEventListener('click', closeModal);
  modalOk.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', (e)=>{ if(e.target===modalOverlay) closeModal(); });

  modalCopySummary.addEventListener('click', async ()=>{
    const ok=await copyText(modalState.summary || '');
    if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
  });

  function canShareFiles(blob, filename, mime){
    try{
      const f=new File([blob], filename, {type:mime});
      return !!(navigator.canShare && navigator.canShare({files:[f]}) && navigator.share);
    }catch(e){ return false; }
  }
  async function shareFile(blob, filename, mime, title){
    try{
      const f=new File([blob], filename, {type:mime});
      if(navigator.canShare && navigator.canShare({files:[f]}) && navigator.share){
        await navigator.share({files:[f], title:title||filename});
        haptic('notify','success');
        return true;
      }
    }catch(e){}
    return false;
  }
  modalShare.addEventListener('click', async ()=>{
    if(!modalState.blob) return;
    const ok = await shareFile(modalState.blob, modalState.filename || 'trade_card.png', 'image/png', modalTitle.textContent);
    if(!ok){
      // fallback: copy summary
      const copied = await copyText(modalState.summary || '');
      if(copied) showToast(t('toast.copied'));
    }
  });

  /* ---------- Trade Card PNG (current tab + history item) ---------- */
  function activeTab(){ return document.querySelector('.tab.active')?.dataset?.tab || 'dca'; }

  function cardPayloadFromCurrent(){
    const tab=activeTab();
    const dt=new Date().toLocaleString();
    let lines=[];
    let summary='';
    if(tab==='dca'){
      const base=dcaBase();
      if(!base) return null;
      lines.push(['AVG', fmt(base.avg,8)]);
      lines.push(['VOL', fmt(base.totalVol,8)]);
      lines.push(['COST', fmtMoney(base.totalCost)]);
      const goalVol=dcaNeedVol.textContent.trim();
      if(goalVol && goalVol!=='‚Äî'){
        lines.push(['GOAL NEED', goalVol]);
        lines.push(['GOAL COST', dcaNeedCost.textContent.trim()]);
        lines.push(['STATUS', dcaGoalStatus.textContent.trim()]);
      }
      summary=buildSummary('DCA', base);
    }else if(tab==='rr'){
      const g=rr_value.textContent.trim();
      if(g==='‚Äî') return null;
      const gross=parseFloat(g.split(':')[1]||'');
      const net=parseFloat(rr_net.textContent.trim());
      lines.push(['GROSS', g]);
      lines.push(['NET', Number.isFinite(net)?net.toFixed(2):rr_net.textContent.trim()]);
      summary=buildSummary('RR', {gross:Number.isFinite(gross)?gross:0, net});
    }else if(tab==='cap'){
      const s=cap_value.textContent.trim();
      if(s==='‚Äî') return null;
      lines.push(['SIZE', s]);
      lines.push(['RISK', cap_riskUsd.textContent.trim()]);
      lines.push(['MARGIN', cap_margin.textContent.trim()]);
      summary = `Size ${s} ¬∑ Risk ${cap_riskUsd.textContent.trim()} ¬∑ Margin ${cap_margin.textContent.trim()}`;
    }else if(tab==='ind'){
      if(fgEl.textContent.trim()==='‚Äî' && altDomEl.textContent.trim()==='‚Äî') return null;
      lines.push(['F&G', fgEl.textContent.trim()]);
      lines.push(['ALT DOM', altDomEl.textContent.trim()]);
      lines.push(['MOOD', moodEl.textContent.trim()]);
      summary = buildSummary('IND', {});
    }
    return { title:'Trader Calculator', subtitle:`${tab.toUpperCase()} ¬∑ ${dt}`, lines, summary, tab };
  }

  function cardPayloadFromHistory(item){
    const dt=new Date(item.t).toLocaleString();
    const type=item.type || 'HISTORY';
    const p=item.payload || {};
    let lines=[];
    if(type==='DCA'){
      lines.push(['AVG', fmt(p.avg,8)]);
      lines.push(['VOL', fmt(p.totalVol,8)]);
      lines.push(['COST', fmtMoney(p.totalCost)]);
    }else if(type==='DCA_GOAL'){
      lines.push(['NEED', fmt(p.needVol,8)]);
      lines.push(['PRICE', String(p.addPrice ?? '‚Äî')]);
      lines.push(['TARGET', String(p.targetAvg ?? '‚Äî')]);
    }else if(type==='RR'){
      lines.push(['GROSS', `1:${(p.gross ?? 0).toFixed(2)}`]);
      lines.push(['NET', Number.isFinite(p.net)?p.net.toFixed(2):'‚Äî']);
    }else if(type==='CAP'){
      lines.push(['SIZE', Number.isFinite(p.size)?p.size.toFixed(8):'‚Äî']);
      lines.push(['RISK', Number.isFinite(p.riskUsd)?('$'+p.riskUsd.toFixed(2)):'‚Äî']);
      lines.push(['MARGIN', Number.isFinite(p.margin)?fmtMoney(p.margin):'‚Äî']);
    }else{
      lines.push(['RESULT', item.summary || '‚Äî']);
    }
    return { title:'Trader Calculator', subtitle:`${type} ¬∑ ${dt}`, lines, summary:item.summary || '', tab:type };
  }

  function roundRectPath(ctx,x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  async function exportCardPNG(opts){
    const fromHistory=opts?.fromHistory;
    const payload = fromHistory ? cardPayloadFromHistory(opts.item) : cardPayloadFromCurrent();
    if(!payload){
      try{ tg?.showAlert?.(lang==='ru' ? '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏' : 'No data for card'); }catch(e){}
      return;
    }

    const W=1080,H=1080,scale=2;
    const canvas=document.createElement('canvas');
    canvas.width=W*scale;
    canvas.height=H*scale;
    const ctx=canvas.getContext('2d');
    ctx.scale(scale,scale);

    const bg=cssVar('--bg')||'#000';
    const panel=cssVar('--panel')||'#0b0b0b';
    const border=cssVar('--border')||'#151515';
    const text=cssVar('--text')||'#fff';
    const muted=cssVar('--muted')||'#9a9a9a';
    const accent=cssVar('--accent')||'#7CFC00';

    ctx.fillStyle=bg;
    ctx.fillRect(0,0,W,H);

    const pad=70;
    const x=pad,y=pad,w=W-pad*2,h=H-pad*2;

    ctx.fillStyle=panel;
    roundRectPath(ctx,x,y,w,h,36); ctx.fill();

    ctx.strokeStyle=border; ctx.lineWidth=3; ctx.stroke();

    ctx.fillStyle=accent;
    roundRectPath(ctx,x+28,y+28,10,h-56,10); ctx.fill();

    ctx.fillStyle=text;
    ctx.font='900 54px Inter, Arial, sans-serif';
    ctx.fillText(payload.title, x+60, y+90);

    ctx.fillStyle=muted;
    ctx.font='700 28px Inter, Arial, sans-serif';
    ctx.fillText(payload.subtitle, x+60, y+135);

    let yy=y+210;
    const left=x+60;
    const right=x+w-60;

    ctx.font='800 34px Inter, Arial, sans-serif';
    for(const row of payload.lines.slice(0,12)){
      const k=String(row[0]||'');
      const v=String(row[1]||'');
      ctx.fillStyle=muted; ctx.textAlign='left';
      ctx.fillText(k, left, yy);

      ctx.fillStyle=text; ctx.textAlign='right';
      // truncate too long values
      let vv=v;
      while(ctx.measureText(vv).width>520 && vv.length>3) vv = vv.slice(0,-2) + '‚Ä¶';
      ctx.fillText(vv, right, yy);
      yy+=70;
    }

    ctx.textAlign='left';
    ctx.fillStyle=muted;
    ctx.font='700 26px Inter, Arial, sans-serif';
    ctx.fillText('@InvestTraderTrade', x+60, y+h-60);

    ctx.textAlign='right';
    ctx.fillText('Trader Calculator', x+w-60, y+h-60);

    const blob = await new Promise(res=>canvas.toBlob(res, 'image/png'));
    if(!blob){
      try{ tg?.showAlert?.('PNG error'); }catch(e){}
      return;
    }

    const url = URL.createObjectURL(blob);
    const filename = `trade_card_${payload.tab}_${Date.now()}.png`;
    openModal({
      title: fromHistory ? (lang==='ru'?'–ö–∞—Ä—Ç–æ—á–∫–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏':'History card') : 'Trade Card',
      url, blob, filename, summary: payload.summary
    });

    // revoke later
    setTimeout(()=>URL.revokeObjectURL(url), 120000);
  }

  document.getElementById('card_btn').addEventListener('click', ()=>{ exportCardPNG({fromHistory:false}); });

  /* ---------- Share text (clipboard / share sheet) ---------- */
  document.getElementById('share_btn').addEventListener('click', async ()=>{
    const tab=activeTab();
    let text='üìä Trader Calculator\n';
    if(tab==='dca'){
      text += `DCA AVG: ${dcaAvgEl.textContent}\nVOL: ${dcaTotalVolEl.textContent}\nCOST: ${dcaTotalCostEl.textContent}\n`;
      if(dcaNeedVol.textContent.trim()!=='‚Äî') text += `\nüéØ Goal\nNeed: ${dcaNeedVol.textContent}\nCost: ${dcaNeedCost.textContent}\n`;
    }else if(tab==='rr'){
      text += `Gross: ${rr_value.textContent}\nNet: ${rr_net.textContent}\n`;
    }else if(tab==='cap'){
      text += `Size: ${cap_value.textContent}\nRisk: ${cap_riskUsd.textContent}\nMargin: ${cap_margin.textContent}\n`;
    }else if(tab==='ind'){
      text += `F&G: ${fgEl.textContent}\nAlt dom: ${altDomEl.textContent}\nMood: ${moodEl.textContent}\n`;
    }
    try{
      if(navigator.share){
        await navigator.share({text, title:'Trader Calculator'});
        haptic('notify','success');
        return;
      }
    }catch(e){}
    const ok=await copyText(text);
    if(ok){ showToast(t('toast.copied')); haptic('notify','success'); }
  });

  /* ---------- theme button ---------- */
  document.getElementById('theme_toggle').addEventListener('click', ()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'dark';
    setTheme(cur==='dark'?'light':'dark');
    haptic('impact','light');
  });

  /* ---------- footer links ---------- */
  function openUrl(url){
    try{
      if(tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url);
      if(tg?.openLink) return tg.openLink(url);
    }catch(e){}
    window.open(url,'_blank','noopener');
  }
  document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
  document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

  /* ---------- init ---------- */
  function refreshAll(){ calcDCA(); calcRR(); calcCap(); }
  window.refreshAll = refreshAll; // for safety

  setTheme(getInitialTheme());
  syncLangButtons();
  translateAll();

  ensureRows();
  renderHistory();

  calcDCA(); calcRR(); calcCap();
  fetchIndicators();
  drawAllIndicatorVisuals(null);

  // redraw canvases on resize
  let resizeTimer=null;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer);
    resizeTimer=setTimeout(()=>drawAllIndicatorVisuals(lastIndicators), 150);
  });
})();
</script>
</body>
</html>
