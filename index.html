<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator + Indicators</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#000000;
  --panel:#0b0b0b;
  --border:#151515;
  --text:#ffffff;
  --muted:#9a9a9a;
  --accent:#7CFC00;
  --danger:#ff4d4f;
  --input-bg:#070707;
  --result-bg:#060606;
  --chip-bg:#0a0a0a;
  --shadow:0 12px 40px rgba(0,0,0,.45);
}
:root[data-theme="light"]{
  --bg:#ffffff;
  --panel:#f6f6f6;
  --border:#e6e6e6;
  --text:#111111;
  --muted:#666666;
  --accent:#0bbf5e;
  --danger:#d9363e;
  --input-bg:#ffffff;
  --result-bg:#ffffff;
  --chip-bg:#f1f1f1;
  --shadow:0 12px 40px rgba(0,0,0,.12);
}
*{box-sizing:border-box;min-width:0}
html,body{margin:0;height:100%;width:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif;overflow:hidden}
body{padding-bottom:env(safe-area-inset-bottom);padding-top:env(safe-area-inset-top)}
#app{height:100vh;min-height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg);overflow-x:hidden}
.leftbar{display:flex;gap:8px;align-items:center}
.lang{display:flex;gap:6px;align-items:center}
.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer;border-radius:10px}
.lang button.active{color:var(--accent);border-color:var(--accent)}
.iconbtn{background:none;border:1px solid var(--border);color:var(--muted);padding:6px 10px;cursor:pointer;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.iconbtn:active{transform:translateY(1px)}
.iconbtn .ico{font-size:14px;line-height:1}
.iconbtn.active{border-color:var(--accent);color:var(--accent)}
.tabs{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-left:auto}
.tab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:10px}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
/* Hide scrollbars but keep scrolling */
main,.history-list{scrollbar-width:none;-ms-overflow-style:none}
main::-webkit-scrollbar,.history-list::-webkit-scrollbar{width:0;height:0}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;max-width:820px}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:10px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:12px;font-size:14px;outline:none}
.row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:10px;border:1px solid var(--border);border-radius:14px;background:var(--panel)}
.row .col{flex:1;min-width:130px}
.row .mini{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:14px;border:1px solid var(--border);background:var(--chip-bg);cursor:pointer;color:var(--muted)}
.result{margin-top:8px;padding:10px;border-radius:14px;background:var(--result-bg);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
.res-left{display:flex;flex-direction:column;gap:3px}
.res-label{color:var(--muted);font-size:12px}
.res-value{font-weight:900;font-size:14px}
.res-value.muted{color:var(--muted);font-weight:700}
.copyable{cursor:pointer;user-select:text}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{background:transparent;color:var(--accent);border:1px solid var(--border);padding:8px 10px;border-radius:14px;cursor:pointer;font-weight:800}
.btn.ghost{color:var(--muted)}
.btn.small{padding:6px 10px;border-radius:999px;font-weight:900}
.btn:active{transform:translateY(1px)}
.btn:disabled{opacity:.45;cursor:not-allowed}
.note{font-size:12px;color:var(--muted);line-height:1.35}
.small{font-size:11px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--chip-bg);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
.hr{height:1px;background:var(--border);margin:12px 0}
.viz-grid{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.viz{flex:1;min-width:240px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
.viz-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.viz-title b{font-size:12px}
.viz-title span{font-size:11px;color:var(--muted)}
.viz canvas{width:100%;height:140px;display:block;border-radius:12px;background:var(--result-bg);border:1px solid var(--border)}
.history{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px;max-width:420px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px}
.links{display:flex;gap:18px;margin-top:2px}
.rainbow{display:inline-block;font-weight:900;text-decoration:none;background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);background-size:400% 400%;-webkit-background-clip:text;color:transparent;animation:rain 3.5s linear infinite}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
@media(min-width:900px){main{flex-direction:row}}
#toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:999px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:9999;font-weight:900;font-size:13px}
#toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
#modalOverlay{position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px}
#modalOverlay.show{display:flex}
#modal{width:min(920px,100%);background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
#modalHeader{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border)}
#modalHeader b{font-size:14px}
#modalBody{padding:12px}
#modalFooter{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
#modalImg{width:100%;max-height:70vh;object-fit:contain;border-radius:14px;border:1px solid var(--border);background:var(--result-bg)}
#modalText{width:100%;min-height:260px;border-radius:14px;border:1px solid var(--border);background:var(--input-bg);color:var(--text);padding:10px;font-size:13px;resize:vertical}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="leftbar">
      <div class="lang">
        <button id="btn_ru" class="active">RU</button>
        <button id="btn_en">EN</button>
      </div>
      <button class="iconbtn" id="theme_toggle"><span class="ico" id="theme_icon">üåô</span><span class="small" id="theme_text" data-i18n="theme.dark">Dark</span></button>
      <button class="iconbtn" id="share_btn"><span class="ico">üìã</span><span class="small" data-i18n="share">Share</span></button>
      <button class="iconbtn" id="card_btn"><span class="ico">üñºÔ∏è</span><span class="small" data-i18n="cardpng">Card PNG</span></button>
    </div>
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1">
      <section id="dca" class="screen active">
        <div class="card">
          <div class="note" data-i18n="dca.tip">–°–æ–≤–µ—Ç‚Ä¶</div>
          <div style="height:10px"></div>
          <div id="dca_rows"></div>
          <div class="controls">
            <button class="btn" id="dca_add" data-i18n="dca.add">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥</button>
            <button class="btn ghost" id="dca_clear" data-i18n="common.clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="result">
            <div class="res-left">
              <span class="res-label" data-i18n="dca.avg">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</span>
              <span class="res-value muted" id="dca_avg" class="copyable">‚Äî</span>
            </div>
            <button class="btn small ghost" id="dca_copy" data-i18n="common.copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="chips">
            <span class="chip"><span data-i18n="dca.totalVol">–û–±—â–∏–π –æ–±—ä—ë–º</span>: <b id="dca_totalVol" class="copyable">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.totalCost">–°—É–º–º–∞</span>: <b id="dca_totalCost" class="copyable">‚Äî</b></span>
          </div>
          <div class="small" id="dca_hint" style="margin-top:8px"></div>
          <div class="hr"></div>
          <h4 style="margin:0 0 8px 0" data-i18n="dca.goal.title">DCA Goal</h4>
          <div class="note" data-i18n="dca.goal.note">‚Ä¶</div>
          <div style="height:10px"></div>
          <div class="row">
            <div class="col">
              <label data-i18n="dca.goal.price">–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)</label>
              <input id="dca_goal_price" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col">
              <label data-i18n="dca.goal.avg">–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)</label>
              <input id="dca_goal_avg" type="number" inputmode="decimal" step="any" placeholder="0.00">
            </div>
            <div class="col" style="min-width:160px">
              <label data-i18n="dca.goal.fee">–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %</label>
              <input id="dca_fee" type="number" inputmode="decimal" step="any" min="0" max="5" placeholder="0">
            </div>
          </div>
          <div class="chips">
            <span class="chip"><span data-i18n="dca.goal.needVol">–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å</span>: <b id="dca_needVol" class="copyable">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.needCost">–°—Ç–æ–∏–º–æ—Å—Ç—å</span>: <b id="dca_needCost" class="copyable">‚Äî</b></span>
            <span class="chip"><span data-i18n="dca.goal.status">–°—Ç–∞—Ç—É—Å</span>: <b id="dca_goalStatus">‚Äî</b></span>
          </div>
          <div class="small" id="dca_goal_hint" style="margin-top:8px"></div>
        </div>
      </section>

      <section id="rr" class="screen"><div class="card">
        <div class="row">
          <div class="col"><label data-i18n="rr.entry">Entry</label><input id="rr_entry" type="number" step="any"></div>
          <div class="col"><label data-i18n="rr.sl">Stop Loss</label><input id="rr_sl" type="number" step="any"></div>
          <div class="col"><label data-i18n="rr.tp">Take Profit</label><input id="rr_tp" type="number" step="any"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col"><label data-i18n="rr.fee">Fee %</label><input id="rr_fee" type="number" step="any"></div>
          <div class="col"><div class="note" data-i18n="rr.feeNote">‚Ä¶</div></div>
        </div>
        <div class="controls"><button class="btn ghost" id="rr_clear" data-i18n="common.clear">Clear</button></div>
        <div class="chips">
          <span class="chip"><span data-i18n="rr.gross">Gross</span>: <b id="rr_value" class="copyable">‚Äî</b></span>
          <span class="chip"><span data-i18n="rr.net">Net</span>: <b id="rr_net" class="copyable">‚Äî</b></span>
        </div>
        <div class="small" id="rr_hint" style="margin-top:8px"></div>
      </div></section>

      <section id="cap" class="screen"><div class="card">
        <div class="row">
          <div class="col"><label data-i18n="cap.dep">Deposit</label><input id="cap_dep" type="number" step="any"></div>
          <div class="col"><label data-i18n="cap.risk">Risk %</label><input id="cap_risk" type="number" step="any"></div>
          <div class="col"><label data-i18n="cap.entry">Entry</label><input id="cap_entry" type="number" step="any"></div>
          <div class="col"><label data-i18n="cap.sl">SL</label><input id="cap_sl" type="number" step="any"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col"><label data-i18n="cap.fee">Fee %</label><input id="cap_fee" type="number" step="any"></div>
          <div class="col"><label data-i18n="cap.lev">Leverage</label><input id="cap_lev" type="number" step="any"></div>
          <div class="col"><label data-i18n="cap.presets">Presets</label>
            <div class="controls" style="margin-top:0">
              <button class="btn small ghost cap_preset" data-v="0.5">0.5%</button>
              <button class="btn small ghost cap_preset" data-v="1">1%</button>
            </div>
          </div>
        </div>
        <div class="controls"><button class="btn ghost" id="cap_clear" data-i18n="common.clear">Clear</button></div>
        <div class="chips">
          <span class="chip"><span data-i18n="cap.pos">Size</span>: <b id="cap_value" class="copyable">‚Äî</b></span>
          <span class="chip"><span data-i18n="cap.riskUsd">Risk $</span>: <b id="cap_riskUsd" class="copyable">‚Äî</b></span>
          <span class="chip"><span data-i18n="cap.margin">Margin</span>: <b id="cap_margin" class="copyable">‚Äî</b></span>
        </div>
        <div class="small" id="cap_hint" style="margin-top:8px"></div>
      </div></section>

      <section id="ind" class="screen"><div class="card">
        <h3 style="margin:0 0 10px 0" data-i18n="ind.title">Indicators</h3>
        <div class="field"><label data-i18n="ind.fg.label">Fear & Greed</label>
          <div class="result"><div class="res-left"><span class="res-label" data-i18n="ind.fg.valueLabel">Value</span><span class="res-value muted" id="fg_value" class="copyable">‚Äî</span></div></div>
        </div>
        <div class="field"><label data-i18n="ind.tcap.label">Total Cap</label>
          <div class="result"><div class="res-left"><span class="res-label" data-i18n="ind.tcap.valueLabel">USD</span><span class="res-value muted" id="tcap" class="copyable">‚Äî</span></div></div>
        </div>
        <div class="field"><label data-i18n="ind.alt.label">Alt dom</label>
          <div class="result"><div class="res-left"><span class="res-label" data-i18n="ind.alt.valueLabel">Alt %</span><span class="res-value muted" id="alt_dom" class="copyable">‚Äî</span></div></div>
        </div>
        <div class="field"><label data-i18n="ind.mood.label">Market Mood</label>
          <div class="result"><div class="res-left"><span class="res-label" data-i18n="ind.mood.hint">Derived</span><span class="res-value muted" id="mood_value" class="copyable">‚Äî</span></div></div>
        </div>
        <div class="viz-grid">
          <div class="viz"><div class="viz-title"><b data-i18n="ind.viz.fg">F&G Gauge</b><span id="fg_viz_text">‚Äî</span></div><canvas id="fg_canvas"></canvas></div>
          <div class="viz"><div class="viz-title"><b data-i18n="ind.viz.cap">Market Cap</b><span id="cap_viz_text">‚Äî</span></div><canvas id="cap_canvas"></canvas></div>
          <div class="viz"><div class="viz-title"><b data-i18n="ind.viz.alt">Alt Dom</b><span id="alt_viz_text">‚Äî</span></div><canvas id="alt_canvas"></canvas></div>
        </div>
        <div class="controls" style="margin-top:12px"><button class="btn" id="refresh_ind" data-i18n="ind.refresh">Refresh</button></div>
        <div class="note" id="ind_note"></div>
      </div></section>
    </div>

    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>
      <div class="controls" style="margin-top:8px">
        <button class="btn ghost" id="clear_history" data-i18n="hist.clear">Clear</button>
        </div>
      <div class="note" data-i18n="hist.note">Saved locally</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">‚Ä¶</div>
    <div class="links">
      <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
      <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
    </div>
  </footer>
</div>

<div id="toast">‚Äî</div>

<div id="modalOverlay" role="dialog" aria-modal="true">
  <div id="modal">
    <div id="modalHeader">
      <b id="modalTitle">‚Äî</b>
      <button class="btn small ghost" id="modalClose">‚úï</button>
    </div>
    <div id="modalBody">
      <img id="modalImg" alt="preview" style="display:none" />
      <textarea id="modalText" style="display:none" readonly></textarea>
      <div class="note" id="modalHint" style="margin-top:10px"></div>
    </div>
    <div id="modalFooter">
      <button class="btn ghost" id="modalCopy" style="display:none" data-i18n="modal.copy">Copy</button>
      <button class="btn ghost" id="modalOpen" style="display:none" data-i18n="modal.open">Open</button>
      <button class="btn" id="modalShare" style="display:none" data-i18n="modal.share">Share</button>
      <button class="btn ghost" id="modalDownload" style="display:none" data-i18n="modal.download">Download</button>
      <button class="btn" id="modalOk" data-i18n="modal.ok">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
  try{ tg && tg.expand && tg.expand(); }catch(e){}
  try{ tg && tg.disableVerticalSwipes && tg.disableVerticalSwipes(); }catch(e){}

  // --- Global error reporting (helps when TG webview hides console) ---
  function reportErr(prefix, err){
    const msg = prefix + (err && err.message ? (": " + err.message) : (": " + String(err)));
    console.error(msg, err);
    try{
      if(tg && tg.showAlert) tg.showAlert(msg);
      else alert(msg);
    }catch(_){}
  }
  window.addEventListener('error', (e)=> reportErr('JS error', e.error || e.message));
  window.addEventListener('unhandledrejection', (e)=> reportErr('Promise error', e.reason || e));

  // --- Helpers ---
  const UA = navigator.userAgent || '';
  const IS_IOS = /iPad|iPhone|iPod/i.test(UA) || (UA.includes('Mac') && 'ontouchend' in document);
  const IN_TG = !!tg;

  function safeNum(v){
    const x = parseFloat(v);
    return Number.isFinite(x) ? x : NaN;
  }
  function fmt(n, maxFrac){
    if(!Number.isFinite(n)) return '‚Äî';
    return n.toLocaleString(undefined, { maximumFractionDigits: (maxFrac==null?8:maxFrac) });
  }
  function fmtMoney(n){
    if(!Number.isFinite(n)) return '‚Äî';
    return '$' + n.toLocaleString(undefined, { maximumFractionDigits:0 });
  }
  function haptic(kind, style){
    try{
      if(!tg || !tg.HapticFeedback) return;
      if(kind === 'impact') tg.HapticFeedback.impactOccurred(style || 'light');
      if(kind === 'notify') tg.HapticFeedback.notificationOccurred(style || 'success');
    }catch(_){}
  }

  // --- i18n ---
  const locales = {
  ru:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "theme.dark":"–¢—ë–º–Ω–∞—è","theme.light":"–°–≤–µ—Ç–ª–∞—è",
      "share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è","cardpng":"–ö–∞—Ä—Ç–æ—á–∫–∞ PNG",
      "common.clear":"–û—á–∏—Å—Ç–∏—Ç—å","common.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å","common.copiedToast":"–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!","common.opened":"–û—Ç–∫—Ä—ã—Ç–æ",
      "dca.tip":"–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Ö–æ–¥–æ–≤ ‚Äî –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É, –æ–±—â–∏–π –æ–±—ä—ë–º –∏ —Å—É–º–º—É.",
      "dca.add":"+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ö–æ–¥","dca.row.price":"–¶–µ–Ω–∞","dca.row.vol":"–û–±—ä—ë–º",
      "dca.avg":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞","dca.totalVol":"–û–±—â–∏–π –æ–±—ä—ë–º","dca.totalCost":"–°—É–º–º–∞",
      "dca.hint.empty":"–î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π –≤—Ö–æ–¥ (—Ü–µ–Ω–∞ + –æ–±—ä—ë–º > 0).",
      "dca.hint.partial":"–ß–∞—Å—Ç—å —Å—Ç—Ä–æ–∫ –Ω–µ —É—á—Ç–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å —Ü–µ–Ω—É/–æ–±—ä—ë–º).",
      "dca.goal.title":"DCA Goal: Target Average",
      "dca.goal.note":"–ü–æ—Å—á–∏—Ç–∞–π, —Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–ø–∏—Ç—å –ø–æ —Ü–µ–Ω–µ X, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é Y.",
      "dca.goal.price":"–¶–µ–Ω–∞ –¥–æ–∫—É–ø–∫–∏ (X)","dca.goal.avg":"–¶–µ–ª–µ–≤–∞—è —Å—Ä–µ–¥–Ω—è—è (Y)","dca.goal.fee":"–ö–æ–º–∏—Å—Å–∏—è –ø–æ–∫—É–ø–∫–∏ %",
      "dca.goal.needVol":"–ù—É–∂–Ω–æ –¥–æ–∫—É–ø–∏—Ç—å","dca.goal.needCost":"–°—Ç–æ–∏–º–æ—Å—Ç—å","dca.goal.status":"–°—Ç–∞—Ç—É—Å",
      "dca.goal.status.na":"‚Äî","dca.goal.status.ok":"–í–æ–∑–º–æ–∂–Ω–æ","dca.goal.status.already":"–£–∂–µ –Ω–∞ —Ü–µ–ª–∏","dca.goal.status.impossible":"–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏ —ç—Ç–æ–π —Ü–µ–Ω–µ",
      "dca.goal.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ X –∏ Y, –∏ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—Ö–æ–¥ –≤—ã—à–µ.",
      "dca.goal.hint.math":"–ï—Å–ª–∏ X = Y ‚Äî –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å, –ø–æ–º–µ–Ω—è–π –∑–Ω–∞—á–µ–Ω–∏—è.",

      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–ø—Ä–∏–º–µ—Ä–Ω–æ)","rr.feeNote":"Net R/R —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥+–≤—ã—Ö–æ–¥ –∫–æ–º–∏—Å—Å–∏—é –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ.",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "rr.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è","rr.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

      "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"–ö–æ–º–∏—Å—Å–∏—è % (–≤—Ö–æ–¥+–≤—ã—Ö–æ–¥)","cap.lev":"–ü–ª–µ—á–æ (–¥–ª—è –º–∞—Ä–∂–∏)","cap.presets":"–ë—ã—Å—Ç—Ä—ã–µ —Ä–∏—Å–∫–∏",
      "cap.pos":"–û–±—ä—ë–º –ø–æ–∑–∏—Ü–∏–∏","cap.riskUsd":"–†–∏—Å–∫ $","cap.margin":"–ú–∞—Ä–∂–∞ (–ø–ª–µ—á–æ)",
      "cap.hint.fill":"–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è","cap.hint.invalid":"–ü—Ä–æ–≤–µ—Ä—å –∑–Ω–∞—á–µ–Ω–∏—è","cap.hint.riskRange":"–†–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0‚Äì100%","cap.hint.entryEqSl":"Entry –∏ SL –Ω–µ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å",

      "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
      "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)","ind.tcap.valueLabel":"USD",
      "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy Altseason)","ind.alt.valueLabel":"Alt %",
      "ind.mood.label":"Market Mood","ind.mood.hint":"–ù–∞ –æ—Å–Ω–æ–≤–µ F&G + –¥–æ–º–∏–Ω–∞—Ü–∏–∏ –∞–ª—å—Ç–æ–≤",
      "ind.refresh":"–û–±–Ω–æ–≤–∏—Ç—å","ind.loading":"–û–±–Ω–æ–≤–ª—è—é‚Ä¶","ind.cached":"–ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞","ind.rate":"–õ–∏–º–∏—Ç/–æ—à–∏–±–∫–∞ API ‚Äî –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ",
      "ind.viz.fg":"F&G Gauge","ind.viz.cap":"Market Cap","ind.viz.alt":"Alt Dom",

      "hist.title":"–ò—Å—Ç–æ—Ä–∏—è","hist.clear":"–û—á–∏—Å—Ç–∏—Ç—å","hist.export":"–≠–∫—Å–ø–æ—Ä—Ç .txt","hist.note":"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ",
    "hist.nocard":"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏",
    "hist.card":"–ö–∞—Ä—Ç–æ—á–∫–∞",
      "footer.tags":"–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì",

      "modal.ok":"OK","modal.copy":"–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å","modal.open":"–û—Ç–∫—Ä—ã—Ç—å","modal.share":"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è","modal.download":"–°–∫–∞—á–∞—Ç—å",
      "file.hint.image":"–ï—Å–ª–∏ –º–µ–Ω—é ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å ‚Äî –∑–∞–∂–º–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –≤—ã–±–µ—Ä–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.",
      "file.hint.text":"–ï—Å–ª–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –Ω–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª –∏–ª–∏ ¬´–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å¬ª."
    },
  en:{
      "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
      "theme.dark":"Dark","theme.light":"Light",
      "share":"Share","cardpng":"Card PNG",
      "common.clear":"Clear","common.copy":"Copy","common.copiedToast":"Copied!","common.opened":"Opened",
      "dca.tip":"Tip: add multiple entries ‚Äî it calculates average price, total size and total cost.",
      "dca.add":"+ Add entry","dca.row.price":"Price","dca.row.vol":"Volume",
      "dca.avg":"Average price","dca.totalVol":"Total volume","dca.totalCost":"Total cost",
      "dca.hint.empty":"Add at least one valid entry (price + volume > 0).",
      "dca.hint.partial":"Some rows were ignored (check price/volume).",
      "dca.goal.title":"DCA Goal: Target Average",
      "dca.goal.note":"Calculate how much to buy at price X to reach target average Y.",
      "dca.goal.price":"Add price (X)","dca.goal.avg":"Target average (Y)","dca.goal.fee":"Buy fee %",
      "dca.goal.needVol":"Need volume","dca.goal.needCost":"Cost","dca.goal.status":"Status",
      "dca.goal.status.na":"‚Äî","dca.goal.status.ok":"Possible","dca.goal.status.already":"Already at target","dca.goal.status.impossible":"Impossible at this price",
      "dca.goal.hint.fill":"Fill X and Y, and add at least one entry above.",
      "dca.goal.hint.math":"If X = Y ‚Äî division by zero; change values.",

      "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
      "rr.fee":"Fee % (approx)","rr.feeNote":"Net R/R approximates entry+exit fees.",
      "rr.gross":"Gross R/R","rr.net":"Net R/R (fees)",
      "rr.hint.fill":"Fill the fields","rr.hint.entryEqSl":"Entry and SL must differ",

      "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss",
      "cap.fee":"Fee % (entry+exit)","cap.lev":"Leverage (margin)","cap.presets":"Quick risks",
      "cap.pos":"Position size","cap.riskUsd":"Risk $","cap.margin":"Margin (lev)",
      "cap.hint.fill":"Fill the fields","cap.hint.invalid":"Check values","cap.hint.riskRange":"Risk must be 0‚Äì100%","cap.hint.entryEqSl":"Entry and SL must differ",

      "ind.title":"Indicators",
      "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"Value",
      "ind.tcap.label":"Total Market Cap (USD)","ind.tcap.valueLabel":"USD",
      "ind.alt.label":"Alt dominance (proxy Altseason)","ind.alt.valueLabel":"Alt %",
      "ind.mood.label":"Market Mood","ind.mood.hint":"Derived from F&G + Alt dom",
      "ind.refresh":"Refresh","ind.loading":"Refreshing‚Ä¶","ind.cached":"Showing cached data","ind.rate":"API limit/error ‚Äî try later",
      "ind.viz.fg":"F&G Gauge","ind.viz.cap":"Market Cap","ind.viz.alt":"Alt Dom",

      "hist.title":"History","hist.clear":"Clear","hist.export":"Export .txt","hist.note":"Saved locally in your browser",
    "hist.nocard":"No card data",
    "hist.card":"Card",
      "footer.tags":"AIRDROP ¬∑ NEWS ¬∑ TRADING",

      "modal.ok":"OK","modal.copy":"Copy","modal.open":"Open","modal.share":"Share","modal.download":"Download",
      "file.hint.image":"If Share menu doesn‚Äôt appear, long-press the image to Save/Share.",
      "file.hint.text":"If download is unavailable, tap Open or just Copy."
    }
};

  let lang = 'en';
  try{
    const tgl = tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.language_code : null;
    if(tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
    else lang = /^ru|uk|be/i.test(navigator.language || '') ? 'ru' : 'en';
  }catch(_){ lang='en'; }

  function tr(key){
    const dict = locales[lang] || locales.en;
    return (dict && dict[key] !== undefined) ? dict[key] : key;
  }

  // --- DOM ready ---
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id)=>document.getElementById(id);

    // toast
    const toastEl = $('toast');
    let toastTimer = null;
    function showToast(msg){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toastEl.classList.remove('show'), 1200);
    }

    // modal
    const modalOverlay = $('modalOverlay');
    const modalTitle = $('modalTitle');
    const modalImg = $('modalImg');
    const modalText = $('modalText');
    const modalHint = $('modalHint');
    const modalClose = $('modalClose');
    const modalOk = $('modalOk');
    const modalCopy = $('modalCopy');
    const modalOpen = $('modalOpen');
    const modalShare = $('modalShare');
    const modalDownload = $('modalDownload');

    const modalState = { kind:null, url:null, blob:null, filename:null, mime:null, text:null };
    function closeModal(){ if(modalOverlay) modalOverlay.classList.remove('show'); }
    if(modalClose) modalClose.addEventListener('click', closeModal);
    if(modalOk) modalOk.addEventListener('click', closeModal);
    if(modalOverlay) modalOverlay.addEventListener('click', (e)=>{ if(e.target === modalOverlay) closeModal(); });

    function canShareFiles(blob, filename, mime){
      try{
        if(!navigator.share || !navigator.canShare) return false;
        const file = new File([blob], filename, { type:mime });
        return navigator.canShare({ files:[file] });
      }catch(_){ return false; }
    }
    async function shareFile(blob, filename, mime, title){
      try{
        const file = new File([blob], filename, { type:mime });
        if(navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
          await navigator.share({ files:[file], title:title || filename });
          return true;
        }
      }catch(_){}
      return false;
    }
    function downloadByLink(url, filename){
      try{
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        return true;
      }catch(_){ return false; }
    }

    function openModal(opts){
      const { title, kind, url, blob, filename, mime, text, hint } = opts || {};
      modalState.kind = kind; modalState.url = url; modalState.blob = blob;
      modalState.filename = filename; modalState.mime = mime; modalState.text = text || '';

      if(modalTitle) modalTitle.textContent = title || '‚Äî';
      if(modalHint) modalHint.textContent = hint || '';

      if(modalImg) modalImg.style.display = 'none';
      if(modalText) modalText.style.display = 'none';

      if(modalCopy) modalCopy.style.display = 'none';
      if(modalOpen) modalOpen.style.display = 'none';
      if(modalShare) modalShare.style.display = 'none';
      if(modalDownload) modalDownload.style.display = 'none';

      if(kind === 'image'){
        if(modalImg){ modalImg.src = url; modalImg.style.display='block'; }
        /* open disabled for images */
        if(modalCopy) modalCopy.style.display = 'inline-flex';
        if(modalShare) modalShare.style.display = canShareFiles(blob, filename, mime) ? 'inline-flex' : 'none';
        if(modalDownload) modalDownload.style.display = (!IN_TG && !IS_IOS) ? 'inline-flex' : 'none';
      }else if(kind === 'text'){
        if(modalText){ modalText.value = text || ''; modalText.style.display='block'; }
        if(modalCopy) modalCopy.style.display = 'inline-flex';
        /* open disabled for images */
        if(modalShare) modalShare.style.display = canShareFiles(blob, filename, mime) ? 'inline-flex' : 'none';
        if(modalDownload) modalDownload.style.display = (!IN_TG && !IS_IOS) ? 'inline-flex' : 'none';
      }

      if(modalOverlay) modalOverlay.classList.add('show');
    }

    async function copyText(text){
      if(!text || text === '‚Äî') return false;
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(_){}
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly','');
        ta.style.position='fixed';
        ta.style.left='-9999px';
        ta.style.top='0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return !!ok;
      }catch(_){ return false; }
    }

    // Copy PNG to clipboard where supported (desktop Chromium). Fallback is handled by caller.
    async function copyImageToClipboard(blob){
      try{
        if(!blob) return false;
        if(!navigator.clipboard || !window.ClipboardItem) return false;
        const mime = blob.type || 'image/png';
        const item = new ClipboardItem({ [mime]: blob });
        await navigator.clipboard.write([item]);
        return true;
      }catch(_){
        return false;
      }
    }

    function blobToDataUrl(blob){
      return new Promise((resolve, reject)=>{
        try{
          const fr = new FileReader();
          fr.onload = ()=>resolve(fr.result);
          fr.onerror = ()=>reject(fr.error);
          fr.readAsDataURL(blob);
        }catch(e){
          reject(e);
        }
      });
    }


    async function saveBlobSmart(opts){
      const { blob, filename, mime, title, kind, previewText } = opts || {};
      if(!blob) return false;

      // 1) share (best on phones)
      if(canShareFiles(blob, filename, mime)){
        const ok = await shareFile(blob, filename, mime, title);
        if(ok) return true;
      }

      // 2) desktop: download
      const url = URL.createObjectURL(blob);
      if(!IN_TG && !IS_IOS){
        const ok = downloadByLink(url, filename);
        if(ok){
          setTimeout(()=>URL.revokeObjectURL(url), 60000);
          return true;
        }
      }

      // 3) fallback: preview modal
      openModal({
        title: title || filename,
        kind: kind,
        url,
        blob,
        filename,
        mime,
        text: previewText || '',
        hint: kind === 'image' ? tr('file.hint.image') : tr('file.hint.text')
      });
      setTimeout(()=>URL.revokeObjectURL(url), 120000);
      return false;
    }

    if(modalOpen) modalOpen.addEventListener('click', async ()=>{
      if(!modalState.url) return;
      const url = modalState.url;
      let opened = false;

      // Try new tab/window
      try{
        const w = window.open(url, '_blank', 'noopener');
        opened = !!w;
      }catch(_){}

      // Try anchor click (some WebViews block window.open)
      if(!opened){
        try{
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          opened = true;
        }catch(_){}
      }

      // Fallback: navigate (and for blob URLs, try data URL)
      if(!opened){
        if(url.startsWith('blob:') && modalState.blob){
          try{
            const dataUrl = await blobToDataUrl(modalState.blob);
            window.location.href = dataUrl;
            opened = true;
          }catch(_){}
        }
      }
      if(!opened){
        try{ window.location.href = url; opened = true; }catch(_){}
      }

      if(opened) showToast(tr('common.opened'));
    });
    if(modalCopy) modalCopy.addEventListener('click', async ()=>{
      // If this is an image modal, try copying the PNG first
      if(modalState.kind === 'image' && modalState.blob){
        const okImg = await copyImageToClipboard(modalState.blob);
        if(okImg){
          showToast(tr('common.copiedToast'));
          try{ tg?.HapticFeedback?.notificationOccurred?.('success'); }catch(_){}
          return;
        }
        // fallback to copying text summary (if available)
        const okText = await copyText(modalState.text || modalState.filename || '');
        if(okText){
          showToast(tr('common.copiedToast'));
          try{ tg?.HapticFeedback?.notificationOccurred?.('success'); }catch(_){}
        }
        return;
      }

      // Text modal
      const ok = await copyText(modalState.text || '');
      if(ok){
        showToast(tr('common.copiedToast'));
        try{ tg?.HapticFeedback?.notificationOccurred?.('success'); }catch(_){}
      }
    });
    if(modalShare) modalShare.addEventListener('click', async ()=>{
      if(!modalState.blob) return;
      await shareFile(modalState.blob, modalState.filename, modalState.mime, modalTitle ? modalTitle.textContent : modalState.filename);
    });
    if(modalDownload) modalDownload.addEventListener('click', ()=>{
      if(!modalState.url || !modalState.filename) return;
      downloadByLink(modalState.url, modalState.filename);
    });

    // --- translateAll ---
    function translateAll(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k = el.getAttribute('data-i18n');
        const dict = locales[lang] || locales.en;
        if(dict && dict[k] !== undefined) el.textContent = dict[k];
      });
      updateThemeUI();
    }

    // --- language buttons ---
    const btnRu = $('btn_ru');
    const btnEn = $('btn_en');
    function syncLangButtons(){
      if(btnRu && btnEn){
        if(lang === 'ru'){ btnRu.classList.add('active'); btnEn.classList.remove('active'); }
        else { btnEn.classList.add('active'); btnRu.classList.remove('active'); }
      }
    }
    if(btnRu) btnRu.addEventListener('click', ()=>{ lang='ru'; syncLangButtons(); translateAll(); renderHistory(); redrawIndicators(); });
    if(btnEn) btnEn.addEventListener('click', ()=>{ lang='en'; syncLangButtons(); translateAll(); renderHistory(); redrawIndicators(); });

    // --- theme ---
    const THEME_KEY = 'tc_theme_v4';
    function getInitialTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved === 'dark' || saved === 'light') return saved;
      const tgScheme = (tg && tg.colorScheme) ? String(tg.colorScheme).toLowerCase() : '';
      if(tgScheme === 'dark' || tgScheme === 'light') return tgScheme;
      try{
        return (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';
      }catch(_){ return 'dark'; }
    }
    function setTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_KEY, theme);
      updateThemeUI();
      redrawIndicators();
    }
    const themeBtn = $('theme_toggle');
    const themeIcon = $('theme_icon');
    const themeText = $('theme_text');
    function updateThemeUI(){
      const theme = document.documentElement.getAttribute('data-theme') || 'dark';
      if(themeIcon) themeIcon.textContent = (theme === 'light') ? '‚òÄÔ∏è' : 'üåô';
      if(themeText) themeText.textContent = (theme === 'light') ? tr('theme.light') : tr('theme.dark');
      if(themeBtn){
        if(theme === 'light') themeBtn.classList.add('active');
        else themeBtn.classList.remove('active');
      }
    }
    if(themeBtn) themeBtn.addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(cur === 'dark' ? 'light' : 'dark');
      haptic('impact','light');
    });

    // --- tabs ---
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.getAttribute('data-tab');
        document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
        const sec = document.getElementById(target);
        if(sec) sec.classList.add('active');
        if(target === 'ind') fetchIndicators();
        translateAll();
      });
    });

    // --- History ---
    const HISTORY_KEY = 'trader_calc_history_v6';
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; }catch(_){ return []; } }
    function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }
    function pushHistory(item){
      const arr = loadHistory();
      arr.unshift(item);
      if(arr.length > 120) arr.pop();
      saveHistory(arr);
    }
    const historyList = $('history_list');
    function renderHistory(){
      if(!historyList) return;
      historyList.innerHTML = '';
      const arr = loadHistory();
      if(!arr.length){
        const el = document.createElement('div');
        el.className = 'note';
        el.textContent = tr('hist.note');
        historyList.appendChild(el);
        return;
      }
      arr.forEach((it, idx)=>{
        const node = document.createElement('div');
        node.style.padding='10px';
        node.style.border='1px solid var(--border)';
        node.style.borderRadius='16px';
        node.style.background='var(--panel)';
        const hasCard = !!it.card;
        node.innerHTML =
          '<div style="display:flex;gap:10px;justify-content:space-between;align-items:flex-start">' +
            '<div style="flex:1;min-width:0">' +
              '<div style="font-weight:900">'+escapeHtml(it.type||'')+'</div>' +
              '<div class="note">'+escapeHtml(it.summary||'')+'</div>' +
              '<div class="small">'+new Date(it.t).toLocaleString()+'</div>' +
            '</div>' +
            '<div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">' +
              '<button class="btn small ghost hist_card" data-idx="'+idx+'" ' + (hasCard ? '' : 'disabled') + '>' + escapeHtml(tr('hist.card')) + '</button>' +
            '</div>' +
          '</div>';
        historyList.appendChild(node);
      });
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    const clearHistBtn = $('clear_history');
    // --- auto-save debounce ---
    const saveState = { last:{}, timers:{} };
    function buildHistoryCard(type, when){
      const dt = new Date(when).toLocaleString();
      const title = 'Trader Calculator';
      const subtitle = type + ' ¬∑ ' + dt;
      const brand = 'InvestTraderTrade';
      const tgLink = '@InvestTraderTrade';
      let lines = [];

      // snapshot from current UI values
      if(type === 'DCA' || type === 'DCA_GOAL'){
        const avg = (dcaAvgEl?.textContent || '‚Äî').trim();
        const vol = (dcaTotalVolEl?.textContent || '‚Äî').trim();
        const cost = (dcaTotalCostEl?.textContent || '‚Äî').trim();
        lines.push({k:'AVG', v:avg});

    // Open history item as Trade Card PNG (preview)
    if(historyList) historyList.addEventListener('click', async (e)=>{
      const btn = e.target && e.target.closest ? e.target.closest('.hist_card') : null;
      if(!btn) return;
      const idx = parseInt(btn.getAttribute('data-idx') || 'NaN', 10);
      if(!isFinite(idx)) return;
      const arr = loadHistory();
      const item = arr[idx];
      if(!item || !item.card){
        showToast(tr('hist.nocard'));
        haptic('notify','warning');
        return;
      }
      await previewCardPNG(item.card, { title: 'Trade Card PNG' });
    });

        lines.push({k:'VOL', v:vol});
        lines.push({k:'COST', v:cost});
        const need = (dcaNeedVol?.textContent || '‚Äî').trim();
        if(need && need !== '‚Äî'){
          lines.push({k:'GOAL NEED', v:need});
          lines.push({k:'GOAL COST', v:(dcaNeedCost?.textContent || '‚Äî').trim()});
          lines.push({k:'STATUS', v:(dcaGoalStatus?.textContent || '‚Äî').trim()});
        }
      }else if(type === 'RR'){
        lines.push({k:'GROSS', v:(rr_value?.textContent || '‚Äî').trim()});
        lines.push({k:'NET', v:(rr_net?.textContent || '‚Äî').trim()});
      }else if(type === 'CAP'){
        lines.push({k:'SIZE', v:(cap_value?.textContent || '‚Äî').trim()});
        lines.push({k:'RISK', v:(cap_riskUsd?.textContent || '‚Äî').trim()});
        lines.push({k:'MARGIN', v:(cap_margin?.textContent || '‚Äî').trim()});
      }else if(type === 'IND'){
        lines.push({k:'F&G', v:(fgEl?.textContent || '‚Äî').trim()});
        lines.push({k:'ALT DOM', v:(altDomEl?.textContent || '‚Äî').trim()});
        lines.push({k:'MOOD', v:(moodEl?.textContent || '‚Äî').trim()});
      }

      return { title, subtitle, lines, brand, tgLink, type };
    }

    function scheduleSave(type, summary, signature){
      if(!signature || signature === '‚Äî') return;
      clearTimeout(saveState.timers[type]);
      saveState.timers[type] = setTimeout(()=>{
        if(saveState.last[type] === signature) return;
        saveState.last[type] = signature;
        const now = Date.now();
        const card = buildHistoryCard(type, now);
        pushHistory({ type, summary, t: now, card });
      }, 650);
    }

    // --- DCA multi entries ---
    const dcaRowsEl = $('dca_rows');
    const dcaAvgEl = $('dca_avg');
    const dcaTotalVolEl = $('dca_totalVol');
    const dcaTotalCostEl = $('dca_totalCost');
    const dcaHintEl = $('dca_hint');
    const dcaCopyBtn = $('dca_copy');

    const dcaGoalPrice = $('dca_goal_price');
    const dcaGoalAvg = $('dca_goal_avg');
    const dcaFee = $('dca_fee');
    const dcaNeedVol = $('dca_needVol');
    const dcaNeedCost = $('dca_needCost');
    const dcaGoalStatus = $('dca_goalStatus');
    const dcaGoalHint = $('dca_goal_hint');

    function dcaRowTemplate(price, vol){
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.innerHTML =
        '<div class="col"><label data-i18n="dca.row.price">'+tr('dca.row.price')+'</label>'
        + '<input class="dca_price" type="number" inputmode="decimal" step="any" placeholder="0.00" value="'+(price||'')+'"></div>'
        + '<div class="col"><label data-i18n="dca.row.vol">'+tr('dca.row.vol')+'</label>'
        + '<input class="dca_vol" type="number" inputmode="decimal" step="any" min="0" placeholder="0" value="'+(vol||'')+'"></div>'
        + '<button class="mini dca_remove" type="button" aria-label="Remove">‚úï</button>';
      return wrap;
    }
    function ensureAtLeastOneRow(){
      if(!dcaRowsEl) return;
      if(dcaRowsEl.children.length === 0){
        dcaRowsEl.appendChild(dcaRowTemplate('',''));
        dcaRowsEl.appendChild(dcaRowTemplate('',''));
      }
    }
    function getDcaLegs(){
      const rows = dcaRowsEl ? Array.from(dcaRowsEl.querySelectorAll('.row')) : [];
      const valid = [];
      let ignored = 0;
      rows.forEach(r=>{
        const p = safeNum(r.querySelector('.dca_price').value);
        const v = safeNum(r.querySelector('.dca_vol').value);
        if(Number.isFinite(p) && Number.isFinite(v) && v > 0){
          valid.push({ p, v });
        }else{
          const pv = (r.querySelector('.dca_price').value || '').trim();
          const vv = (r.querySelector('.dca_vol').value || '').trim();
          if((pv && !Number.isFinite(p)) || (vv && !Number.isFinite(v)) || (pv && vv && !(v>0))) ignored++;
        }
      });
      return { valid, ignored };
    }
    function getDcaBase(){
      const { valid } = getDcaLegs();
      if(!valid.length) return null;
      let totalVol=0, totalCost=0;
      valid.forEach(l=>{ totalVol += l.v; totalCost += l.p*l.v; });
      return { totalVol, totalCost, avg: totalCost/totalVol };
    }
    function calcDcaGoal(base){
      if(!dcaNeedVol) return;
      dcaNeedVol.textContent = '‚Äî';
      dcaNeedCost.textContent = '‚Äî';
      dcaGoalStatus.textContent = tr('dca.goal.status.na');
      dcaGoalHint.textContent = '';

      if(!base){ dcaGoalHint.textContent = tr('dca.goal.hint.fill'); return; }

      const X = safeNum(dcaGoalPrice.value);
      const Y = safeNum(dcaGoalAvg.value);
      const feePct = safeNum(dcaFee.value);
      const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

      if(!Number.isFinite(X) || !Number.isFinite(Y)){ dcaGoalHint.textContent = tr('dca.goal.hint.fill'); return; }
      if(X === Y){ dcaGoalHint.textContent = tr('dca.goal.hint.math'); dcaGoalStatus.textContent = tr('dca.goal.status.impossible'); return; }

      if(Math.abs(base.avg - Y) / (Math.abs(Y)||1) < 1e-12){
        dcaGoalStatus.textContent = tr('dca.goal.status.already');
        dcaNeedVol.textContent = '0';
        dcaNeedCost.textContent = '$0';
        return;
      }

      const Xeff = X * (1 + fee);
      const numerator = (Y * base.totalVol) - base.totalCost;
      const denom = (Xeff - Y);
      const v = numerator / denom;

      if(!Number.isFinite(v) || v <= 0){
        dcaGoalStatus.textContent = tr('dca.goal.status.impossible');
        return;
      }

      dcaNeedVol.textContent = fmt(v, 8);
      dcaNeedCost.textContent = fmtMoney(Xeff * v);
      dcaGoalStatus.textContent = tr('dca.goal.status.ok');

      scheduleSave('DCA_GOAL', 'Need '+fmt(v,8)+' @ '+X+' to target '+Y, fmt(v,8));
    }
    function calcDCA(){
      if(!dcaRowsEl) return;
      const { valid, ignored } = getDcaLegs();
      if(valid.length === 0){
        dcaAvgEl.textContent = '‚Äî';
        dcaTotalVolEl.textContent = '‚Äî';
        dcaTotalCostEl.textContent = '‚Äî';
        dcaHintEl.textContent = tr('dca.hint.empty');
        if(dcaCopyBtn) dcaCopyBtn.disabled = true;
        calcDcaGoal(null);
        return;
      }
      let totalVol=0, totalCost=0;
      valid.forEach(l=>{ totalVol += l.v; totalCost += l.p*l.v; });
      const avg = totalCost/totalVol;
      const avgText = fmt(avg, 8);

      dcaAvgEl.textContent = avgText;
      dcaTotalVolEl.textContent = fmt(totalVol, 8);
      dcaTotalCostEl.textContent = fmtMoney(totalCost);
      dcaHintEl.textContent = ignored > 0 ? tr('dca.hint.partial') : '';
      if(dcaCopyBtn) dcaCopyBtn.disabled = false;

      scheduleSave('DCA', 'AVG '+avgText+' ¬∑ vol '+fmt(totalVol,8)+' ¬∑ cost '+fmtMoney(totalCost), avgText);

      calcDcaGoal({ totalVol, totalCost, avg });
    }

    const dcaAddBtn = $('dca_add');
    const dcaClearBtn = $('dca_clear');
    if(dcaAddBtn) dcaAddBtn.addEventListener('click', ()=>{
      dcaRowsEl.appendChild(dcaRowTemplate('',''));
      translateAll();
      calcDCA();
      haptic('impact','light');
    });
    if(dcaClearBtn) dcaClearBtn.addEventListener('click', ()=>{
      dcaRowsEl.innerHTML = '';
      ensureAtLeastOneRow();
      translateAll();
      calcDCA();
      haptic('notify','success');
    });
    if(dcaRowsEl) dcaRowsEl.addEventListener('input', (e)=>{
      if(e.target && (e.target.classList.contains('dca_price') || e.target.classList.contains('dca_vol'))) calcDCA();
    });
    if(dcaRowsEl) dcaRowsEl.addEventListener('click', (e)=>{
      const btn = e.target.closest ? e.target.closest('.dca_remove') : null;
      if(!btn) return;
      const row = btn.closest('.row');
      if(!row) return;
      if(dcaRowsEl.children.length <= 1){
        row.querySelector('.dca_price').value = '';
        row.querySelector('.dca_vol').value = '';
      }else row.remove();
      calcDCA();
      haptic('impact','light');
    });
    if(dcaCopyBtn) dcaCopyBtn.addEventListener('click', async ()=>{
      const ok = await copyText(dcaAvgEl.textContent.trim());
      if(ok){ showToast(tr('common.copiedToast')); haptic('notify','success'); }
    });
    [dcaGoalPrice, dcaGoalAvg, dcaFee].forEach(el=>{
      if(el) el.addEventListener('input', ()=>calcDcaGoal(getDcaBase()));
    });

    // --- R/R ---
    const rrEntry = $('rr_entry');
    const rrSl = $('rr_sl');
    const rrTp = $('rr_tp');
    const rrFee = $('rr_fee');
    const rrValue = $('rr_value');
    const rrNet = $('rr_net');
    const rrHint = $('rr_hint');

    function calcRR(){
      const e = safeNum(rrEntry.value);
      const sl = safeNum(rrSl.value);
      const tp = safeNum(rrTp.value);
      const feePct = safeNum(rrFee.value);
      const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

      rrValue.textContent = '‚Äî';
      rrNet.textContent = '‚Äî';
      rrHint.textContent = '';

      if([e,sl,tp].some(x=>Number.isNaN(x))){ rrHint.textContent = tr('rr.hint.fill'); return; }
      if(e === sl){ rrHint.textContent = tr('rr.hint.entryEqSl'); return; }

      const risk = Math.abs(e-sl);
      const reward = Math.abs(tp-e);
      if(!(risk > 0)) return;

      const gross = (reward/risk).toFixed(2);
      rrValue.textContent = '1:' + gross;

      const riskNet = risk + fee*(Math.abs(e)+Math.abs(sl));
      const rewardNet = reward - fee*(Math.abs(e)+Math.abs(tp));
      rrNet.textContent = (rewardNet <= 0) ? '0.00' : (rewardNet/riskNet).toFixed(2);

      scheduleSave('RR', 'Gross 1:'+gross+' ¬∑ Net '+rrNet.textContent, gross);
    }
    [rrEntry, rrSl, rrTp, rrFee].forEach(el=>{ if(el) el.addEventListener('input', calcRR); });
    const rrClear = $('rr_clear');
    if(rrClear) rrClear.addEventListener('click', ()=>{
      rrEntry.value=''; rrSl.value=''; rrTp.value=''; rrFee.value='';
      calcRR();
      haptic('notify','success');
    });

    // --- Capital ---
    const capDep = $('cap_dep');
    const capRisk = $('cap_risk');
    const capEntry = $('cap_entry');
    const capSl = $('cap_sl');
    const capFee = $('cap_fee');
    const capLev = $('cap_lev');
    const capValue = $('cap_value');
    const capRiskUsd = $('cap_riskUsd');
    const capMargin = $('cap_margin');
    const capHint = $('cap_hint');

    function calcCap(){
      const dep = safeNum(capDep.value);
      const rp = safeNum(capRisk.value);
      const e = safeNum(capEntry.value);
      const sl = safeNum(capSl.value);

      const feePct = safeNum(capFee.value);
      const fee = Number.isFinite(feePct) ? Math.max(0, feePct)/100 : 0;

      const levRaw = safeNum(capLev.value);
      const lev = Number.isFinite(levRaw) ? Math.max(1, levRaw) : 1;

      capValue.textContent = '‚Äî';
      capRiskUsd.textContent = '‚Äî';
      capMargin.textContent = '‚Äî';
      capHint.textContent = '';

      if([dep,rp,e,sl].some(x=>Number.isNaN(x))){ capHint.textContent = tr('cap.hint.fill'); return; }
      if(dep <= 0){ capHint.textContent = tr('cap.hint.invalid'); return; }
      if(rp <= 0 || rp > 100){ capHint.textContent = tr('cap.hint.riskRange'); return; }
      if(e === sl){ capHint.textContent = tr('cap.hint.entryEqSl'); return; }

      const riskUsd = dep * (rp/100);
      const perUnit = Math.abs(e - sl) + fee*(Math.abs(e)+Math.abs(sl));
      const size = riskUsd / perUnit;

      if(!Number.isFinite(size) || size <= 0){ capHint.textContent = tr('cap.hint.invalid'); return; }

      capValue.textContent = size.toFixed(8);
      capRiskUsd.textContent = '$' + riskUsd.toFixed(2);

      const notional = Math.abs(size * e);
      capMargin.textContent = fmtMoney(notional / lev);

      scheduleSave('CAP', 'Size '+size.toFixed(8)+' ¬∑ Risk $'+riskUsd.toFixed(2)+' ¬∑ Margin '+capMargin.textContent, size.toFixed(8));
    }
    [capDep, capRisk, capEntry, capSl, capFee, capLev].forEach(el=>{ if(el) el.addEventListener('input', calcCap); });

    const capClear = $('cap_clear');
    if(capClear) capClear.addEventListener('click', ()=>{
      capDep.value=''; capRisk.value=''; capEntry.value=''; capSl.value='';
      capFee.value=''; capLev.value='';
      calcCap();
      haptic('notify','success');
    });
    document.querySelectorAll('.cap_preset').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        capRisk.value = btn.getAttribute('data-v');
        calcCap();
        haptic('impact','light');
      });
    });

    // --- Indicators ---
    const fgEl = $('fg_value');
    const tcapEl = $('tcap');
    const altDomEl = $('alt_dom');
    const moodEl = $('mood_value');
    const indNote = $('ind_note');
    const fgVizText = $('fg_viz_text');
    const capVizText = $('cap_viz_text');
    const altVizText = $('alt_viz_text');

    const IND_CACHE_KEY = 'trader_ind_cache_v5';
    const IND_TTL = 60000;
    let indBusy = false;
    let lastInd = null;

    function getCache(){ try{ return JSON.parse(localStorage.getItem(IND_CACHE_KEY)); }catch(_){ return null; } }
    function setCache(data){ localStorage.setItem(IND_CACHE_KEY, JSON.stringify({ t: Date.now(), data })); }

    function computeMood(fngValue, altDom){
      if(!Number.isFinite(fngValue) || !Number.isFinite(altDom)) return '‚Äî';
      if(fngValue >= 60 && altDom >= 55) return 'üü¢ Risk-on';
      if(fngValue <= 40 && altDom <= 45) return 'üî¥ Risk-off';
      return 'üü° Neutral';
    }

    function applyIndicators(data){
      lastInd = data;

      fgEl.textContent = data.fgText || '‚Äî';
      tcapEl.textContent = data.totalMc ? fmtMoney(Number(data.totalMc)) : '‚Äî';
      altDomEl.textContent = (typeof data.altDom === 'number') ? data.altDom.toFixed(2)+'%' : '‚Äî';
      moodEl.textContent = computeMood(data.fngValue, data.altDom);

      fgVizText.textContent = Number.isFinite(data.fngValue) ? String(data.fngValue) : '‚Äî';
      capVizText.textContent = data.totalMc ? fmtMoney(Number(data.totalMc)) : '‚Äî';
      altVizText.textContent = (typeof data.altDom === 'number') ? data.altDom.toFixed(2)+'%' : '‚Äî';

      drawAllIndicatorVisuals(data);
    }

    async function fetchIndicators(force){
      if(indBusy) return;
      indBusy = true;
      indNote.textContent = tr('ind.loading');

      if(!force){
        const c = getCache();
        if(c && (Date.now() - c.t) < IND_TTL){
          applyIndicators(c.data);
          indNote.textContent = tr('ind.cached');
          indBusy = false;
          return;
        }
      }

      const out = { fgText:null, fngValue:NaN, totalMc:null, altDom:NaN };
      let err = false;

      try{
        const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json', { cache:'no-store' });
        if(!res.ok) throw new Error('FNG');
        const j = await res.json();
        const d = j && j.data && j.data[0] ? j.data[0] : null;
        if(d && d.value){
          out.fngValue = Number(d.value);
          out.fgText = String(d.value) + ' ¬∑ ' + (d.value_classification || '');
        }
      }catch(_){ err = true; }

      try{
        const res2 = await fetch('https://api.coingecko.com/api/v3/global', { cache:'no-store' });
        if(!res2.ok) throw new Error('CG');
        const j2 = await res2.json();
        out.totalMc = j2 && j2.data && j2.data.total_market_cap ? j2.data.total_market_cap.usd : null;
        const btcDom = j2 && j2.data && j2.data.market_cap_percentage ? j2.data.market_cap_percentage.btc : null;
        if(typeof btcDom === 'number') out.altDom = 100 - btcDom;
      }catch(_){ err = true; }

      applyIndicators(out);
      setCache(out);
      indNote.textContent = err ? tr('ind.rate') : '';
      indBusy = false;
    }

    const refreshBtn = $('refresh_ind');
    if(refreshBtn) refreshBtn.addEventListener('click', ()=>{ localStorage.removeItem(IND_CACHE_KEY); fetchIndicators(true); haptic('impact','light'); });

    function setupCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      // when hidden, clientWidth may be 0: use fallback
      const w = Math.max(320, canvas.clientWidth || 0);
      const h = Math.max(140, canvas.clientHeight || 0);
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return { ctx, w, h };
    }
    function getCss(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
    function drawFGGauge(value){
      const canvas = $('fg_canvas');
      if(!canvas) return;
      const { ctx, w, h } = setupCanvas(canvas);
      const bg = getCss('--result-bg');
      const border = getCss('--border');
      const muted = getCss('--muted');
      const text = getCss('--text');
      const accent = getCss('--accent');
      const danger = getCss('--danger');

      ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = border; ctx.lineWidth = 2; ctx.strokeRect(1,1,w-2,h-2);

      const cx = w/2, cy = h*0.86;
      const r = Math.min(w*0.38, h*0.8);

      ctx.beginPath();
      ctx.strokeStyle = muted;
      ctx.lineWidth = 12;
      ctx.lineCap = 'round';
      ctx.arc(cx, cy, r, Math.PI, 0);
      ctx.stroke();

      if(Number.isFinite(value)){
        const v = Math.max(0, Math.min(100, value));
        const end = Math.PI - (Math.PI * (v/100));
        ctx.beginPath();
        ctx.strokeStyle = (v < 35) ? danger : (v > 65 ? accent : muted);
        ctx.lineWidth = 12;
        ctx.lineCap = 'round';
        ctx.arc(cx, cy, r, Math.PI, end);
        ctx.stroke();

        const ang = Math.PI - (Math.PI * (v/100));
        const nx = cx + Math.cos(ang) * (r - 8);
        const ny = cy + Math.sin(ang) * (r - 8);

        ctx.beginPath(); ctx.strokeStyle = text; ctx.lineWidth = 3;
        ctx.moveTo(cx, cy); ctx.lineTo(nx, ny); ctx.stroke();

        ctx.beginPath(); ctx.fillStyle = text; ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = text; ctx.font = '900 16px Inter, Arial, sans-serif';
        ctx.textAlign = 'center'; ctx.fillText('F&G: '+v, cx, 26);
        ctx.fillStyle = muted; ctx.font = '700 12px Inter, Arial, sans-serif';
        const lbl = v<=25?'Extreme Fear':v<=45?'Fear':v<=55?'Neutral':v<=75?'Greed':'Extreme Greed';
        ctx.fillText(lbl, cx, 46);
      }else{
        ctx.fillStyle = muted; ctx.font='900 16px Inter, Arial, sans-serif';
        ctx.textAlign='center'; ctx.fillText('‚Äî', cx, 30);
      }
    }
    function drawMarketCap(totalMc){
      const canvas = $('cap_canvas');
      if(!canvas) return;
      const { ctx, w, h } = setupCanvas(canvas);
      const bg = getCss('--result-bg');
      const border = getCss('--border');
      const muted = getCss('--muted');
      const text = getCss('--text');
      const accent = getCss('--accent');

      ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = border; ctx.lineWidth = 2; ctx.strokeRect(1,1,w-2,h-2);

      const pad = 14;
      const barX = pad, barY = h/2 - 10, barW = w - pad*2, barH = 20;

      ctx.fillStyle = muted;
      roundRect(ctx, barX, barY, barW, barH, 10);
      ctx.fill();

      if(Number.isFinite(totalMc) && totalMc > 0){
        const max = 10_000_000_000_000; // 10T
        const norm = Math.min(1, Math.log10(totalMc) / Math.log10(max));
        const fillW = Math.max(8, barW * norm);
        ctx.fillStyle = accent;
        roundRect(ctx, barX, barY, fillW, barH, 10);
        ctx.fill();

        ctx.fillStyle = text; ctx.font='900 16px Inter, Arial, sans-serif'; ctx.textAlign='left';
        ctx.fillText('Total Cap', barX, 28);
        ctx.fillStyle = muted; ctx.font='700 12px Inter, Arial, sans-serif';
        ctx.fillText('log scale (0..10T)', barX, 46);
      }else{
        ctx.fillStyle = muted; ctx.font='900 16px Inter, Arial, sans-serif';
        ctx.textAlign='center'; ctx.fillText('‚Äî', w/2, h/2 + 6);
      }
    }
    function drawAltDonut(altDom){
      const canvas = $('alt_canvas');
      if(!canvas) return;
      const { ctx, w, h } = setupCanvas(canvas);
      const bg = getCss('--result-bg');
      const border = getCss('--border');
      const muted = getCss('--muted');
      const text = getCss('--text');
      const accent = getCss('--accent');

      ctx.fillStyle = bg; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = border; ctx.lineWidth = 2; ctx.strokeRect(1,1,w-2,h-2);

      const cx = w/2, cy = h/2 + 6, r = Math.min(w,h) * 0.28;

      ctx.beginPath();
      ctx.strokeStyle = muted;
      ctx.lineWidth = 16;
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.stroke();

      if(Number.isFinite(altDom)){
        const v = Math.max(0, Math.min(100, altDom));
        const start = -Math.PI/2;
        const end = start + (Math.PI*2)*(v/100);

        ctx.beginPath();
        ctx.strokeStyle = accent;
        ctx.lineWidth = 16;
        ctx.lineCap = 'round';
        ctx.arc(cx, cy, r, start, end);
        ctx.stroke();

        ctx.fillStyle = text; ctx.font='900 18px Inter, Arial, sans-serif';
        ctx.textAlign='center'; ctx.fillText(v.toFixed(2)+'%', cx, 28);
        ctx.fillStyle = muted; ctx.font='700 12px Inter, Arial, sans-serif';
        ctx.fillText('Alt dominance', cx, 46);
      }else{
        ctx.fillStyle = muted; ctx.font='900 16px Inter, Arial, sans-serif';
        ctx.textAlign='center'; ctx.fillText('‚Äî', cx, cy+6);
      }
    }
    function drawAllIndicatorVisuals(data){
      if(!data){ drawFGGauge(NaN); drawMarketCap(NaN); drawAltDonut(NaN); return; }
      drawFGGauge(data.fngValue);
      drawMarketCap(Number(data.totalMc));
      drawAltDonut(data.altDom);
    }
    function redrawIndicators(){
      drawAllIndicatorVisuals(lastInd);
    }
    window.addEventListener('resize', ()=>{ setTimeout(redrawIndicators, 120); });

    // --- Share text button ---
    const shareBtn = $('share_btn');
    if(shareBtn) shareBtn.addEventListener('click', async ()=>{
      const activeTab = document.querySelector('.tab.active') ? document.querySelector('.tab.active').getAttribute('data-tab') : 'dca';
      let text = 'üìä Trader Calculator\n';
      if(activeTab === 'dca'){
        text += 'DCA AVG: ' + dcaAvgEl.textContent + '\nVOL: ' + dcaTotalVolEl.textContent + '\nCOST: ' + dcaTotalCostEl.textContent + '\n';
        if(dcaNeedVol.textContent && dcaNeedVol.textContent !== '‚Äî'){
          text += '\nüéØ Goal\nNeed: ' + dcaNeedVol.textContent + '\nCost: ' + dcaNeedCost.textContent + '\n';
        }
      }else if(activeTab === 'rr'){
        text += 'R/R Gross: ' + rrValue.textContent + '\nR/R Net: ' + rrNet.textContent + '\n';
      }else if(activeTab === 'cap'){
        text += 'Size: ' + capValue.textContent + '\nRisk: ' + capRiskUsd.textContent + '\nMargin: ' + capMargin.textContent + '\n';
      }else if(activeTab === 'ind'){
        text += 'F&G: ' + fgEl.textContent + '\nAlt dom: ' + altDomEl.textContent + '\nMood: ' + moodEl.textContent + '\n';
      }

      try{
        if(navigator.share){
          await navigator.share({ text:text, title:'Trader Calculator' });
          haptic('notify','success');
          return;
        }
      }catch(_){}

      const ok = await copyText(text);
      if(ok) showToast(tr('common.copiedToast'));
    });

    // --- Card PNG ---
    function roundRectPath(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines){
      const words = String(text||'').split(' ');
      let line = '';
      let lines = 0;
      for(let i=0;i<words.length;i++){
        const test = line + words[i] + ' ';
        if(ctx.measureText(test).width > maxWidth && i>0){
          ctx.fillText(line.trim(), x, y);
          line = words[i] + ' ';
          y += lineHeight;
          lines++;
          if(maxLines && lines >= maxLines) return y;
        }else{
          line = test;
        }
      }
      ctx.fillText(line.trim(), x, y);
      return y + lineHeight;
    }
    function activeTabId(){
      const el = document.querySelector('.tab.active');
      return el ? el.getAttribute('data-tab') : 'dca';
    }
    function getCssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function getCardPayload(){
      const tab = activeTabId();
      const dt = new Date().toLocaleString();
      let lines = [];
      if(tab === 'dca'){
        if(dcaAvgEl.textContent.trim()==='‚Äî') return null;
        lines.push({k:'AVG', v:dcaAvgEl.textContent.trim()});
        lines.push({k:'VOL', v:dcaTotalVolEl.textContent.trim()});
        lines.push({k:'COST', v:dcaTotalCostEl.textContent.trim()});
        if(dcaNeedVol.textContent.trim() !== '‚Äî'){
          lines.push({k:'GOAL NEED', v:dcaNeedVol.textContent.trim()});
          lines.push({k:'GOAL COST', v:dcaNeedCost.textContent.trim()});
          lines.push({k:'STATUS', v:dcaGoalStatus.textContent.trim()});
        }
      }else if(tab === 'rr'){
        if(rrValue.textContent.trim()==='‚Äî' && rrNet.textContent.trim()==='‚Äî') return null;
        lines.push({k:'GROSS', v:rrValue.textContent.trim()});
        lines.push({k:'NET', v:rrNet.textContent.trim()});
      }else if(tab === 'cap'){
        if(capValue.textContent.trim()==='‚Äî') return null;
        lines.push({k:'SIZE', v:capValue.textContent.trim()});
        lines.push({k:'RISK', v:capRiskUsd.textContent.trim()});
        lines.push({k:'MARGIN', v:capMargin.textContent.trim()});
      }else if(tab === 'ind'){
        if(fgEl.textContent.trim()==='‚Äî' && altDomEl.textContent.trim()==='‚Äî') return null;
        lines.push({k:'F&G', v:fgEl.textContent.trim()});
        lines.push({k:'ALT DOM', v:altDomEl.textContent.trim()});
        lines.push({k:'MOOD', v:moodEl.textContent.trim()});
      }
      return {
        tab, dt,
        title:'Trader Calculator',
        subtitle: tab.toUpperCase() + ' ¬∑ ' + dt,
        brand:'InvestTraderTrade',
        tgLink:'@InvestTraderTrade',
        lines
      };
    }

    async function renderTradeCardBlob(payload){
      const W=1080, H=1080;
      const canvas = document.createElement('canvas');
      canvas.width = W;
      canvas.height = H;
      const ctx = canvas.getContext('2d');

      const bg = getCssVar('--bg') || '#000';
      const panel = getCssVar('--panel') || '#0b0b0b';
      const border = getCssVar('--border') || '#151515';
      const text = getCssVar('--text') || '#fff';
      const muted = getCssVar('--muted') || '#9a9a9a';
      const accent = getCssVar('--accent') || '#7CFC00';

      // background
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,W,H);

      // card panel
      const pad = 70;
      const cardX = pad, cardY = pad, cardW = W - pad*2, cardH = H - pad*2;
      roundRect(ctx, cardX, cardY, cardW, cardH, 42);
      ctx.fillStyle = panel; ctx.fill();
      ctx.lineWidth = 4; ctx.strokeStyle = border; ctx.stroke();

      // accent glow strip
      ctx.save();
      ctx.globalAlpha = 0.85;
      roundRect(ctx, cardX+18, cardY+18, cardW-36, 10, 10);
      ctx.fillStyle = accent; ctx.fill();
      ctx.restore();

      // title
      ctx.fillStyle = text; ctx.font = '900 54px Inter, Arial, sans-serif';
      ctx.textAlign='left'; ctx.fillText(payload.title || 'Trader Calculator', cardX+60, cardY+90);

      // subtitle
      ctx.fillStyle = muted; ctx.font = '700 28px Inter, Arial, sans-serif';
      ctx.fillText(payload.subtitle || '', cardX+60, cardY+135);

      // rows
      let y = cardY + 210;
      const left = cardX + 60;
      const right = cardX + cardW - 60;

      ctx.font = '800 34px Inter, Arial, sans-serif';
      (payload.lines || []).slice(0, 12).forEach(row=>{
        ctx.fillStyle = muted; ctx.textAlign='left'; ctx.fillText(String(row.k||''), left, y);
        ctx.fillStyle = text; ctx.textAlign='right'; ctx.fillText(String(row.v||''), right, y);
        y += 58;
      });

      // footer
      ctx.fillStyle = muted; ctx.font = '700 26px Inter, Arial, sans-serif';
      ctx.textAlign='left';
      ctx.fillText(payload.tgLink || '@InvestTraderTrade', cardX+60, cardY+cardH-60);
      ctx.textAlign='right';
      ctx.fillText(payload.brand || 'InvestTraderTrade', cardX+cardW-60, cardY+cardH-60);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      if(!blob){
        reportErr('PNG', 'toBlob failed');
        return null;
      }
      const NL = String.fromCharCode(10);
      const previewText = (payload.subtitle ? payload.subtitle + NL : '') + (payload.lines||[]).map(r=>`${r.k}: ${r.v}`).join(NL);
      return { blob, previewText };
    }

    async function previewCardPNG(payload, opts){
      const out = await renderTradeCardBlob(payload);
      if(!out) return;
      const { blob, previewText } = out;
      const type = (payload.type || payload.tab || 'calc').toString().toLowerCase();
      const filename = (opts && opts.filename) ? opts.filename : ('trade_card_' + type + '_' + Date.now() + '.png');
      const url = URL.createObjectURL(blob);
      openModal({
        title: (opts && opts.title) ? opts.title : 'Trade Card PNG',
        kind:'image',
        url,
        blob,
        filename,
        mime:'image/png',
        text: previewText,
        hint: tr('file.hint.image')
      });
      setTimeout(()=>URL.revokeObjectURL(url), 60000);
    }

    async function exportCardPNG(){
      const payload = getCardPayload();
      if(!payload){
        showToast('‚Äî');
        try{ tg && tg.showAlert ? tg.showAlert(lang==='ru'?'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏':'No data for card') : null; }catch(_){}
        return;
      }
      const out = await renderTradeCardBlob(payload);
      if(!out) return;
      const { blob, previewText } = out;
      const filename = 'trade_card_' + (payload.tab || payload.type || 'calc') + '_' + Date.now() + '.png';
      await saveBlobSmart({ blob, filename, mime:'image/png', title:'Trade Card PNG', kind:'image', previewText });
    }
    const cardBtn = $('card_btn');
    if(cardBtn) cardBtn.addEventListener('click', ()=>exportCardPNG());


    // --- one-tap copy on any .copyable element ---
    document.addEventListener('click', async (e)=>{
      const el = e.target && e.target.closest ? e.target.closest('.copyable') : null;
      if(!el) return;
      // don't trigger if user clicked inside an input
      if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable) return;
      const txt = (el.textContent || '').trim();
      if(!txt || txt === '‚Äî') return;
      const ok = await copyText(txt);
      if(ok){ showToast(tr('common.copiedToast')); haptic('notify','success'); }
    });
    // --- links ---
    function openUrl(url){
      try{
        if(tg && tg.openTelegramLink && url.indexOf('https://t.me/') === 0) return tg.openTelegramLink(url);
        if(tg && tg.openLink) return tg.openLink(url);
      }catch(_){}
      window.open(url, '_blank', 'noopener');
    }
    const linkTelegram = $('link_telegram');
    const linkYoutube = $('link_youtube');
    if(linkTelegram) linkTelegram.addEventListener('click', (e)=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade'); });
    if(linkYoutube) linkYoutube.addEventListener('click', (e)=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE'); });

    // --- init order ---
    document.documentElement.setAttribute('data-theme', getInitialTheme());
    syncLangButtons();
    translateAll();

    ensureAtLeastOneRow();
    renderHistory();

    calcDCA();
    calcRR();
    calcCap();
    fetchIndicators(false);

    // redraw indicator canvases even if tab hidden
    redrawIndicators();
  });

})();
</script>
</body>
</html>
