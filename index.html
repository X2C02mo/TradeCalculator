 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index d119897b15096f67c3322c367a50fcb728d182cb..58cd1a944bed425aba9c971f057a5eeea0c9ebdb 100644
--- a/index.html
+++ b/index.html
@@ -1,118 +1,141 @@
 <!DOCTYPE html>
 <html lang="ru">
 <head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width,initial-scale=1" />
 <title>Trader Calculator + Indicators</title>
 <script src="https://telegram.org/js/telegram-web-app.js"></script>
 <style>
-:root{
-  --bg:#000;
-  --panel:#0b0b0b;
-  --border:#151515;
-  --text:#fff;
-  --muted:#9a9a9a;
-  --accent:#7CFC00;
-  --danger:#ff4d4f;
-}
+:root{
+  --bg:#000;
+  --panel:#0b0b0b;
+  --border:#151515;
+  --input:#070707;
+  --result:#060606;
+  --text:#fff;
+  --muted:#9a9a9a;
+  --accent:#7CFC00;
+  --danger:#ff4d4f;
+}
+
+:root[data-theme="light"]{
+  --bg:#f7f7f8;
+  --panel:#ffffff;
+  --border:#dcdcdc;
+  --input:#f1f3f6;
+  --result:#eef1f5;
+  --text:#0c0c0d;
+  --muted:#4c4f54;
+  --accent:#1677ff;
+  --danger:#d9363e;
+}
 
 *{box-sizing:border-box}
-html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
-body{padding-bottom:env(safe-area-inset-bottom); padding-top:env(safe-area-inset-top)}
-#app{min-height:100vh;display:flex;flex-direction:column}
-
-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);gap:10px}
-.tabs{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
-.tab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:4px}
-.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
-.lang{display:flex;gap:6px;align-items:center;flex:0 0 auto}
-.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer;border-radius:4px}
-.lang button.active{color:var(--accent);border-color:var(--accent)}
-
-main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
-.panels{display:flex;gap:16px;flex-wrap:wrap}
-.screen{display:none;width:100%}
+html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
+body{padding-bottom:env(safe-area-inset-bottom); padding-top:env(safe-area-inset-top)}
+#app{min-height:100vh;display:flex;flex-direction:column}
+
+header{display:flex;justify-content:space-between;align-items:flex-start;padding:10px 12px;border-bottom:1px solid var(--border);gap:12px;flex-wrap:wrap}
+.header-left{display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap}
+.tabs{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
+.tab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:4px}
+.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
+.lang{display:flex;gap:6px;align-items:center;flex:0 0 auto}
+.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer;border-radius:4px}
+.lang button.active{color:var(--accent);border-color:var(--accent)}
+.header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-left:auto}
+.theme-toggle{background:transparent;border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:6px;cursor:pointer;font-weight:600}
+.theme-toggle:hover{border-color:var(--accent);color:var(--accent)}
+
+main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
+.panels{display:flex;gap:16px;flex-wrap:wrap}
+.screen{display:none;width:100%}
 .screen.active{display:block}
 
 .card{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;max-width:760px}
 .field{margin-bottom:10px}
-label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
-input{
-  width:100%;padding:10px;background:#070707;border:1px solid var(--border);
-  color:var(--text);border-radius:6px;font-size:14px;outline:none
-}
-input:focus{border-color:#2a2a2a}
-
-.result{
-  margin-top:8px;padding:10px;border-radius:6px;background:#060606;border:1px solid var(--border);
-  display:flex;align-items:center;justify-content:space-between;gap:10px
-}
+label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
+input{
+  width:100%;padding:10px;background:var(--input);border:1px solid var(--border);
+  color:var(--text);border-radius:6px;font-size:14px;outline:none
+}
+input:focus{border-color:#2a2a2a}
+
+.result{
+  margin-top:8px;padding:10px;border-radius:6px;background:var(--result);border:1px solid var(--border);
+  display:flex;align-items:center;justify-content:space-between;gap:10px
+}
 .res-label{color:var(--muted);font-size:12px}
 .res-value{font-weight:700;font-size:14px}
 .res-value.muted{color:var(--muted);font-weight:600}
 .res-value.danger{color:var(--danger)}
 
 .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
-.btn{background:transparent;color:var(--accent);border:1px solid #2b2b2b;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600}
+.btn{background:transparent;color:var(--accent);border:1px solid var(--border);padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600}
 .btn:active{transform:translateY(1px)}
 .btn.ghost{color:var(--muted);border-color:var(--border)}
 
 .history{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:10px;max-width:420px}
 .history-list{display:flex;flex-direction:column;gap:8px;max-height:340px;overflow:auto}
 .note{font-size:12px;color:var(--muted)}
 .small{font-size:11px;color:var(--muted)}
 
 footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
 .tags{font-size:12px;color:var(--muted);letter-spacing:1px}
 .links{display:flex;gap:18px;margin-top:2px}
 .rainbow{
   display:inline-block;font-weight:700;text-decoration:none;
   background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
   background-size:400% 400%;
   -webkit-background-clip:text;color:transparent;
   animation:rain 3.5s linear infinite
 }
 @keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
 @media(min-width:900px){main{flex-direction:row}}
 </style>
 </head>
 
 <body>
 <div id="app">
-  <header>
-    <div class="tabs" role="tablist">
-      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
-      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
-      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
-      <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
-    </div>
-    <div class="lang">
-      <button id="btn_ru" class="active">RU</button>
-      <button id="btn_en">EN</button>
-    </div>
-  </header>
+  <header>
+    <div class="header-left">
+      <div class="lang">
+        <button id="btn_ru" class="active">RU</button>
+        <button id="btn_en">EN</button>
+      </div>
+      <div class="tabs" role="tablist">
+        <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
+        <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
+        <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
+        <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
+      </div>
+    </div>
+    <div class="header-actions">
+      <button id="theme_toggle" class="theme-toggle" type="button">üåô Theme</button>
+    </div>
+  </header>
 
   <main>
     <div class="panels" style="flex:1">
       <!-- DCA -->
       <section id="dca" class="screen active">
         <div class="card">
           <div class="field"><label data-i18n="dca.p1">–¶–µ–Ω–∞ 1</label><input id="dca_p1" type="number" inputmode="decimal" step="any" placeholder="0.00"></div>
           <div class="field"><label data-i18n="dca.v1">–û–±—ä—ë–º 1</label><input id="dca_v1" type="number" inputmode="decimal" step="any" min="0" placeholder="0"></div>
           <div class="field"><label data-i18n="dca.p2">–¶–µ–Ω–∞ 2</label><input id="dca_p2" type="number" inputmode="decimal" step="any" placeholder="0.00"></div>
           <div class="field"><label data-i18n="dca.v2">–û–±—ä—ë–º 2</label><input id="dca_v2" type="number" inputmode="decimal" step="any" min="0" placeholder="0"></div>
 
           <div class="result" id="dca_result">
             <span class="res-label" data-i18n="dca.result.label">–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</span>
             <span class="res-value muted" id="dca_value">‚Äî</span>
           </div>
 
           <div class="small" id="dca_hint"></div>
         </div>
       </section>
 
       <!-- R/R -->
       <section id="rr" class="screen">
         <div class="card">
           <div class="field"><label data-i18n="rr.entry">Entry</label><input id="rr_entry" type="number" inputmode="decimal" step="any" placeholder="0.00"></div>
           <div class="field"><label data-i18n="rr.sl">Stop Loss</label><input id="rr_sl" type="number" inputmode="decimal" step="any" placeholder="0.00"></div>
@@ -184,60 +207,70 @@ footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-directi
 
     <!-- right: history -->
     <aside class="history" aria-live="polite">
       <h4 data-i18n="hist.title">History</h4>
       <div class="history-list" id="history_list"></div>
 
       <div style="display:flex;gap:8px;margin-top:8px">
         <button class="btn ghost" id="clear_history" data-i18n="hist.clear">Clear</button>
         <button class="btn" id="export_history" data-i18n="hist.export">Export</button>
       </div>
 
       <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
     </aside>
   </main>
 
   <footer>
     <div class="tags" data-i18n="footer.tags">–ê–ò–†–î–†–û–ü ¬∑ –ù–û–í–û–°–¢–ò ¬∑ –¢–†–ï–ô–î–ò–ù–ì</div>
     <div class="links">
       <a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a>
       <a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a>
     </div>
   </footer>
 </div>
 
 <script>
-/* Telegram init + theme */
-const tg = window.Telegram?.WebApp || null;
-try{ tg?.expand?.(); }catch(e){}
-
-(function applyTelegramTheme(){
-  try{
-    const p = tg?.themeParams;
-    if(!p) return;
-    // Telegram may provide colors like "#ffffff"
-    if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
+/* Telegram init + theme */
+const tg = window.Telegram?.WebApp || null;
+const THEME_KEY = 'trader_theme_preference';
+
+function getStoredTheme(){
+  try{
+    const val = localStorage.getItem(THEME_KEY);
+    return (val === 'light' || val === 'dark') ? val : null;
+  }catch(e){ return null; }
+}
+
+try{ tg?.expand?.(); }catch(e){}
+
+(function applyTelegramTheme(){
+  if(getStoredTheme()) return; // user preference wins
+  try{
+    const p = tg?.themeParams;
+    if(!p) return;
+    // Telegram may provide colors like "#ffffff"
+    if (p.bg_color) document.documentElement.style.setProperty('--bg', p.bg_color);
     if (p.text_color) document.documentElement.style.setProperty('--text', p.text_color);
     if (p.hint_color) document.documentElement.style.setProperty('--muted', p.hint_color);
     if (p.secondary_bg_color) document.documentElement.style.setProperty('--panel', p.secondary_bg_color);
     // Accent: keep your neon by default
   }catch(e){}
 })();
 
 /* locales */
 const locales = {
   ru:{
     "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
 
     "dca.p1":"–¶–µ–Ω–∞ 1","dca.v1":"–û–±—ä—ë–º 1","dca.p2":"–¶–µ–Ω–∞ 2","dca.v2":"–û–±—ä—ë–º 2",
     "dca.result.label":"–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞",
 
     "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit",
     "rr.result.label":"R/R",
 
     "cap.dep":"–î–µ–ø–æ–∑–∏—Ç","cap.risk":"–†–∏—Å–∫ %","cap.entry":"Entry","cap.sl":"Stop Loss",
     "cap.result.label":"–û–±—ä—ë–º",
 
     "ind.title":"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã",
     "ind.fg.label":"Fear & Greed","ind.fg.valueLabel":"–ó–Ω–∞—á–µ–Ω–∏–µ",
     "ind.tcap.label":"–û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è (USD)","ind.tcap.valueLabel":"USD",
     "ind.alt.label":"–î–æ–º–∏–Ω–∞—Ü–∏—è –∞–ª—å—Ç–æ–≤ (proxy)","ind.alt.valueLabel":"Alt %",
@@ -293,106 +326,135 @@ let lang = 'en';
 try{
   const tgl = tg?.initDataUnsafe?.user?.language_code;
   if (tgl) lang = /^ru|uk|be/i.test(tgl) ? 'ru' : 'en';
   else lang = /^ru|uk|be/i.test(navigator.language) ? 'ru' : 'en';
 }catch(e){ lang='en'; }
 
 function t(key){ return (locales[lang] && locales[lang][key] !== undefined) ? locales[lang][key] : key; }
 function translateAll(){
   document.querySelectorAll('[data-i18n]').forEach(el=>{
     const k = el.getAttribute('data-i18n');
     if(locales[lang] && locales[lang][k] !== undefined) el.textContent = locales[lang][k];
   });
 }
 
 /* Tabs */
 document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', ()=>{
   document.querySelectorAll('.tab').forEach(tn=>tn.classList.remove('active'));
   btn.classList.add('active');
   const target = btn.dataset.tab;
   document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
   document.getElementById(target).classList.add('active');
   translateAll();
 }));
 
 /* Language buttons */
-const btn_ru = document.getElementById('btn_ru');
-const btn_en = document.getElementById('btn_en');
-btn_ru.addEventListener('click', ()=>{ lang='ru'; btn_ru.classList.add('active'); btn_en.classList.remove('active'); translateAll(); renderHistory(); refreshHints(); });
-btn_en.addEventListener('click', ()=>{ lang='en'; btn_en.classList.add('active'); btn_ru.classList.remove('active'); translateAll(); renderHistory(); refreshHints(); });
-
-translateAll();
+const btn_ru = document.getElementById('btn_ru');
+const btn_en = document.getElementById('btn_en');
+btn_ru.addEventListener('click', ()=>{ lang='ru'; btn_ru.classList.add('active'); btn_en.classList.remove('active'); translateAll(); renderHistory(); refreshHints(); applyTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark'); });
+btn_en.addEventListener('click', ()=>{ lang='en'; btn_en.classList.add('active'); btn_ru.classList.remove('active'); translateAll(); renderHistory(); refreshHints(); applyTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark'); });
+
+/* Theme toggle */
+const themeToggle = document.getElementById('theme_toggle');
+function applyTheme(mode){
+  const root = document.documentElement;
+  if(mode === 'light') root.setAttribute('data-theme','light');
+  else { root.removeAttribute('data-theme'); mode='dark'; }
+  const label = mode === 'light'
+    ? (lang === 'ru' ? '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è' : '‚òÄÔ∏è Light')
+    : (lang === 'ru' ? 'üåô –¢—ë–º–Ω–∞—è' : 'üåô Dark');
+  themeToggle.textContent = label;
+  themeToggle.setAttribute('aria-pressed', mode === 'light');
+}
+function setTheme(mode){
+  applyTheme(mode);
+  try{ localStorage.setItem(THEME_KEY, mode); }catch(e){}
+}
+function detectPreferredTheme(){
+  const stored = getStoredTheme();
+  if(stored) return stored;
+  if(tg?.colorScheme === 'light' || tg?.colorScheme === 'dark') return tg.colorScheme;
+  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) return 'light';
+  return 'dark';
+}
+applyTheme(detectPreferredTheme());
+themeToggle.addEventListener('click', ()=>{
+  const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
+  setTheme(next);
+});
+
+translateAll();
 
 /* Utils */
 function safeNum(v){
   const x = parseFloat(v);
   return Number.isFinite(x) ? x : NaN;
 }
 function setValue(el, value, kind){
   el.classList.remove('muted','danger');
   if(kind === 'danger') el.classList.add('danger');
   if(kind === 'muted') el.classList.add('muted');
   el.textContent = value;
 }
 function haptic(kind='impact', style='light'){
   try{
     if(!tg?.HapticFeedback) return;
     if(kind==='impact') tg.HapticFeedback.impactOccurred(style);
     if(kind==='notify') tg.HapticFeedback.notificationOccurred(style); // 'success'|'warning'|'error'
   }catch(e){}
 }
 
 /* History (localStorage) */
 const HISTORY_KEY = 'trader_calc_history_v2';
 function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY))||[] }catch(e){ return [] } }
 function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }
 function pushHistory(item){
   const arr = loadHistory();
   arr.unshift(item);
   if(arr.length > 80) arr.pop();
   saveHistory(arr);
 }
 function renderHistory(){
   const list = document.getElementById('history_list');
   list.innerHTML = '';
   const arr = loadHistory();
   if(!arr.length){
     const el = document.createElement('div');
     el.className = 'note';
     el.textContent = t('hist.note');
     list.appendChild(el);
     return;
   }
   arr.forEach(it=>{
     const node = document.createElement('div');
     node.style.display='flex';
     node.style.justifyContent='space-between';
     node.style.alignItems='flex-start';
     node.style.padding='8px';
     node.style.border='1px solid var(--border)';
     node.style.borderRadius='8px';
-    node.style.background='#070707';
+    node.style.background='var(--input)';
 
     const left = document.createElement('div');
     left.innerHTML = `
       <div style="font-weight:700">${it.type}</div>
       <div class="note">${it.summary || ''}</div>
       <div class="small">${new Date(it.t).toLocaleString()}</div>
     `;
     node.appendChild(left);
 
     list.appendChild(node);
   });
 }
 
 document.getElementById('clear_history').addEventListener('click', ()=>{
   localStorage.removeItem(HISTORY_KEY);
   renderHistory();
   haptic('notify','success');
 });
 
 document.getElementById('export_history').addEventListener('click', ()=>{
   const data = JSON.stringify(loadHistory(), null, 2);
   const blob = new Blob([data], {type:'application/json'});
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
 
EOF
)
