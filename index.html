<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trader Calculator + Indicators</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{ --bg:#000; --panel:#0b0b0b; --border:#151515; --text:#fff; --muted:#9a9a9a; --accent:#7CFC00; }
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,Helvetica,sans-serif}
#app{min-height:100vh;display:flex;flex-direction:column}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
.tabs{display:flex;gap:12px;align-items:center}
.tab{background:none;border:none;color:var(--muted);font-size:13px;padding:6px 10px;cursor:pointer;border-radius:4px}
.tab.active{color:var(--accent);border-bottom:2px solid var(--accent)}
.lang{display:flex;gap:6px;align-items:center}
.lang button{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;cursor:pointer;border-radius:4px}
.lang button.active{color:var(--accent);border-color:var(--accent)}
main{flex:1;padding:14px;display:flex;gap:16px;flex-direction:column}
.panels{display:flex;gap:16px;flex-wrap:wrap}
.screen{display:none;width:100%}
.screen.active{display:block}
.card{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;max-width:760px}
.field{margin-bottom:10px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input{width:100%;padding:10px;background:#070707;border:1px solid var(--border);color:var(--text);border-radius:6px;font-size:14px}
.result{margin-top:8px;padding:10px;border-radius:6px;background:#060606;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.btn{background:transparent;color:var(--accent);border:1px solid #2b2b2b;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600}
.btn.ghost{color:var(--muted);border-color:var(--border)}
.history{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:10px;max-width:420px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto}
.note{font-size:12px;color:var(--muted)}
footer{border-top:1px solid var(--border);padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
.tags{font-size:12px;color:var(--muted);letter-spacing:1px}
.links{display:flex;gap:18px;margin-top:2px}
.rainbow{display:inline-block;font-weight:700;text-decoration:none;background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);background-size:400% 400%;-webkit-background-clip:text;color:transparent;animation:rain 3.5s linear infinite}
@keyframes rain{0%{background-position:0% 50%}100%{background-position:100% 50%}}
@media(min-width:900px){main{flex-direction:row}}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="dca" data-i18n="tab.dca">DCA</button>
      <button class="tab" data-tab="rr" data-i18n="tab.rr">R/R</button>
      <button class="tab" data-tab="cap" data-i18n="tab.cap">Capital</button>
      <button class="tab" data-tab="ind" data-i18n="tab.ind">Indicators</button>
    </div>
    <div class="lang">
      <button id="btn_ru" class="active">RU</button>
      <button id="btn_en">EN</button>
    </div>
  </header>

  <main>
    <div class="panels" style="flex:1">
      <!-- DCA -->
      <section id="dca" class="screen active"><div class="card">
        <div class="field"><label data-i18n="dca.p1">Цена 1</label><input id="dca_p1" type="number" step="any"></div>
        <div class="field"><label data-i18n="dca.v1">Объём 1</label><input id="dca_v1" type="number" step="any"></div>
        <div class="field"><label data-i18n="dca.p2">Цена 2</label><input id="dca_p2" type="number" step="any"></div>
        <div class="field"><label data-i18n="dca.v2">Объём 2</label><input id="dca_v2" type="number" step="any"></div>
        <div class="result" id="dca_result" data-i18n="dca.result">Средняя цена: —</div>
      </div></section>

      <!-- R/R -->
      <section id="rr" class="screen"><div class="card">
        <div class="field"><label data-i18n="rr.entry">Entry</label><input id="rr_entry" type="number" step="any"></div>
        <div class="field"><label data-i18n="rr.sl">Stop Loss</label><input id="rr_sl" type="number" step="any"></div>
        <div class="field"><label data-i18n="rr.tp">Take Profit</label><input id="rr_tp" type="number" step="any"></div>
        <div class="result" id="rr_result" data-i18n="rr.result">R/R: —</div>
      </div></section>

      <!-- Capital -->
      <section id="cap" class="screen"><div class="card">
        <div class="field"><label data-i18n="cap.dep">Депозит</label><input id="cap_dep" type="number" step="any"></div>
        <div class="field"><label data-i18n="cap.risk">Риск %</label><input id="cap_risk" type="number" step="any"></div>
        <div class="field"><label data-i18n="cap.entry">Entry</label><input id="cap_entry" type="number" step="any"></div>
        <div class="field"><label data-i18n="cap.sl">Stop Loss</label><input id="cap_sl" type="number" step="any"></div>
        <div class="result" id="cap_result" data-i18n="cap.result">Объём: —</div>
      </div></section>

      <!-- Indicators -->
      <section id="ind" class="screen"><div class="card">
        <h3 style="margin:0 0 10px 0" data-i18n="ind.title">Indicators</h3>
        <div class="field"><label data-i18n="ind.fg.label">Fear &amp; Greed</label><div id="fg_value" class="result" data-i18n="ind.fg.placeholder">—</div></div>
        <div class="field"><label data-i18n="ind.tcap.label">Total Market Cap (USD)</label><div id="tcap" class="result" data-i18n="ind.tcap.placeholder">—</div></div>
        <div class="field"><label data-i18n="ind.alt.label">Alt dominance (proxy Altseason)</label><div id="alt_dom" class="result" data-i18n="ind.alt.placeholder">—</div></div>
        <div class="controls" style="margin-top:8px"><button class="btn" id="refresh_ind" data-i18n="ind.refresh">Refresh</button></div>
        <div class="note" id="ind_note"></div>
      </div></section>

    </div>

    <!-- right: history/small info -->
    <aside class="history" aria-live="polite">
      <h4 data-i18n="hist.title">History</h4>
      <div class="history-list" id="history_list"></div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn ghost" id="clear_history" data-i18n="hist.clear">Clear</button><button class="btn" id="export_history" data-i18n="hist.export">Export</button></div>
      <div class="note" data-i18n="hist.note">Saved locally in your browser</div>
    </aside>
  </main>

  <footer>
    <div class="tags" data-i18n="footer.tags">АИРДРОП · НОВОСТИ · ТРЕЙДИНГ</div>
    <div class="links"><a id="link_telegram" class="rainbow" href="https://t.me/InvestTraderTrade" target="_blank" rel="noopener">TELEGRAM</a><a id="link_youtube" class="rainbow" href="https://www.youtube.com/@TRADER_TRADE" target="_blank" rel="noopener">YOUTUBE</a></div>
  </footer>
</div>

<script>
/* Init */
const tg = window.Telegram?.WebApp || null;
try{ tg && tg.expand && tg.expand(); }catch(e){}

/* locales */
const locales = {
  ru:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "dca.p1":"Цена 1","dca.v1":"Объём 1","dca.p2":"Цена 2","dca.v2":"Объём 2","dca.result":"Средняя цена",
    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.result":"R/R: —",
    "cap.dep":"Депозит","cap.risk":"Риск %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.result":"Объём: —",
    "ind.title":"Индикаторы","ind.fg.label":"Fear & Greed","ind.fg.placeholder":"—","ind.tcap.label":"Общая капитализация (USD)","ind.tcap.placeholder":"—","ind.alt.label":"Доминация альтов (proxy)","ind.alt.placeholder":"—","ind.refresh":"Обновить",
    "hist.title":"История","hist.clear":"Очистить","hist.export":"Экспорт","hist.note":"Сохранено локально в браузере","footer.tags":"АИРДРОП · НОВОСТИ · ТРЕЙДИНГ"
  },
  en:{
    "tab.dca":"DCA","tab.rr":"R/R","tab.cap":"Capital","tab.ind":"Indicators",
    "dca.p1":"Price 1","dca.v1":"Volume 1","dca.p2":"Price 2","dca.v2":"Volume 2","dca.result":"Average price",
    "rr.entry":"Entry","rr.sl":"Stop Loss","rr.tp":"Take Profit","rr.result":"R/R: —",
    "cap.dep":"Deposit","cap.risk":"Risk %","cap.entry":"Entry","cap.sl":"Stop Loss","cap.result":"Position size: —",
    "ind.title":"Indicators","ind.fg.label":"Fear & Greed","ind.fg.placeholder":"—","ind.tcap.label":"Total Market Cap (USD)","ind.tcap.placeholder":"—","ind.alt.label":"Alt dominance (proxy)","ind.alt.placeholder":"—","ind.refresh":"Refresh",
    "hist.title":"History","hist.clear":"Clear","hist.export":"Export","hist.note":"Saved locally in your browser","footer.tags":"AIRDROP · NEWS · TRADING"
  }
};
let lang = 'en';
try{ const tgl = tg?.initDataUnsafe?.user?.language_code; if (tgl) lang = /^ru|uk|be/i.test(tgl)?'ru':'en'; else lang = /^ru|uk|be/i.test(navigator.language)?'ru':'en'; }catch(e){ lang='en'; }
function translateAll(){ document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(locales[lang]&&locales[lang][k]!==undefined) el.textContent = locales[lang][k]; }); }

/* Tabs */
document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', ()=>{ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); const target = btn.dataset.tab; document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(target).classList.add('active'); translateAll(); }));

/* Language buttons */
const btn_ru = document.getElementById('btn_ru');
const btn_en = document.getElementById('btn_en');
btn_ru.addEventListener('click', ()=>{ lang='ru'; btn_ru.classList.add('active'); btn_en.classList.remove('active'); translateAll(); });
btn_en.addEventListener('click', ()=>{ lang='en'; btn_en.classList.add('active'); btn_ru.classList.remove('active'); translateAll(); });
translateAll();

/* Existing calculators (minimal safe implementations) */
function safeNum(v){ const x=parseFloat(v); return isFinite(x)?x:0; }
const dca_p1 = document.getElementById('dca_p1'), dca_v1=document.getElementById('dca_v1'), dca_p2=document.getElementById('dca_p2'), dca_v2=document.getElementById('dca_v2'), dca_result=document.getElementById('dca_result');
function calcDCA(){ const p1=safeNum(dca_p1.value), v1n=safeNum(dca_v1.value), p2=safeNum(dca_p2.value), v2n=safeNum(dca_v2.value); const vol=v1n+v2n; if(vol<=0){ dca_result.textContent = locales[lang]['dca.result']+': —'; delete dca_result._last; return; } const avg = ((p1*v1n)+(p2*v2n))/vol; dca_result._last = avg.toFixed(8); dca_result.textContent = locales[lang]['dca.result']+': '+dca_result._last; }
[dca_p1,dca_v1,dca_p2,dca_v2].forEach(i=>i.addEventListener('input',calcDCA));

const rr_entry=document.getElementById('rr_entry'), rr_sl=document.getElementById('rr_sl'), rr_tp=document.getElementById('rr_tp'), rr_result=document.getElementById('rr_result');
function calcRR(){ const e=safeNum(rr_entry.value), sl=safeNum(rr_sl.value), tp=safeNum(rr_tp.value); if(!isFinite(e)||!isFinite(sl)||!isFinite(tp)||e===sl){ rr_result.textContent = locales[lang]['rr.result']; delete rr_result._last; return; } const risk=Math.abs(e-sl); if(risk===0){ rr_result.textContent = locales[lang]['rr.result']; delete rr_result._last; return; } const ratio=(Math.abs(tp-e)/risk).toFixed(2); rr_result._last='1:'+ratio; rr_result.textContent = locales[lang]['rr.result'].split(':')[0]+': '+rr_result._last; }
[rr_entry,rr_sl,rr_tp].forEach(i=>i.addEventListener('input',calcRR));

const cap_dep=document.getElementById('cap_dep'), cap_risk=document.getElementById('cap_risk'), cap_entry=document.getElementById('cap_entry'), cap_sl=document.getElementById('cap_sl'), cap_result=document.getElementById('cap_result');
function calcCap(){ const dep=safeNum(cap_dep.value), rp=safeNum(cap_risk.value), e=safeNum(cap_entry.value), sl=safeNum(cap_sl.value); if(!isFinite(dep)||!isFinite(rp)||!isFinite(e)||!isFinite(sl)||e===sl){ cap_result.textContent = locales[lang]['cap.result']+': —'; delete cap_result._last; return; } const riskUsd = dep * (rp/100); const size = (riskUsd / Math.abs(e-sl)).toFixed(8); cap_result._last = size; cap_result.textContent = locales[lang]['cap.result'].split(':')[0]+': '+size; }
[cap_dep,cap_risk,cap_entry,cap_sl].forEach(i=>i.addEventListener('input',calcCap));

/* Indicators implementation */
const fgEl = document.getElementById('fg_value'), tcapEl = document.getElementById('tcap'), altDomEl = document.getElementById('alt_dom'), indNote = document.getElementById('ind_note');
async function fetchIndicators(){
  indNote.textContent = locales[lang]['ind.refresh'] + '...';
  try{
    const res = await fetch('https://api.alternative.me/fng/?limit=1&format=json');
    if(!res.ok) throw new Error('FNG fetch failed');
    const j = await res.json();
    if(j && j.data && j.data.length){ const d = j.data[0]; fgEl.textContent = `${d.value} · ${d.value_classification}`; } else fgEl.textContent = locales[lang]['ind.fg.placeholder'];
  }catch(e){ fgEl.textContent = locales[lang]['ind.fg.placeholder']; }
  try{
    const res2 = await fetch('https://api.coingecko.com/api/v3/global');
    if(!res2.ok) throw new Error('CoinGecko global failed');
    const j2 = await res2.json();
    const totalMc = j2.data?.total_market_cap?.usd;
    const btcDom = j2.data?.market_cap_percentage?.btc;
    if(totalMc) tcapEl.textContent = '$' + Number(totalMc).toLocaleString(undefined, {maximumFractionDigits:0}); else tcapEl.textContent = locales[lang]['ind.tcap.placeholder'];
    if(typeof btcDom === 'number'){ const altDom = (100 - btcDom).toFixed(2); altDomEl.textContent = altDom + '%'; } else altDomEl.textContent = locales[lang]['ind.alt.placeholder'];
  }catch(e){ tcapEl.textContent = locales[lang]['ind.tcap.placeholder']; altDomEl.textContent = locales[lang]['ind.alt.placeholder']; }
  indNote.textContent = '';
}

document.getElementById('refresh_ind').addEventListener('click', fetchIndicators);

/* History basics (localStorage) */
const HISTORY_KEY = 'trader_calc_history_v1';
function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY))||[] }catch(e){return[]} }
function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); renderHistory(); }
function pushHistory(item){ const arr = loadHistory(); arr.unshift(item); if(arr.length>50) arr.pop(); saveHistory(arr); }
function renderHistory(){ const list=document.getElementById('history_list'); list.innerHTML=''; const arr=loadHistory(); if(!arr.length){ const el=document.createElement('div'); el.className='note'; el.textContent=locales[lang]['hist.note']; list.appendChild(el); return; } arr.forEach(it=>{ const node=document.createElement('div'); node.className='history-item'; node.style.display='flex'; node.style.justifyContent='space-between'; node.style.alignItems='center'; node.style.padding='6px'; node.style.borderRadius='6px'; node.innerHTML = `<div><div style="font-weight:600">${it.type} · ${new Date(it.t).toLocaleString()}</div><div class="note">${it.summary||''}</div></div>`; list.appendChild(node); }) }
document.getElementById('clear_history').addEventListener('click', ()=>{ localStorage.removeItem(HISTORY_KEY); renderHistory(); });
document.getElementById('export_history').addEventListener('click', ()=>{ const data=JSON.stringify(loadHistory(),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href = url; a.download='history.json'; a.click(); URL.revokeObjectURL(url); });

/* links */
function openUrl(url){ try{ if(tg?.openLink) return tg.openLink(url); if(tg?.openTelegramLink && url.startsWith('https://t.me/')) return tg.openTelegramLink(url); }catch(e){} window.open(url,'_blank'); }
document.getElementById('link_telegram').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://t.me/InvestTraderTrade');});
document.getElementById('link_youtube').addEventListener('click', e=>{ e.preventDefault(); openUrl('https://www.youtube.com/@TRADER_TRADE');});

/* initial */
translateAll();
calcDCA(); calcRR(); calcCap(); fetchIndicators(); renderHistory();

</script>
</body>
</html>
